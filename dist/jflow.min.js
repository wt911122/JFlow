!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["jflow-core"]={})}(this,(function(e){"use strict";function i(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function n(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?i(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,E(n.key),n)}}function s(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function a(t,e,i){return(e=E(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function h(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&l(t,e)}function c(t){return c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},c(t)}function l(t,e){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},l(t,e)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function f(t,e,i){return f=u()?Reflect.construct.bind():function(t,e,i){var n=[null];n.push.apply(n,e);var r=new(Function.bind.apply(t,n));return i&&l(r,i.prototype),r},f.apply(null,arguments)}function d(t){var e="function"==typeof Map?new Map:void 0;return d=function(t){if(null===t||(i=t,-1===Function.toString.call(i).indexOf("[native code]")))return t;var i;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return f(t,arguments,c(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),l(n,t)},d(t)}function g(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function v(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return g(t)}function p(t){var e=u();return function(){var i,n=c(t);if(e){var r=c(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return v(this,i)}}function _(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=c(t)););return t}function m(){return m="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,i){var n=_(t,e);if(n){var r=Object.getOwnPropertyDescriptor(n,e);return r.get?r.get.call(arguments.length<3?t:i):r.value}},m.apply(this,arguments)}function y(t,e){return w(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,r,o,s,a=[],h=!0,c=!1;try{if(o=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(n=o.call(i)).done)&&(a.push(n.value),a.length!==e);h=!0);}catch(t){c=!0,r=t}finally{try{if(!h&&null!=i.return&&(s=i.return(),Object(s)!==s))return}finally{if(c)throw r}}return a}}(t,e)||x(t,e)||S()}function b(t){return function(t){if(Array.isArray(t))return T(t)}(t)||k(t)||x(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(t){if(Array.isArray(t))return t}function k(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function x(t,e){if(t){if("string"==typeof t)return T(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?T(t,e):void 0}}function T(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function S(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function E(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}function C(t){var e=document.createElement("canvas"),i=e.getContext("2d"),n=t.getBoundingClientRect(),r=n.width,o=n.height,s=n.left,a=n.top;e.style.width=r+"px",e.style.height=o+"px",e.style.userSelect="none";var h=window.devicePixelRatio;return e.width=Math.floor(r*h),e.height=Math.floor(o*h),t&&(t.style.position="relative",t.style.overflow="hidden",t.append(e)),{canvas:e,width:r,height:o,raw_width:e.width,raw_height:e.height,left:s,top:a,ctx:i,scale:h}}var O=document.createElement("canvas");O.width=1,O.height=1;var P=O.getContext("2d"),B=window.devicePixelRatio;function M(t){P.clearRect(0,0,5,5),P.save(),t(P),P.restore(),P.clearRect(0,0,5,5)}function R(t,e){var i=matchMedia("(resolution: ".concat(window.devicePixelRatio,"dppx)"));function n(){console.log("devicePixelRatio changed: "+window.devicePixelRatio),t(window.devicePixelRatio),R(t,e)}e((function(){console.log("remove devicePixelRatio event handler"),i.removeEventListener("change",n,{once:!0})})),i.addEventListener("change",n,{once:!0})}P.scale(B,B);const{abs:I,cos:L,sin:D,acos:j,atan2:A,sqrt:W,pow:H}=Math;function z(t){return t<0?-H(-t,1/3):H(t,1/3)}const X=Math.PI,Y=2*X,F=X/2,N=Number.MAX_SAFE_INTEGER||9007199254740991,q=Number.MIN_SAFE_INTEGER||-9007199254740991,G={x:0,y:0,z:0},V={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(t,e){const i=e(t);let n=i.x*i.x+i.y*i.y;return void 0!==i.z&&(n+=i.z*i.z),W(n)},compute:function(t,e,i){if(0===t)return e[0].t=0,e[0];const n=e.length-1;if(1===t)return e[n].t=1,e[n];const r=1-t;let o=e;if(0===n)return e[0].t=t,e[0];if(1===n){const e={x:r*o[0].x+t*o[1].x,y:r*o[0].y+t*o[1].y,t:t};return i&&(e.z=r*o[0].z+t*o[1].z),e}if(n<4){let e,s,a,h=r*r,c=t*t,l=0;2===n?(o=[o[0],o[1],o[2],G],e=h,s=r*t*2,a=c):3===n&&(e=h*r,s=h*t*3,a=r*c*3,l=t*c);const u={x:e*o[0].x+s*o[1].x+a*o[2].x+l*o[3].x,y:e*o[0].y+s*o[1].y+a*o[2].y+l*o[3].y,t:t};return i&&(u.z=e*o[0].z+s*o[1].z+a*o[2].z+l*o[3].z),u}const s=JSON.parse(JSON.stringify(e));for(;s.length>1;){for(let e=0;e<s.length-1;e++)s[e]={x:s[e].x+(s[e+1].x-s[e].x)*t,y:s[e].y+(s[e+1].y-s[e].y)*t},void 0!==s[e].z&&(s[e]=s[e].z+(s[e+1].z-s[e].z)*t);s.splice(s.length-1,1)}return s[0].t=t,s[0]},computeWithRatios:function(t,e,i,n){const r=1-t,o=i,s=e;let a,h=o[0],c=o[1],l=o[2],u=o[3];return h*=r,c*=t,2===s.length?(a=h+c,{x:(h*s[0].x+c*s[1].x)/a,y:(h*s[0].y+c*s[1].y)/a,z:!!n&&(h*s[0].z+c*s[1].z)/a,t:t}):(h*=r,c*=2*r,l*=t*t,3===s.length?(a=h+c+l,{x:(h*s[0].x+c*s[1].x+l*s[2].x)/a,y:(h*s[0].y+c*s[1].y+l*s[2].y)/a,z:!!n&&(h*s[0].z+c*s[1].z+l*s[2].z)/a,t:t}):(h*=r,c*=1.5*r,l*=3*r,u*=t*t*t,4===s.length?(a=h+c+l+u,{x:(h*s[0].x+c*s[1].x+l*s[2].x+u*s[3].x)/a,y:(h*s[0].y+c*s[1].y+l*s[2].y+u*s[3].y)/a,z:!!n&&(h*s[0].z+c*s[1].z+l*s[2].z+u*s[3].z)/a,t:t}):void 0))},derive:function(t,e){const i=[];for(let n=t,r=n.length,o=r-1;r>1;r--,o--){const t=[];for(let i,r=0;r<o;r++)i={x:o*(n[r+1].x-n[r].x),y:o*(n[r+1].y-n[r].y)},e&&(i.z=o*(n[r+1].z-n[r].z)),t.push(i);i.push(t),n=t}return i},between:function(t,e,i){return e<=t&&t<=i||V.approximately(t,e)||V.approximately(t,i)},approximately:function(t,e,i){return I(t-e)<=(i||1e-6)},length:function(t){const e=V.Tvalues.length;let i=0;for(let n,r=0;r<e;r++)n=.5*V.Tvalues[r]+.5,i+=V.Cvalues[r]*V.arcfn(n,t);return.5*i},map:function(t,e,i,n,r){return n+(r-n)*((t-e)/(i-e))},lerp:function(t,e,i){const n={x:e.x+t*(i.x-e.x),y:e.y+t*(i.y-e.y)};return void 0!==e.z&&void 0!==i.z&&(n.z=e.z+t*(i.z-e.z)),n},pointToString:function(t){let e=t.x+"/"+t.y;return void 0!==t.z&&(e+="/"+t.z),e},pointsToString:function(t){return"["+t.map(V.pointToString).join(", ")+"]"},copy:function(t){return JSON.parse(JSON.stringify(t))},angle:function(t,e,i){const n=e.x-t.x,r=e.y-t.y,o=i.x-t.x,s=i.y-t.y;return A(n*s-r*o,n*o+r*s)},round:function(t,e){const i=""+t,n=i.indexOf(".");return parseFloat(i.substring(0,n+1+e))},dist:function(t,e){const i=t.x-e.x,n=t.y-e.y;return W(i*i+n*n)},closest:function(t,e){let i,n,r=H(2,63);return t.forEach((function(t,o){n=V.dist(e,t),n<r&&(r=n,i=o)})),{mdist:r,mpos:i}},abcratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const i=H(t,e)+H(1-t,e);return I((i-1)/i)},projectionratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const i=H(1-t,e);return i/(H(t,e)+i)},lli8:function(t,e,i,n,r,o,s,a){const h=(t-i)*(o-a)-(e-n)*(r-s);return 0!=h&&{x:((t*n-e*i)*(r-s)-(t-i)*(r*a-o*s))/h,y:((t*n-e*i)*(o-a)-(e-n)*(r*a-o*s))/h}},lli4:function(t,e,i,n){const r=t.x,o=t.y,s=e.x,a=e.y,h=i.x,c=i.y,l=n.x,u=n.y;return V.lli8(r,o,s,a,h,c,l,u)},lli:function(t,e){return V.lli4(t,t.c,e,e.c)},makeline:function(t,e){const i=t.x,n=t.y,r=e.x,o=e.y,s=(r-i)/3,a=(o-n)/3;return new nt(i,n,i+s,n+a,i+2*s,n+2*a,r,o)},findbbox:function(t){let e=N,i=N,n=q,r=q;return t.forEach((function(t){const o=t.bbox();e>o.x.min&&(e=o.x.min),i>o.y.min&&(i=o.y.min),n<o.x.max&&(n=o.x.max),r<o.y.max&&(r=o.y.max)})),{x:{min:e,mid:(e+n)/2,max:n,size:n-e},y:{min:i,mid:(i+r)/2,max:r,size:r-i}}},shapeintersections:function(t,e,i,n,r){if(!V.bboxoverlap(e,n))return[];const o=[],s=[t.startcap,t.forward,t.back,t.endcap],a=[i.startcap,i.forward,i.back,i.endcap];return s.forEach((function(e){e.virtual||a.forEach((function(n){if(n.virtual)return;const s=e.intersects(n,r);s.length>0&&(s.c1=e,s.c2=n,s.s1=t,s.s2=i,o.push(s))}))})),o},makeshape:function(t,e,i){const n=e.points.length,r=t.points.length,o=V.makeline(e.points[n-1],t.points[0]),s=V.makeline(t.points[r-1],e.points[0]),a={startcap:o,forward:t,back:e,endcap:s,bbox:V.findbbox([o,t,e,s]),intersections:function(t){return V.shapeintersections(a,a.bbox,t,t.bbox,i)}};return a},getminmax:function(t,e,i){if(!i)return{min:0,max:0};let n,r,o=N,s=q;-1===i.indexOf(0)&&(i=[0].concat(i)),-1===i.indexOf(1)&&i.push(1);for(let a=0,h=i.length;a<h;a++)n=i[a],r=t.get(n),r[e]<o&&(o=r[e]),r[e]>s&&(s=r[e]);return{min:o,mid:(o+s)/2,max:s,size:s-o}},align:function(t,e){const i=e.p1.x,n=e.p1.y,r=-A(e.p2.y-n,e.p2.x-i);return t.map((function(t){return{x:(t.x-i)*L(r)-(t.y-n)*D(r),y:(t.x-i)*D(r)+(t.y-n)*L(r)}}))},roots:function(t,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const i=t.length-1,n=V.align(t,e),r=function(t){return 0<=t&&t<=1};if(2===i){const t=n[0].y,e=n[1].y,i=n[2].y,o=t-2*e+i;if(0!==o){const n=-W(e*e-t*i),s=-t+e;return[-(n+s)/o,-(-n+s)/o].filter(r)}return e!==i&&0===o?[(2*e-i)/(2*e-2*i)].filter(r):[]}const o=n[0].y,s=n[1].y,a=n[2].y;let h=3*s-o-3*a+n[3].y,c=3*o-6*s+3*a,l=-3*o+3*s,u=o;if(V.approximately(h,0)){if(V.approximately(c,0))return V.approximately(l,0)?[]:[-u/l].filter(r);const t=W(l*l-4*c*u),e=2*c;return[(t-l)/e,(-l-t)/e].filter(r)}c/=h,l/=h,u/=h;const f=(3*l-c*c)/3,d=f/3,g=(2*c*c*c-9*c*l+27*u)/27,v=g/2,p=v*v+d*d*d;let _,m,y,b,w;if(p<0){const t=-f/3,e=W(t*t*t),i=-g/(2*e),n=j(i<-1?-1:i>1?1:i),o=2*z(e);return y=o*L(n/3)-c/3,b=o*L((n+Y)/3)-c/3,w=o*L((n+2*Y)/3)-c/3,[y,b,w].filter(r)}if(0===p)return _=v<0?z(-v):-z(v),y=2*_-c/3,b=-_-c/3,[y,b].filter(r);{const t=W(p);return _=z(-v+t),m=z(v+t),[_-m-c/3].filter(r)}},droots:function(t){if(3===t.length){const e=t[0],i=t[1],n=t[2],r=e-2*i+n;if(0!==r){const t=-W(i*i-e*n),o=-e+i;return[-(t+o)/r,-(-t+o)/r]}return i!==n&&0===r?[(2*i-n)/(2*(i-n))]:[]}if(2===t.length){const e=t[0],i=t[1];return e!==i?[e/(e-i)]:[]}return[]},curvature:function(t,e,i,n,r){let o,s,a,h,c=0,l=0;const u=V.compute(t,e),f=V.compute(t,i),d=u.x*u.x+u.y*u.y;if(n?(o=W(H(u.y*f.z-f.y*u.z,2)+H(u.z*f.x-f.z*u.x,2)+H(u.x*f.y-f.x*u.y,2)),s=H(d+u.z*u.z,1.5)):(o=u.x*f.y-u.y*f.x,s=H(d,1.5)),0===o||0===s)return{k:0,r:0};if(c=o/s,l=s/o,!r){const r=V.curvature(t-.001,e,i,n,!0).k,o=V.curvature(t+.001,e,i,n,!0).k;h=(o-c+(c-r))/2,a=(I(o-c)+I(c-r))/2}return{k:c,r:l,dk:h,adk:a}},inflections:function(t){if(t.length<4)return[];const e=V.align(t,{p1:t[0],p2:t.slice(-1)[0]}),i=e[2].x*e[1].y,n=e[3].x*e[1].y,r=e[1].x*e[2].y,o=18*(-3*i+2*n+3*r-e[3].x*e[2].y),s=18*(3*i-n-3*r),a=18*(r-i);if(V.approximately(o,0)){if(!V.approximately(s,0)){let t=-a/s;if(0<=t&&t<=1)return[t]}return[]}const h=s*s-4*o*a,c=Math.sqrt(h),l=2*o;return V.approximately(l,0)?[]:[(c-s)/l,-(s+c)/l].filter((function(t){return 0<=t&&t<=1}))},bboxoverlap:function(t,e){const i=["x","y"],n=i.length;for(let r,o,s,a,h=0;h<n;h++)if(r=i[h],o=t[r].mid,s=e[r].mid,a=(t[r].size+e[r].size)/2,I(o-s)>=a)return!1;return!0},expandbox:function(t,e){e.x.min<t.x.min&&(t.x.min=e.x.min),e.y.min<t.y.min&&(t.y.min=e.y.min),e.z&&e.z.min<t.z.min&&(t.z.min=e.z.min),e.x.max>t.x.max&&(t.x.max=e.x.max),e.y.max>t.y.max&&(t.y.max=e.y.max),e.z&&e.z.max>t.z.max&&(t.z.max=e.z.max),t.x.mid=(t.x.min+t.x.max)/2,t.y.mid=(t.y.min+t.y.max)/2,t.z&&(t.z.mid=(t.z.min+t.z.max)/2),t.x.size=t.x.max-t.x.min,t.y.size=t.y.max-t.y.min,t.z&&(t.z.size=t.z.max-t.z.min)},pairiteration:function(t,e,i){const n=t.bbox(),r=e.bbox(),o=1e5,s=i||.5;if(n.x.size+n.y.size<s&&r.x.size+r.y.size<s)return[(o*(t._t1+t._t2)/2|0)/o+"/"+(o*(e._t1+e._t2)/2|0)/o];let a=t.split(.5),h=e.split(.5),c=[{left:a.left,right:h.left},{left:a.left,right:h.right},{left:a.right,right:h.right},{left:a.right,right:h.left}];c=c.filter((function(t){return V.bboxoverlap(t.left.bbox(),t.right.bbox())}));let l=[];return 0===c.length||(c.forEach((function(t){l=l.concat(V.pairiteration(t.left,t.right,s))})),l=l.filter((function(t,e){return l.indexOf(t)===e}))),l},getccenter:function(t,e,i){const n=e.x-t.x,r=e.y-t.y,o=i.x-e.x,s=i.y-e.y,a=n*L(F)-r*D(F),h=n*D(F)+r*L(F),c=o*L(F)-s*D(F),l=o*D(F)+s*L(F),u=(t.x+e.x)/2,f=(t.y+e.y)/2,d=(e.x+i.x)/2,g=(e.y+i.y)/2,v=u+a,p=f+h,_=d+c,m=g+l,y=V.lli8(u,f,v,p,d,g,_,m),b=V.dist(y,t);let w,k=A(t.y-y.y,t.x-y.x),x=A(e.y-y.y,e.x-y.x),T=A(i.y-y.y,i.x-y.x);return k<T?((k>x||x>T)&&(k+=Y),k>T&&(w=T,T=k,k=w)):T<x&&x<k?(w=T,T=k,k=w):T+=Y,y.s=k,y.e=T,y.r=b,y},numberSort:function(t,e){return t-e}};class U{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(t){return V.pointsToString(t.points)})).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map((function(t){return t.length()})).reduce((function(t,e){return t+e}))}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var e=t[0].bbox(),i=1;i<t.length;i++)V.expandbox(e,t[i].bbox());return e}offset(t){const e=[];return this.curves.forEach((function(i){e.push(...i.offset(t))})),new U(e)}}const{abs:Z,min:K,max:J,cos:$,sin:Q,acos:tt,sqrt:et}=Math,it=Math.PI;class nt{constructor(t){let e=t&&t.forEach?t:Array.from(arguments).slice(),i=!1;if("object"==typeof e[0]){i=e.length;const t=[];e.forEach((function(e){["x","y","z"].forEach((function(i){void 0!==e[i]&&t.push(e[i])}))})),e=t}let n=!1;const r=e.length;if(i){if(i>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");n=!0}}else if(6!==r&&8!==r&&9!==r&&12!==r&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const o=this._3d=!n&&(9===r||12===r)||t&&t[0]&&void 0!==t[0].z,s=this.points=[];for(let t=0,i=o?3:2;t<r;t+=i){var a={x:e[t],y:e[t+1]};o&&(a.z=e[t+2]),s.push(a)}const h=this.order=s.length-1,c=this.dims=["x","y"];o&&c.push("z"),this.dimlen=c.length;const l=V.align(s,{p1:s[0],p2:s[h]});this._linear=!l.some((t=>Z(t.y)>1e-4)),this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,e,i,n){if(void 0===n&&(n=.5),0===n)return new nt(e,e,i);if(1===n)return new nt(t,e,e);const r=nt.getABC(2,t,e,i,n);return new nt(t,r.A,i)}static cubicFromPoints(t,e,i,n,r){void 0===n&&(n=.5);const o=nt.getABC(3,t,e,i,n);void 0===r&&(r=V.dist(e,o.C));const s=r*(1-n)/n,a=V.dist(t,i),h=(i.x-t.x)/a,c=(i.y-t.y)/a,l=r*h,u=r*c,f=s*h,d=s*c,g=e.x-l,v=e.y-u,p=e.x+f,_=e.y+d,m=o.A,y=m.x+(g-m.x)/(1-n),b=m.y+(v-m.y)/(1-n),w=m.x+(p-m.x)/n,k=m.y+(_-m.y)/n,x={x:t.x+(y-t.x)/n,y:t.y+(b-t.y)/n},T={x:i.x+(w-i.x)/(1-n),y:i.y+(k-i.y)/(1-n)};return new nt(t,x,T,i)}static getUtils(){return V}getUtils(){return nt.getUtils()}static get PolyBezier(){return U}valueOf(){return this.toString()}toString(){return V.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,e=["M",t[0].x,t[0].y,2===this.order?"Q":"C"];for(let i=1,n=t.length;i<n;i++)e.push(t[i].x),e.push(t[i].y);return e.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map((function(t,e){return""+e+t.x+t.y+(t.z?t.z:0)})).join("")}update(){this._lut=[],this.dpoints=V.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,e=V.angle(t[0],t[this.order],t[1]);this.clockwise=e>0}length(){return V.length(this.derivative.bind(this))}static getABC(t=2,e,i,n,r=.5){const o=V.projectionratio(r,t),s=1-o,a={x:o*e.x+s*n.x,y:o*e.y+s*n.y},h=V.abcratio(r,t);return{A:{x:i.x+(i.x-a.x)/h,y:i.y+(i.y-a.y)/h},B:i,C:a,S:e,E:n}}getABC(t,e){e=e||this.get(t);let i=this.points[0],n=this.points[this.order];return nt.getABC(this.order,i,e,n,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t)return this._lut;this._lut=[],t--;for(let e,i,n=0;n<t;n++)i=n/(t-1),e=this.compute(i),e.t=i,this._lut.push(e);return this._lut}on(e,i){i=i||5;const n=this.getLUT(),r=[];for(let t,o=0,s=0;o<n.length;o++)t=n[o],V.dist(t,e)<i&&(r.push(t),s+=o/n.length);return!!r.length&&(t/=r.length)}project(t){const e=this.getLUT(),i=e.length-1,n=V.closest(e,t),r=n.mpos,o=(r-1)/i,s=(r+1)/i,a=.1/i;let h,c,l=n.mdist,u=o,f=u;for(l+=1;u<s+a;u+=a)h=this.compute(u),c=V.dist(t,h),c<l&&(l=c,f=u);return f=f<0?0:f>1?1:f,h=this.compute(f),h.t=f,h.d=l,h}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?V.computeWithRatios(t,this.points,this.ratios,this._3d):V.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,e=[t[0]],i=t.length;for(let n,r,o=1;o<i;o++)n=t[o],r=t[o-1],e[o]={x:(i-o)/i*n.x+o/i*r.x,y:(i-o)/i*n.y+o/i*r.y};return e[i]=t[i-1],new nt(e)}derivative(t){return V.compute(t,this.dpoints[0],this._3d)}dderivative(t){return V.compute(t,this.dpoints[1],this._3d)}align(){let t=this.points;return new nt(V.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return V.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return V.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const e=this.derivative(t),i=et(e.x*e.x+e.y*e.y);return{x:-e.y/i,y:e.x/i}}__normal3(t){const e=this.derivative(t),i=this.derivative(t+.01),n=et(e.x*e.x+e.y*e.y+e.z*e.z),r=et(i.x*i.x+i.y*i.y+i.z*i.z);e.x/=n,e.y/=n,e.z/=n,i.x/=r,i.y/=r,i.z/=r;const o={x:i.y*e.z-i.z*e.y,y:i.z*e.x-i.x*e.z,z:i.x*e.y-i.y*e.x},s=et(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=s,o.y/=s,o.z/=s;const a=[o.x*o.x,o.x*o.y-o.z,o.x*o.z+o.y,o.x*o.y+o.z,o.y*o.y,o.y*o.z-o.x,o.x*o.z-o.y,o.y*o.z+o.x,o.z*o.z];return{x:a[0]*e.x+a[1]*e.y+a[2]*e.z,y:a[3]*e.x+a[4]*e.y+a[5]*e.z,z:a[6]*e.x+a[7]*e.y+a[8]*e.z}}hull(t){let e=this.points,i=[],n=[],r=0;for(n[r++]=e[0],n[r++]=e[1],n[r++]=e[2],3===this.order&&(n[r++]=e[3]);e.length>1;){i=[];for(let o,s=0,a=e.length-1;s<a;s++)o=V.lerp(t,e[s],e[s+1]),n[r++]=o,i.push(o);e=i}return n}split(t,e){if(0===t&&e)return this.split(e).left;if(1===e)return this.split(t).right;const i=this.hull(t),n={left:2===this.order?new nt([i[0],i[3],i[5]]):new nt([i[0],i[4],i[7],i[9]]),right:2===this.order?new nt([i[5],i[4],i[2]]):new nt([i[9],i[8],i[6],i[3]]),span:i};return n.left._t1=V.map(0,0,1,this._t1,this._t2),n.left._t2=V.map(t,0,1,this._t1,this._t2),n.right._t1=V.map(t,0,1,this._t1,this._t2),n.right._t2=V.map(1,0,1,this._t1,this._t2),e?(e=V.map(e,t,1,0,1),n.right.split(e).left):n}extrema(){const t={};let e=[];return this.dims.forEach(function(i){let n=function(t){return t[i]},r=this.dpoints[0].map(n);t[i]=V.droots(r),3===this.order&&(r=this.dpoints[1].map(n),t[i]=t[i].concat(V.droots(r))),t[i]=t[i].filter((function(t){return t>=0&&t<=1})),e=e.concat(t[i].sort(V.numberSort))}.bind(this)),t.values=e.sort(V.numberSort).filter((function(t,i){return e.indexOf(t)===i})),t}bbox(){const t=this.extrema(),e={};return this.dims.forEach(function(i){e[i]=V.getminmax(this,i,t[i])}.bind(this)),e}overlaps(t){const e=this.bbox(),i=t.bbox();return V.bboxoverlap(e,i)}offset(t,e){if(void 0!==e){const i=this.get(t),n=this.normal(t),r={c:i,n:n,x:i.x+n.x*e,y:i.y+n.y*e};return this._3d&&(r.z=i.z+n.z*e),r}if(this._linear){const e=this.normal(0),i=this.points.map((function(i){const n={x:i.x+t*e.x,y:i.y+t*e.y};return i.z&&e.z&&(n.z=i.z+t*e.z),n}));return[new nt(i)]}return this.reduce().map((function(e){return e._linear?e.offset(t)[0]:e.scale(t)}))}simple(){if(3===this.order){const t=V.angle(this.points[0],this.points[3],this.points[1]),e=V.angle(this.points[0],this.points[3],this.points[2]);if(t>0&&e<0||t<0&&e>0)return!1}const t=this.normal(0),e=this.normal(1);let i=t.x*e.x+t.y*e.y;return this._3d&&(i+=t.z*e.z),Z(tt(i))<it/3}reduce(){let t,e,i=0,n=0,r=.01,o=[],s=[],a=this.extrema().values;for(-1===a.indexOf(0)&&(a=[0].concat(a)),-1===a.indexOf(1)&&a.push(1),i=a[0],t=1;t<a.length;t++)n=a[t],e=this.split(i,n),e._t1=i,e._t2=n,o.push(e),i=n;return o.forEach((function(t){for(i=0,n=0;n<=1;)for(n=i+r;n<=1.01;n+=r)if(e=t.split(i,n),!e.simple()){if(n-=r,Z(i-n)<r)return[];e=t.split(i,n),e._t1=V.map(i,0,1,t._t1,t._t2),e._t2=V.map(n,0,1,t._t1,t._t2),s.push(e),i=n;break}i<1&&(e=t.split(i,1),e._t1=V.map(i,0,1,t._t1,t._t2),e._t2=t._t2,s.push(e))})),s}scale(t){const e=this.order;let i=!1;if("function"==typeof t&&(i=t),i&&2===e)return this.raise().scale(i);const n=this.clockwise,r=i?i(0):t,o=i?i(1):t,s=[this.offset(0,10),this.offset(1,10)],a=this.points,h=[],c=V.lli4(s[0],s[0].c,s[1],s[1].c);if(!c)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(t){const i=h[t*e]=V.copy(a[t*e]);i.x+=(t?o:r)*s[t].n.x,i.y+=(t?o:r)*s[t].n.y})),i?([0,1].forEach((function(r){if(2!==e||!r){var o=a[r+1],s={x:o.x-c.x,y:o.y-c.y},l=i?i((r+1)/e):t;i&&!n&&(l=-l);var u=et(s.x*s.x+s.y*s.y);s.x/=u,s.y/=u,h[r+1]={x:o.x+l*s.x,y:o.y+l*s.y}}})),new nt(h)):([0,1].forEach((t=>{if(2===e&&t)return;const i=h[t*e],n=this.derivative(t),r={x:i.x+n.x,y:i.y+n.y};h[t+1]=V.lli4(i,r,c,a[t+1])})),new nt(h))}outline(t,e,i,n){e=void 0===e?t:e;const r=this.reduce(),o=r.length,s=[];let a,h=[],c=0,l=this.length();const u=void 0!==i&&void 0!==n;function f(t,e,i,n,r){return function(o){const s=n/i,a=(n+r)/i,h=e-t;return V.map(o,0,1,t+s*h,t+a*h)}}r.forEach((function(r){const o=r.length();u?(s.push(r.scale(f(t,i,l,c,o))),h.push(r.scale(f(-e,-n,l,c,o)))):(s.push(r.scale(t)),h.push(r.scale(-e))),c+=o})),h=h.map((function(t){return a=t.points,a[3]?t.points=[a[3],a[2],a[1],a[0]]:t.points=[a[2],a[1],a[0]],t})).reverse();const d=s[0].points[0],g=s[o-1].points[s[o-1].points.length-1],v=h[o-1].points[h[o-1].points.length-1],p=h[0].points[0],_=V.makeline(v,d),m=V.makeline(g,p),y=[_].concat(s).concat([m]).concat(h);return y.length,new U(y)}outlineshapes(t,e,i){e=e||t;const n=this.outline(t,e).curves,r=[];for(let t=1,e=n.length;t<e/2;t++){const o=V.makeshape(n[t],n[e-t],i);o.startcap.virtual=t>1,o.endcap.virtual=t<e/2-1,r.push(o)}return r}intersects(t,e){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof nt&&(t=t.reduce()),this.curveintersects(this.reduce(),t,e)):this.selfintersects(e)}lineIntersects(t){const e=K(t.p1.x,t.p2.x),i=K(t.p1.y,t.p2.y),n=J(t.p1.x,t.p2.x),r=J(t.p1.y,t.p2.y);return V.roots(this.points,t).filter((t=>{var o=this.get(t);return V.between(o.x,e,n)&&V.between(o.y,i,r)}))}selfintersects(t){const e=this.reduce(),i=e.length-2,n=[];for(let r,o,s,a=0;a<i;a++)o=e.slice(a,a+1),s=e.slice(a+2),r=this.curveintersects(o,s,t),n.push(...r);return n}curveintersects(t,e,i){const n=[];t.forEach((function(t){e.forEach((function(e){t.overlaps(e)&&n.push({left:t,right:e})}))}));let r=[];return n.forEach((function(t){const e=V.pairiteration(t.left,t.right,i);e.length>0&&(r=r.concat(e))})),r}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,e,i,n){const r=(n-i)/4,o=this.get(i+r),s=this.get(n-r),a=V.dist(t,e),h=V.dist(t,o),c=V.dist(t,s);return Z(h-a)+Z(c-a)}_iterate(t,e){let i,n=0,r=1;do{i=0,r=1;let o,s,a,h,c,l=this.get(n),u=!1,f=!1,d=r,g=1;do{if(f=u,h=a,d=(n+r)/2,o=this.get(d),s=this.get(r),a=V.getccenter(l,o,s),a.interval={start:n,end:r},u=this._error(a,l,n,r)<=t,c=f&&!u,c||(g=r),u){if(r>=1){if(a.interval.end=g=1,h=a,r>1){let t={x:a.x+a.r*$(a.e),y:a.y+a.r*Q(a.e)};a.e+=V.angle({x:a.x,y:a.y},t,this.get(1))}break}r+=(r-n)/2}else r=d}while(!c&&i++<100);if(i>=100)break;h=h||a,e.push(h),n=g}while(r<1);return e}}var rt={RIGHT:0,BOTTOM:1,LEFT:2,TOP:3,SELF:100},ot={DEFAULT:"DEFAULT",LINKING:"LINKING"};function st(t){if(0===t.length)return{width:1,height:1,x:0,y:0};var e=1/0,i=1/0,n=-1/0,r=-1/0;for(var o in t){var s=t[o];s[0]<e&&(e=s[0]),s[0]>n&&(n=s[0]),s[1]<i&&(i=s[1]),s[1]>r&&(r=s[1])}return{width:Math.max(n-e,10),height:Math.max(r-i,10),x:e,y:i}}function at(t){return t*t}function ht(t,e){return at(t[0]-e[0])+at(t[1]-e[1])}function ct(t,e,i){var n=ht(e,i);if(0===n)return ht(t,e);var r=((t[0]-e[0])*(i[0]-e[0])+(t[1]-e[1])*(i[1]-e[1]))/n;return r=Math.max(0,Math.min(1,r)),ht(t,[e[0]+r*(i[0]-e[0]),e[1]+r*(i[1]-e[1])])}function lt(t,e){var i={fromDir:null,fromP:null,toDir:null,toP:null,distMin:1/0};return Object.keys(t).forEach((function(n){if(+n!==rt.SELF){var r=t[n];Object.keys(e).forEach((function(t){if(+t!==rt.SELF){var o=e[t],s=ht(r,o);s<i.distMin&&Object.assign(i,{distMin:s,fromDir:+n,fromP:r,toDir:+t,toP:o})}}))}})),i}function ut(t,e,i,n){return e===rt.TOP?[t[0],t[1]-n]:e===rt.BOTTOM?[t[0],t[1]+n]:e===rt.LEFT?[t[0]-i,t[1]]:e===rt.RIGHT?[t[0]+i,t[1]]:void 0}function ft(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:rt.TOP,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:rt.TOP,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=Math.max(Math.abs((t[0]-e[0])/2),r),a=Math.max(Math.abs((t[1]-e[1])/2),o),h=ut(t,i,s,a),c=ut(e,n,s,a),l=[rt.TOP,rt.LEFT].includes(n)?-5:5,u=[rt.TOP,rt.BOTTOM].includes(n),f=u?e[0]:e[0]+l,d=u?e[1]+l:e[1];return[].concat(b(h),b(c),[f,d])}function dt(t,e,i,n,r,o,s,a,h){var c=Math.pow(1-t,2)*(n-e)+2*t*(1-t)*(o-n)+t*t*(a-o),l=Math.pow(1-t,2)*(r-i)+2*t*(1-t)*(s-r)+t*t*(h-s);return-Math.atan2(c,l)+.5*Math.PI}function gt(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:rt.TOP,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:rt.TOP,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:10,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:10,a=arguments.length>7?arguments[7]:void 0,h=Math.abs(n-r),c=n===rt.TOP||n===rt.BOTTOM;switch(t.length=0,h){case 0:if(n===rt.TOP){var l=Math.min(e[1],i[1]),u=l-s;t.push([e[0],u]),t.push([i[0],u])}if(n===rt.BOTTOM){var f=Math.max(e[1],i[1]),d=f+s;t.push([e[0],d]),t.push([i[0],d])}if(n===rt.LEFT){var g=Math.min(e[0],i[0]),v=g-o;t.push([v,e[1]]),t.push([v,i[1]])}if(n===rt.RIGHT){var p=Math.max(e[0],i[0]),_=p+o;t.push([_,e[1]]),t.push([_,i[1]])}break;case 1:case 3:if(a)c?(t.push([e[0],e[1]+s]),t.push([i[0]+o,e[1]+s]),t.push([i[0]+o,i[1]])):(t.push([e[0]+o,e[1]]),t.push([e[0]+o,i[1]+s]),t.push([i[0],i[1]+s]));else{var m=c?[e[0],i[1]]:[i[0],e[1]];t.push(m)}break;case 2:var y=[(e[0]-i[0])/2+i[0],(e[1]-i[1])/2+i[1]];c?(t.push([e[0],y[1]]),t.push([i[0],y[1]])):(t.push([y[0],e[1]]),t.push([y[0],i[1]]))}t.unshift(e),t.push(i)}function vt(t,e){return[t[0]-e[0],t[1]-e[1]]}function pt(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function _t(t,e){return[t[0]*e,t[1]*e]}function mt(t,e){return t[0]!=t[2]&&t[1]!=t[3]&&e[0]!=e[2]&&e[1]!=e[3]&&!(t[2]<=e[0]||t[3]<=e[1]||t[0]>=e[2]||t[1]>=e[3])}function yt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function bt(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]}var wt=Symbol("ishit"),kt=Symbol("isInViewBox"),xt=function(t){h(i,t);var e=p(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,i),t=e.call(this),Object.assign(g(t),n),t.visible=!0,t._belongs=void 0,t[wt]=!1,t.borderWidth=n.borderWidth||0,t.borderColor=n.borderColor||"transparent",t.backgroundColor=n.backgroundColor||"transparent",t.shadowColor=n.shadowColor,t.shadowBlur=n.shadowBlur||5,t.shadowOffsetX=n.shadowOffsetX||0,t.shadowOffsetY=n.shadowOffsetY||0,t.opacity=n.opacity||1,t._boundingrect=[0,0,0,0],t}return s(i,[{key:"_isTargeting",get:function(){return this===(this._jflow._target.instance||this._jflow._target.link)}},{key:"_isMoving",get:function(){return this===this._jflow._getMovingTarget()&&this._jflow._target.status.movingState}},{key:"_isHit",get:function(){return this[wt]},set:function(t){this[wt]!==t&&this.dispatchEvent(new CustomEvent(t?"mouseenter":"mouseleave",{detail:{instance:this,jflow:this._jflow}})),this[wt]=t}},{key:"_jflow",get:function(){return"jflow"===this._belongs.uniqueName?this._belongs:this._belongs._jflow}},{key:"isInViewBox",get:function(){return this[kt]}},{key:"_isInViewBox",set:function(t){t!==this[kt]&&(t?this.onEnterViewbox():this.onLeaveViewbox()),this[kt]=t}},{key:"onEnterViewbox",value:function(){}},{key:"onLeaveViewbox",value:function(){}},{key:"setConfig",value:function(t){var e=this;Object.keys(t).forEach((function(i){void 0!==t[i]&&null!==t[i]&&(e[i]=t[i])}))}},{key:"render",value:function(t){throw"require render implement"}},{key:"isHit",value:function(t){throw"require isHit implement"}},{key:"getBoundingRect",value:function(){throw"require getBoundingRect implement"}},{key:"calculateIntersection",value:function(){throw"require calculateIntersection implement"}},{key:"getIntersectionsInFourDimension",value:function(){throw"require getIntersectionsInFourDimension implement"}},{key:"getCenter",value:function(){return this.anchor}},{key:"getBoundingDimension",value:function(){var t=instance.getBoundingRect(),e=1/0,i=-1/0,n=1/0,r=-1/0;return t.forEach((function(t){i=Math.max(i,t[1]),e=Math.min(e,t[1]),r=Math.max(r,t[0]),n=Math.min(n,t[0])})),{height:i-e,width:r-n}}},{key:"bubbleEvent",value:function(t){t.detail.currentTarget=this,this.dispatchEvent(t),t.detail.bubbles&&(this._belongs.bubbleEvent?this._belongs.bubbleEvent(t):this._belongs.dispatchEvent(t))}},{key:"calculateToRealWorld",value:function(t){return this._belongs&&this._belongs.calculateToRealWorld?this._belongs.calculateToRealWorld(t):t}},{key:"calculateToRealWorldWithScalar",value:function(t){return this._jflow.scale*t}},{key:"recalculateUp",value:function(){this.belongs&&this.belongs.recalculateUp()}},{key:"destroy",value:function(){}}]),i}(d(EventTarget)),Tt=function(t){h(i,t);var e=p(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,i),(t=e.call(this,n))._rawConfigs=n,t.anchor=n.anchor||[0,0],t.absolutePosition=n.absolutePosition,t}return s(i,[{key:"setConfig",value:function(t){var e=this;Object.keys(t).forEach((function(i){void 0!==t[i]&&null!==t[i]&&(e[i]=t[i],e._rawConfigs[i]=t[i])}))}},{key:"setAnchorX",value:function(t){this.anchor[0]=t}},{key:"setAnchorY",value:function(t){this.anchor[1]=t}},{key:"setAnchor",value:function(t,e){this.anchor[0]=t,this.anchor[1]=e}},{key:"beforeRender",value:function(){return mt(this._belongs._getViewBox(),this.getBoundingRect())}},{key:"clone",value:function(){var t=new(0,this.constructor)(this._rawConfigs);return t.visible=this.visible,t}}]),i}(xt),St=function(t){h(i,t);var e=p(i);function i(t){return r(this,i),e.call(this,t)}return s(i,[{key:"render",value:function(t){}},{key:"isHit",value:function(t){return!1}},{key:"calculateIntersection",value:function(t){return this.anchor}},{key:"getBoundingRect",value:function(){var t=y(this.anchor,2),e=t[0],i=t[1];return[e,i,e,i]}},{key:"getBoundingDimension",value:function(){return{width:0,height:0}}},{key:"getIntersectionsInFourDimension",value:function(){var t,e=y(this.anchor,2),i=e[0],n=e[1];return a(t={},rt.RIGHT,[i+1,n]),a(t,rt.LEFT,[i-1,n]),a(t,rt.BOTTOM,[i,n+1]),a(t,rt.TOP,[i,n-1]),t}}]),i}(Tt);var Et=function(){function t(){r(this,t),this._map=new WeakMap}return s(t,[{key:"get",value:function(t){return this._map.get(t)}},{key:"set",value:function(t){var e={layoutNode:void 0,jflowNode:void 0,jflowlinks:[],jflowFromLinks:[],jflowToLinks:[]};return this._map.set(t,e),e}},{key:"has",value:function(t){return this._map.has(t)}},{key:"delete",value:function(t){this._map.delete(t)}},{key:"clear",value:function(){this._map.clear()}}]),t}(),Ct={initNodeWeakMap:function(){this.source_Layout_Render_NodeMap=new Et},getRenderNodeBySource:function(t){var e=this.source_Layout_Render_NodeMap.get(t);if(e)return e.jflowNode},getLayoutNodeBySource:function(t){var e=this.source_Layout_Render_NodeMap.get(t);if(e)return e.layoutNode},getSourceRenderMeta:function(t){return this.source_Layout_Render_NodeMap.get(t)},_getMap:function(t){var e=this.source_Layout_Render_NodeMap;return e.has(t)?e.get(t):e.set(t)},setLayoutNodeBySource:function(t,e){this._getMap(t).layoutNode=e},setRenderNodeBySource:function(t,e){this._getMap(t).jflowNode=e},addLinkNodeBySource:function(t,e,i){var n=this._getMap(t);n.jflowFromLinks.push(i),(n=this._getMap(e)).jflowToLinks.push(i)},removeLinkNodeBySource:function(t,e,i){var n=this._getMap(t),r=n.jflowFromLinks.findIndex((function(t){return t===i}));-1!==r&&n.jflowFromLinks.splice(r,1),-1!==(r=(n=this._getMap(e)).jflowToLinks.findIndex((function(t){return t===i})))&&n.jflowToLinks.splice(r,1)}},Ot=function(t){h(i,t);var e=p(i);function i(){var t;return r(this,i),(t=e.call(this))._currentHit=null,t}return s(i,[{key:"render",value:function(t,e){var i;this.forEach((function(n){if(n._isMoving)i=n;else if(n.visible&&(!e||e(n))){if(n.beforeRender&&!n.beforeRender(t))return;t.save(),n.render(t),t.restore()}})),i&&(t.save(),i.render(t),t.restore())}},{key:"resetHitStatus",value:function(){this._currentHit=null,this.forEach((function(t){t._stack&&t._stack.resetHitStatus(),t._isHit=!1}))}},{key:"checkHit",value:function(t,e,i){for(var n=this.length-1;n>=0;){var r=this[n];if(r.visible&&!r.ignoreHit){if(e&&e(r)){n--;continue}if(i&&!i(r)){n--;continue}var o=r.isHit(t,e);if(o)return this._currentHit!==r&&(this._currentHit&&(this._currentHit._isHit=!1),r._isHit=!0,this._currentHit=r),"boolean"!=typeof o?o:r;r._isHit=!1}n--}return this._currentHit=null,null}},{key:"getBoundingRectPoints",value:function(){var t=[];return this.forEach((function(e){if(e.visible&&!e.absolutePosition){var i=e.getBoundingRect();t.push([i[0],i[1]]),t.push([i[2],i[3]])}})),t}},{key:"getAnchorRectPoints",value:function(){var t=[];return this.forEach((function(e){e.visible&&!e.absolutePosition&&t.push(e.anchor)})),t}}]),i}(d(Array)),Pt={instances:[],links:[],_stack:null,_linkStack:null,initStack:function(t){var e=this,i=t.data;this._stack=new Ot,this._linkStack=new Ot,i&&(this.instances=i.instances,this.links=i.links,this.instances.forEach((function(t){e._stack.push(t),t._belongs=e})),this.links.forEach((function(t){e._linkStack.push(t),t._belongs=e})))},addToStack:function(t){t._belongs=this,this._stack.push(t)},replaceFromStack:function(t,e){var i=this._stack.findIndex((function(e){return e===t}));this._stack.splice(i,1,e),t._belongs=null,e._belongs=this},addToLinkStack:function(t){t._belongs=this,this._linkStack.push(t)},removeFromStack:function(t){var e=this._stack.findIndex((function(e){return e===t}));-1!==e&&this._stack.splice(e,1)},removeFromLinkStack:function(t){var e=this._linkStack.findIndex((function(e){return e===t}));-1!==e&&this._linkStack.splice(e,1)},emptyLink:function(){this._linkStack=new Ot},resetChildrenPosition:function(){this._stack.forEach((function(t){t.anchor=[0,0]}))},addInstanceToLink:function(t,e){this.addToStack(e);var i=t.from,n=t.to,r=this._linkStack.findIndex((function(e){return e===t})),o=t.__proto__.constructor,s=new o({from:i,to:e});s._belongs=this;var a=new o({from:e,to:n});a._belongs=this,this._linkStack.splice(r,1,s,a)},interateNodeStack:function(t){this._stack.forEach((function(e){t(e)}))}},Bt={_layout:null,initLayout:function(t){this._layout=t.layout},recalculateUp:function(){var t=!0;if(this.getBoundingDimension){var e=this.getBoundingDimension(),i=e.width,n=e.height;this.resetChildrenPosition&&this.resetChildrenPosition(),this._getBoundingGroupRect&&this._getBoundingGroupRect(),this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect();var r=this.getBoundingDimension(),o=r.width,s=r.height;t=i!==o||n!==s}else this.reflow();this._belongs&&t&&this._belongs.recalculateUp()},recalculate:function(){this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect()},staticCheck:function(t){return!!this._layout&&this._layout.staticCheck(t,this)},reflow:function(){this._layout&&this._layout.reflow(this)}},Mt={initAnime:function(){this.anime_queue=[],this.__animeClock__=void 0},requestJFlowAnime:function(t){var e=this.enqueueAnime(t);return this._runAnime(),e},enqueueAnime:function(t){var e=this,i={start:void 0,callback:t,cancel:function(){e._cancelAnime(i),e._render()}};return this.anime_queue.push(i),i},_cancelAnime:function(t){var e=this.anime_queue.findIndex((function(e){return e===t}));~e&&this.anime_queue.splice(e,1)},runAnime:function(){this._runAnime()},_runAnime:function(){var t=this;this.anime_queue.length&&requestAnimationFrame((function(){t.scheduleRender(),t._runAnime()}))},runAnimeFrame:function(){this.anime_queue.forEach((function(t){var e=Date.now();t.start||(t.start=e);var i=e-t.start;t.callback(i)}))}},Rt={captureMap:function(t,e){var i=this,n=e.padding,r=void 0===n?0:n,o=e.placement,s=void 0===o?"normal":o;this._getBoundingGroupRect();var a=this.bounding_box,h=a.width,c=a.height,l=a.x,u=a.y;if(!this.miniMap){this.miniMap=C(t);var f=this.miniMap,d=f.width,g=f.height,v=f.raw_width,p=f.raw_height;this.addEventListener("zoompan",(function(){i._renderMap&&i._renderMap()}));var _=!1;this.miniMap.canvas.addEventListener("pointerdown",(function(t){var e=t.offsetX,n=t.offsetY;t.deltaX,t.deltaY,_=!0,i._onMoveMap&&i._onMoveMap(e,n)})),this.miniMap.canvas.addEventListener("pointermove",(function(t){var e=t.offsetX,n=t.offsetY;t.deltaX,t.deltaY,_&&i._onMoveMap&&i._onMoveMap(e,n),(n<5||e<5||e>d-5||n>g-5)&&(_=!1)})),this.miniMap.canvas.addEventListener("pointerup",(function(){_=!1}));var m=document.createElement("canvas");m.width=v,m.height=p,this.cacheMinimapCtx=m.getContext("2d")}var b=this.miniMap,w=b.width,k=b.height,x=b.raw_width,T=b.raw_height;b.left,b.top;var S=b.scale,E=b.ctx,O=2*r,P=r,B=(w-O)/h,M=(k-O)/c,R=Math.min(B,M),I=0,L=0;"center"===s?(L=(k-c*R)/2-u*R,I=(w-h*R)/2-l*R):B<M?(L=(k-c*R)/2-u*R,I=P):(I=(w-h*R)/2-l*R,L=P);var D=this.cacheMinimapCtx;D.setTransform(),D.clearRect(0,0,x,T),D.scale(S,S),D.transform(R,0,0,R,I,L);var j=[0,0,0,0];this.NodeRenderTop?(this._linkStack.render(D,(function(t){return t.isInViewBox(j),!0})),this._stack.render(D)):(this._stack.render(D),this._linkStack.render(D,(function(t){return t.isInViewBox(j),!0})));var A=D.getImageData(0,0,x,T);this._renderMap=function(){E.save(),E.setTransform(),E.clearRect(0,0,x,T),E.scale(S,S),E.putImageData(A,0,0),E.transform(R,0,0,R,I,L);var t=y(i._getViewBox(),4),e=t[0],n=t[1],r=t[2],o=t[3];E.beginPath(),E.rect(e,n,r-e,o-n),E.setTransform(),E.rect(0,0,x,T),E.clip("evenodd"),E.fillStyle="rgba(0,0,0,0.4)",E.fillRect(0,0,x,T),E.restore()},this._renderMap(),this._onMoveMap=function(t,e){var n=y(i._getViewBox(),4),r=n[0],o=n[1],s=n[2],a=n[3],h=[((s-r)/2+r)*R+I,((a-o)/2+o)*R+L];i._recalculatePosition((h[0]-t)/R*i.scale,(h[1]-e)/R*i.scale),i._render(),i._renderMap()}}},It=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t),this.anchor=[0,0],this.width=i.barWidth||4,this.height=i.barWidth||4,this.barMarginX=0,this.barMarginY=0,this.dir=e,this.plainColor=i.plainColor||"rgba(0, 0, 0, 0.15)",this.focusColor=i.focusColor||"rgba(0, 0, 0, 0.25)",this.isFocus=!1}return s(t,[{key:"render",value:function(t){var e=y(this.anchor,2),i=e[0],n=e[1];if(t.save(),t.beginPath(),"x"===this.dir){var r=this.height/2,o=n+r,s=n+this.height,a=i+this.width-2*this.barMarginX-r,h=i+this.barMarginX+r;t.moveTo(h,s),t.arc(h,o,r,Math.PI/2,Math.PI/2*3),t.lineTo(a,n),t.arc(a,o,r,-Math.PI/2,Math.PI/2),t.closePath()}else{var c=this.width/2,l=n+this.barMarginY+c,u=n+this.height-2*this.barMarginY-c,f=i+c,d=i+this.width;t.moveTo(i,l),t.arc(f,l,c,-Math.PI,0),t.lineTo(d,u),t.arc(f,u,c,0,Math.PI),t.closePath()}t.fillStyle=this.isFocus?this.focusColor:this.plainColor,t.fill(),t.restore()}},{key:"isHit",value:function(t){var e=this.anchor,i=this.width,n=this.height;return t[0]>e[0]-5&&t[0]<e[0]+i+5&&t[1]>e[1]-5&&t[1]<e[1]+n+5}}]),t}(),Lt={initScrollBar:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.barColor,n=e.barFocusColor,r=e.barMarginX,o=e.barMarginY,s=e.barWidth;this._scrollbarEnable=!0,this._scrollbarX=new It("x",{plainColor:i,focusColor:n,barWidth:s}),this._scrollbarX.barMarginX=r||5,this._scrollbarY=new It("y",{plainColor:i,focusColor:n,barWidth:s}),this._scrollbarY.barMarginY=o||5,this._scrollBarStatus={dragging:!1,target:null,xscale:void 0,yscale:void 0,barInitX:0,barInitY:0},this.addEventListener("zoompan",(function(){t.scrollBarOnPanAndZoom()})),this.scrollBarOnPanAndZoom(),this.canvas.addEventListener("pointerdown",(function(e){var i=e.offsetX,n=e.offsetY,r=e.clientX,o=e.clientY;t.onScrollbarPressStart(i,n,r,o)}))},checkScrollDragging:function(){return this._scrollBarStatus&&this._scrollBarStatus.dragging},onScrollbarPressStart:function(t,e,i,n){var r=this;this._scrollbarX.isHit([t,e])&&Object.assign(this._scrollBarStatus,{dragging:!0,target:this._scrollbarX,barStartX:this._scrollbarX.anchor[0],barInitX:i}),this._scrollbarY.isHit([t,e])&&Object.assign(this._scrollBarStatus,{dragging:!0,target:this._scrollbarY,barStartY:this._scrollbarY.anchor[1],barInitY:n});var o=function(t){var e=t.offsetX,i=t.offsetY,n=t.clientX,o=t.clientY;r.onDraggingScrollbar(e,i,n,o)}.bind(this);document.addEventListener("pointermove",o);var s=function(t){Object.assign(r._scrollBarStatus,{dragging:!1,target:null,x:void 0,y:void 0}),document.removeEventListener("pointermove",o),document.removeEventListener("pointerup",s),r.canvas.removeEventListener("pointerup",s)}.bind(this);this.canvas.addEventListener("pointerup",s,{once:!0}),document.addEventListener("pointerup",s,{once:!0})},onDraggingScrollbar:function(t,e,i,n){if(this._scrollbarEnable&&this._scrollBarStatus.dragging){var r=this._scrollBarStatus,o=r.target,s=r.barInitX,a=r.barStartX,h=r.barInitY,c=r.barStartY;r.xscale,r.yscale;var l=r.scollbarHeight,u=r.scollbarWidth,f=r.realR,d=r.realL,g=r.realT,v=r.realB,p=this.canvasMeta,_=p.actual_width,m=p.actual_height,y=this.bounding_box,b=y.x,w=y.y;if("x"===o.dir){var k=a+(i-s),x=(b-((f-d)*((o.anchor[0]=Math.max(Math.min(k,_-u),0))/_)+d))*this.scale;Object.assign(this.position,{offsetX:x-b*this.scale,x:x})}if("y"===o.dir){var T=c+(n-h),S=(w-((v-g)*((o.anchor[1]=Math.max(Math.min(T,m-l),0))/m)+g))*this.scale;Object.assign(this.position,{offsetY:S-w*this.scale,y:S})}return this.scheduleRender(),!0}return!1},checkScrollBarHover:function(t,e){if(this._scrollbarEnable){if(this._scrollbarX.isHit([t,e]))return this._scrollbarX.isFocus||(this._scrollbarX.isFocus=!0,this.scheduleRender()),this.canvas.style.cursor="default",!0;if(this._scrollbarY.isHit([t,e]))return this._scrollbarY.isFocus||(this._scrollbarY.isFocus=!0,this.scheduleRender()),this.canvas.style.cursor="default",!0}return!1},resetScrollBarHover:function(){this._scrollbarEnable&&(this._scrollbarY.isFocus||this._scrollbarX.isFocus)&&(this._scrollbarY.isFocus=!1,this._scrollbarX.isFocus=!1,this.scheduleRender())},_getScrollViewBoundingbox:function(){var t=this.bounding_box;return{width:t.width+240,height:t.height+240,x:t.x-120,y:t.y-120}},scrollBarOnPanAndZoom:function(){if(this._scrollbarEnable&&!this._scrollBarStatus.dragging){var t=this._getScrollViewBoundingbox(),e=t.width,i=t.height,n=t.x,r=t.y,o=y(this._getViewBox(),4),s=o[0],a=o[1],h=o[2],c=o[3],l=Math.max(h,n+e),u=Math.min(s,n),f=Math.min(a,r),d=Math.max(c,r+i),g=h-s,v=c-a,p=this.canvasMeta,_=p.actual_width,m=p.actual_height,b=g/(l-u);if(b<1){var w=_*b,k=(s-u)*b*this.scale;this._scrollbarX.anchor=[k,m-10],this._scrollbarX.width=w,this._scrollBarStatus.scollbarWidth=w}var x=v/(d-f);if(x<1){var T=m*x,S=(a-f)*x*this.scale;this._scrollbarY.anchor=[_-10,S],this._scrollbarY.height=T,this._scrollBarStatus.scollbarHeight=T}Object.assign(this._scrollBarStatus,{yscale:x,xscale:b,realR:l,realL:u,realT:f,realB:d})}},resetScollBarStatus:function(){this._scrollbarEnable&&Object.assign(this._scrollBarStatus,{dragging:!1,target:null,x:void 0,y:void 0})},renderScrollBar:function(t){if(this._scrollbarEnable){t.setTransform(),t.scale(this.dpr,this.dpr);var e=this._scrollBarStatus,i=e.xscale,n=e.yscale;i<1&&this._scrollbarX.render(t),n<1&&this._scrollbarY.render(t)}}},Dt={initSchedule:function(){this.__clock__=void 0},scheduleRender:function(t){var e=this;requestAnimationFrame((function(i){e.__clock__!==i&&e.__render(),t&&t(i),e.__clock__=i}))}},jt=function(t){h(i,t);var e=p(i);function i(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,i);var s=n(n({},o),{},{originEvent:o.event,target:o.target,jflow:o.jflow,bubbles:o.bubbles||!1});return e.call(this,t,{detail:s})}return s(i)}(d(CustomEvent));function At(){var t={pointerDown:!1,dirty:!1};return{canvas:{wheel:function(t,e){t.preventDefault();var i=t.offsetX,n=t.offsetY,r=t.deltaX,o=t.deltaY;t.ctrlKey?(o=-o,e.zoomHandler(i,n,r,o,t)):e.panHandler(-r,-o,t)},pointerdown:function(e,i){var n=e.offsetX,r=e.offsetY;e.deltaY,0===e.button&&(t.pointerDown=!0,i.pressStartHandler(n,r,e))},pointermove:function(e,i){var n=e.offsetX,r=e.offsetY;t.pointerDown&&(t.dirty=!0),i.pressMoveHandler(n,r,e)},pointerup:function(e,i){e.preventDefault(),e.offsetX,e.offsetY,0===e.button&&t.pointerDown&&t.dirty&&(t.pointerDown=!1,t.dirty=!1,i.pressUpHanlder(!1,e))},contextmenu:function(t,e){t.preventDefault(),t.stopPropagation();var i=t.offsetX,n=t.offsetY;e.contextMenuHanlder(i,n,t)},dblclick:function(t,e){t.preventDefault(),t.stopPropagation();var i=t.offsetX,n=t.offsetY;e.dblclickHandler(i,n,t)},click:function(e,i){e.preventDefault(),e.stopPropagation();var n=e.offsetX,r=e.offsetY;t.dirty||(t.pointerDown=!1,t.dirty=!1,i.clickHanlder(n,r,e))}},document:{pointerup:function(t,e){e.pressUpHanlder(!0,t)}}}}var Wt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,t),this.plugin=At(),this.use(e),this.canvasHandlers=[],this.documentHandlers=[]}return s(t,[{key:"use",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.canvas,i=t.document;if(e)for(var n in e)e.hasOwnProperty(n)&&(this.plugin.canvas[n]=e[n]);if(i)for(var r in i)i.hasOwnProperty(r)&&(this.plugin.document[r]=i[r])}},{key:"apply",value:function(t){var e=this,i=this.plugin,n=i.canvas,r=i.document,o=t.canvas,s=function(){var i=n[a];function r(e){i(e,t)}o.addEventListener(a,r),e.canvasHandlers.push({eventName:a,handlerWrapperd:r})};for(var a in n)s();var h=function(){var i,n={};function o(e){i(e,t)}"function"==typeof r[c]?i=r[c]:(i=r[c].handler,Object.assign(n,r[c].options)),document.addEventListener(c,o,n),e.documentHandlers.push({eventName:c,handlerWrapperd:o,options:n})};for(var c in r)h()}},{key:"unload",value:function(t){var e=t.canvas;this.canvasHandlers.forEach((function(t){var i=t.eventName,n=t.handlerWrapperd;e.removeEventListener(i,n)})),this.documentHandlers.forEach((function(t){var e=t.eventName,i=t.handlerWrapperd,n=t.options;console.log("unload",e),document.removeEventListener(e,i,n)}))}}]),t}(),Ht=n(n(n({},Pt),Bt),{},{_setPadding:function(t){this.padding={top:t.paddingTop||t.padding||0,right:t.paddingRight||t.padding||0,bottom:t.paddingBottom||t.padding||0,left:t.paddingLeft||t.padding||0}},_setMargin:function(t){this.margin={top:t.marginTop||t.margin||0,right:t.marginRight||t.margin||0,bottom:t.marginBottom||t.margin||0,left:t.marginLeft||t.margin||0}},_getCenter:function(){var t=this.anchor,e=this.padding,i=this.margin,n=(i.left-i.right)/2,r=(i.top-i.bottom)/2,o=(e.left-e.right)/2+n,s=(e.top-e.bottom)/2+r;return this._shape.anchor=[t[0]+n,t[1]+r],[t[0]+o,t[1]+s]},setAnchorX:function(t){this.anchor[0]=t,this._getCenter()},setAnchorY:function(t){this.anchor[1]=t,this._getCenter()},setAnchor:function(t,e){this.anchor[0]=t,this.anchor[1]=e,this._getCenter()},_calculatePointBack:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this._getCenter(),2);return[i-r[0],n-r[1]]},_calculatePointBackWithPoint:function(t,e,i,n,r){var o=this.anchor,s=this.padding,a=this.margin;i[n]=t-(o[0]+(s.left-s.right)/2+(a.left-a.right)/2),i[r]=e-(o[1]+(s.top-s.bottom)/2+(a.top-a.bottom)/2)},calculateToCoordination:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this._getCenter(),2),o=[i+r[0],n+r[1]];return this._belongs&&this._belongs.calculateToCoordination?this._belongs.calculateToCoordination(o):o},calculateToRealWorld:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this._getCenter(),2),o=[i+r[0],n+r[1]];if(this._belongs&&this._belongs.calculateToRealWorld)return this._belongs.calculateToRealWorld(o)},clone:function(){var t=new(0,this.constructor)(Object.assign({},this._rawConfigs,{layout:this._layout&&this._layout.clone()}));return this.interateNodeStack((function(e){t.addToStack(e.clone())})),t.recalculate(),t.visible=this.visible,t},getBoundingDimension:function(){return{width:this.width,height:this.height}},getBoundingRect:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a},getIntersectionsInFourDimension:function(){var t,e=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(e=this._belongs.calculateToCoordination(e));var i=y(e,2),n=i[0],r=i[1],o=this.width/2,s=this.height/2;return a(t={},rt.RIGHT,[n+o,r]),a(t,rt.LEFT,[n-o,r]),a(t,rt.BOTTOM,[n,r+s]),a(t,rt.TOP,[n,r-s]),a(t,rt.SELF,[n+.618*o,r+.618*s]),t},calculateIntersection:function(t){var e,i,n=y(t,2),r=n[0],o=n[1],s=y(this.anchor,2),a=s[0],h=s[1],c=this.width/2,l=this.height/2,u=a-r,f=h-o,d=l/c,g=Math.abs(f/u),v=r>a,p=o>h;return g<d?(e=a+(v?c:-c),i=c*(p?g:-g)+h):(i=h+(p?l:-l),e=l/(v?g:-g)+a),[e,i]},onEnterViewbox:function(){this.interateNodeStack((function(t){t.onEnterViewbox()}))},onLeaveViewbox:function(){this.interateNodeStack((function(t){t.onLeaveViewbox()}))},destroy:function(){this._shape.destroy(),this.interateNodeStack((function(t){t.destroy()}))}});function zt(t,e){return[t,e]}function Xt(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i="function"==typeof e.shapeShift?e.shapeShift:zt,n=function(e){h(n,e);var i=p(n);function n(e){var o,s,a;return r(this,n),(a=i.call(this,e)).initStack(e),a.initLayout(e),a._shape=new t(e),a._shape.anchor=[0,0],a._shape._belongs=g(a),a._setPadding(e),a._setMargin(e),a.definedWidth=e.width,a.minWidth=e.minWidth,a.definedHeight=e.height,a.lock=null===(o=e.lock)||void 0===o||o,a.display=e.display||"default",a.transparent=null!==(s=e.transparent)&&void 0!==s&&s,a._getBoundingGroupRect(),a.reflow(),a._getBoundingGroupRect(),a._cacheViewBox=[],a}return s(n)}(Tt);return Object.assign(n.prototype,Ht),Object.assign(n.prototype,{reflow:function(){Ht.reflow.call(this);var t=this.margin,e=y(i(this.width-t.left-t.right,this.height-t.top-t.bottom,this._shape),2),n=e[0],r=e[1];this._shape.width=n,this._shape.height=r},setConfig:function(t){this._shape.setConfig(t),this._setPadding(t),this._setMargin(t),"opacity"in t&&(this.opacity=t.opacity),t.layout&&this._layout!==t.layout&&(this._layout=t.layout)},_getBoundingGroupRect:function(){var t=st(this._stack.getBoundingRectPoints()),e=this.padding,n=this.minWidth,r=this.definedWidth,o=t.width+e.left+e.right,s=t.height+e.top+e.bottom,a=n?Math.max(n,o):r||o,h=this.definedHeight||s;this._paddingWidth=a,this._paddingHeight=h;var c=y(i(a,h,this._shape),2),l=c[0],u=c[1];this._shape.width=l,this._shape.height=u;var f=this.margin;this.width=l+f.left+f.right,this.height=u+f.top+f.bottom},_getViewBox:function(){var t=this._belongs.getCacheViewBox(),e=this._cacheViewBox;return this._calculatePointBackWithPoint(t[0],t[1],e,0,1),this._calculatePointBackWithPoint(t[2],t[3],e,2,3),this._cacheViewBox},getCacheViewBox:function(){return this._cacheViewBox},render:function(t){t.save(),this._isMoving?t.globalAlpha=.6:1!==this.opacity&&(t.globalAlpha=this.opacity);var e=y(this._getCenter(),2),i=e[0],n=e[1];this._shape.render(t),t.translate(i,n),this._stack.render(t),t.translate(-i,-n),t.restore()},isHit:function(t,e){var i=this._calculatePointBack(t);this._currentp=i;var n=this._stack.checkHit(i,e);return n||!this.transparent&&this._shape.isHit(t)}}),n}var Yt=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).type="Point",n.radius=t.radius||10,n._doCache(),n}return s(i,[{key:"setConfig",value:function(t){var e=this;Object.keys(t).forEach((function(i){void 0!==t[i]&&null!==t[i]&&(e[i]=t[i],e._rawConfigs[i]=t[i])})),this._doCache()}},{key:"_doCache",value:function(){this.width=2*this.radius,this.height=2*this.radius}},{key:"render",value:function(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath(),t.arc(this.anchor[0],this.anchor[1],this.radius,0,2*Math.PI),t.fillStyle=this.backgroundColor,t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}},{key:"isHit",value:function(t){var e=this.anchor;return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)<this.radius*this.radius}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.radius,i=t[0]-e,n=t[1]-e,r=t[0]+e,o=t[1]+e,s=this._boundingrect;return s[0]=i,s[1]=n,s[2]=r,s[3]=o,s}},{key:"calculateIntersection",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this.anchor,2),o=r[0],s=r[1],a=o-i,h=s-n,c=Math.sqrt(a*a+h*h),l=this.radius/c;return[o-l*a,s-l*h]}},{key:"getIntersectionsInFourDimension",value:function(){var t,e=y(this.anchor,2),i=e[0],n=e[1],r=this.radius;return a(t={},rt.RIGHT,[i+r,n]),a(t,rt.LEFT,[i-r,n]),a(t,rt.BOTTOM,[i,n+r]),a(t,rt.TOP,[i,n-r]),t}},{key:"calculateIntersectionInFourDimension",value:function(t,e){var i,n=y(t,2),r=n[0],o=n[1],s=y(this.anchor,2),h=s[0],c=s[1],l=this.radius,u=h-r,f=c-o,d=(a(i={},rt.RIGHT,[h+l,c]),a(i,rt.LEFT,[h-l,c]),a(i,rt.BOTTOM,[h,c+l]),a(i,rt.TOP,[h,c-l]),i),g=Math.abs(f)>Math.abs(u)?f<0?rt.BOTTOM:rt.TOP:u<0?rt.RIGHT:rt.LEFT;return{p:d[g],dir:g}}},{key:"getBoundingDimension",value:function(){return{width:this.width,height:this.height}}}]),i}(Tt),Ft=function(t){h(i,t);var e=p(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,i),(t=e.call(this,n)).type="Rectangle",t.width=n.width||10,t.height=n.height||10,t.borderRadius=n.borderRadius||0,t._setBorder(n),t}return s(i,[{key:"_setBorder",value:function(t){var e,i,n,r,o,s,a,h,c,l,u,f;this.border={top:{color:(null===(e=t.border)||void 0===e||null===(e=e.top)||void 0===e?void 0:e.borderColor)||t.borderColor||"transparent",width:(null===(i=t.border)||void 0===i||null===(i=i.top)||void 0===i?void 0:i.borderWidth)||t.borderWidth||0,enable:null===(n=t.border)||void 0===n||null===(n=n.top)||void 0===n?void 0:n.borderWidth},right:{color:(null===(r=t.border)||void 0===r||null===(r=r.right)||void 0===r?void 0:r.borderColor)||t.borderColor||"transparent",width:(null===(o=t.border)||void 0===o||null===(o=o.right)||void 0===o?void 0:o.borderWidth)||t.borderWidth||0,enable:null===(s=t.border)||void 0===s||null===(s=s.right)||void 0===s?void 0:s.borderWidth},bottom:{color:(null===(a=t.border)||void 0===a||null===(a=a.bottom)||void 0===a?void 0:a.borderColor)||t.borderColor||"transparent",width:(null===(h=t.border)||void 0===h||null===(h=h.bottom)||void 0===h?void 0:h.borderWidth)||t.borderWidth||0,enable:null===(c=t.border)||void 0===c||null===(c=c.bottom)||void 0===c?void 0:c.borderWidth},left:{color:(null===(l=t.border)||void 0===l||null===(l=l.left)||void 0===l?void 0:l.borderColor)||t.borderColor||"transparent",width:(null===(u=t.border)||void 0===u||null===(u=u.left)||void 0===u?void 0:u.borderWidth)||t.borderWidth||0,enable:null===(f=t.border)||void 0===f||null===(f=f.left)||void 0===f?void 0:f.borderWidth}},this.borderColor=t.borderColor||"transparent",this.borderWidth=t.borderWidth||0}},{key:"setConfig",value:function(t){var e=this;Object.keys(t).forEach((function(i){void 0!==t[i]&&null!==t[i]&&(e[i]=t[i],e._rawConfigs[i]=t[i])})),this._setBorder(t)}},{key:"render",value:function(t){t.save(),this._isMoving&&(t.globalAlpha=.6);var e=this.borderRadius;this.anchor;var i=this.width,n=this.height,r=this.anchor[0]-this.width/2,o=this.anchor[1]-this.height/2,s=this.anchor[0]+this.width/2,a=this.anchor[1]+this.height/2;if(this.borderRadius?(t.beginPath(),t.moveTo(r+e,o),t.lineTo(r+i-e,o),t.quadraticCurveTo(r+i,o,r+i,o+e),t.lineTo(r+i,o+n-e),t.quadraticCurveTo(r+i,o+n,r+i-e,o+n),t.lineTo(r+e,o+n),t.quadraticCurveTo(r,o+n,r,o+n-e),t.lineTo(r,o+e),t.quadraticCurveTo(r,o,r+e,o),t.closePath()):(t.beginPath(),t.rect(this.anchor[0]-this.width/2,this.anchor[1]-this.height/2,this.width,this.height)),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor),this.shadowColor&&"transparent"!==this.shadowColor){t.shadowColor=this.shadowColor;var h=this._jflow.scale;t.shadowBlur=this.shadowBlur*h,t.shadowOffsetX=this.shadowOffsetX*h,t.shadowOffsetY=this.shadowOffsetY*h;var c=new Path2D;this.borderRadius?(c.moveTo(r+e,o),c.lineTo(r+i-e,o),c.quadraticCurveTo(r+i,o,r+i,o+e),c.lineTo(r+i,o+n-e),c.quadraticCurveTo(r+i,o+n,r+i-e,o+n),c.lineTo(r+e,o+n),c.quadraticCurveTo(r,o+n,r,o+n-e),c.lineTo(r,o+e),c.quadraticCurveTo(r,o,r+e,o),c.closePath()):c.rect(this.anchor[0]-this.width/2,this.anchor[1]-this.height/2,this.width,this.height),c.rect(r-10,o-10,this.width+20,this.height+20),t.save(),t.clip(c,"evenodd"),t.stroke(),t.restore()}if(t.fillStyle=this.backgroundColor,t.fill(),this.borderRadius&&this.borderWidth&&(t.shadowColor="transparent",t.stroke()),this.borderRadius){if(this.border.top.enable){var l=o-this.border.top.width/2;t.beginPath();var u=new Path2D;u.moveTo(r,l+e),u.quadraticCurveTo(r,l,r+e,l),u.lineTo(r+i-e,l),u.quadraticCurveTo(r+i,l,r+i,l+e),u.closePath(),t.clip(u),t.save(),t.shadowColor="transparent",t.fillStyle=this.border.top.color,t.rect(r,l,this.width,this.border.top.width),t.fill(),t.restore()}}else this.border.top.width&&(t.beginPath(),t.moveTo(r,o),t.lineTo(s,o),t.strokeStyle=this.border.top.color,t.lineWidth=this.border.top.width,t.stroke()),this.border.right.width&&(t.beginPath(),t.moveTo(s,o),t.lineTo(s,a),t.strokeStyle=this.border.right.color,t.lineWidth=this.border.right.width,t.stroke()),this.border.bottom.width&&(t.beginPath(),t.moveTo(s,a),t.lineTo(r,a),t.strokeStyle=this.border.bottom.color,t.lineWidth=this.border.bottom.width,t.stroke()),this.border.left.width&&(t.beginPath(),t.moveTo(r,a),t.lineTo(r,o),t.strokeStyle=this.border.left.color,t.lineWidth=this.border.left.width,t.stroke());t.restore()}},{key:"isHit",value:function(t){var e=this.anchor,i=this.width/2,n=this.height/2;return t[0]>e[0]-i&&t[0]<e[0]+i&&t[1]>e[1]-n&&t[1]<e[1]+n}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a}},{key:"getBoundingDimension",value:function(){return{height:this.height,width:this.width}}},{key:"calculateIntersection",value:function(t){var e,i,n=y(t,2),r=n[0],o=n[1],s=y(this.anchor,2),a=s[0],h=s[1],c=this.width/2,l=this.height/2,u=a-r,f=h-o,d=l/c,g=Math.abs(f/u),v=r>a,p=o>h;return g<d?(e=a+(v?c:-c),i=c*(p?g:-g)+h):(i=h+(p?l:-l),e=l/(v?g:-g)+a),[e,i]}},{key:"getIntersectionsInFourDimension",value:function(){var t,e=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(e=this._belongs.calculateToCoordination(e));var i=y(e,2),n=i[0],r=i[1],o=this.width/2,s=this.height/2;return a(t={},rt.RIGHT,[n+o,r]),a(t,rt.LEFT,[n-o,r]),a(t,rt.BOTTOM,[n,r+s]),a(t,rt.TOP,[n,r-s]),t}},{key:"calculateIntersectionInFourDimension",value:function(t,e){var i,n=y(t,2),r=n[0],o=n[1],s=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(s=this._belongs.calculateToCoordination(s));var h=y(s,2),c=h[0],l=h[1],u=this.width/2,f=this.height/2,d=(a(i={},rt.RIGHT,[c+u,l]),a(i,rt.LEFT,[c-u,l]),a(i,rt.BOTTOM,[c,l+f]),a(i,rt.TOP,[c,l-f]),i),g=c-r,v=l-o,p=f/u,_=r>c,m=Math.abs(v/g)>p?o>l?rt.BOTTOM:rt.TOP:_?rt.RIGHT:rt.LEFT;return{p:d[m],dir:m}}}]),i}(Tt),Nt=function(t){h(i,t);var e=p(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,i),(t=e.call(this,n)).type="Capsule",t.width=n.width||20,t.height=n.height||10,t}return s(i,[{key:"render",value:function(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();var e=y(this.anchor,2),i=e[0],n=e[1],r=this.width/2,o=this.height/2,s=i-r+o,a=i+r-o,h=n-o,c=n+o;t.moveTo(s,h),t.lineTo(a,h),t.arc(a,n,o,-Math.PI/2,Math.PI/2),t.lineTo(s,c),t.arc(s,n,o,Math.PI/2,Math.PI/2*3),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}},{key:"isHit",value:function(t){var e=this.anchor,i=this.width/2,n=this.height/2,r=Math.abs(i-n),o=e[0]-i+n,s=e[0]+i-n,a=n*n;return t[0]>e[0]-r&&t[0]<e[0]+r&&t[1]>e[1]-n&&t[1]<e[1]+n||Math.pow(t[0]-o,2)+Math.pow(t[1]-e[1],2)<a||Math.pow(t[0]-s,2)+Math.pow(t[1]-e[1],2)<a}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a}},{key:"getBoundingDimension",value:function(){return{height:this.height,width:this.width}}},{key:"getIntersectionsInFourDimension",value:function(){var t,e=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(e=this._belongs.calculateToCoordination(e));var i=y(e,2),n=i[0],r=i[1],o=this.width/2,s=this.height/2;return a(t={},rt.RIGHT,[n+o,r]),a(t,rt.LEFT,[n-o,r]),a(t,rt.BOTTOM,[n,r+s]),a(t,rt.TOP,[n,r-s]),t}}]),i}(Tt),qt=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"render",value:function(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();var e=y(this.anchor,2),i=e[0],n=e[1],r=this.width/2,o=this.height/2,s=n-o+r,a=n+o-r,h=i-r,c=i+r;t.moveTo(h,s),t.arc(i,s,r,-Math.PI,0),t.lineTo(c,a),t.arc(i,a,r,0,Math.PI),t.closePath(),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}},{key:"isHit",value:function(t,e){var i=y(this.anchor,2),n=i[0],r=i[1],o=this.width/2,s=this.height/2,a=Math.abs(s-o),h=r-s+o,c=r+s-o,l=o*o;return t[0]>n-o&&t[0]<n+o&&t[1]>r-a&&t[1]<r+a||Math.pow(t[0]-n,2)+Math.pow(t[1]-h,2)<l||Math.pow(t[0]-n,2)+Math.pow(t[1]-c,2)<l}}]),i}(Nt),Gt=function(t){h(i,t);var e=p(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,i),(t=e.call(this,n)).type="Rhombus",t.height=n.diagonalsV||10,t.width=n.diagonalsH||20,t}return s(i,[{key:"render",value:function(t){t.save(),this._isMoving&&(t.globalAlpha=.6);var e=this.width/2,i=this.height/2,n=this.anchor;if(t.translate(n[0],n[1]),t.beginPath(),t.moveTo(0,-i),t.lineTo(e,0),t.lineTo(0,i),t.lineTo(-e,0),t.closePath(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor),this.shadowColor){t.shadowColor=this.shadowColor;var r=this._jflow.scale;t.shadowBlur=this.shadowBlur*r,t.shadowOffsetX=this.shadowOffsetX*r,t.shadowOffsetY=this.shadowOffsetY*r;var o=new Path2D;o.moveTo(0,-i),o.lineTo(e,0),o.lineTo(0,i),o.lineTo(-e,0),o.closePath(),o.rect(-e-10,-i-10,this.width+20,this.height+20),t.save(),t.clip(o,"evenodd"),t.stroke(),t.restore()}t.fillStyle=this.backgroundColor,t.fill(),this.borderWidth&&(t.shadowColor="transparent",t.stroke()),t.translate(-n[0],-n[1]),t.restore()}},{key:"isHit",value:function(t){var e=this.height/2,i=this.width/2,n=this.anchor;return Math.abs(t[0]-n[0])/i+Math.abs(t[1]-n[1])/e<=1}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a}},{key:"getBoundingDimension",value:function(){return{height:this.height,width:this.width}}},{key:"getIntersectionsInFourDimension",value:function(){var t,e=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(e=this._belongs.calculateToCoordination(e));var i=y(e,2),n=i[0],r=i[1],o=this.width/2,s=this.height/2;return a(t={},rt.RIGHT,[n+o,r]),a(t,rt.LEFT,[n-o,r]),a(t,rt.BOTTOM,[n,r+s]),a(t,rt.TOP,[n,r-s]),a(t,rt.SELF,[n+.618*o,r+.618*s]),t}}]),i}(Tt),Vt=function(t){h(i,t);var e=p(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,i),(t=e.call(this,n)).type="Diamond",t.width=n.width||20,t.height=n.height||10,t.side=n.side||6,t._doCache(),t}return s(i,[{key:"setConfig",value:function(t){var e=this;Object.keys(t).forEach((function(i){void 0!==t[i]&&null!==t[i]&&(e[i]=t[i],e._rawConfigs[i]=t[i])})),this._doCache()}},{key:"_doCache",value:function(){this.sinSIDE=Math.sin(Math.PI/3)*this.side,this.cosSIDE=Math.cos(Math.PI/3)*this.side}},{key:"render",value:function(t){var e=y(this.anchor,2),i=e[0],n=e[1],r=this.width/2,o=this.height/2,s=o/1.732,a=i-r+s,h=i+r-s,c=i+r,l=i-r,u=n-o,f=n+o;this._cachePoints=[[h,u],[c,n],[h,f],[a,f],[l,n],[a,u]],t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();var d=this.side,g=this.sinSIDE,v=this.cosSIDE;t.moveTo(i,u),t.lineTo(h-d,u),t.quadraticCurveTo(h,u,h+v,u+g),t.lineTo(c-v,n-g),t.quadraticCurveTo(c,n,c-v,n+g),t.lineTo(h+v,f-g),t.quadraticCurveTo(h,f,h-d,f),t.lineTo(a+d,f),t.quadraticCurveTo(a,f,a-v,f-g),t.lineTo(l+v,n+g),t.quadraticCurveTo(l,n,l+v,n-g),t.lineTo(a-v,u+g),t.quadraticCurveTo(a,u,a+d,u),t.closePath(),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}},{key:"isHit",value:function(t){if(!this._cachePoints)return!1;for(var e=this._cachePoints,i=!1,n=0,r=e.length-1;n<e.length;n++)e[n][1]>t[1]!=e[r][1]>t[1]&&t[0]<(e[r][0]-e[n][0])*(t[1]-e[n][1])/(e[r][1]-e[n][1])+e[n][0]&&(i=!i),r=n;return i}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a}},{key:"getBoundingDimension",value:function(){return{height:this.height,width:this.width}}},{key:"getIntersectionsInFourDimension",value:function(){var t,e=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(e=this._belongs.calculateToCoordination(e));var i=y(e,2),n=i[0],r=i[1],o=this.width/2,s=this.height/2;return a(t={},rt.RIGHT,[n+o,r]),a(t,rt.LEFT,[n-o,r]),a(t,rt.BOTTOM,[n,r+s]),a(t,rt.TOP,[n,r-s]),t}}]),i}(Tt),Ut=function(t){h(i,t);var e=p(i);function i(t){return r(this,i),e.call(this,t)}return s(i,[{key:"render",value:function(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();var e=y(this.anchor,2),i=e[0],n=e[1],r=this.width/2,o=this.height/2,s=r/1.732,a=n-o,h=n+o,c=n-o+s,l=n+o-s,u=i-r,f=i+r;t.moveTo(i,a),t.lineTo(f,c),t.lineTo(f,l),t.lineTo(i,h),t.lineTo(u,l),t.lineTo(u,c),t.closePath(),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore(),this._cachePoints=[[i,a],[f,c],[f,l],[i,h],[u,l],[u,c]]}}]),i}(Vt);var Zt=Symbol("ishit"),Kt=function(t){h(i,t);var e=p(i);function i(t){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return r(this,i),(n=e.call(this,t,o)).visible=!1,n}return s(i,[{key:"render",value:function(t){this.visible&&m(c(i.prototype),"render",this).call(this,t)}},{key:"setHit",value:function(t){this[Zt]!==t&&(this.isFocus=t,this.onHit()),this[Zt]=t}}]),i}(It),Jt=function(t){h(i,t);var e=p(i);function i(t){var n,o;return r(this,i),(o=e.call(this,t)).type="ScrollGroup",o.initStack(t),o.initLayout(t),o.initScrollBar(t),o._shape=new Ft(t),o._shape.anchor=[0,0],o._shape._belongs=g(o),o.maxWidth=t.maxWidth||1/0,o.definedWidth=t.definedWidth,o.maxHeight=t.maxHeight||1/0,o.definedHeight=t.definedHeight,o.lock=null===(n=t.lock)||void 0===n||n,o._offset=[0,0],o._getBoundingGroupRect(),o.reflow(),o._getBoundingGroupRect(),o._resetOffset(),o._cacheViewBox=[],o}return s(i,[{key:"initScrollBar",value:function(t){var e=this,i=t.barColor,n=t.barFocusColor,r=t.barMarginX,o=t.barMarginY,s=t.barWidth;this._scrollbarX=new Kt("x",{plainColor:i,focusColor:n,barWidth:s}),this._scrollbarY=new Kt("y",{plainColor:i,focusColor:n,barWidth:s}),this._scrollbarX.barMarginX=r||1,this._scrollbarY.barMarginY=o||1;var a=function(){e._jflow.scheduleRender()};this._scrollbarX.onHit=a,this._scrollbarY.onHit=a,this._scrollBarStatus={dragging:!1,target:null,barInitX:0,barInitY:0,barStartX:0,barStartY:0,hitScrollX:!1,hitScrollY:!1},this.addEventListener("instancePressStart",(function(t){if(e._scrollBarStatus.hitScrollX){t.detail.preventDefault(),t.detail.bubbles=!1;var i=t.detail.event.clientX;Object.assign(e._scrollBarStatus,{dragging:!0,target:e._scrollbarX,barStartX:e._scrollbarX.anchor[0],barInitX:i}),e.onScrollbarPressStart()}if(e._scrollBarStatus.hitScrollY){t.detail.preventDefault(),t.detail.bubbles=!1;var n=t.detail.event.clientY;Object.assign(e._scrollBarStatus,{dragging:!0,target:e._scrollbarY,barStartY:e._scrollbarY.anchor[1],barInitY:n}),e.onScrollbarPressStart()}}))}},{key:"onScrollbarPressStart",value:function(){var t=this,e=this._jflow.canvas,i=function(e){var i=e.clientX,n=e.clientY;t.onDraggingScrollbar(i,n)}.bind(this);document.addEventListener("pointermove",i);var n=function(r){Object.assign(t._scrollBarStatus,{dragging:!1,target:null,barInitX:0,barInitY:0,barStartX:0,barStartY:0,hitScrollX:!1,hitScrollY:!1}),document.removeEventListener("pointermove",i),document.removeEventListener("pointerup",n),e.removeEventListener("pointerup",n)}.bind(this);e.addEventListener("pointerup",n,{once:!0}),document.addEventListener("pointerup",n,{once:!0})}},{key:"onDraggingScrollbar",value:function(t,e){if(this._scrollbarX.visible&&this._scrollBarStatus.dragging){var i=this._jflow,n=i.scale,r=this._scrollBarStatus,o=r.target,s=r.barInitX,a=r.barStartX,h=r.barInitY,c=r.barStartY;if("x"===o.dir){var l=this._scrollbarX.width,u=this._outerWidth,f=a+(t-s)/n,d=(o.anchor[0]=Math.max(Math.min(f,u-l),0))/(u-l),g=(this._innerWidth-u)/2;this._offset[0]=g-(this._innerWidth-u)*d,i.scheduleRender()}if("y"===o.dir){var v=this._scrollbarY.height,p=this._outerHeight,_=c+(e-h)/n,m=(o.anchor[1]=Math.max(Math.min(_,p-v),0))/(p-v),y=(this._innerHeight-p)/2;this._offset[1]=y-(this._innerHeight-p)*m,i.scheduleRender()}}}},{key:"setConfig",value:function(t){this._shape.setConfig(t)}},{key:"_getBoundingGroupRect",value:function(){var t=st(this._stack.getBoundingRectPoints()),e=t.width,i=t.height,n=this.definedWidth||Math.min(e,this.maxWidth),r=this.definedHeight||Math.min(i,this.maxHeight);this._innerWidth=e,this._outerWidth=n,this._innerHeight=i,this._outerHeight=r,this._shape.width=n,this._shape.height=r,this.width=n,this.height=r}},{key:"_calculatePointBack",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this._offset,2),o=r[0],s=r[1],a=y(this.anchor,2);return[i-a[0]-o,n-a[1]-s]}},{key:"_calculatePointBackWithPoint",value:function(t,e,i,n,r){var o=this.anchor,s=this._offset;i[n]=t-o[0]-s[0],i[r]=e-o[1]-s[1]}},{key:"calculateToCoordination",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this.anchor,2),o=r[0],s=r[1],a=y(this._offset,2),h=[i+o-a[0],n+s-a[1]];return this._belongs&&this._belongs.calculateToCoordination?this._belongs.calculateToCoordination(h):h}},{key:"calculateToRealWorld",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this.anchor,2),o=r[0],s=r[1],a=y(this._offset,2),h=[i+o-a[0],n+s-a[1]];if(this._belongs&&this._belongs.calculateToRealWorld)return this._belongs.calculateToRealWorld(h)}},{key:"_getViewBox",value:function(){var t=this._cacheViewBox;return this._calculatePointBackWithPoint(0,0,t,0,1),this._calculatePointBackWithPoint(this.width,this.height,t,2,3),t}},{key:"getCacheViewBox",value:function(){return this._cacheViewBox}},{key:"_resetOffset",value:function(){this._offset=[Math.max((this._innerWidth-this._outerWidth)/2,0),Math.max((this._innerHeight-this._outerHeight)/2,0)],this._innerWidth>this._outerWidth?(this._scrollbarX.visible=!0,this._scrollbarX.width=this._outerWidth*this._outerWidth/this._innerWidth,this._scrollbarX.anchor=[0,this._outerHeight-4]):this._scrollbarX.visible=!1,this._innerHeight>this._outerHeight?(this._scrollbarY.visible=!0,this._scrollbarY.height=this._outerHeight*this._outerHeight/this._innerHeight,this._scrollbarY.anchor=[this._outerWidth-4,0]):this._scrollbarY.visible=!1}},{key:"render",value:function(t){this._isMoving?t.globalAlpha=.6:1!==this.opacity&&(t.globalAlpha=this.opacity);var e=y(this.anchor,2),i=e[0],n=e[1],r=this.width,o=this.height,s=r/2,a=o/2,h=y(this._offset,2),c=h[0],l=h[1];t.translate(i,n),this._shape.render(t),t.translate(-s,-a),this._scrollbarX.visible&&this._scrollbarX.render(t),this._scrollbarY.visible&&this._scrollbarY.render(t),t.translate(s,a),t.save(),t.beginPath(),t.rect(-s,-a,r,o),t.clip(),t.translate(c,l),this._stack.render(t),this._linkStack.render(t),t.translate(-i-c,-n-l),t.restore()}},{key:"isHit",value:function(t,e){var i=y(t,2),n=i[0],r=i[1],o=y(this.anchor,2),s=o[0],a=o[1],h=[n-s+this.width/2,r-a+this.height/2];if((this._scrollBarStatus.hitScrollX=!1,this._scrollBarStatus.hitScrollY=!1,this._scrollbarX.visible)&&this._scrollbarX.isHit(h))return this._scrollBarStatus.hitScrollX=!0,this._scrollbarX.setHit(!0),!0;if((this._scrollbarX.setHit(!1),this._scrollbarY.visible)&&this._scrollbarY.isHit(h))return this._scrollBarStatus.hitScrollY=!0,this._scrollbarY.setHit(!0),!0;if(this._scrollbarY.setHit(!1),this._shape.isHit([n-s,r-a])){var c=y(this._offset,2),l=[n-s-c[0],r-a-c[1]];this._currentp=l;var u=this._stack.checkHit(l,e);if(u)return u}else this._stack.resetHitStatus();return!1}},{key:"getBoundingDimension",value:function(){return{width:this.width,height:this.height}}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a}},{key:"getIntersectionsInFourDimension",value:function(){var t,e=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(e=this._belongs.calculateToCoordination(e));var i=y(e,2),n=i[0],r=i[1],o=this.width/2,s=this.height/2;return a(t={},rt.RIGHT,[n+o,r]),a(t,rt.LEFT,[n-o,r]),a(t,rt.BOTTOM,[n,r+s]),a(t,rt.TOP,[n,r-s]),a(t,rt.SELF,[n+.618*o,r+.618*s]),t}},{key:"onEnterViewbox",value:function(){this.interateNodeStack((function(t){t.onEnterViewbox()}))}},{key:"onLeaveViewbox",value:function(){this.interateNodeStack((function(t){t.onLeaveViewbox()}))}},{key:"destroy",value:function(){this._shape.destroy(),this.interateNodeStack((function(t){t.destroy()}))}},{key:"clone",value:function(){var t=new(0,this.constructor)(Object.assign({},this._rawConfigs,{layout:this._layout&&this._layout.clone()}));return this.interateNodeStack((function(e){t.addToStack(e.clone())})),t.recalculate(),t.visible=this.visible,t}}]),i}(Tt);Object.assign(Jt.prototype,Pt),Object.assign(Jt.prototype,Bt),Object.assign(Jt.prototype,{recalculateUp:function(){var t=!0;if(this.getBoundingDimension){var e=this._innerWidth,i=this._innerHeight;this.resetChildrenPosition&&this.resetChildrenPosition(),this._getBoundingGroupRect&&this._getBoundingGroupRect(),this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect();var n=this._innerWidth,r=this._innerHeight;t=e!==n||i!==r}else this.reflow();this._belongs&&t&&(this._resetOffset(),this._belongs.recalculateUp())},recalculate:function(){var t=this.getBoundingDimension(),e=t.width,i=t.height;this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect();var n=this.getBoundingDimension(),r=n.width,o=n.height;e===r&&i===o||this._resetOffset()}});var $t=function(t){h(i,t);var e=p(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(this,i),(t=e.call(this)).from=n.from,t.to=n.to,t.fromDir=n.fromDir,t.toDir=n.toDir,t._cachePoints=null,t.backgroundColor=n.backgroundColor||"#000",t.isSelf=!!n.isSelf,t}return s(i,[{key:"isInViewBox",value:function(t){return!0}},{key:"bringToTop",value:function(){var t=this,e=this._jflow._linkStack,i=e.findIndex((function(e){return e===t}));e.splice(i,1),e.push(this),this._jflow._render()}}]),i}(xt),Qt=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).width=t.width,n.height=t.height,n.imageBuffer=document.createElement("canvas"),n.imageBuffer.width=n.width+2,n.imageBuffer.height=n.height+2,t.cache(n.imageBuffer.getContext("2d")),n}return s(i,[{key:"render",value:function(t){var e=y(this.anchor,2),i=e[0],n=e[1];t.save(),t.translate(i,n),t.beginPath(),t.drawImage(this.imageBuffer,-this.width/2,-this.height/2),t.translate(-i,-n),t.restore()}},{key:"getBoundingDimension",value:function(){return{height:this.height,width:this.width}}},{key:"recalculate",value:function(){}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a}}]),i}(Tt),te="center",ee="left",ie="right",ne=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).type="Text",n.content=t.content||"",n.fontFamily=t.fontFamily||"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",n.fontSize=t.fontSize||"14px",n.fontWeight=t.fontWeight||"",n.textColor=t.textColor||"white",n.placeholderColor=t.placeholderColor||t.textColor||"white",n.textAlign=t.textAlign||te,n.textBaseline=t.textBaseline||"middle",n.lineHeight=t.lineHeight,n.indent=t.indent||0,n.backgroundColor=t.backgroundColor,n.editable=t.editable,n.definedWidth=t.definedWidth,n.minWidth=t.minWidth||0,n.maxWidth=t.maxWidth,n.ellipsis=t.ellipsis,n.placeholder=t.placeholder||"",n.emptyWhenInput=t.emptyWhenInput||!1,n.editting=!1,n.disabled=t.disabled,n.cursorColor=t.cursorColor||"#60CFC4",n.textRangeColor=t.textRangeColor||"#4E75EC1A",n._status={editing:!1,cursorshow:!0,cursoranime:null,lastElapsed:0,refreshElapsed:!1,cursorDragging:!1,shiftOn:!1,oldVal:"",inputElement:null},n._cursorOffset=0,n._textRange={enable:!1,rangefrom:null,rangeTo:null,initialRange:null},n.editable&&n._makeFunctional(),n.preCalculateText(),n.shadowCache(),n}return s(i,[{key:"currentContent",get:function(){return this.content||this.placeholder}},{key:"isEmpty",get:function(){return!this.content}},{key:"preCalculateText",value:function(){var t=this;M((function(e){e.beginPath(),e.font="".concat(t.fontSize," ").concat(t.fontFamily),e.textAlign=t.textAlign,e.textBaseline=t.textBaseline;var i=parseInt(t.fontSize),n=t.currentContent,r=e.measureText(n),o=r.fontBoundingBoxAscent,s=r.fontBoundingBoxDescent,a=r.width;if(t._textWidth=t.indent+a,t.definedWidth){if(t.ellipsis&&t._textWidth>t.definedWidth){var h=t._calculateOffset(t.definedWidth-12);t.ellipsisContent=n.substring(0,h)+"..."}else t.ellipsisContent=n;t.width=t.definedWidth}else if(t.maxWidth&&t.ellipsis){if(t._textWidth>t.maxWidth){var c=t.maxWidth/t._textWidth,l=Math.floor(n.length*c-3);t.ellipsisContent=n.substring(0,l)+"..."}else t.ellipsisContent=n;t.width=Math.min(t.maxWidth,t._textWidth)}else t.width=Math.max(t.minWidth,t._textWidth);var u=Math.abs(o)+Math.abs(s)||i;t._textHeight=u,t.lineHeight?t.height=t.lineHeight:t.height=u}))}},{key:"shadowCache",value:function(){var t=this,e=window.devicePixelRatio,i=this.width*e,n=this.height*e,r=this.indent*e,o=parseInt(this.fontSize)*e;this._shadowCache=new Qt({width:i,height:n,cache:function(e){e.translate(i/2,n/2);var s="".concat(t.fontWeight," ").concat(o,"px ").concat(t.fontFamily);e.font=s,e.textAlign=t.textAlign,e.textBaseline=t.textBaseline,e.fillStyle=t.isEmpty?t.placeholderColor:t.textColor;var a=t.currentContent;if(t.ellipsisContent&&(a=t.ellipsisContent),a)if(t.textAlign===ee){var h=i/2;e.fillText(a,r/2-h,0)}else if(t.textAlign===ie){var c=i/2;e.fillText(a,c,0)}else e.fillText(a,r/2,0)}})}},{key:"setConfig",value:function(t){var e=this;Object.keys(t).forEach((function(i){void 0!==t[i]&&null!==t[i]&&(e[i]=t[i],e._rawConfigs[i]=t[i])})),this.preCalculateText(),this.shadowCache()}},{key:"click",value:function(){var t=this;if(!this._status.editing){var e=!0;if(this.dispatchEvent(new jt("edit",{target:this,preventDefault:function(){e=!1}})),!e)return;var i=this._belongs._currentp,n=this._jflow;this._cursorOffset=i?this._positionToCursorOffset(i):0;var r=function(t,e){var i=document.createElement("input");i.setAttribute("style","\n        width: 100px;\n        position: absolute;\n        left: 0;\n        top: 0;\n        border:none;\n        opacity: 0;\n        z-index: -1;\n        contain: strict;"),i.setAttribute("tabindex",-1),i.setAttribute("aria-hidden",!0),i.setAttribute("spellcheck",!1),i.setAttribute("autocorrect","off");var n=!1,r={ctrlOn:!1};return i.addEventListener("beforeinput",(function(e){e.preventDefault(),e.data&&(n||t("Input",e.data))})),i.addEventListener("compositionstart",(function(e){t("compositionstart"),n=!0})),i.addEventListener("compositionupdate",(function(e){t("compositionupdate",e.data)})),i.addEventListener("compositionend",(function(e){t("compositionend",e.data),i.value="",n=!1})),i.addEventListener("keyup",(function(e){switch(e.key){case"Shift":t("Shift",!1);break;case"Meta":case"Control":r.ctrlOn=!1}})),i.addEventListener("keydown",(function(e){switch(e.code){case"Enter":t("Enter");break;case"Backspace":t("Backspace");break;case"ArrowLeft":t("ArrowLeft");break;case"ArrowRight":t("ArrowRight");break;case"ArrowDown":t("ArrowDown");break;case"ArrowUp":t("ArrowUp")}switch(e.key){case"Shift":t("Shift",!0);break;case"Meta":case"Control":r.ctrlOn=!0;break;case"a":r.ctrlOn&&t("CtrlA")}})),i.addEventListener("keyup",(function(t){e("KeyUp",t)})),i.addEventListener("keydown",(function(t){e("KeyDown",t)})),i.addEventListener("copy",(function(e){e.preventDefault(),e.stopPropagation(),t("COPY",null,e)})),i.addEventListener("cut",(function(e){e.preventDefault(),e.stopPropagation(),t("CUT",null,e)})),i.addEventListener("paste",(function(e){e.preventDefault(),e.stopPropagation(),t("PASTE",null,e)})),i}(this._controlCallback.bind(this),this._defaultCallback.bind(this));n.DOMwrapper.append(r),r.focus({preventScroll:!0}),n.setFocusInstance(this),Object.assign(this._status,{editing:!0,oldVal:this.content,inputElement:r,cursoranime:n.requestJFlowAnime((function(e){var i=t._status.lastElapsed;t._status.refreshElapsed&&(t._status.lastElapsed=e,t._status.refreshElapsed=!1),e-i>500&&(t._status.cursorshow=!t._status.cursorshow,t._status.lastElapsed=e)}))}),this.emptyWhenInput&&(this.content=""),this.syncShadowInputPosition()}}},{key:"_makeFunctional",value:function(){var t=this;this.addEventListener("dblclick",(function(e){e.currentTarget===t&&t._status.editing&&t._selectFullRange()})),this.addEventListener("click",(function(e){if(e.currentTarget===t){if(t._status.editing){var i=t._belongs._currentp,n=t._positionToCursorOffset(i);if(t._status.shiftOn){var r=t._textRange.initialRange;Object.assign(t._textRange,{rangefrom:Math.min(n,r),rangeTo:Math.max(n,r),enable:!0}),t._cursorOffset=t._textRange.rangeTo,t._status.inputElement.focus({preventScroll:!0})}else t._cursorOffset=n,t._status.inputElement.focus({preventScroll:!0}),t._refreshCursor(),t.syncShadowInputPosition()}t.click()}})),this.addEventListener("blur",(function(e){t._status.editing=!1,t._status.inputElement&&t._status.inputElement.remove(),t._belongs&&t._jflow.scheduleRender(),t.dispatchEvent(new jt("change",{target:t,oldVal:t._status.oldVal,val:t.content})),t._textRange.enable=!1,t._status.cursoranime.cancel(),Object.assign(t._status,{editing:!1,cursorshow:!0,cursoranime:null,lastElapsed:0,refreshElapsed:!1,cursorDragging:!1,shiftOn:!1,oldVal:"",inputElement:null})})),this.addEventListener("instancePressStart",(function(e){if(t._status.editing&&!t._status.shiftOn){e.detail.bubbles=!1,e.detail.preventDefault();var i=t._belongs._currentp,n=t._positionToCursorOffset(i);t._textRange.initialRange=n;var r=e.detail.jflow,o=!1,s=function(e){o=!0;var i=e.offsetX,n=e.offsetY,s=r._calculatePointBack([i,n]);r._stack.checkHit(s);var a=t._belongs._currentp,h=t._positionToCursorOffset(a),c=t._textRange.initialRange;t._status.editing=!1,Object.assign(t._textRange,{rangefrom:Math.min(h,c),rangeTo:Math.max(h,c),enable:!0})}.bind(t);document.addEventListener("pointermove",s),document.addEventListener("pointerup",(function(e){if(document.removeEventListener("pointermove",s),o){var i=t._textRange.rangeTo;t._cursorOffset=i,t._status.editing=!0,t._status.inputElement.focus({preventScroll:!0}),t._textRange.initialRange=null}else t._textRange.initialRange=null}),{once:!0})}}))}},{key:"_positionToCursorOffset",value:function(t){var e=y(t,1)[0],i=this.width/2,n=e-(y(this.anchor,1)[0]-i);return n>=this._textWidth?this.content.length:this._calculateOffset(n)}},{key:"_calculateOffset",value:function(t){var e=this,i=this.content,n=i.length-1,r=this._textWidth;if(0===r)return 0;var o=r,s=Math.floor(t/o*n);return M((function(r){var a,h,c;r.font="".concat(e.fontSize," ").concat(e.fontFamily);var l=i.substring(0,s),u=i.substring(s-1,s),f=i.substring(s,s+1),d=r.measureText(l).width,g=r.measureText(u).width,v=r.measureText(f).width;a=d-g/2,h=d+v/2;do{if(a<=t&&h>=t)break;if(a>t){var p=h-t;c=s,s-=p<100?1:Math.floor(p/h*c),l=i.substring(s,c),d-=r.measureText(l).width}else if(h<t){var _=t-a;c=s,s+=_<100?1:Math.floor(_/(o-a)*(n-c)),l=i.substring(c,s),d+=r.measureText(l).width}u=i.substring(s-1,s),f=i.substring(s,s+1),a=d-(g=r.measureText(u).width)/2,h=d+(v=r.measureText(f).width)/2}while(s>=0&&s<=n)})),s}},{key:"_refreshCursor",value:function(){this._status.editing&&Object.assign(this._status,{cursorshow:!0,refreshElapsed:!0}),this._textRange.enable&&(this._textRange.enable=!1)}},{key:"render",value:function(t){if(this._isMoving&&(t.globalAlpha=.6),!t.disableCache&&!this._status.editing&&this._jflow.scale*parseInt(this.fontSize)<8){var e=y(this.anchor,2),i=e[0],n=e[1];return t.save(),t.translate(i,n),t.beginPath(),t.drawImage(this._shadowCache.imageBuffer,-this.width/2,-this.height/2,this.width,this.height),t.translate(-i,-n),void t.restore()}var r="".concat(this.fontWeight," ").concat(this.fontSize," ").concat(this.fontFamily);t.font!==r&&(t.font=r),t.textAlign!==this.textAlign&&(t.textAlign=this.textAlign),t.textBaseline!==this.textBaseline&&(t.textBaseline=this.textBaseline),t.fillStyle=this.isEmpty?this.placeholderColor:this.textColor;var o=this.currentContent;if(this.ellipsisContent&&(o=this.ellipsisContent),o)if(this.textAlign===ee){var s=this.width/2;t.fillText(o,this.anchor[0]-s+this.indent/2,this.anchor[1])}else if(this.textAlign===ie){var a=this.width/2;t.fillText(o,this.anchor[0]+a,this.anchor[1])}else t.fillText(o,this.anchor[0]+this.indent/2,this.anchor[1]);var h=this.width/2,c=this._textHeight,l=y(this.anchor,2),u=l[0],f=l[1],d=u-h,g=f-c/2;if(this._status.cursorshow&&this._status.editing){var v=this._cursorOffset,p=this.content.substring(0,v),_=d+t.measureText(p).width,m=this._textHeight/2;t.beginPath(),t.moveTo(_,f-m),t.lineTo(_,f+m),t.lineWidth=2,t.strokeStyle=this.cursorColor,t.stroke()}if(this._textRange.enable){var b=this._textRange,w=b.rangefrom,k=b.rangeTo,x=this.content.substring(0,w),T=this.content.substring(w,k),S=d+t.measureText(x).width,E=t.measureText(T).width;t.beginPath(),t.rect(S,g,E,c),t.fillStyle=this.textRangeColor,t.fill()}}},{key:"_inputControl",value:function(t,e){if(this._textRange.enable&&(this._clearTextRange(),"Backspace"===t))return this.dispatchEvent(new jt("input",{target:this,oldVal:this._status.oldVal,val:this.content})),this.refresh(),void this.syncShadowInputPosition();var i,n=this._cursorOffset,r=this.content,o=r.substring(0,n);i=this.cacheIdx?r.substring(this.cacheIdx[1]):r.substring(n);var s=!1;switch(t){case"Input":o+=e,this._cursorOffset+=e.length,this.content=o+i;break;case"compositionstart":this.cacheIdx=[o.length,o.length];break;case"compositionupdate":o=o.substring(0,this.cacheIdx[0]),o+=e,this.content=o+i,this._cursorOffset=this.cacheIdx[0]+e.length,this.cacheIdx[1]=this.cacheIdx[0]+e.length;break;case"compositionend":o=o.substring(0,this.cacheIdx[0]),this._cursorOffset=this.cacheIdx[0]+e.length,this.cacheIdx=null,o+=e,this.content=o+i;break;case"Enter":if(this.cacheIdx)return;var a=!0;this.dispatchEvent(new jt("enterkeypressed",{target:this,handler:function(t){a=t},stopInput:function(){s=!0}})),a&&this._jflow.blur();break;case"Backspace":o=o.substring(0,o.length-1),this._cursorOffset=Math.max(0,this._cursorOffset-1),this.content=o+i}s||this.dispatchEvent(new jt("input",{target:this,oldVal:this._status.oldVal,val:this.content})),this.refresh(),this.syncShadowInputPosition()}},{key:"refresh",value:function(){this.preCalculateText(),this._belongs.recalculateUp(),this._jflow.scheduleRender()}},{key:"syncShadowInputPosition",value:function(){var t=this;if(this._status.editing){var e=this.width/2,i=this.height/2,n=this.anchor[0]-e,r=this._cursorOffset;M((function(e){e.beginPath(),e.font="".concat(t.fontSize," ").concat(t.fontFamily);var i=t.content.substring(0,r);n+=e.measureText(i).width}));var o=this.calculateToRealWorld([n,i]),s=this._jflow.canvasMeta,a=Math.min(s.actual_width-120,o[0]);this._status.inputElement.style.transform="translate(".concat(a,"px, ").concat(o[1],"px)")}}},{key:"_controlCallback",value:function(t,e,i){switch(this._status.editing&&Object.assign(this._status,{cursorshow:!0,refreshElapsed:!0}),t){case"Input":case"compositionstart":case"compositionupdate":case"compositionend":case"Enter":case"Backspace":this._inputControl(t,e);break;case"ArrowLeft":this._textRange.enable&&(this._textRange.enable=!1),this._onArrowLeft();break;case"ArrowRight":this._textRange.enable&&(this._textRange.enable=!1),this._onArrowRight();break;case"Shift":this._onShiftToggle(e);break;case"CtrlA":this._selectFullRange();break;case"COPY":this._copy(i);break;case"CUT":this._cut(i);break;case"PASTE":this._paste(i)}}},{key:"_onArrowLeft",value:function(){this._cursorOffset=Math.max(0,this._cursorOffset-1),this._jflow.scheduleRender(),this.syncShadowInputPosition()}},{key:"_onArrowRight",value:function(){this._cursorOffset=Math.min(this.content.length,this._cursorOffset+1),this._jflow.scheduleRender(),this.syncShadowInputPosition()}},{key:"_onShiftToggle",value:function(t){this._status.shiftOn=t,this._textRange.initialRange=t?this._cursorOffset:null}},{key:"_selectFullRange",value:function(){this._textRange={enable:!0,rangefrom:0,rangeTo:this.content.length},this._cursorOffset=this.content.length}},{key:"_clearTextRange",value:function(){if(this._textRange.enable){var t=this._textRange,e=t.rangefrom,i=t.rangeTo,n=this.content,r=n.substring(0,e),o=n.substring(i);this.content=r+o,this._cursorOffset=r.length,this._textRange.enable=!1}}},{key:"_getSelection",value:function(){if(this._textRange.enable){var t=this._textRange,e=t.rangefrom,i=t.rangeTo;return this.content.substring(e,i)}return null}},{key:"_copy",value:function(t){var e=this._getSelection();e&&t.clipboardData.setData("text/plain",e)}},{key:"_cut",value:function(t){var e=this._getSelection();e&&(t.clipboardData.setData("text/plain",e),this._clearTextRange(),this.refresh())}},{key:"_paste",value:function(t){var e=(t.clipboardData||window.clipboardData).getData("text"),i=!1;if(this.dispatchEvent(new jt("paste",{target:this,content:e,preventDefault:function(){i=!0},resolvePasteContent:function(t){e=t(e)}})),!i){this._clearTextRange();var n=this._cursorOffset,r=this.content,o=r.substring(0,n),s=r.substring(n);this.content=o+e+s,this._cursorOffset=(o+e).length,this.refresh()}}},{key:"_defaultCallback",value:function(t,e){switch(t){case"KeyDown":this.dispatchEvent(new jt("keydown",{target:this,key:e.key,code:e.code,rawEvent:e}));break;case"KeyUp":this.dispatchEvent(new jt("keyup",{target:this,key:e.key,code:e.code,rawEvent:e}))}}},{key:"destroy",value:function(){this._jflow._focus.instance===this&&this._jflow.blur()}}]),i}(Ft);var re=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).image=t.image,n.image.onload=function(){n._jflow._render()},n.imageBounding={width:t.imageWidth||t.width,height:t.imageHeight||t.height},n}return s(i,[{key:"setConfig",value:function(t){var e=this;Object.keys(t).forEach((function(i){void 0!==t[i]&&null!==t[i]&&(e[i]=t[i],e._rawConfigs[i]=t[i])})),t.image&&!t.image.complete&&(this.image.onload=function(){e._jflow._render()}),this.imageBounding={width:t.imageWidth||t.width||this.imageBounding.width,height:t.imageHeight||t.height||this.imageBounding.height}}},{key:"render",value:function(t){t.save(),this._isMoving&&(t.globalAlpha=.6),Ft.prototype.render.call(this,t);var e=this.anchor[0]-this.width/2,i=this.anchor[1]-this.height/2;this.opacity<1&&(t.globalAlpha=this.opacity),this.image.complete&&t.drawImage(this.image,e,i,this.imageBounding.width,this.imageBounding.height),t.restore()}}]),i}(Ft),oe=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).domFactory=t.createDocument,n._dom=null,n}return s(i,[{key:"getRealWorldPosition",value:function(){var t=this.getBoundingRect();return this.calculateToRealWorld(t.slice(0,2))}},{key:"render",value:function(t){var e=this;if(!this._dom&&this.domFactory)requestAnimationFrame((function(){if(!e._dom){var t=document.createElement("div"),i=e.getRealWorldPosition(),n=e._jflow.scale;t.setAttribute("style","\n                        position: absolute;\n                        width: ".concat(e.width,"px;\n                        height: ").concat(e.height,"px;\n                        transform-origin: left top;\n                        top: 0;\n                        left: 0;\n                        transform: translate(").concat(i[0],"px, ").concat(i[1],"px) scale(").concat(n,");")),e._dom=t,e._jflow.DOMwrapper.appendChild(t),e.domFactory(t)}}));else{var n=this.getRealWorldPosition(),r=this._jflow.scale;this._dom.style.transform="translate(".concat(n[0],"px, ").concat(n[1],"px) scale(").concat(r,")")}m(c(i.prototype),"render",this).call(this,t)}},{key:"onEnterViewbox",value:function(){this._dom&&(this._dom.style.display="block")}},{key:"onLeaveViewbox",value:function(){this._dom&&(this._dom.style.display="none")}},{key:"destroy",value:function(){this._dom&&this._jflow.DOMwrapper.removeChild(this._dom),m(c(i.prototype),"destroy",this).call(this)}}]),i}(Ft),se=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).fontFamily=t.fontFamily="-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",n.fontSize=t.fontSize||"12px",n.content=t.content||"",n.lineDash=t.lineDash,n.approximate=t.approximate||6,n._cacheAngle=void 0,n._cachePoints=[],n._cacheBoundingbox={from:[],to:[]},n}return s(i,[{key:"_calculateAnchorPoints",value:function(){var t=this.from.calculateIntersection(this.to.getCenter()),e=this.to.calculateIntersection(this.from.getCenter());this._cachePoints[0]=t,this._cachePoints[1]=e;var i=e[0]-t[0],n=e[1]-t[1],r=Math.atan2(n,i);this._cacheAngle=r}},{key:"isInViewBox",value:function(t){var e=this.from.getBoundingRect(),i=this.to.getBoundingRect(),n=this._cacheBoundingbox;return yt(n.from,e)&&!yt(n.to,i)||(bt(n.from,e),bt(n.to,i),this._calculateAnchorPoints()),!0}},{key:"render",value:function(t){var e=y(this._cachePoints,2),i=e[0],n=e[1],r=this._cacheAngle,o=n[0]-i[0],s=n[1]-i[1];if(t.fillStyle=t.strokeStyle=this.backgroundColor,t.beginPath(),this.content){t.textAlign="center",t.font="".concat(this.fontSize," ").concat(this.fontFamily),t.textBaseline="middle";var a=t.measureText(this.content),h=a.actualBoundingBoxLeft,c=a.actualBoundingBoxRight,l=a.fontBoundingBoxAscent,u=a.fontBoundingBoxDescent,f=o/2+i[0],d=s/2+i[1];t.fillText(this.content,f,d);var g=Math.abs(h)+Math.abs(c)+20,v=1.5*(Math.abs(l)+Math.abs(u));t.beginPath();var p=new Path2D;p.rect(f-g/2,d-v/2,g,v);var _=Math.min(n[0],i[0])-10,m=Math.min(n[1],i[1])-10,b=Math.abs(o)+20,w=Math.abs(s)+20;p.rect(_,m,b,w),t.clip(p,"evenodd")}t.moveTo(i[0],i[1]),t.lineTo(n[0],n[1]),this.lineDash&&(t.save(),t.setLineDash(this.lineDash)),t.stroke(),this.lineDash&&t.restore(),t.translate(n[0],n[1]),t.rotate(r),t.moveTo(0,0),t.lineTo(-5,-4),t.lineTo(-5,4),t.lineTo(0,0),t.fill(),t.rotate(-r),t.translate(-n[0],-n[1])}},{key:"isHit",value:function(t){if(!this._cachePoints)return!1;var e=y(this._cachePoints,2);return ct(t,e[0],e[1])<this.approximate}}]),i}($t),ae=Math.PI/180,he=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).approximate=t.approximate||6,n.radius=t.radius||0,n.minSpanX=t.minSpanX||10,n.minSpanY=t.minSpanY||10,n.lineDash=t.lineDash,n.doubleLink=t.doubleLink,n.fontFamily=t.fontFamily="-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",n.fontSize=t.fontSize||"12px",n.content=t.content||"",n.isSelf=!!t.isSelf,n.noArrow=!!t.noArrow,n._cacheAngle=[],n._cachePoints=[],n._cacheBoundingbox={from:[],to:[]},n}return s(i,[{key:"_calculateAnchorPoints",value:function(){var t=this.from.getIntersectionsInFourDimension(),e=this.to.getIntersectionsInFourDimension(),i=this._cacheAngle;if(this.isSelf)gt(this._cachePoints,t[this.fromDir],e[rt.SELF],this.fromDir,this.toDir,this.minSpanX,this.minSpanY,!0),i[0]=this.fromDir,i[1]=this.toDir;else if(void 0!==this.fromDir&&void 0!==this.toDir)gt(this._cachePoints,t[this.fromDir],e[this.toDir],this.fromDir,this.toDir,this.minSpanX,this.minSpanY),i[0]=this.fromDir,i[1]=this.toDir;else{var n=lt(t,e);gt(this._cachePoints,n.fromP,n.toP,n.fromDir,n.toDir,this.minSpanX,this.minSpanY),i[0]=n.fromDir,i[1]=n.toDir}}},{key:"isInViewBox",value:function(t){return!!this._static||(this._calculateAnchorPoints(),function(t,e){for(var i=t[0],n=t.length,r=1,o=y(e,4),s=o[0],a=o[1],h=o[2],c=o[3];r<n;){var l=t[r];if(i[0]===l[0]){if(i[0]<h&&i[0]>s&&!(i[1]>c&&l[1]>c||i[1]<a&&l[1]<a))return!0}else if(i[1]<c&&i[1]>a&&!(i[0]>h&&l[0]>h||i[0]<s&&l[0]<s))return!0;i=l,r++}return!1}(this._cachePoints,t))}},{key:"render",value:function(t){var e=this,i=this.radius,n=this._cachePoints,r=n[0],o=n[n.length-1],s=(this._cacheAngle[1]+2)%4*90*ae;if(t.fillStyle=t.strokeStyle=this.backgroundColor,this.doubleLink){var a=(this._cacheAngle[0]+2)%4*90*ae;t.beginPath(),t.translate(r[0],r[1]),t.rotate(a),t.moveTo(5,0),t.lineTo(0,-4),t.lineTo(0,4),t.lineTo(5,0),t.fill(),t.rotate(-a),t.translate(-r[0],-r[1])}if(t.beginPath(),t.moveTo(r[0],r[1]),n.slice(1,n.length-1).forEach((function(r,o){if(e.radius){var s=function(t,e,i,n){var r=vt(e,t),o=vt(e,i),s=pt(r),a=pt(o);if(!s||!a)return{p1:null,p2:null};var h=_t(r,n/s),c=_t(o,n/a);return{p1:vt(e,h),p2:vt(e,c)}}(n[o],r,n[o+2],i),a=s.p1,h=s.p2;a&&h?(t.lineTo(a[0],a[1]),t.quadraticCurveTo(r[0],r[1],h[0],h[1])):t.lineTo(r[0],r[1])}else t.lineTo(r[0],r[1])})),t.lineTo(o[0],o[1]),this.lineDash&&(t.save(),t.setLineDash(this.lineDash)),t.stroke(),this.lineDash&&t.restore(),this.noArrow||(t.beginPath(),t.translate(o[0],o[1]),t.rotate(s),t.moveTo(0,0),t.lineTo(-5,-4),t.lineTo(-5,4),t.lineTo(0,0),t.fill(),t.rotate(-s),t.translate(-o[0],-o[1])),this.content)switch(t.beginPath(),t.font="".concat(this.fontSize," ").concat(this.fontFamily),this.fromDir){case rt.BOTTOM:t.textAlign="left",t.fillText(this.content,r[0]+2,r[1]+10);break;case rt.RIGHT:t.textAlign="left",t.fillText(this.content,r[0]+10,r[1]-2)}}},{key:"isHit",value:function(t){if(this._static)return!1;if(!this._cachePoints)return!1;var e=this._cachePoints,i=e[0],n=e.slice(1);do{var r=n.shift();if(r)if(ct(t,i,r)<this.approximate)return!0;i=r}while(i);return!1}},{key:"cloneStatic",value:function(){var t,e=new i({});return Object.assign(e,(a(t={radius:this.radius,_cachePoints:this._cachePoints,_cacheAngle:this._cacheAngle,backgroundColor:this.backgroundColor,doubleLink:this.doubleLink},"radius",this.radius),a(t,"lineDash",this.lineDash),a(t,"noArrow",this.noArrow),a(t,"content",this.content),a(t,"fontSize",this.fontSize),a(t,"fontFamily",this.fontFamily),a(t,"fromDir",this.fromDir),a(t,"_static",!0),t)),e}}]),i}($t),ce=Math.PI/180,le=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).approximate=t.approximate||6,n.minSpanX=t.minSpanX||0,n.minSpanY=t.minSpanY||0,n.lineDash=t.lineDash,n.doubleLink=t.doubleLink,n.fontFamily=t.fontFamily="-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",n.fontSize=t.fontSize||"12px",n.content=t.content||"",n.isSelf=!!t.isSelf,n}return s(i,[{key:"_calculateAnchorPoints",value:function(){var t=this.from.getIntersectionsInFourDimension(),e=this.to.getIntersectionsInFourDimension();if(this.isSelf){var i=ft(t[this.fromDir],e[rt.SELF],this.fromDir,rt.BOTTOM,this.minSpanX,this.minSpanY);this._cachePoints=[].concat(b(t[this.fromDir]),b(i)),this._cacheAngle=[this.fromDir,rt.BOTTOM]}else if(void 0!==this.fromDir&&void 0!==this.toDir){var n=ft(t[this.fromDir],e[this.toDir],this.fromDir,this.toDir,this.minSpanX,this.minSpanY);this._cachePoints=[].concat(b(t[this.fromDir]),b(n)),this._cacheAngle=[this.fromDir,this.toDir]}else{var r=lt(t,e),o=ft(r.fromP,r.toP,r.fromDir,r.toDir);this._cachePoints=[].concat(b(r.fromP),b(o)),this._cacheAngle=[r.fromDir,r.toDir]}}},{key:"render",value:function(t){this._calculateAnchorPoints();var e=this._cachePoints,i=dt.apply(null,[1].concat(b(e)));if(t.fillStyle=t.strokeStyle=this.backgroundColor,this.doubleLink){var n=(this._cacheAngle[0]+2)%4*90*ce;t.beginPath(),t.translate(e[0],e[1]),t.rotate(n),t.moveTo(5,0),t.lineTo(0,-4),t.lineTo(0,4),t.lineTo(5,0),t.fill(),t.rotate(-n),t.translate(-e[0],-e[1])}if(t.beginPath(),t.moveTo(e[0],e[1]),t.bezierCurveTo.apply(t,b(e.slice(2))),this.lineDash&&(t.save(),t.setLineDash(this.lineDash)),t.stroke(),this.lineDash&&t.restore(),t.beginPath(),t.translate(e[6],e[7]),t.rotate(i),t.moveTo(5,0),t.lineTo(0,-4),t.lineTo(0,4),t.lineTo(5,0),t.fill(),t.rotate(-i),t.translate(-e[6],-e[7]),this.content){t.beginPath();var r=e[0]>e[6],o=function(t,e){var i=1-t,n=i*i*i*e[0]+3*i*i*t*e[2]+3*i*t*t*e[4]+t*t*t*e[6],r=i*i*i*e[1]+3*i*i*t*e[3]+3*i*t*t*e[5]+t*t*t*e[7],o=i*i*(e[2]-e[0])+2*t*i*(e[4]-e[2])+t*t*(e[6]-e[4]),s=i*i*(e[3]-e[1])+2*t*i*(e[5]-e[3])+t*t*(e[7]-e[5]);return[n,r,Math.atan2(s,o)]}(.5,e),s=y(o,3),a=s[0],h=s[1],c=s[2];t.translate(a,h),t.rotate(c),r&&t.rotate(Math.PI),t.font="".concat(this.fontSize," ").concat(this.fontFamily),t.textAlign="center",t.fillText(this.content,0,-(parseInt(this.fontSize)||12)/4),r&&t.rotate(Math.PI),t.rotate(-c),t.translate(-a,-h)}}},{key:"isHit",value:function(t){if(!this._cachePoints)return!1;var e=function(t,e){var i=f(nt,b(e)).project({x:t[0],y:t[1]});return ht(t,[i.x,i.y])}(t,this._cachePoints);return e<this.approximate}}]),i}($t),ue=function(){function t(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,t),this.direction=i.direction||"vertical",this.gap=null!==(e=i.gap)&&void 0!==e?e:5,this.alignment=i.alignment||"center",this.justify=i.justify||"center",this._rawConfigs=i}return s(t,[{key:"reflow",value:function(t){var e=this,i=t._stack.filter((function(t){return t.visible&&!t.absolutePosition})),n=t._stack.filter((function(t){return t.visible&&t.absolutePosition})),r=t.width-t.padding.left-t.padding.right;if("vertical"===this.direction){var o=0,s=0,a=0,h=0,c=i.concat(n);c.forEach((function(t,e){"block"===t.display&&(t.width=0,t.resetChildrenPosition(),t.reflow(),t._getBoundingGroupRect())})),i.forEach((function(t,i){var n=t.getBoundingDimension(),r=n.width,c=n.height,l=i>0?e.gap:0;"outstretch"!==t.display&&(a=Math.max(r,a)),h+=c+l,o+=c/2+l+s,s=c/2,t.anchor=[0,o]})),c.forEach((function(e,i){if("block"===e.display)e.resetChildrenPosition(),e.width=a,e.reflow();else if("outstretch"===e.display){var n=t._belongs.width-t._belongs.padding.left-t._belongs.padding.right;e.resetChildrenPosition(),e.width=Math.max(n,a),e.reflow()}})),a=Math.max(r,a),h/=2,"start"===this.alignment&&i.forEach((function(t,e){var i=t.getBoundingDimension().width;t.anchor[0]=-(a-i)/2,t.anchor[1]-=h})),"end"===this.alignment&&i.forEach((function(t,e){var i=t.getBoundingDimension().width;t.anchor[0]=(a-i)/2,t.anchor[1]-=h})),"center"===this.alignment&&i.forEach((function(t,e){t.getBoundingDimension().width,t.anchor[1]-=h}))}if("horizontal"===this.direction){var l=0,u=0,f=0,d=0;if(i.forEach((function(t,i){var n=t.getBoundingDimension(),r=n.width,o=n.height,s=i>0?e.gap:0;f=Math.max(o,f),d+=r+s,l+=r/2+s+u,u=r/2,t.anchor=[l,0]})),"start"===this.justify){var g=r/2;i.forEach((function(t,e){t.anchor[0]-=g}))}if("end"===this.justify){var v=r/2-d;i.forEach((function(t,e){t.anchor[0]+=v}))}if("center"===this.justify){var p=d/2;i.forEach((function(t,e){t.anchor[0]-=p}))}if("space-between"===this.justify&&i.length>1){var _=Math.max(r,d),m=(_-d)/(i.length-1),y=_/2;i.forEach((function(t,e){t.anchor[0]+=m*e-y}))}"start"===this.alignment&&i.forEach((function(t,e){var i=t.getBoundingDimension().height;t.anchor[1]=-(f-i)/2})),"end"===this.alignment&&i.forEach((function(t,e){var i=t.getBoundingDimension().height;t.anchor[1]=(f-i)/2}))}if(n.length){"block"===t.display?t.getBoundingDimension():t._getBoundingGroupRect();var b=t.width/2,w=t.height/2,k=(t.padding.top-t.padding.bottom)/2,x=(t.padding.left-t.padding.right)/2;n.forEach((function(t){t.anchor=e._resolveAbsoluteAnchor(t.absolutePosition,t,b,w,x,k)}))}}},{key:"_resolveAbsoluteAnchor",value:function(t,e,i,n,r,o){var s=t.top,a=t.right,h=t.bottom,c=t.left,l=t.centerX,u=t.centerY,f=e.getBoundingDimension(),d=f.width/2,g=f.height/2,v=0,p=0;return"number"==typeof s&&(v=s+g-n-o),"number"==typeof a&&(p=i-a-d-r),"number"==typeof h&&(v=n-h-g-o),"number"==typeof c&&(p=c+d-i-r),"number"==typeof l&&(p=l),"number"==typeof u&&(v=u),[p,v]}},{key:"clone",value:function(){return new t(this._rawConfigs)}}]),t}(),fe=function(){function t(e){r(this,t),this.source=e,this.id=e.id,this.type=e.type,this.level=void 0,this.sequence=void 0,this.isFree=!1,this.parent=void 0,this.idx=void 0,this.parentIterateType=void 0,this.hasEndPoint=!1}return s(t,[{key:"reflowPreCalculate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;return this.level=t,this.sequence=e,this.spanX=1,this.spanY=1,i&&i(t,e,this),{spanX:this.spanX,spanY:this.spanY,level:t,sequence:e}}},{key:"makeLink",value:function(t){return this}},{key:"makeEndpoint",value:function(){}},{key:"traverse",value:function(t){t(this)}},{key:"getNodes",value:function(t){var e=[];return this.traverse((function(i){var n=t.getRenderNodeBySource(i.source);n&&e.push(n)})),e}},{key:"linkSource",value:function(t){this.parent.source[this.parentIterateType].splice(this.idx+1,0,t)}},{key:"remove",value:function(){this.parent.source[this.parentIterateType].splice(this.idx,1)}}]),t}(),de=function(t){h(i,t);var e=p(i);function i(t){var n;r(this,i),(n=e.call(this,t)).isroot=!0,n.body=(t.body||[]).map(be("body").bind(g(n)));var o=be("playground").bind(g(n));return n.playground=(t.playground||[]).map((function(t,e){var i=o(t,e);return i.isFree=!0,i})),n}return s(i,[{key:"reflowBodyPreCalculate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=1,r=1;return this.level=t,this.sequence=e,i&&i(t,e,this),this.body.forEach((function(o){var s=o.reflowPreCalculate(t+1,e,i),a=s.spanX,h=s.spanY;n=Math.max(a,n),r+=h,t+=h})),this.spanX=n,this.spanY=r,{spanX:n,spanY:r,level:t,sequence:e}}},{key:"reflowPlaygroundPreCalculate",value:function(t,e){this.playground.forEach((function(i){t(i),i.reflowPreCalculate(0,0,e)}))}},{key:"makeLink",value:function(t){var e;return this.body.forEach((function(i){e?(t({from:e,to:i,part:"body",fromDir:rt.BOTTOM,toDir:rt.TOP}),i=i.makeLink(t),e=i):e=i})),this.playground.forEach((function(e){e.makeLink(t)})),this}},{key:"traverse",value:function(t){this.body.forEach((function(e){e.traverse(t)})),this.playground.forEach((function(e){e.traverse(t)}))}}]),i}(fe),ge=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).consequent=(t.consequent||[]).map(be("consequent").bind(g(n))),n.alternate=(t.alternate||[]).map(be("alternate").bind(g(n))),n.isLocked=!0,n.hasEndPoint=!0,n}return s(i,[{key:"reflowPreCalculate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=1,r=1;this.level=t,this.sequence=e,i&&i(t,e,this);var o=1,s=0,a=0,h=0;this.consequent.forEach((function(n,r){var a=n.reflowPreCalculate(t+1,e,i),h=a.spanX,c=a.spanY;o=Math.max(o,h),s+=c,t+=c}));var c=e+o;t=this.level,this.alternate.forEach((function(e,n){var r=e.reflowPreCalculate(t+1,c,i),o=r.spanX,s=r.spanY;a=Math.max(a,o),h+=s,t+=s})),n=Math.max(1,o+a),r+=Math.max(s,h),t=this.level+r-1;var l=this.Endpoint.reflowPreCalculate(t+1,e,i),u=l.spanY;return r+=u,this.spanX=n,this.spanY=r,{spanX:n,spanY:r,level:t,sequence:e}}},{key:"makeLink",value:function(t){var e=this,i=this;this.consequent.forEach((function(e){t({from:i,to:e,part:"consequent",fromDir:rt.BOTTOM,toDir:rt.TOP}),e=e.makeLink(t),i=e})),t({from:i,to:this.Endpoint,fromDir:rt.BOTTOM,toDir:rt.TOP,part:"consequent"});var n=this;return this.alternate.forEach((function(i){t({from:n,to:i,fromDir:n===e?rt.RIGHT:rt.BOTTOM,toDir:rt.TOP,part:"alternate"}),i=i.makeLink(t),n=i})),t({from:n,to:this.Endpoint,fromDir:n===this?rt.RIGHT:rt.BOTTOM,toDir:rt.RIGHT,part:"alternate"}),this.Endpoint}},{key:"traverse",value:function(t){t(this),this.consequent.forEach((function(e){e.traverse(t)})),this.alternate.forEach((function(e){e.traverse(t)})),console.log(this.Endpoint),t(this.Endpoint)}},{key:"linkSource",value:function(t,e){this.source[e.part].unshift(t)}}]),i}(fe),ve=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).cases=(t.cases||[]).map(be("case").bind(g(n))),n.cases.length&&(n.cases[n.cases.length-1].lastCase=!0),n.isLocked=!0,n.hasEndPoint=!0,n}return s(i,[{key:"reflowPreCalculate",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0,r=1,o=1;this.level=e,this.sequence=i,n&&n(e,i,this);var s=1,a=0;if(this.cases.length){var h=this.cases[this.cases.length-1].consequent;e=this.level,h.forEach((function(t){var r=t.reflowPreCalculate(e+1,i,n),o=r.spanX,h=r.spanY;s=Math.max(s,o),a+=h,e+=h}))}var c=s,l=0;this.cases.forEach((function(r,o){var s=i+c,a=0,h=0;e=t.level,r.alternate.forEach((function(t){var i=t.reflowPreCalculate(e+1,s,n),r=i.spanX,o=i.spanY;a=Math.max(a,r),h+=o,e+=o})),c+=a,l=Math.max(l,h)})),r=Math.max(1,c),o=Math.max(a,l),e=this.level+o;var u=this.Endpoint.reflowPreCalculate(e+1,i,n),f=u.spanY;return o+=f,o+=1,this.spanX=r,this.spanY=o,{spanX:r,spanY:o,level:e,sequence:i}}},{key:"makeLink",value:function(t){var e=this,i=this;this.cases.length&&this.cases[this.cases.length-1].consequent.forEach((function(e,n){t({from:i,to:e,fromDir:rt.BOTTOM,toDir:rt.TOP,part:"consequent"}),i=e.makeLink(t)}));return console.log(i),t({from:i,to:this.Endpoint,fromDir:rt.BOTTOM,toDir:rt.TOP,part:"consequent"}),this.cases.forEach((function(i,n){var r=i;i.alternate.forEach((function(e){t({from:r,to:e,fromDir:r===i?rt.RIGHT:rt.BOTTOM,toDir:rt.TOP,part:"alternate"}),r=e.makeLink(t)})),t({from:r,to:e.Endpoint,fromDir:r===i?rt.RIGHT:rt.BOTTOM,toDir:rt.RIGHT,part:"alternate",minSpanX:32*(n+1)})})),this.Endpoint}},{key:"traverse",value:function(t){t(this),this.cases.forEach((function(e){e.traverse(t)})),t(this.Endpoint)}},{key:"getNodes",value:function(t){var e=[];return this.traverse((function(i){if("SwitchCase"!==i.type){var n=t.getRenderNodeBySource(i.source);n&&e.push(n)}})),e}},{key:"linkSource",value:function(t,e){var i=this.source.cases;i[i.length-1].consequent.unshift(t)}}]),i}(fe),pe=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i)}(fe),_e=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).body=(t.body||[]).map(be("body").bind(g(n))),n.isLocked=!0,n}return s(i,[{key:"reflowPreCalculate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=1,r=1;this.level=t,this.sequence=e,i&&i(t,e,this);var o=e+1;return this.body.forEach((function(e){var s=e.reflowPreCalculate(t+1,o,i),a=s.spanX,h=s.spanY;n=Math.max(a,n),r+=h,t+=h})),this.spanX=n+1,this.spanY=r,{spanX:n,spanY:r,level:t,sequence:e}}},{key:"makeLink",value:function(t){var e=this,i=this;return this.body.forEach((function(n,r){t({from:i,to:n,part:"body",fromDir:i===e?rt.RIGHT:rt.BOTTOM,toDir:rt.TOP}),n=n.makeLink(t),i=n})),t({from:i,to:this,part:"body",fromDir:i===this?rt.RIGHT:rt.BOTTOM,anticlock:i===this,toDir:rt.BOTTOM,isSelf:!0,minSpanX:20,minSpanY:20}),this}},{key:"traverse",value:function(t){t(this),this.body.forEach((function(e){e.traverse(t)}))}},{key:"linkSource",value:function(t,e){this.source[e.part].unshift(t)}}]),i}(fe),me=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).consequent=(t.consequent||[]).map(be("consequent").bind(g(n))),n.alternate=(t.alternate||[]).map(be("alternate").bind(g(n))),n.lastCase=!1,n}return s(i,[{key:"reflowPreCalculate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=1,r=1;this.level=t,this.sequence=e,i&&i(t,e,this);var o=0,s=0,a=0,h=0;this.lastCase&&this.consequent.forEach((function(n,r){var a=n.reflowPreCalculate(t+1,e,i),h=a.spanX,c=a.spanY;o=Math.max(o,h),s+=c,t+=c}));var c=e+Math.max(o,1);return t=this.level,this.alternate.forEach((function(e,n){var r=e.reflowPreCalculate(t+1,c,i),o=r.spanX,s=r.spanY;a=Math.max(a,o),h+=s,t+=s})),n=Math.max(1,o+a),r+=Math.max(s,h),this.spanX=n,this.spanY=r,{spanX:n,spanY:r,level:t,sequence:e}}},{key:"traverse",value:function(t){t(this),this.consequent.forEach((function(e){e.traverse(t)})),this.alternate.forEach((function(e){e.traverse(t)}))}},{key:"linkSource",value:function(t,e){this.source[e.part].unshift(t)}}]),i}(fe),ye={IfStatement:ge,SwitchStatement:ve,SwitchCase:me,ForEachStatement:pe,WhileStatement:_e,Root:de,other:fe};function be(t){return function(e,i){var n=we(e);if(n.parent=this,n.idx=i,n.parentIterateType=t,n.hasEndPoint){e.__endpoint__||(e.__endpoint__={type:"endpoint",id:"".concat(n.id,"-endpoint")});var r=we(e.__endpoint__);r.parent=this,r.idx=i,r.parentIterateType=t,n.Endpoint=r}return n}}function we(t){var e=t.type;return new(ye[e]||ye.other)(t)}function ke(t){return t*t}var xe=function(){function t(e){var i;r(this,t),this.linkLength=e.linkLength||18,this.gap=e.gap||30,this.treeItemDraggable=null===(i=e.treeItemDraggable)||void 0===i||i,this.reOrder(e.ast),this.static=!0}return s(t,[{key:"reOrder",value:function(t){var e=this;this.ast=t,this.flowStack=[],this.flowLinkStack=[],this.root=we(this.ast),this.root.traverse((function(t){"playground"!==t.parentIterateType&&(t.isDraggable=e.treeItemDraggable),e.flowStack.push({type:t.type,source:t.source,layoutNode:t})}));var i,n={vertical:{},horizontal:{}},r={};this.root.reflowBodyPreCalculate(0,0,(function(t,e,i){i.isroot||(n.vertical[t]||(n.vertical[t]={}),n.vertical[t][e]=i,n.horizontal[e]||(n.horizontal[e]={}),n.horizontal[e][t]=i)})),this.root.reflowPlaygroundPreCalculate((function(t){i=t.id,r[t.id]={vertical:{},horizontal:{},node:t}}),(function(t,e,n){var o=r[i];o.vertical[t]||(o.vertical[t]={}),o.vertical[t][e]=n,o.horizontal[e]||(o.horizontal[e]={}),o.horizontal[e][t]=n})),this.layoutMapping=n,this.playgroundLayoutMapping=r,this.root.makeLink((function(t){e.flowLinkStack.push(t)}))}},{key:"staticCheck",value:function(t,e){if(t._layoutNode&&t._layoutNode.isFree)return!1;if(!e._linkStack.find((function(e){return e.from===t||e.to===t})))return!1;var i=t.anchor.slice();if(e.reflow(),!(e._linkStack.length<2)){var n,r,o=t.anchor;return(r=o,ke((n=i)[0]-r[0])+ke(n[1]-r[1]))>1e3&&(t.dispatchEvent(new jt("outOfFlow",{anchor:i,instance:t,jflow:e,point:i})),!0)}}},{key:"reflowByMapping",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=this.linkLength,o=this.gap,s=e.vertical,a=e.horizontal,h=i;Object.keys(a).forEach((function(e,i){var n=a[e],r=0,s=Object.keys(n);s.forEach((function(e){var i=n[e],o=t.getRenderNodeBySource(i.source).getBoundingDimension().width;r=Math.max(o,r)})),h+=0===i?0:r/2,s.forEach((function(e){var i=n[e];t.getRenderNodeBySource(i.source).anchor[0]=h})),h+=r/2+o}));var c=n;Object.keys(s).forEach((function(e,i){var n=s[e],o=0,a=Object.keys(n);a.forEach((function(e){var i=n[e],r=t.getRenderNodeBySource(i.source).getBoundingDimension(),s=r.height;r.width,o=Math.max(s,o)})),c+=0===i?0:o/2,a.forEach((function(e){var i=n[e];t.getRenderNodeBySource(i.source).anchor[1]=c})),c+=o/2+r}))}},{key:"findLayoutNode",value:function(t){var e=this.flowStack.find((function(e){return e.configs===t}));return e?e.layoutMeta:null}},{key:"reflow",value:function(t){var e=this;this.reflowByMapping(t,this.layoutMapping),Object.values(this.playgroundLayoutMapping).forEach((function(i){var n=t.getRenderNodeBySource(i.node.source);e.reflowByMapping(t,i,n.anchor[0],n.anchor[1])}))}}]),t}(),Te=s((function t(e,i,n){r(this,t),this.type="ERProperty",this.source=e,this.node=i,this.ref=e.ref,this.type=e.type,this.association=e.association,this.id=n?"".concat(i.id,"-").concat(e.name,"-navigation"):"".concat(i.id,"-").concat(e.name),this._selfLink=!1,this.parentPropertyRef=void 0,this.getJflowInstance=void 0,this.doubleRef=void 0})),Se=function(){function t(e){var i=this;r(this,t),this.type="ERNode",this.source=e,this.id=e.name,this.isDraggable=!0,this.getJflowInstance=void 0,this.propertyList=e.propertyList.map((function(t){return new Te(t,i)})),this.navigationPropertyList=e.navigationPropertyList.map((function(t){return new Te(t,i,!0)})),this.idProperty=this.propertyList.find((function(t){return"id"===t.source.name}))}return s(t,[{key:"_traverseProperty",value:function(t){var e=this;this.propertyList.forEach((function(i){var n=i.source.idRef;if(i.source.isParentRef,n&&"Array"!==i.source.type&&t[n]){var r=t[n];i.source.isParentRef&&(e.parentRef=r),r===e&&(i._selfLink=!0),i.parentPropertyRef=r.idProperty}})),this.navigationPropertyList.forEach((function(i){var n=i.source.objectRef;if(n&&t[n]){var r=t[n],o=r.navigationPropertyList.find((function(t){return t.source.objectRef===e.id}));r===e&&(i._selfLink=!0),i.doubleRef=o}}))}},{key:"traverse",value:function(e){e(this),this.propertyList.forEach((function(i){i.ref instanceof t&&e(i)}))}},{key:"makeLink",value:function(t){this.propertyList.forEach((function(e){if(e.parentPropertyRef instanceof Te){var i=e.parentPropertyRef;e._selfLink?t({from:e.id,to:i.id,part:"property",fromDir:rt.LEFT,toDir:rt.LEFT,content:e.association,minSpanX:80,meta:{from:e,to:i}}):t({from:e.id,to:i.id,part:"property",content:e.association,meta:{from:e,to:i}})}})),this.navigationPropertyList.forEach((function(e){if(e.doubleRef instanceof Te){var i=e.doubleRef;e._selfLink?t({from:e.id,to:i.id,part:"property",fromDir:rt.LEFT,toDir:rt.TOP,lineDash:[10,5],doubleLink:!0,content:e.association,minSpanX:80,minSpanY:80,meta:{from:e,to:i}}):t({from:e.id,to:i.id,part:"property",lineDash:[10,5],doubleLink:!0,content:e.association,meta:{from:e,to:i,isObjectRef:!0}})}}))}}]),t}();var Ee=function(){function t(e){r(this,t),this.static=!1,this.flowStack=[],this.flowLinkStack=[],this.erNodes=[],this.reOrder(e.entityRelationship)}return s(t,[{key:"reOrder",value:function(t){var e=this;this.er=t,this.flowStack=[],this.flowLinkStack=[];var i=function(t){var e={},i=t.map((function(t){var i=new Se(t);return e[t.name]=i,i}));return i.forEach((function(t){t._traverseProperty(e)})),i}(this.er),n=[];i.forEach((function(t){t.traverse((function(t){e.flowStack.push({type:t.type,configs:t.source,layoutMeta:t})})),t.makeLink((function(t){var i=t.from,r=t.to,o=t.meta;if(o.isObjectRef){var s="".concat(i,"-").concat(r),a="".concat(r,"-").concat(i),h=o.from;if(n.includes(s)||n.includes(a))return;h.source.isParentRef||(n.push(s),n.push(a),e.flowLinkStack.push(t))}else e.flowLinkStack.push(t)}))})),this.erNodes=i}},{key:"staticCheck",value:function(t,e){return!1}},{key:"reflow",value:function(t){this.flowLinkStack,this.erNodes;var e={},i=1e3;function n(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=[0,0];return t.parentRef?e.includes(t.parentRef)?[r[0]-500+t.source.diagramWeight*i,r[1]]:(e.push(t.parentRef),[(r=n(t.parentRef,e))[0]-500+t.source.diagramWeight*i,r[1]+600]):r}this.erNodes.forEach((function(t){var i=t.getJflowInstance(),r=y(n(t),2),o=r[0],s=r[1];e[s]||(e[s]=[]),e[s].push(t),i.anchor=[o+500*e[s].length,s]}))}}]),t}(),Ce="input",Oe="control",Pe="input",Be="compositionstart",Me="compositionupdate",Re="compositionend",Ie="enter",Le="delete",De="backspace",je="arrowLeft",Ae="arrowRight",We="arrowUp",He="arrowDown",ze="undo",Xe="redo",Ye="shift_down",Fe="shift_up",Ne="ctrla",qe="ctrlc",Ge="ctrlv",Ve="ctrlx",Ue="startedit",Ze="editclick",Ke="shiftonclick",Je="doubleclick",$e=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),a(g(n=e.call(this)),"_inputElement",null),n._inputElement=function(t){var e=document.createElement("input");e.setAttribute("style","\n        width: 100px;\n        position: absolute;\n        left: 0;\n        top: 0;\n        border:none;\n        opacity: 0;\n        z-index: -1;\n        contain: strict;"),e.setAttribute("tabindex",-1),e.setAttribute("aria-hidden",!0),e.setAttribute("spellcheck",!1),e.setAttribute("autocorrect","off");var i=!1,n={ctrlOn:!1,shiftOn:!1};return e.addEventListener("beforeinput",(function(e){e.preventDefault(),e.data&&(i||t(Pe,e.data))})),e.addEventListener("compositionstart",(function(e){t(Be),i=!0})),e.addEventListener("compositionupdate",(function(e){t(Me,e.data)})),e.addEventListener("compositionend",(function(n){t(Re,n.data),e.value="",i=!1})),e.addEventListener("keyup",(function(e){if(!i)switch(e.key){case"Shift":t(Fe),n.shiftOn=!1;break;case"Meta":case"Control":n.ctrlOn=!1}})),e.addEventListener("keydown",(function(e){if(!i){switch(e.code){case"Enter":t(Ie);break;case"Backspace":t(De);break;case"Delete":t(Le);break;case"ArrowLeft":t(je);break;case"ArrowRight":t(Ae);break;case"ArrowDown":t(He);break;case"ArrowUp":t(We)}switch(e.key){case"Shift":t(Ye),n.shiftOn=!0;break;case"Meta":case"Control":n.ctrlOn=!0;break;case"a":n.ctrlOn&&t(Ne);break;case"c":n.ctrlOn&&t(qe);break;case"v":n.ctrlOn&&t(Ge);break;case"x":n.ctrlOn&&t(Ve);break;case"y":n.ctrlOn&&(e.preventDefault(),t(Xe));break;case"z":n.ctrlOn&&n.shiftOn?t(Xe):n.ctrlOn&&t(ze)}}})),e}(n.controlCallback.bind(g(n))),t.append(n._inputElement),n._inputElement.focus(),n}return s(i,[{key:"controlCallback",value:function(t,e){switch(t){case Pe:case Be:case Me:case Re:case Ie:case De:case Le:this.dispatchEvent(new CustomEvent(Ce,{detail:{kind:t,data:e}}));break;case je:case Ae:case We:case He:case Ne:case Ye:case Fe:case ze:case Xe:this.dispatchEvent(new CustomEvent(Oe,{detail:{kind:t}}))}}},{key:"focus",value:function(){this._inputElement.focus({preventScroll:!0})}},{key:"syncPosition",value:function(t,e){this._inputElement.style.transform="translate(".concat(t,"px, ").concat(e,"px)")}},{key:"destroy",value:function(){this._inputElement.remove()}}]),i}(d(EventTarget));var Qe=function(){function t(){r(this,t),a(this,"_row",0),a(this,"_column",[0,0]),a(this,"_status",{show:!0,anime:null,lastElapsed:0,refreshElapsed:!1})}return s(t,[{key:"setRow",value:function(t){this._row=t}},{key:"setColumn",value:function(t,e){void 0!==e?this._column[t]=e:this._column=t}},{key:"getRow",value:function(){return this._row}},{key:"getColumn",value:function(t){return void 0!==t?this._column[t]:this._column}},{key:"animate",value:function(t){var e=this;this._status.anime=t.requestJFlowAnime((function(t){var i=e._status.lastElapsed;e._status.refreshElapsed&&(e._status.lastElapsed=t,e._status.refreshElapsed=!1),t-i>500&&(e._status.show=!e._status.show,e._status.lastElapsed=t)}))}},{key:"cancelAnimate",value:function(){this._status.anime.cancel(),Object.assign(this._status,{show:!0,anime:null,lastElapsed:0})}},{key:"isShow",value:function(){return this._status.show}},{key:"refresh",value:function(){Object.assign(this._status,{show:!0,refreshElapsed:!0})}},{key:"toRange",value:function(){return[this._row].concat(b(this._column))}},{key:"fromRange",value:function(t){this._row=t[0],this._column=t.slice(1)}}]),t}();var ti=function(){function t(){r(this,t),a(this,"_lines",[])}return s(t,[{key:"get",value:function(t){return this._lines[t]}},{key:"getLineAbove",value:function(t){for(var e=0,i=this._lines;e<i.length&&!(i[e].reduceHeight>t);)e++;return Math.min(e,i.length-1)}},{key:"truncate",value:function(t){var e=ei.create(t);return this._lines=[e],e}},{key:"push",value:function(t){this._lines.push(t)}},{key:"forEach",value:function(t){this._lines.forEach(t)}},{key:"length",value:function(){return this._lines.length}}]),t}(),ei=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,t),a(this,"width",0),a(this,"anchorY",0),a(this,"height",0),a(this,"reduceHeight",0),a(this,"_elements",[]),a(this,"_elements",[]),Object.assign(this,e)}return s(t,[{key:"get",value:function(t){return this._elements[t]}},{key:"length",value:function(){return this._elements.length}},{key:"insert",value:function(t,e){this._elements.splice(t,0,e)}},{key:"push",value:function(t){this._elements.push(t)}},{key:"tail",value:function(){return this._elements[this._elements.length-1]}},{key:"copy",value:function(){return this._elements.slice()}},{key:"getColumnNearest",value:function(t,e,i,n){var r=this._elements;if(t>=this.width){var o=r.length-1,s=r[o],a=0;return"text"===s.type&&(a=s.source.length),[o,a]}for(var h=0,c=0,l=0,u=null;h<r.length-1;){c=l;var f=r[h];if("text"!==f.type){var d=u&&"text"===u.type?2*e:e;l+=f.width+d}else l+=f.width;if(l>t){u=f;break}u=f,h++}l<=t&&(c=l);var g=r[h];if("text"===g.type){var v=function(t,e,i,n){var r=e.source,o=r.length-1;if(0===e.width)return 0;var s=e.width,a=Math.floor(t/s*o);return M((function(e){var h,c,l;e.font="".concat(i," ").concat(n);var u=r.substring(0,a),f=r.substring(a-1,a),d=r.substring(a,a+1),g=e.measureText(u).width,v=e.measureText(f).width,p=e.measureText(d).width;h=g-v/2,c=g+p/2;do{if(h<=t&&c>=t)break;if(h>t){var _=c-t;l=a,a-=_<100?1:Math.floor(_/c*l),u=r.substring(a,l),g-=e.measureText(u).width}else if(c<t){var m=t-h;l=a,a+=m<100?1:Math.floor(m/(s-h)*(o-l)),u=r.substring(l,a),g+=e.measureText(u).width}f=r.substring(a-1,a),d=r.substring(a,a+1),h=g-(v=e.measureText(f).width)/2,c=g+(p=e.measureText(d).width)/2}while(a>=0&&a<=o)})),a}(t-c,g,i,n);return[h,v]}return t-c>u.width/2?[h+1,0]:[h,0]}},{key:"forEach",value:function(t){this._elements.forEach(t)}}],[{key:"create",value:function(e){return new t(e)}}]),t}(),ii=function(){function t(){r(this,t),a(this,"_textElements",[]),a(this,"_records",[]),a(this,"_caretRecord",null)}return s(t,[{key:"insertBefore",value:function(t,e){var i=this.findIndex(t);this.inersetAt(i,e)}},{key:"insertAfter",value:function(t,e){var i=this.findIndex(t);this.get(i+1)&&e.setNeedWrap(t.needWrap||t.isTail),this.inersetAt(i+1,e)}},{key:"findIndex",value:function(t){return this._textElements.findIndex((function(e){return e===t}))}},{key:"get",value:function(t){return this._textElements[t]}},{key:"from",value:function(t){this._textElements=t}},{key:"inersetAt",value:function(t,e){this.splice(t,0,e)}},{key:"push",value:function(t){this.splice(this.length(),0,t)}},{key:"remove",value:function(t){this.splice(t,1)}},{key:"splice",value:function(){var t,e=(t=this._textElements).splice.apply(t,arguments);this._records.push({op:"splice",args:arguments,removed:e})}},{key:"copy",value:function(){return this._textElements.slice()}},{key:"isEmpty",value:function(){return 1===this._textElements.length&&""===this._textElements[0].source}},{key:"forEach",value:function(t){this._textElements.forEach(t)}},{key:"tail",value:function(){return this._textElements[this._textElements.length-1]}},{key:"filter",value:function(t){return this._textElements.filter(t)}},{key:"length",value:function(){return this._textElements.length}},{key:"startRecord",value:function(){return this._caretRecord={before:null,after:null},this._records=[],this._records}},{key:"getRecord",value:function(){return this._records}},{key:"recordBeforeCaret",value:function(t){this._caretRecord.before=t.toRange()}},{key:"recordAfterCaret",value:function(t){this._caretRecord.after=t.toRange()}},{key:"getCaretRecord",value:function(){return this._caretRecord}},{key:"collectRecords",value:function(){return this._records}}],[{key:"create",value:function(e){var i=new t;return i.from(e),i}}]),t}(),ni=function(){function t(e,i){r(this,t),a(this,"needWrap",!1),a(this,"width",0),a(this,"reduceWidth",0),a(this,"height",0),a(this,"anchorX",0),a(this,"anchorY",0),a(this,"dirty",!0),a(this,"isTail",!1),this.type=e,this.source=i}return s(t,[{key:"setSource",value:function(t,e){var i=this.source;this.source=t,this.dirty=!0,e&&e.push({op:"setSource",args:[this,t,i]})}},{key:"setNeedWrap",value:function(t,e){var i=this.needWrap;this.needWrap=t,i!==t&&e&&e.push({op:"setNeedWrap",args:[this,t,i]})}},{key:"shift",value:function(t,e){if("text"===this.type){var i=this.source.length,n=t+e;return n<0?"prev":n>i?"next":"self"}return e>0?"next":e<0?"prev":void 0}},{key:"tailOffset",value:function(){return"text"===this.type?this.needWrap||this.isTail?this.source.length:Math.max(0,this.source.length-1):0}},{key:"headOffset",value:function(){return 0}}]),t}(),ri=function(){function t(){r(this,t),a(this,"_enable",!1),a(this,"_rangeFrom",null),a(this,"_rangeTo",null),a(this,"_initialRange",null)}return s(t,[{key:"setInitialRange",value:function(t){this._initialRange=t}},{key:"getRangeFrom",value:function(){return this._rangeFrom}},{key:"getRangeTo",value:function(){return this._rangeTo}},{key:"isEnable",value:function(){return this._enable}},{key:"enable",value:function(){this._enable=!0}},{key:"disable",value:function(){this._enable=!1}},{key:"handleCaret",value:function(t){var e=y(this._rangeTo,3),i=e[0],n=e[1],r=e[2];t.setRow(i),t.setColumn([n,r])}},{key:"setRange",value:function(t){var e=this._initialRange;this._compareRange(e,t)?(this._rangeFrom=e,this._rangeTo=t):(this._rangeFrom=t,this._rangeTo=e)}},{key:"_compareRange",value:function(t,e){return!(t[0]>e[0])&&(!(t[0]===e[0]&&t[1]>e[1])&&!(t[0]===e[0]&&t[1]===e[1]&&t[2]>e[2]))}},{key:"delete",value:function(t,e){if(this._enable){var i=t._area,n=t._caret,r=this._rangeFrom,o=this._rangeTo,s=i.get(r[0]).get(r[1]),a=i.get(o[0]).get(o[1]),h=y(r,3),c=h[0],l=h[1],u=h[2];if(e.push({op:"range",args:[r.slice(),o.slice()]}),s===a){var f=s.source;s.setSource(f.substring(0,r[2])+f.substring(o[2]),e),s.dirty=!0}else{var d,g,v=t._flattenTxtElem,p="",_="",m=v.findIndex(s),b=v.findIndex(a),w=!1;if("text"===s.type?p=s.source.substring(0,r[2]):d=v.get(m-1),"text"===a.type?(_=a.source.substring(o[2]),w=a.needWrap):g=v.get(b-1),d)if(v.splice(m,b-m+1),"text"===d.type)d.needWrap?c-=1:l-=1,u=d.source.length,d.setSource(d.source+_,e),d.dirty=!0,d.setNeedWrap(w,e);else{var k=new ni("text",p+_);k.setNeedWrap(w,e),v.splice(m,0,k)}else if(v.splice(m,b-m),g){var x=new ni("text",p);v.splice(m,0,x)}else a.setSource(p+_,e),a.dirty=!0;0===v.length()&&v.push(new ni("text",""))}this.disable(),n.setRow(c),n.setColumn([l,u])}}}]),t}();function oi(t){return 1===t.length&&"setSource"===t[0].op}var si=function(){function t(){r(this,t),a(this,"_undo",[]),a(this,"_redo",[]),a(this,"_editor",null)}return s(t,[{key:"write",value:function(e,i){if(0!==e.length){if(oi(e)){var n=e[0],r=this.getLastUndo();if(r&&oi(r._batch)){var o=r._batch[0];if(o.args[0]===n.args[0])return o.args[1]=n.args[1],void(r._caretMetaTo=i.after)}}var s=new ai(e);s._caretMetaFrom=i.before,s._caretMetaTo=i.after,this._undo.push(s),this._undo.length>t.length&&this._undo.splice(0,1),this._redo.length&&(this._redo=[])}}},{key:"getLastUndo",value:function(){return this._undo[this._undo.length-1]}},{key:"undo",value:function(){var t=this._undo.pop();return t&&(t.undo(this._editor),this._redo.push(t)),t}},{key:"redo",value:function(){for(var t=this._redo.pop();t&&t.SKIP_REDO;)t=this._redo.pop();return t&&(t.redo(this._editor),this._undo.push(t)),t}}]),t}();a(si,"length",50);var ai=function(){function t(e){r(this,t),a(this,"_batch",[]),a(this,"_caretMetaFrom",null),a(this,"_caretMetaTo",null),this._batch=e}return s(t,[{key:"updateCaretMetaTo",value:function(t){this._caretMetaTo=t}},{key:"undo",value:function(t){this._batch.slice().reverse().forEach((function(e){switch(e.op){case"range":var i=y(e.args,2),n=i[0],r=i[1],o=t._range;o.setInitialRange(n),o.setRange(r),o.enable();break;case"setSource":var s=y(e.args,3),a=s[0];s[1];var h=s[2];a.source=h,a.dirty=!0;break;case"setNeedWrap":var c=y(e.args,3),l=c[0];c[1];var u=c[2];l.needWrap=u,l.dirty=!0;break;case"splice":var f=t._flattenTxtElem,d=w(m=e.args)||k(m)||x(m)||S(),g=d[0];d[1];var v=d.slice(2),p=e.removed,_=0;v&&(_=v.length),f.splice.apply(f,[g,_].concat(b(p)))}var m})),t._caret.fromRange(this._caretMetaFrom)}},{key:"redo",value:function(t){this._batch.forEach((function(e){switch(e.op){case"setSource":var i=y(e.args,3),n=i[0],r=i[1];i[2],n.source=r,n.dirty=!0;break;case"setNeedWrap":var o=y(e.args,3),s=o[0],a=o[1];o[2],s.needWrap=a,s.dirty=!0;break;case"splice":var h=t._flattenTxtElem;h.splice.apply(h,b(e.args))}})),t._caret.fromRange(this._caretMetaTo)}}]),t}(),hi=function(){function t(e){r(this,t),this._editor=e}return s(t,[{key:"exec",value:function(){}}],[{key:"create",value:function(t){return new this(t)}}]),t}(),ci=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor;t._range.disable();var e=t._flattenTxtElem,i=t._caret,n=i.getRow(),r=y(i.getColumn(),2),o=r[0],s=r[1],a=t._area.get(n),h=a.get(o),c=e.findIndex(h);switch(h.shift(s,-1)){case"prev":if(o>0){var l=a.get(o-1);i.setColumn([o-1,l.tailOffset()])}else if(c>0){var u=n-1,f=t._area.get(u).length()-1,d=e.get(c-1).tailOffset();i.setRow(u),i.setColumn([f,d])}break;case"self":i.setColumn(1,s-1)}i.refresh(),t.syncShadowInputPosition(),t._jflow._render()}}]),i}(hi);a(ci,"name",je);var li=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor;t._range.disable();var e=t._flattenTxtElem,i=t._caret,n=i.getRow(),r=y(i.getColumn(),2),o=r[0],s=r[1],a=t._area.get(n),h=a.get(o),c=e.findIndex(h);switch(h.shift(s,1,c===e.length()-1)){case"next":if(o<a.length()-1){var l=a.get(o+1);"text"===h.type&&"text"!==l.type?i.setColumn([o+2,l.headOffset()]):i.setColumn([o+1,l.headOffset()])}else if(c<e.length()-1){var u=n+1,f=e.get(c+1).headOffset();i.setRow(u),i.setColumn([0,f])}break;case"self":i.setColumn(1,s+1)}i.refresh(),t.syncShadowInputPosition(),t._jflow._render()}}]),i}(hi);a(li,"name",Ae);var ui=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){this._editor._range.disable();var t=this._editor._caret.getRow()-1;t>-1&&this._handler(t)}}]),i}(hi);a(ui,"name",We);var fi=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){this._editor._range.disable();var t=this._editor._caret.getRow()+1;t<this._editor._area.length()&&this._handler(t)}}]),i}(hi);a(fi,"name",He);var di={_handler:function(t){var e=this._editor,i=e._caret,n=i.getRow(),r=y(i.getColumn(),2),o=r[0],s=r[1],a=e._area,h=a.get(n).get(o),c=h.reduceWidth;s>0&&(c+=e.measureTextWidth(h.source.substring(0,s)));var l=a.get(t).getColumnNearest(c,e.elementSpace,e.fontSize,e.fontFamily);i.setRow(t),i.setColumn(l),i.refresh(),e.syncShadowInputPosition(),e._jflow._render()}};function gi(t,e,i,n){if(!t)return[i,!1];if("text"===t.type&&"text"===e.type){var r=t.source.length;return t.setSource(t.source+e.source,n),t.setNeedWrap(e.needWrap,n),[r,!0]}return[i,!1]}Object.assign(ui.prototype,di),Object.assign(fi.prototype,di);var vi=function(t){h(i,t);var e=p(i);function i(){var t;r(this,i);for(var n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return a(g(t=e.call.apply(e,[this].concat(o))),"cacheIdx",null),t}return s(i,[{key:"exec",value:function(t,e){var i=this._editor,n=i._range,r=i._caret,o=i._flattenTxtElem,s=i._undoredo,a=o.startRecord();if(o.recordBeforeCaret(r),n.isEnable()&&(n.delete(i,a),t===De||t===Le))return o.collectRecords(),o.recordAfterCaret(r),this._editor.refresh(),void s.write(a,o.getCaretRecord());var h=r.getRow(),c=y(r.getColumn(),2),l=c[0],u=c[1],f=i._area,d=f.get(h),g=d.get(l),v=d.get(l-1),p="";if("text"===g.type)p=g.source;else if("text"===(null==v?void 0:v.type))g=v,u=(p=v.source).length,r.setColumn([l-1,p.length]);else{var _=new ni("text","");o.insertBefore(g,_),g=_}var m,b=p.substring(0,u);switch(m=this.cacheIdx?p.substring(this.cacheIdx[1]):p.substring(u),t){case Pe:if(/\r?\n/.test(e)){var w=e.split(/\r?\n/);w=w.replace(/\t/,"");var k=o.findIndex(g),x=w.shift();g.setSource(b+x,a);var T=h+1;for(k++;w.length>1;){var S=new ni("text",w.shift());S.setNeedWrap(!0,a),T++,o.inersetAt(k,S),k++}x=w.shift();var E=o.get(k);if(E&&"text"===E.type)E.setSource(x+E.source,a);else{var C=new ni("text",x);o.inersetAt(k,C)}r.setRow(T),r.setColumn([0,x.length])}else b+=e,r.setColumn(1,r.getColumn(1)+e.length),g.setSource(b+m,a);break;case Be:this.cacheIdx=[b.length,b.length];break;case Me:b=b.substring(0,this.cacheIdx[0]),b+=e,g.setSource(b+m,a);var O=this.cacheIdx[0]+e.length;r.setColumn(1,O),this.cacheIdx[1]=O;break;case Re:b=b.substring(0,this.cacheIdx[0]),r.setColumn(1,this.cacheIdx[0]+e.length),this.cacheIdx=null,b+=e,g.setSource(b+m,a);break;case Ie:g.setSource(b,a),g.setNeedWrap(!0,a);var P=new ni("text",m);o.insertAfter(g,P),r.setRow(h+1),r.setColumn([0,0]);break;case De:switch(g.shift(u,-1)){case"prev":var B=o.findIndex(g);if(l>0){o.splice(B-1,1),B-=1;var M=y(gi(o.get(B-1),g,0,a),2),R=M[0];M[1]&&o.remove(B),r.setColumn([l-(R>0?2:1),R])}else if(B>0){var I=h-1,L=f.get(I).length()-1,D=y(gi(o.get(B-1),g,0,a),2),j=D[0];D[1]&&o.remove(B),r.setRow(I),r.setColumn([L,j])}break;case"self":b=b.substring(0,b.length-1),r.setColumn(1,r.getColumn(1)-1),g.setSource(b+m,a)}break;case Le:switch(g.shift(u,1)){case"next":var A=o.findIndex(g);if(l<d.length()-1){o.splice(A+1,1);var W=y(gi(g,o.get(A+1),g.source.length,a),2),H=W[0];W[1]&&o.remove(A+1),r.setColumn([l,H])}else if(A<o.length()-1){var z=y(gi(g,o.get(A+1),g.source.length,a),2),X=z[0];z[1]&&o.remove(A+1),r.setColumn([l,X])}break;case"self":m=m.substring(1),g.setSource(b+m,a)}}o.collectRecords(),o.recordAfterCaret(r),s.write(a,o.getCaretRecord()),this._editor.refresh()}}]),i}(hi);a(vi,"name",Ce);var pi=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor;if(this._startEdit()){var e=t._jflow;t.moveCaretByHitPoint(),t.createShadowInput(),t._caret.animate(e),t.syncShadowInputPosition()}}},{key:"_startEdit",value:function(){var t=!0,e=this._editor;return e.dispatchEvent(new jt("edit",{target:e,preventDefault:function(){t=!1}})),t}}]),i}(hi);a(pi,"name",Ue);var _i=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor;t.moveCaretByHitPoint(),t._caret.refresh(),t.syncShadowInputPosition(),t._range.disable()}}]),i}(hi);a(_i,"name",Ze);var mi=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor;t.moveCaretByHitPoint();var e=t._caret,i=t._range,n=t._area,r=e.getRow(),o=n.get(r),s=o.length()-1;i.setInitialRange([r,0,0]),i.setRange([r,s,o.tail().tailOffset()]),i.handleCaret(e),i.enable(),t.syncShadowInputPosition()}}]),i}(hi);a(mi,"name",Je);var yi=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){this._editor._range.setInitialRange(null),this._editor.toggleShift(!1)}}]),i}(hi);a(yi,"name",Fe);var bi=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor._range,e=this._editor._caret;t.setInitialRange(e.toRange()),this._editor.toggleShift(!0)}}]),i}(hi);a(bi,"name",Ye);var wi=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor;t.moveCaretByHitPoint();var e=this._editor._caret,i=this._editor._range;i.setRange(e.toRange()),i.enable(),i.handleCaret(e),e.refresh(),t.syncShadowInputPosition()}}]),i}(hi);a(wi,"name",Ke);var ki=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){var t=this._editor,e=t._caret,i=t._range,n=t._area,r=n.length()-1,o=n.get(r),s=o.length()-1;i.setInitialRange([0,0,0]),i.setRange([r,s,o.tail().tailOffset()]),i.handleCaret(e),i.enable(),t.syncShadowInputPosition()}}]),i}(hi);a(ki,"name",Ne);var xi=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){this._editor._range.disable(),this._editor._undoredo.undo(),this._editor.refresh()}}]),i}(hi);a(xi,"name",ze);var Ti=function(t){h(i,t);var e=p(i);function i(){return r(this,i),e.apply(this,arguments)}return s(i,[{key:"exec",value:function(){this._editor._range.disable(),this._editor._undoredo.redo(),this._editor.refresh()}}]),i}(hi);a(Ti,"name",Xe);var Si,Ei,Ci,Oi=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this,t)).initStack(t),n.initLayout(t),n._undoredo=new si,n._undoredo._editor=g(n),n._caret=new Qe,n._range=new ri,n._shadowInput=void 0,n.textColor=t.textColor||"transparent",n.fontFamily=t.fontFamily||"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",n.fontSize=t.fontSize||"28px",n.fontWeight=t.fontWeight||"",n.elementSpace=t.elementSpace||5,n.lineSpace=t.lineSpace||5,n.placeholder=t.placeholder||"",n.placeholderColor=t.placeholderColor||"#eee",n.cursorColor=t.cursorColor||"#60CFC4",n.textRangeColor=t.textRangeColor||"#4E75EC1A",n.minWidth=t.minWidth||0,n.resolver=function(){var e=t.resolver();return 0!==e.length&&"text"===e[e.length-1].type||e.push(new ni("text","")),e},n._area=new ti,n._flattenTxtElem=ii.create(n.resolver()),n._status={editing:!1,dragover:!1},n.commands=new Map,n.registCommand(pi),n.registCommand(_i),n.registCommand(yi),n.registCommand(bi),n.registCommand(wi),n.registCommand(vi),n.registCommand(ci),n.registCommand(li),n.registCommand(ui),n.registCommand(fi),n.registCommand(ki),n.registCommand(mi),n.registCommand(xi),n.registCommand(Ti),n._makeFunctional(),n._cacheViewBox=[],n}return s(i,[{key:"currentLineHeight",get:function(){return this.lineHeight||parseInt(this.fontSize)}},{key:"registCommand",value:function(t){this.commands.has(t.name)||this.commands.set(t.name,t.create(this))}},{key:"_makeFunctional",value:function(){var t=this;this.addEventListener("dblclick",(function(e){e.currentTarget===t&&(e.detail.bubbles=!1,t._status.editing&&t.execCommand(Je))})),this.addEventListener("click",(function(e){var i;e.currentTarget===t&&(e.detail.bubbles=!1,i=t._status.editing?t._status.shiftOn?Ke:Ze:Ue,t.execCommand(i))})),this.addEventListener("blur",(function(e){t._status.editing=!1,t._shadowInput&&t._shadowInput.destroy(),t._belongs&&t._jflow._render(),t.dispatchEvent(new jt("change",{target:t,textElements:t._flattenTxtElem.copy()})),t._range.disable(),t._caret.cancelAnimate()})),this.addEventListener("instancePressStart",(function(e){if(t._status.editing&&!t._status.shiftOn){e.detail.bubbles=!1,e.detail.preventDefault();var i=t._currentp,n=t._positionToCursorOffset(i),r=t._range;r.setInitialRange([n.row].concat(b(n.column)));var o=e.detail.jflow,s=!1,a=function(e){t._status.editing=!1,s=!0;var i=e.offsetX,n=e.offsetY,a=o._calculatePointBack([i,n]);o._stack.checkHit(a);var h=t._currentp,c=t._positionToCursorOffset(h);r.setRange([c.row].concat(b(c.column))),r.enable()}.bind(t);document.addEventListener("pointermove",a),document.addEventListener("pointerup",(function(e){document.removeEventListener("pointermove",a),r.setInitialRange(null),s&&(r.handleCaret(t._caret),t._status.editing=!0,t._shadowInput.focus())}),{once:!0})}})),this.addEventListener("dragenter",(function(){t.moveCaretByHitPoint(),t._status.dragover=!0})),this.addEventListener("dragover",(function(){t.moveCaretByHitPoint()})),this.addEventListener("dragleave",(function(){t._status.dragover=!1}));var e=function(e){if(t._status.dragover){e.detail.bubbles=!1,t._status.dragover=!1;var i=t._caret,r=i.getRow(),o=i.getColumn(),s=t._area.get(r),a=y(o,2),h=a[0],c=a[1],l=s.get(h),u=s.get(h-1),f=t._flattenTxtElem,d=f.findIndex(l);"text"!==l.type&&"text"===(null==u?void 0:u.type)&&(c=u.source.length,d=f.findIndex(u));var g=f.length();t.dispatchEvent(new jt("insert",n(n({},e.detail),{},{type:e.type,textElements:f.copy(),idx:d,offset:c}))),f=t._flattenTxtElem,t._status.editing&&(f.length()>g&&i.setColumn([h+f.length()-g,0]),t._shadowInput.focus()),t._status.editing&&t._caret.refresh(),t.syncShadowInputPosition(),t._range.disable()}}.bind(this);this.addEventListener("pressEnd",e),this.addEventListener("drop",e)}},{key:"toggleShift",value:function(t){this._status.shiftOn=t}},{key:"execCommand",value:function(t){this.commands.get(t).exec()}},{key:"createShadowInput",value:function(){var t=this,e=this._jflow;this._shadowInput=new $e(e.DOMwrapper),this._shadowInput.addEventListener(Oe,(function(e){var i=e.detail.kind;t.execCommand(i)})),this._shadowInput.addEventListener(Ce,(function(e){var i=e.detail.kind,n=e.detail.data;t.commands.get(Ce).exec(i,n)})),this._status.editing=!0,e.setFocusInstance(this)}},{key:"moveCaretByHitPoint",value:function(){var t=this._currentp,e=this._caret,i=this._positionToCursorOffset(t),n=i.row,r=i.column;e.setRow(n),e.setColumn(r)}},{key:"refresh",value:function(){this.recalculateUp(),this.syncShadowInputPosition(),this._jflow._render()}},{key:"refreshTextElements",value:function(){this._flattenTxtElem=ii.create(this.resolver())}},{key:"_positionToCursorOffset",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=this._area,o=i+this.width/2,s=n+this.height/2,a=r.getLineAbove(s);return{row:a,column:r.get(a).getColumnNearest(o,this.elementSpace,this.fontSize,this.fontFamily)}}},{key:"_caretToPosition",value:function(){var t,e=this,i=this._caret.getRow(),n=this._caret.getColumn(),r=this._area.get(i),o=y(n,2),s=o[0],a=o[1],h=r.get(s),c=this._flattenTxtElem.findIndex(h),l=this._flattenTxtElem.get(c-1),u=this.currentLineHeight/2;if("text"===h.type){var f=h.source.substring(0,a);M((function(i){i.beginPath(),i.font="".concat(e.fontSize," ").concat(e.fontFamily),t=h.anchorX-h.width/2+i.measureText(f).width}))}else t=h.anchorX-h.width/2,u=Math.max(u,h.height/2);return 0===a&&l&&"text"!==l.type&&(u=Math.max(u,l.height/2)),[t,u,r.anchorY,l,h]}},{key:"syncShadowInputPosition",value:function(){if(this._status.editing){var t=y(this._caretToPosition(),3),e=t[0],i=t[1],n=t[2],r=this.calculateToRealWorld([e,n+i]),o=this._jflow.canvasMeta,s=Math.min(o.actual_width-120,r[0]);this._shadowInput.syncPosition(s,r[1]),this._shadowInput.focus()}}},{key:"render",value:function(t){t.save(),this._isMoving?t.globalAlpha=.6:1!==this.opacity&&(t.globalAlpha=this.opacity);var e=y(this.anchor,2),i=e[0],n=e[1],r=this._jflow,o=this._area;t.translate(i,n);var s=this._flattenTxtElem;if(s.isEmpty())return t.beginPath(),t.font="".concat(this.fontWeight," ").concat(this.fontSize," ").concat(this.fontFamily),t.textAlign="center",t.textBaseline="middle",t.fillStyle=this.placeholderColor,t.fillText(this.placeholder,0,0),this._randerCursor(t),t.translate(-i,-n),void t.restore();t.beginPath(),t.font="".concat(this.fontWeight," ").concat(this.fontSize," ").concat(this.fontFamily),t.textAlign="center",t.textBaseline="middle",t.fillStyle=this.textColor,o.forEach((function(e){e.forEach((function(e){"text"===e.type&&t.fillText(e.source,e.anchorX,e.anchorY)}))})),s.forEach((function(e){if("text"!==e.type){var i=r.getRenderNodeBySource(e.source);i.visible&&(t.save(),i.render(t),t.restore())}})),this._randerCursor(t),this._renderRange(t),t.translate(-i,-n),t.restore()}},{key:"_randerCursor",value:function(t){if(this._caret.isShow()&&(this._status.editing||this._status.dragover)){var e=y(this._caretToPosition(),3),i=e[0],n=e[1],r=e[2];t.beginPath(),t.moveTo(i,r-n),t.lineTo(i,r+n),t.lineWidth=2,t.strokeStyle=this.cursorColor,t.stroke()}}},{key:"_renderRange",value:function(t){var e=this._range;if(e.isEnable()){var i=this._area,n=this.textRangeColor,r=this.height,o=this.width,s=this.lineSpace,a=y(e.getRangeFrom(),3),h=a[0],c=a[1],l=a[2],u=y(e.getRangeTo(),3),f=u[0],d=u[1],g=u[2];if(h===f){if(c===d&&l==g)return;var v=i.get(h),p=h===i.length()-1?0:s,_=v.reduceHeight-p-v.height-r/2,m=v.height,b=this._measureElementOffsetX(v.get(c),l,t),w=this._measureElementOffsetX(v.get(d),g,t);t.beginPath(),t.rect(b,_,w-b,m),t.fillStyle=n,t.fill()}else for(var k=h,x=!0;k<=f;){var T=i.get(k),S=k===i.length()-1?0:s,E=T.reduceHeight-S-T.height-r/2,C=T.height;if(x){var O=T.get(c),P=this._measureElementOffsetX(O,l,t),B=T.tail(),M=B.anchorX+B.width/2;t.beginPath(),t.rect(P,E,M-P,C),t.fillStyle=n,t.fill()}else if(k===f){var R=T.get(d),I=this._measureElementOffsetX(R,g,t);t.beginPath(),t.rect(-o/2,E,R.reduceWidth+(I-R.anchorX+R.width/2),C),t.fillStyle=n,t.fill()}else t.beginPath(),t.rect(-o/2,E,T.width,C),t.fillStyle=n,t.fill();x=!1,k++}}}},{key:"_measureElementOffsetX",value:function(t,e,i){return"text"!==t.type||0===e?t.anchorX-t.width/2:t.anchorX-t.width/2+i.measureText(t.source.substring(0,e)).width}},{key:"measureTextWidth",value:function(t){var e,i=this;return M((function(n){n.font="".concat(i.fontSize," ").concat(i.fontFamily),e=n.measureText(t).width})),e}},{key:"getBoundingDimension",value:function(){return{width:this.width,height:this.height}}},{key:"getBoundingRect",value:function(){var t=this.anchor,e=this.width/2,i=this.height/2,n=t[0]-e,r=t[1]-i,o=t[0]+e,s=t[1]+i,a=this._boundingrect;return a[0]=n,a[1]=r,a[2]=o,a[3]=s,a}},{key:"_getViewBox",value:function(){var t=this._belongs.getCacheViewBox(),e=this._cacheViewBox;return this._calculatePointBackWithPoint(t[0],t[1],e,0,1),this._calculatePointBackWithPoint(t[2],t[3],e,2,3),this._cacheViewBox}},{key:"getCacheViewBox",value:function(){return this._cacheViewBox}},{key:"calculateToCoordination",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this.anchor,2),o=[i+r[0],n+r[1]];return this._belongs&&this._belongs.calculateToCoordination?this._belongs.calculateToCoordination(o):o}},{key:"calculateToRealWorld",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this.anchor,2),o=[i+r[0],n+r[1]];if(this._belongs&&this._belongs.calculateToRealWorld)return this._belongs.calculateToRealWorld(o)}},{key:"_calculatePointBack",value:function(t){var e=y(t,2),i=e[0],n=e[1],r=y(this.anchor,2);return[i-r[0],n-r[1]]}},{key:"_calculatePointBackWithPoint",value:function(t,e,i,n,r){i[n]=t-this.anchor[0],i[r]=e-this.anchor[1]}},{key:"isHit",value:function(t,e){var i=this._calculatePointBack(t),n=this._jflow;this._currentp=i;var r=[];this._flattenTxtElem.forEach((function(t){if("text"!==t.type){var e=n.getRenderNodeBySource(t.source);e.visible&&r.push(e)}}));var o=this._stack.checkHit(i,e,(function(t){return r.includes(t)}));if(o)return o;var s=this.anchor,a=this.width/2,h=this.height/2;return t[0]>s[0]-a&&t[0]<s[0]+a&&t[1]>s[1]-h&&t[1]<s[1]+h}},{key:"clone",value:function(){var t=this;return new Qt({width:this.width,height:this.height,cache:function(e){var i=y(t.anchor,2),n=i[0],r=i[1];e.translate(-n+t.width/2,-r+t.height/2),t.render(e)}})}},{key:"destroy",value:function(){this._jflow._focus.instance===this&&this._jflow.blur()}}]),i}(Tt);Object.assign(Oi.prototype,Pt),Object.assign(Oi.prototype,Bt),Object.assign(Oi.prototype,{_getBoundingGroupRect:function(){},resetChildrenPosition:function(){},reflow:function(){var t=this,e=this.currentLineHeight,i=this._flattenTxtElem,n=this._area;if(i.isEmpty()){var r=0,o=i.get(0);return M((function(e){e.font="".concat(t.fontSize," ").concat(t.fontFamily),r=e.measureText(t.placeholder).width})),n.truncate({height:e,reduceHeight:e}).insert(0,o),Object.assign(o,{anchorX:-r/2,height:e,isTail:!0}),this.width=r,void(this.height=e)}var s=this._jflow;M((function(e){e.font="".concat(t.fontSize," ").concat(t.fontFamily),i.forEach((function(t){"text"===t.type&&t.dirty&&(t.width=e.measureText(t.source).width,t.dirty=!1)}))}));var a=new ti;a.truncate({height:e});var h=a.get(0),c=0,l=0,u=null,f=this.lineSpace,d=this.elementSpace;i.forEach((function(t){if(h.push(t),t.reduceWidth=h.width,"text"===t.type)t.height=e,h.width+=t.width,t.needWrap&&(c+=h.height+f,h.reduceHeight=c,l=Math.max(h.width,l),h=ei.create({height:e}),a.push(h));else{var i=s.getRenderNodeBySource(t.source);t.height=i.height,h.height=Math.max(h.height,i.height);var n=u&&"text"!==u.type?d:2*d;h.width+=i.width+n}u=t})),i.tail().isTail=!0,c+=h.height,h.reduceHeight=c;var g=(l=Math.max(this.minWidth,Math.max(h.width,l)))/2,v=-(c/2),p=0;a.forEach((function(t){var e=t.height,i=t.reduceHeight,n=v+p+e/2;t.anchorY=n;var r=-g,o=null;t.forEach((function(t){if("text"===t.type)t.anchorY=n,t.anchorX=r+t.width/2,r+=t.width;else{var e=s.getRenderNodeBySource(t.source),i=!o||"text"===o.type,a=i?2*d:d;t.width=e.width,t.anchorY=n,t.anchorX=r+t.width/2+(i?a/2:0),e.anchor=[t.anchorX,t.anchorY],r+=t.width+a}o=t})),p=i})),this._area=a,this.width=l,this.height=c}}),Si=".jfloweditablespan[contenteditable=true]:empty:before{\n        content: attr(placeholder);\n        opacity: 0.5;\n        pointer-events: none;\n        display: block; \n      }",Ei=document.head||document.getElementsByTagName("head")[0],Ci=document.createElement("style"),Ei.appendChild(Ci),Ci.type="text/css",Ci.styleSheet?Ci.styleSheet.cssText=Si:Ci.appendChild(document.createTextNode(Si));var Pi=Xt(Ft),Bi=Xt(Nt),Mi=Xt(Gt),Ri=Xt(Vt,{shapeShift:function(t,e){return[t+.28865*e,e]}}),Ii=Xt(Ut,{shapeShift:function(t,e){return[t,e+.5773*t]}}),Li=Xt(qt),Di=Xt(Yt,{shapeShift:function(t,e,i){var n=Math.ceil(Math.sqrt(t*t+e*e)/2);i.radius=n;var r=2*n;return[r,r]}}),ji=function(t){h(i,t);var e=p(i);function i(t){var n;return r(this,i),(n=e.call(this)).uniqueName="jflow",n.eventAdapter=new Wt(t.eventAdapter),n.initNodeWeakMap(),n.initAnime(),n.initStack(t),n.initLayout(t),n.ctx=null,n.canvas=null,n.dpr=1,n.padding=20,n.position=null,n.scale=null,n.initialZoom=t.initialZoom,n.initialPosition=t.setInitialPosition,n.maxZoom=t.maxZoom||3,n.minZoom=t.minZoom||.5,n.NodeRenderTop=!!t.NodeRenderTop,n.worldMargin=t.worldMargin,n.draggingbehavior=Object.assign({panInBorder:{enable:!0,padding:20,deltamovement:8,allowMovingTargetInPan:!0}},t.draggingbehavior||{}),n.scrollBarBehavior=Object.assign({enable:!0},t.scrollBarBehavior||{}),n.offeset=null,n._lastState={x:null,y:null,dragging:!1,processing:!1},n._lastDragState={target:null,targetLink:null,processing:!1},n._target={instance:null,link:null,moving:null,isInstanceDirty:!1,isLinkDirty:!1,cache:{stack:null,belongs:null,point:null},meta:{x:void 0,y:void 0,initialX:void 0,initialY:void 0},status:{dragovering:!1,dragging:!1,processing:!1,movingState:!1}},n._focus={instance:null},n._dragOverTarget=null,n.allowDrop=t.allowDrop,n._tempNode=null,n._tempLink=null,n.mode=ot.DEFAULT,n._allowMovingTarget=!0,n.canvasMeta={},n._cacheViewBox=[],n}return s(i,[{key:"setMovingTargets",value:function(t){Object.assign(this._target,{moving:t})}},{key:"setTempDraggingInstance",value:function(t){t._belongs=this,this._tempNode=t,Object.assign(this._target,{moving:[this._tempNode],dragging:!0})}},{key:"removeTempDraggingInstance",value:function(){if(this._tempNode){var t=this._tempNode.anchor;return this._tempNode=null,t}}},{key:"preventDefaultDragging",value:function(){this._allowMovingTarget=!1}},{key:"allowDefaultDragging",value:function(){this._allowMovingTarget=!0}},{key:"$mount",value:function(t){var e=this,i=C(t),n=i.canvas,r=i.ctx,o=i.scale,s=i.width,a=i.height,h=i.raw_width,c=i.raw_height;i.left,i.top,this.reflow(),this.ctx=r,this.DOMwrapper=t,this.canvas=n,this.canvas.setAttribute("data-jflow",!0),this.canvas.$jflow=this,this.canvasMeta={width:h,height:c,actual_width:s,actual_height:a},this.dpr=o,this._getBoundingGroupRect();var l,u=this.padding,f=this.bounding_box,d=f.width,g=f.height,v=f.x,p=f.y,_={x:u,y:u,width:s-2*u,height:a-2*u},m={x:0,y:0,offsetX:0,offsetY:0},y=_.width/d,b=_.height/g,w=y<=b?"x":"y";l=this.initialZoom?this.initialZoom:Math.min(y,b),this.scale=l,l>this.maxZoom&&(this.maxZoom=l),l<this.minZoom&&(this.minZoom=l);var k=v*l,x=p*l,T=_.width,S=_.height;if(this.initialPosition){var E=this.initialPosition(k,x,T,S,_.x,_.y,s,a,v,p,d,g),O=E.x,P=E.y;m.x=O,m.y=P}else m.x="x"===w?_.x:(T-d*l)/2+u,m.y="y"===w?_.y:(S-g*l)/2+u;m.offsetX=m.x-k,m.offsetY=m.y-x,this.position=m,this._readyToRender=!0,this.scrollBarBehavior.enable&&this.initScrollBar(this.scrollBarBehavior),this.__render(),this._createEventHandler(),R((function(t){e.dpr=t,e.resizeCanvas(),e.scheduleRender()}),(function(t){e.destroyDprListener=t}))}},{key:"setLinkingMode",value:function(t,e,i){var n=this.getRenderNodeBySource(t);this._tempNode=new St,this._tempLink=e(i?{from:this._tempNode,to:n}:{from:n,to:this._tempNode}),this.sendMessage({instance:t}),this.mode=ot.LINKING}},{key:"isInLinkingMode",value:function(){return this.mode===ot.LINKING}},{key:"setLinkingLink",value:function(t){this.mode===ot.LINKING&&this._tempLink.setConfig(t)}},{key:"resetLinkingLink",value:function(){this.mode===ot.LINKING&&this._tempLink.setConfig({to:this._tempNode})}},{key:"clearTemp",value:function(){this._tempNode&&(this._tempNode.destroy(),this._tempNode=null),this._tempLink&&(this._tempLink.destroy(),this._tempLink=null),this._render()}},{key:"preventClearTemp",value:function(){this._preventClearTemp=!0}},{key:"resizeCanvas",value:function(){if(this.canvas&&this.DOMwrapper){var t=function(t,e){var i=e.getBoundingClientRect(),n=i.width,r=i.height;i.left,i.top,t.style.width=n+"px",t.style.height=r+"px";var o=window.devicePixelRatio;return t.width=Math.floor(n*o),t.height=Math.floor(r*o),{width:n,height:r,raw_width:t.width,raw_height:t.height}}(this.canvas,this.DOMwrapper),e=t.width,i=t.height,n=t.raw_width,r=t.raw_height;this.canvasMeta={width:n,height:r,actual_width:e,actual_height:i}}}},{key:"setFocusInstance",value:function(t){this._focus.instance=t}},{key:"focusOn",value:function(t){var e=this._calculatePointBack([this.canvasMeta.actual_width/2,this.canvasMeta.actual_height/2]),i=t.anchor;t._belongs.calculateToCoordination&&(i=t._belongs.calculateToCoordination(i));var n=(e[0]-i[0])*this.scale,r=(e[1]-i[1])*this.scale;this._recalculatePosition(n,r),this._render()}},{key:"_getBoundingGroupRect",value:function(){var t=this._stack.getBoundingRectPoints();if(this.bounding_box){this.bounding_box=st(t);var e=this.bounding_box,i=e.x,n=e.y,r=this.scale;this.position.x=this.position.offsetX+i*r,this.position.y=this.position.offsetY+n*r}else this.bounding_box=st(t)}},{key:"_createEventHandler",value:function(){var t,e=this,i=this.canvas;this.eventAdapter.apply(this);var n=function(){e.eventAdapter.unload(e),e.destroyDprListener()};if(t=n,this.allowDrop){var r=this._onDragover.bind(this),o=this._onDrop.bind(this),s=this._onDragLeave.bind(this);i.addEventListener("dragstart",(function(t){t.preventDefault()})),i.addEventListener("dragover",r),i.addEventListener("drop",o),i.addEventListener("dragleave",s),t=function(){n(),i.removeEventListener("dragover",r),i.removeEventListener("drop",o),i.removeEventListener("dragleave",s)}}this.destroy=t}},{key:"_targetLockOn",value:function(t,e){var i=this,n=this._calculatePointBack(t),r=n;this._currentp=n;var o,s=this._stack,a=this._getViewBox(),h=s.checkHit(n,(function(t){return i._target.status.dragging&&t===i._getMovingTarget()}),(function(t){return mt(a,t.getBoundingRect())})),c=this._linkStack;if(h&&h._belongs!==this||(o=c.checkHit(n,(function(t){if(!i._target.status.dragging)return!1;var e=i._getMovingTarget();return t.from===e||t.to===e}))),o||(o=c.checkHit(n,(function(t){return!t.ON_TOP}))),Object.assign(this._target,{instance:h,link:o,isInstanceDirty:h===this._target.instance,isLinkDirty:o===this._target.link}),Object.assign(this._target.cache,{stack:s,belongs:this,point:n,topLayerPoint:r}),Object.assign(this._target.meta,{x:t[0],y:t[1]}),"pressStart"===e&&!this._target.status.dragging&&!this._target.status.dragovering){for(var l=h;l&&l._belongs.lock&&l!==this;)l=l._belongs;this.setMovingTargets(l&&[l]),l&&h.bubbleEvent(new jt("afterResolveMovingTarget",{event:e,target:l,jflow:this,bubbles:!0}))}return["pressStart","click","dblclick","contextclick"].includes(e)&&this._focus.instance&&this._focus.instance!==h&&(this._focus.instance.dispatchEvent(new jt("blur",{relatedTarget:h})),this._focus.instance=null),this._target}},{key:"blur",value:function(){this._focus.instance&&(this._focus.instance.dispatchEvent(new jt("blur",{relatedTarget:null})),this._focus.instance=null)}},{key:"_getMovingTarget",value:function(){return this._target.moving&&this._target.moving[0]}},{key:"_processDragOver",value:function(t,e){if(this._dragOverTarget!==t){var i,n=null===(i=this.readMessage())||void 0===i?void 0:i.instance;this._dragCurrentData=n;var r=this._target.cache.point;if(this._dragOverTarget){var o=this._dragOverTarget;o.dispatchEvent(new jt("dragleave",{event:e,instance:o,target:n,jflow:this,point:r}))}t&&t.dispatchEvent(new jt("dragenter",{event:e,instance:t,target:n,jflow:this,point:r})),this._dragOverTarget=t}else this._dragOverTarget&&this._dragOverTarget.dispatchEvent(new jt("dragover",{event:e,instance:t,jflow:this,target:this._dragCurrentData}));this._processPanInBorder()}},{key:"_processPanInBorder",value:function(){var t,e=this;if(null!==(t=this.draggingbehavior)&&void 0!==t&&null!==(t=t.panInBorder)&&void 0!==t&&t.enable&&(this.draggingbehavior.panInBorder.timer||(this.draggingbehavior.panInBorder.timer=Date.now()),Date.now()-this.draggingbehavior.panInBorder.timer>500)){var i=y(this._cacheViewBox,4),n=i[0],r=i[1],o=i[2],s=i[3],a=y(this._currentp,2),h=a[0],c=a[1],l=this.draggingbehavior.panInBorder,u=l.padding,f=l.deltamovement,d=0,g=0;h<n+u&&(d=f),h>o-u&&(d=-f),c<r+u&&(g=f),c>s-u&&(g=-f),this.__processOverAnime&&this.__processOverAnime.cancel(),d||g?this.__processOverAnime=this.requestJFlowAnime((function(){e.panHandler(d,g)})):this.draggingbehavior.panInBorder.timer=null}}},{key:"_onDragover",value:function(t){var e=this;if(t.preventDefault(),t.stopPropagation(),!this._lastDragState.processing){this._lastDragState.processing=!0;var i=t.offsetX,n=t.offsetY;Object.assign(this._target.status,{dragovering:!0}),this._targetLockOn([i,n]);var r=this._target.instance||this._target.link;this._processDragOver(r,t),this._target.isLinkDirty||this._target.isInstanceDirty?Promise.resolve().then((function(){e._render(),e._target.isLinkDirty=!1,e._target.isInstanceDirty=!1,e._lastDragState.processing=!1})):this._lastDragState.processing=!1}}},{key:"_cancelPanInBorder",value:function(){var t;this.__processOverAnime&&this.__processOverAnime.cancel(),null!==(t=this.draggingbehavior)&&void 0!==t&&t.panInBorder&&(this.draggingbehavior.panInBorder.timer=null)}},{key:"_onDragLeave",value:function(){this._cancelPanInBorder()}},{key:"_onDrop",value:function(t){var e=this;this._cancelPanInBorder();var i=this.consumeMessage(),n=null==i?void 0:i.instance;if(this._dragOverTarget){var r=this._dragOverTarget;r.dispatchEvent(new jt("dragoverend",{event:t,instance:r})),this._dragOverTarget=null}var o=this._target,s=o.link,a=o.instance,h=this._target.cache,c=h.point,l=h.belongs;s?s.dispatchEvent(new jt("drop",{event:t,instance:n,link:s,jflow:this,belongs:l,point:c})):a?a.bubbleEvent(new jt("drop",{event:t,instance:n,jflow:this,target:a,point:c,bubbles:!0})):this.dispatchEvent(new jt("drop",{event:t,instance:n,jflow:this,target:a,point:c})),requestAnimationFrame((function(){e.cancelDrop()}))}},{key:"cancelDrop",value:function(){this._target.instance=null,this._target.link=null,Object.assign(this._target.status,{dragovering:!1})}},{key:"zoomHandler",value:function(t,e,i,n,r){var o=this;if(!this._zooming){this._zooming=!0;var s=this.bounding_box,a=s.width,h=s.height;s.x,s.y;var c=this.canvasMeta,l=c.actual_width,u=c.actual_height,f=this.minZoom;if(this.worldMargin){var d=this.worldMargin,g=a+2*d,v=h+2*d;f=Math.max(f,Math.max(l/g,u/v))}var p=this.scale;p*=n>0?1.05:1/1.05;var _=(p=Math.min(this.maxZoom,Math.max(f,p)))-this.scale,m=a*this.scale,y=h*this.scale,b=a*_,w=h*_,k=-(t-this.position.x)/m,x=-(e-this.position.y)/y;this.scale=p,this._recalculatePosition(k*b,x*w),this.dispatchEvent(new jt("zoompan",{deltaX:0,deltaY:0})),this.scheduleRender((function(){o._zooming=!1}))}}},{key:"panHandler",value:function(t,e,i){var n=this;if(!this._panning){if(this._panning=!0,this._target.status.dragging){var r=this._target.moving;r&&this.draggingbehavior.panInBorder.allowMovingTargetInPan&&r.forEach((function(i){i.anchor[0]+=-t/n.scale,i.anchor[1]+=-e/n.scale}))}this._recalculatePosition(t,e),this.dispatchEvent(new jt("zoompan",{deltaX:t,deltaY:e})),this.scheduleRender((function(){n._panning=!1}))}}},{key:"pressStartHandler",value:function(t,e,i){var n=this;if(!this.checkScrollDragging()){Object.assign(this._target.meta,{initialX:t,initialY:e});var r=this._targetLockOn([t,e],"pressStart"),o=r.link,s=r.instance;if(this.mode!==ot.LINKING){if(Object.assign(this._target.status,{dragging:!0,processing:!1}),this._target.moving){var a=this._getMovingTarget();a.dispatchEvent(new jt("pressStart",{event:i,instance:a,jflow:this}))}var h=this._resolveLockOnTarget(o,s);h&&h.bubbleEvent(new jt("instancePressStart",{event:i,target:h,jflow:this,bubbles:!0,preventDefault:function(){n._preventPressSequeence=!0,n._clearTarget(),document.addEventListener("pointerup",(function(t){t.preventDefault(),t.stopPropagation(),n._preventPressSequeence=!1}),{once:!0})}})),this._preventPressSequeence||this.dispatchEvent(new jt("jflowPressStart",{event:i,jflow:this}))}}}},{key:"pressMoveHandler",value:function(t,e,i){var n=this;if(!this._preventPressSequeence&&!this.checkScrollDragging()){var r=this._target.status,o=r.dragging,s=r.processing,a=this._target.meta,h=a.x,c=a.y;if(!o){if(this.checkScrollBarHover(t,e))return;this.resetScrollBarHover()}if(!o&&!s){var l=this._targetLockOn([t,e]),u=l.link,f=l.instance,d=this._resolveLockOnTarget(u,f);if(d?d.bubbleEvent(new jt("instancemousemove",{event:i,instance:d,jflow:this,bubbles:!0})):this.dispatchEvent(new jt("instancemousemove",{event:i,instance:null,jflow:this})),this.mode===ot.LINKING)return this._tempNode.anchor=this._currentp,this.scheduleRender((function(){n._target.isLinkDirty=!1,n._target.isInstanceDirty=!1,n._target.status.processing=!1})),void this._processPanInBorder()}if(this.dispatchEvent(new jt("canvasmousemove",{event:i,jflow:this})),o&&!s){var g=this._target.moving;this._target.status.movingState=!0,this._target.status.processing=!0;var v=t-h,p=e-c;g?this._allowMovingTarget&&g.forEach((function(t){t.anchor[0]+=v/n.scale,t.anchor[1]+=p/n.scale})):(this._recalculatePosition(v,p),this.dispatchEvent(new jt("zoompan",{deltaX:v,deltaY:p})));var _=this._targetLockOn([t,e]),m=_.instance,y=_.link;this._processDragOver(m||y,i),this.scheduleRender((function(){n._target.isLinkDirty=!1,n._target.isInstanceDirty=!1,n._target.status.processing=!1}))}}}},{key:"pressUpHanlder",value:function(t,e){if(!this._preventPressSequeence){if(this.__processOverAnime&&this.__processOverAnime.cancel(),this._cancelPanInBorder(),this._target.meta,this.mode===ot.LINKING){var i=this._target.instance,n=this.consumeMessage(),r=!1,o=function(){r=!0};if(i)i.bubbleEvent(new jt("link",{event:e,target:i,jflow:this,payload:n,bubbles:!0,link:this._tempLink,preventDefault:o}));else{var s=e.offsetX,a=e.offsetY;this.dispatchEvent(new jt("link",{event:e,jflow:this,payload:n,anchor:this._calculatePointBack([s,a]),link:this._tempLink,preventDefault:o}))}if(r)return;return this._clearTarget(),this._preventClearTemp||(this._tempNode&&(this._tempNode.destroy(),this._tempNode=null),this._tempLink&&(this._tempLink.destroy(),this._tempLink=null)),this._preventClearTemp=!1,this.mode=ot.DEFAULT,void this._render()}if(this._target.moving){var h=!1;if(this._layout.static&&(h=this.staticCheck(this._getMovingTarget())),!h&&this._target.link){var c=this._target.cache;c.point;var l=c.belongs,u=this._target.link,f=this._getMovingTarget();u.dispatchEvent(new jt("drop",{event:e,instance:f,link:u,jflow:this,belongs:l})),this._target.link=null,this._target.instance=null}this._target.moving&&(this._target.instance?this._target.instance.bubbleEvent(new jt("pressEnd",{event:e,instance:this._getMovingTarget(),jflow:this,target:this._target.instance,bubbles:!0})):this.dispatchEvent(new jt("pressEnd",{event:e,instance:this._getMovingTarget(),jflow:this}))),this._target.moving=null,this.removeTempDraggingInstance(),this._render()}this._clearTarget()}}},{key:"clickHanlder",value:function(t,e,i){var n=this._targetLockOn([t,e],"click"),r=n.link,o=n.instance,s=n.meta;if(Math.abs(s.initialX-s.x)<1&&Math.abs(s.initialY-s.y)<1){if(i.target!==this.canvas)return this._clearTarget(),void Object.assign(this._target.meta,{initialX:void 0,initialY:void 0});var a=this._target.cache.topLayerPoint,h=this._resolveLockOnTarget(r,o);if(h){var c=h;c.bubbleEvent(new jt("click",{event:i,jflow:this,target:c,topLayerPoint:a,bubbles:!0}))}else this.dispatchEvent(new jt("click",{event:i,jflow:this,topLayerPoint:a}));this._clearTarget(),Object.assign(this._target.meta,{initialX:void 0,initialY:void 0})}}},{key:"contextMenuHanlder",value:function(t,e,i){var n=this._targetLockOn([t,e],"contextclick"),r=n.link,o=n.instance,s=this._target.cache.topLayerPoint,a=this._resolveLockOnTarget(r,o);if(a){var h=a;h.bubbleEvent(new jt("contextclick",{event:i,jflow:this,target:h,topLayerPoint:s,bubbles:!0}))}else this.dispatchEvent(new jt("contextclick",{event:i,jflow:this,topLayerPoint:s}))}},{key:"dblclickHandler",value:function(t,e,i){var n=this._targetLockOn([t,e],"dblclick"),r=n.link,o=n.instance,s=this._target.cache.topLayerPoint,a=this._resolveLockOnTarget(r,o);if(a){var h=a;h.bubbleEvent(new jt("dblclick",{event:i,jflow:this,target:h,topLayerPoint:s,bubbles:!0}))}else this.dispatchEvent(new jt("dblclick",{event:i,jflow:this,topLayerPoint:s}))}},{key:"_resolveLockOnTarget",value:function(t,e){return null!=t&&t.ON_TOP?t:e||t}},{key:"_clearTarget",value:function(){Object.assign(this._target.meta,{x:void 0,y:void 0}),Object.assign(this._target.status,{dragging:!1,processing:!1,movingState:!1}),Object.assign(this._target,{instance:null,link:null,moving:null})}},{key:"_recalculatePosition",value:function(t,e,i){var n=this.bounding_box,r=n.x,o=n.y,s=n.width,a=n.height,h=this.canvasMeta,c=h.actual_width,l=h.actual_height;if(void 0===i&&(i=this.scale),this.worldMargin){var u=this.worldMargin,f=(r+s+u)*i-c,d=(r-u)*i,g=r*i,v=this.position.x+t-g;this.position.offsetX=Math.min(Math.max(-f,v),-d),this.position.x=this.position.offsetX+g;var p=(o+a+u)*i-l,_=(o-u)*i,m=o*i,y=this.position.y+e-m;this.position.offsetY=Math.min(Math.max(-p,y),-_),this.position.y=this.position.offsetY+m}else this.position.x+=t,this.position.y+=e,this.position.offsetX=this.position.x-r*i,this.position.offsetY=this.position.y-o*i}},{key:"calculateToRealWorld",value:function(t){var e=this.scale,i=this.position;return[t[0]*e+i.offsetX,t[1]*e+i.offsetY]}},{key:"_calculatePointBack",value:function(t){var e=this.scale,i=this.position;return[(t[0]-i.offsetX)/e,(t[1]-i.offsetY)/e]}},{key:"_calculatePointBackWithPoint",value:function(t,e,i,n,r){var o=this.scale,s=this.position;i[n]=(t-s.offsetX)/o,i[r]=(e-s.offsetY)/o}},{key:"_calculateDistance",value:function(t){return this.scale*t}},{key:"_resetTransform",value:function(){var t=this.canvasMeta,e=t.width,i=t.height,n=this.position,r=this.scale,o=this.ctx;o.setTransform(),o.clearRect(0,0,e,i),o.scale(this.dpr,this.dpr),o.transform(r,0,0,r,n.offsetX,n.offsetY)}},{key:"resetTransform",value:function(t){var e=this.position,i=this.scale;t.setTransform(),t.scale(this.dpr,this.dpr),t.transform(i,0,0,i,e.offsetX,e.offsetY)}},{key:"_getViewBox",value:function(){var t=this._cacheViewBox;return this._calculatePointBackWithPoint(0,0,t,0,1),this._calculatePointBackWithPoint(this.canvasMeta.actual_width,this.canvasMeta.actual_height,t,2,3),t}},{key:"setNodeToTopLayer",value:function(t){var e=this._stack.findIndex((function(e){return e===t}));if(-1!==e){var i=y(this._stack.splice(e,1),1)[0];this._stack.push(i)}}},{key:"getCacheViewBox",value:function(){return this._cacheViewBox}},{key:"_render",value:function(){this.scheduleRender()}},{key:"__render",value:function(){if(this._readyToRender){this.runAnimeFrame(),this._resetTransform();var t=this.ctx;this.dispatchEvent(new jt("beforeJflowRender",{ctx:t}));var e=this._getViewBox();this.NodeRenderTop?(this._linkStack.render(t,(function(t){return!t.ON_TOP&&t.isInViewBox(e)})),this._stack.render(t,(function(t){var i=mt(e,t.getBoundingRect());return t._isInViewBox=i,i})),this._linkStack.render(t,(function(t){return t.ON_TOP&&t.isInViewBox(e)}))):(this._stack.render(t,(function(t){var i=mt(e,t.getBoundingRect());return t._isInViewBox=i,i})),this._linkStack.render(t,(function(t){return t.isInViewBox(e)}))),this._tempNode&&(t.save(),this._tempNode.render(t),t.restore()),this._tempLink&&(t.save(),this._tempLink.isInViewBox(e),this._tempLink.render(t),t.restore()),this.dispatchEvent(new jt("afterJflowRender",{ctx:t})),this.renderScrollBar(t)}}}]),i}(d(EventTarget));Object.assign(ji.prototype,{_message:null,sendMessage:function(t){this._message=t},consumeMessage:function(){var t=this._message;return this._message=null,t},readMessage:function(){return this._message}}),Object.assign(ji.prototype,Pt),Object.assign(ji.prototype,Bt),Object.assign(ji.prototype,Ct),Object.assign(ji.prototype,Mt),Object.assign(ji.prototype,Rt),Object.assign(ji.prototype,Dt),Object.assign(ji.prototype,Lt),e.BaseLink=$t,e.BezierLink=le,e.Capsule=Nt,e.CapsuleGroup=Bi,e.CapsuleVertical=qt,e.CapsuleVerticalGroup=Li,e.Diamond=Vt,e.DiamondGroup=Ri,e.DiamondVerticalGroup=Ii,e.ERLayout=Ee,e.Group=Pi,e.GroupFactory=Xt,e.Icon=re,e.Instance=xt,e.JFLOW_MODE=ot,e.JFlowEvent=jt,e.LinearLayout=ue,e.Link=se,e.Lowcodelayout=xe,e.Node=Tt,e.Point=Yt,e.PointGroup=Di,e.PolyLink=he,e.Rectangle=Ft,e.Rhombus=Gt,e.RhombusGroup=Mi,e.ScrollGroup=Jt,e.ShadowDom=oe,e.Text=ne,e.TextElement=ni,e.TextGroup=Oi,e.commonEventAdapter={canvas:{wheel:function(t,e){t.preventDefault();var i=t.offsetX,n=t.offsetY,r=t.deltaX,o=t.deltaY;t.ctrlKey&&(o=-o),e.zoomHandler(i,n,r,o,t)}}},e.default=ji,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=jflow.min.js.map

{"version":3,"sources":["vue-plugin/components/JFlow.js"],"names":["mixins","StackMixin","provide","renderJFlow","addNameToRootStack","props","configs","type","Object","data","nodes","links","render","createElement","length","$slots","vnodes","map","meta","$scopedSlots","vnode","getJflowInstance","instance","componentInstance","_jflowInstance","$children","_layoutNode","key","id","vlinks","from","to","part","created","JFlow","mounted","_layout","flowStack","layoutMeta","flowLinkStack","slice","$nextTick","$mount","$el","keys","$listeners","event","func","bind","addEventListener","methods","reflow","preCallback","layoutNodes","recalculate","_render","getInstance","jflowId","stack","push"],"mappings":"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","sourcesContent":["import JFlow from '../../core/flow';\nimport StackMixin from './StackMixin';\nexport default {\n    mixins: [StackMixin],\n    provide(){\n        return {\n            renderJFlow: this.renderJFlow,\n            addNameToRootStack: this.addNameToRootStack\n        }\n    },\n    props: {\n        configs: {\n            type: Object,\n            default: function () {\n                return {};\n            },\n        },\n    },\n    data() {\n        return {\n            nodes: [],\n            links: [],\n        }\n    },\n    render: function (createElement) {\n        if(!this.nodes.length) {\n            return createElement('div', this.$slots.default);\n        } else {\n            const vnodes = this.nodes.map(({ type, configs, meta }) => {\n                if(!this.$scopedSlots[type]) {\n                    if(this.$scopedSlots['jflowcommon']){\n                        type = 'jflowcommon';\n                    } else {\n                        return\n                    }\n                }\n                const [vnode] = this.$scopedSlots[type]({ configs, meta });\n                meta.getJflowInstance = function() {\n                    // 只支持一个元素\n                    let instance = vnode.componentInstance;\n                    while(instance && !instance._jflowInstance)  {\n                        instance = instance.$children[0];\n                    }\n                    // TODO 优化下这里的逻辑\n                    instance._jflowInstance._layoutNode = meta;\n                    return instance._jflowInstance;\n                }\n                vnode.key = configs.id;\n                return vnode;\n            });\n            const vlinks = this.links.map(meta => {\n                let type = meta.type || 'plainlink'\n                if(!this.$scopedSlots[type]) {\n                    return null;\n                }\n                const [vnode] = this.$scopedSlots[type]({ configs: meta });\n                vnode.key = `${meta.from}-${meta.to}-${meta.part}`\n                return vnode\n            })\n\n            return createElement('div', [...vnodes, ...vlinks]);\n        }\n        \n    },\n    created() {\n        this._jflowInstance = new JFlow(this.configs);\n    },\n    mounted() {\n        // this._jflowInstance = new JFlow(this.configs);\n        this.nodes = this._jflowInstance._layout.flowStack.map(meta => {\n            return {\n                type: meta.type,\n                configs: meta.configs,\n                meta: meta.layoutMeta,\n            }\n        });\n        \n        this.links = this._jflowInstance._layout.flowLinkStack.slice();\n        this.$nextTick(() => {\n            this._jflowInstance.$mount(this.$el);\n            // this._jflowInstance.addEventListener('drop', (e) => {\n            //     const astblock = e.detail.instance;\n            //     const node = {\n            //         type: astblock.type,\n            //         configs: astblock,\n            //         meta: {},\n            //     };\n            //     this.nodes.push(node);\n            //     this.$nextTick(() => {\n            //         node.meta.getJflowInstance().anchor = e.detail.point\n            //         this.renderJFlow();\n            //     })\n            // })\n        });\n        Object.keys(this.$listeners).map(event => {\n            const func = this.$listeners[event].bind(this);\n            this._jflowInstance.addEventListener(event, func);\n        })\n    },\n    \n    methods: {\n        /**\n         * 绘制之前，vnode渲染之后\n         * @name j-jflow~preCallback\n         * @function\n         */\n        /**\n         * 重排\n         * @param {j-jflow~preCallback} preCallback - JFlow 绘制之前，vnode渲染之后\n         */\n        reflow(preCallback) {\n            const layoutNodes = this._jflowInstance._layout.flowStack.map(meta => {\n                return {\n                    type: meta.type,\n                    configs: meta.configs,\n                    meta: meta.layoutMeta,\n                }\n            });\n            /* no free Nodes\n            const freeNodes = []\n            this.nodes.forEach(n => {\n                if(!layoutNodes.find(ln => ln.configs.id === n.configs.id)){\n                    freeNodes.push(n)\n                }\n            })\n            this.nodes = layoutNodes.concat(freeNodes);\n            */\n            this.nodes = layoutNodes;\n            this.links = this._jflowInstance._layout.flowLinkStack.slice();\n            this.$nextTick(() => {\n                if(preCallback) {\n                    preCallback();\n                }\n                this._jflowInstance.recalculate();\n                this._jflowInstance._render();\n            })\n        },\n        /**\n         * 获取单签 JFlow 实例\n         * @return {Jflow} - JFlow对象\n         */\n        getInstance() {\n            return this._jflowInstance;\n        },\n        /**\n         * 手动触发绘制\n         */\n        renderJFlow() {\n            this._jflowInstance._render();\n        },\n        addNameToRootStack(instance, jflowId) {\n             this.stack.push({\n                jflowId,\n                instance,\n            });\n        }\n    }\n}"],"file":"JFlow.js"}
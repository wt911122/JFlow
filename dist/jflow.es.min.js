function e(t){const e=document.createElement("canvas"),i=e.getContext("2d"),{width:s,height:n,left:o,top:r}=t.getBoundingClientRect();e.style.width=s+"px",e.style.height=n+"px",e.style.userSelect="none";const a=window.devicePixelRatio;return e.width=Math.floor(s*a),e.height=Math.floor(n*a),t&&(t.style.position="relative",t.style.overflow="hidden",t.append(e)),{canvas:e,width:s,height:n,raw_width:e.width,raw_height:e.height,left:o,top:r,ctx:i,scale:a}}const i=document.createElement("canvas");i.width=1,i.height=1;const s=i.getContext("2d"),n=window.devicePixelRatio;function o(t){s.clearRect(0,0,5,5),s.save(),t(s),s.restore(),s.clearRect(0,0,5,5)}function r(t,e){const i=matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);function s(){console.log("devicePixelRatio changed: "+window.devicePixelRatio),t(window.devicePixelRatio),r(t,e)}e((()=>{console.log("remove devicePixelRatio event handler"),i.removeEventListener("change",s,{once:!0})})),i.addEventListener("change",s,{once:!0})}s.scale(n,n);const{abs:a,cos:h,sin:c,acos:l,atan2:d,sqrt:u,pow:g}=Math;function f(t){return t<0?-g(-t,1/3):g(t,1/3)}const p=Math.PI,_=2*p,m=p/2,b=Number.MAX_SAFE_INTEGER||9007199254740991,w=Number.MIN_SAFE_INTEGER||-9007199254740991,x={x:0,y:0,z:0},v={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(t,e){const i=e(t);let s=i.x*i.x+i.y*i.y;return void 0!==i.z&&(s+=i.z*i.z),u(s)},compute:function(t,e,i){if(0===t)return e[0].t=0,e[0];const s=e.length-1;if(1===t)return e[s].t=1,e[s];const n=1-t;let o=e;if(0===s)return e[0].t=t,e[0];if(1===s){const e={x:n*o[0].x+t*o[1].x,y:n*o[0].y+t*o[1].y,t:t};return i&&(e.z=n*o[0].z+t*o[1].z),e}if(s<4){let e,r,a,h=n*n,c=t*t,l=0;2===s?(o=[o[0],o[1],o[2],x],e=h,r=n*t*2,a=c):3===s&&(e=h*n,r=h*t*3,a=n*c*3,l=t*c);const d={x:e*o[0].x+r*o[1].x+a*o[2].x+l*o[3].x,y:e*o[0].y+r*o[1].y+a*o[2].y+l*o[3].y,t:t};return i&&(d.z=e*o[0].z+r*o[1].z+a*o[2].z+l*o[3].z),d}const r=JSON.parse(JSON.stringify(e));for(;r.length>1;){for(let e=0;e<r.length-1;e++)r[e]={x:r[e].x+(r[e+1].x-r[e].x)*t,y:r[e].y+(r[e+1].y-r[e].y)*t},void 0!==r[e].z&&(r[e]=r[e].z+(r[e+1].z-r[e].z)*t);r.splice(r.length-1,1)}return r[0].t=t,r[0]},computeWithRatios:function(t,e,i,s){const n=1-t,o=i,r=e;let a,h=o[0],c=o[1],l=o[2],d=o[3];return h*=n,c*=t,2===r.length?(a=h+c,{x:(h*r[0].x+c*r[1].x)/a,y:(h*r[0].y+c*r[1].y)/a,z:!!s&&(h*r[0].z+c*r[1].z)/a,t:t}):(h*=n,c*=2*n,l*=t*t,3===r.length?(a=h+c+l,{x:(h*r[0].x+c*r[1].x+l*r[2].x)/a,y:(h*r[0].y+c*r[1].y+l*r[2].y)/a,z:!!s&&(h*r[0].z+c*r[1].z+l*r[2].z)/a,t:t}):(h*=n,c*=1.5*n,l*=3*n,d*=t*t*t,4===r.length?(a=h+c+l+d,{x:(h*r[0].x+c*r[1].x+l*r[2].x+d*r[3].x)/a,y:(h*r[0].y+c*r[1].y+l*r[2].y+d*r[3].y)/a,z:!!s&&(h*r[0].z+c*r[1].z+l*r[2].z+d*r[3].z)/a,t:t}):void 0))},derive:function(t,e){const i=[];for(let s=t,n=s.length,o=n-1;n>1;n--,o--){const t=[];for(let i,n=0;n<o;n++)i={x:o*(s[n+1].x-s[n].x),y:o*(s[n+1].y-s[n].y)},e&&(i.z=o*(s[n+1].z-s[n].z)),t.push(i);i.push(t),s=t}return i},between:function(t,e,i){return e<=t&&t<=i||v.approximately(t,e)||v.approximately(t,i)},approximately:function(t,e,i){return a(t-e)<=(i||1e-6)},length:function(t){const e=v.Tvalues.length;let i=0;for(let s,n=0;n<e;n++)s=.5*v.Tvalues[n]+.5,i+=v.Cvalues[n]*v.arcfn(s,t);return.5*i},map:function(t,e,i,s,n){return s+(n-s)*((t-e)/(i-e))},lerp:function(t,e,i){const s={x:e.x+t*(i.x-e.x),y:e.y+t*(i.y-e.y)};return void 0!==e.z&&void 0!==i.z&&(s.z=e.z+t*(i.z-e.z)),s},pointToString:function(t){let e=t.x+"/"+t.y;return void 0!==t.z&&(e+="/"+t.z),e},pointsToString:function(t){return"["+t.map(v.pointToString).join(", ")+"]"},copy:function(t){return JSON.parse(JSON.stringify(t))},angle:function(t,e,i){const s=e.x-t.x,n=e.y-t.y,o=i.x-t.x,r=i.y-t.y;return d(s*r-n*o,s*o+n*r)},round:function(t,e){const i=""+t,s=i.indexOf(".");return parseFloat(i.substring(0,s+1+e))},dist:function(t,e){const i=t.x-e.x,s=t.y-e.y;return u(i*i+s*s)},closest:function(t,e){let i,s,n=g(2,63);return t.forEach((function(t,o){s=v.dist(e,t),s<n&&(n=s,i=o)})),{mdist:n,mpos:i}},abcratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const i=g(t,e)+g(1-t,e);return a((i-1)/i)},projectionratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const i=g(1-t,e);return i/(g(t,e)+i)},lli8:function(t,e,i,s,n,o,r,a){const h=(t-i)*(o-a)-(e-s)*(n-r);return 0!=h&&{x:((t*s-e*i)*(n-r)-(t-i)*(n*a-o*r))/h,y:((t*s-e*i)*(o-a)-(e-s)*(n*a-o*r))/h}},lli4:function(t,e,i,s){const n=t.x,o=t.y,r=e.x,a=e.y,h=i.x,c=i.y,l=s.x,d=s.y;return v.lli8(n,o,r,a,h,c,l,d)},lli:function(t,e){return v.lli4(t,t.c,e,e.c)},makeline:function(t,e){const i=t.x,s=t.y,n=e.x,o=e.y,r=(n-i)/3,a=(o-s)/3;return new O(i,s,i+r,s+a,i+2*r,s+2*a,n,o)},findbbox:function(t){let e=b,i=b,s=w,n=w;return t.forEach((function(t){const o=t.bbox();e>o.x.min&&(e=o.x.min),i>o.y.min&&(i=o.y.min),s<o.x.max&&(s=o.x.max),n<o.y.max&&(n=o.y.max)})),{x:{min:e,mid:(e+s)/2,max:s,size:s-e},y:{min:i,mid:(i+n)/2,max:n,size:n-i}}},shapeintersections:function(t,e,i,s,n){if(!v.bboxoverlap(e,s))return[];const o=[],r=[t.startcap,t.forward,t.back,t.endcap],a=[i.startcap,i.forward,i.back,i.endcap];return r.forEach((function(e){e.virtual||a.forEach((function(s){if(s.virtual)return;const r=e.intersects(s,n);r.length>0&&(r.c1=e,r.c2=s,r.s1=t,r.s2=i,o.push(r))}))})),o},makeshape:function(t,e,i){const s=e.points.length,n=t.points.length,o=v.makeline(e.points[s-1],t.points[0]),r=v.makeline(t.points[n-1],e.points[0]),a={startcap:o,forward:t,back:e,endcap:r,bbox:v.findbbox([o,t,e,r]),intersections:function(t){return v.shapeintersections(a,a.bbox,t,t.bbox,i)}};return a},getminmax:function(t,e,i){if(!i)return{min:0,max:0};let s,n,o=b,r=w;-1===i.indexOf(0)&&(i=[0].concat(i)),-1===i.indexOf(1)&&i.push(1);for(let a=0,h=i.length;a<h;a++)s=i[a],n=t.get(s),n[e]<o&&(o=n[e]),n[e]>r&&(r=n[e]);return{min:o,mid:(o+r)/2,max:r,size:r-o}},align:function(t,e){const i=e.p1.x,s=e.p1.y,n=-d(e.p2.y-s,e.p2.x-i);return t.map((function(t){return{x:(t.x-i)*h(n)-(t.y-s)*c(n),y:(t.x-i)*c(n)+(t.y-s)*h(n)}}))},roots:function(t,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const i=t.length-1,s=v.align(t,e),n=function(t){return 0<=t&&t<=1};if(2===i){const t=s[0].y,e=s[1].y,i=s[2].y,o=t-2*e+i;if(0!==o){const s=-u(e*e-t*i),r=-t+e;return[-(s+r)/o,-(-s+r)/o].filter(n)}return e!==i&&0===o?[(2*e-i)/(2*e-2*i)].filter(n):[]}const o=s[0].y,r=s[1].y,a=s[2].y;let c=3*r-o-3*a+s[3].y,d=3*o-6*r+3*a,g=-3*o+3*r,p=o;if(v.approximately(c,0)){if(v.approximately(d,0))return v.approximately(g,0)?[]:[-p/g].filter(n);const t=u(g*g-4*d*p),e=2*d;return[(t-g)/e,(-g-t)/e].filter(n)}d/=c,g/=c,p/=c;const m=(3*g-d*d)/3,b=m/3,w=(2*d*d*d-9*d*g+27*p)/27,x=w/2,y=x*x+b*b*b;let k,T,S,E,C;if(y<0){const t=-m/3,e=u(t*t*t),i=-w/(2*e),s=l(i<-1?-1:i>1?1:i),o=2*f(e);return S=o*h(s/3)-d/3,E=o*h((s+_)/3)-d/3,C=o*h((s+2*_)/3)-d/3,[S,E,C].filter(n)}if(0===y)return k=x<0?f(-x):-f(x),S=2*k-d/3,E=-k-d/3,[S,E].filter(n);{const t=u(y);return k=f(-x+t),T=f(x+t),[k-T-d/3].filter(n)}},droots:function(t){if(3===t.length){const e=t[0],i=t[1],s=t[2],n=e-2*i+s;if(0!==n){const t=-u(i*i-e*s),o=-e+i;return[-(t+o)/n,-(-t+o)/n]}return i!==s&&0===n?[(2*i-s)/(2*(i-s))]:[]}if(2===t.length){const e=t[0],i=t[1];return e!==i?[e/(e-i)]:[]}return[]},curvature:function(t,e,i,s,n){let o,r,h,c,l=0,d=0;const f=v.compute(t,e),p=v.compute(t,i),_=f.x*f.x+f.y*f.y;if(s?(o=u(g(f.y*p.z-p.y*f.z,2)+g(f.z*p.x-p.z*f.x,2)+g(f.x*p.y-p.x*f.y,2)),r=g(_+f.z*f.z,1.5)):(o=f.x*p.y-f.y*p.x,r=g(_,1.5)),0===o||0===r)return{k:0,r:0};if(l=o/r,d=r/o,!n){const n=v.curvature(t-.001,e,i,s,!0).k,o=v.curvature(t+.001,e,i,s,!0).k;c=(o-l+(l-n))/2,h=(a(o-l)+a(l-n))/2}return{k:l,r:d,dk:c,adk:h}},inflections:function(t){if(t.length<4)return[];const e=v.align(t,{p1:t[0],p2:t.slice(-1)[0]}),i=e[2].x*e[1].y,s=e[3].x*e[1].y,n=e[1].x*e[2].y,o=18*(-3*i+2*s+3*n-e[3].x*e[2].y),r=18*(3*i-s-3*n),a=18*(n-i);if(v.approximately(o,0)){if(!v.approximately(r,0)){let t=-a/r;if(0<=t&&t<=1)return[t]}return[]}const h=r*r-4*o*a,c=Math.sqrt(h),l=2*o;return v.approximately(l,0)?[]:[(c-r)/l,-(r+c)/l].filter((function(t){return 0<=t&&t<=1}))},bboxoverlap:function(t,e){const i=["x","y"],s=i.length;for(let n,o,r,h,c=0;c<s;c++)if(n=i[c],o=t[n].mid,r=e[n].mid,h=(t[n].size+e[n].size)/2,a(o-r)>=h)return!1;return!0},expandbox:function(t,e){e.x.min<t.x.min&&(t.x.min=e.x.min),e.y.min<t.y.min&&(t.y.min=e.y.min),e.z&&e.z.min<t.z.min&&(t.z.min=e.z.min),e.x.max>t.x.max&&(t.x.max=e.x.max),e.y.max>t.y.max&&(t.y.max=e.y.max),e.z&&e.z.max>t.z.max&&(t.z.max=e.z.max),t.x.mid=(t.x.min+t.x.max)/2,t.y.mid=(t.y.min+t.y.max)/2,t.z&&(t.z.mid=(t.z.min+t.z.max)/2),t.x.size=t.x.max-t.x.min,t.y.size=t.y.max-t.y.min,t.z&&(t.z.size=t.z.max-t.z.min)},pairiteration:function(t,e,i){const s=t.bbox(),n=e.bbox(),o=1e5,r=i||.5;if(s.x.size+s.y.size<r&&n.x.size+n.y.size<r)return[(o*(t._t1+t._t2)/2|0)/o+"/"+(o*(e._t1+e._t2)/2|0)/o];let a=t.split(.5),h=e.split(.5),c=[{left:a.left,right:h.left},{left:a.left,right:h.right},{left:a.right,right:h.right},{left:a.right,right:h.left}];c=c.filter((function(t){return v.bboxoverlap(t.left.bbox(),t.right.bbox())}));let l=[];return 0===c.length||(c.forEach((function(t){l=l.concat(v.pairiteration(t.left,t.right,r))})),l=l.filter((function(t,e){return l.indexOf(t)===e}))),l},getccenter:function(t,e,i){const s=e.x-t.x,n=e.y-t.y,o=i.x-e.x,r=i.y-e.y,a=s*h(m)-n*c(m),l=s*c(m)+n*h(m),u=o*h(m)-r*c(m),g=o*c(m)+r*h(m),f=(t.x+e.x)/2,p=(t.y+e.y)/2,b=(e.x+i.x)/2,w=(e.y+i.y)/2,x=f+a,y=p+l,k=b+u,T=w+g,S=v.lli8(f,p,x,y,b,w,k,T),E=v.dist(S,t);let C,P=d(t.y-S.y,t.x-S.x),B=d(e.y-S.y,e.x-S.x),M=d(i.y-S.y,i.x-S.x);return P<M?((P>B||B>M)&&(P+=_),P>M&&(C=M,M=P,P=C)):M<B&&B<P?(C=M,M=P,P=C):M+=_,S.s=P,S.e=M,S.r=E,S},numberSort:function(t,e){return t-e}};class y{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(t){return v.pointsToString(t.points)})).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map((function(t){return t.length()})).reduce((function(t,e){return t+e}))}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var e=t[0].bbox(),i=1;i<t.length;i++)v.expandbox(e,t[i].bbox());return e}offset(t){const e=[];return this.curves.forEach((function(i){e.push(...i.offset(t))})),new y(e)}}const{abs:k,min:T,max:S,cos:E,sin:C,acos:P,sqrt:B}=Math,M=Math.PI;class O{constructor(t){let e=t&&t.forEach?t:Array.from(arguments).slice(),i=!1;if("object"==typeof e[0]){i=e.length;const t=[];e.forEach((function(e){["x","y","z"].forEach((function(i){void 0!==e[i]&&t.push(e[i])}))})),e=t}let s=!1;const n=e.length;if(i){if(i>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");s=!0}}else if(6!==n&&8!==n&&9!==n&&12!==n&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const o=this._3d=!s&&(9===n||12===n)||t&&t[0]&&void 0!==t[0].z,r=this.points=[];for(let t=0,i=o?3:2;t<n;t+=i){var a={x:e[t],y:e[t+1]};o&&(a.z=e[t+2]),r.push(a)}const h=this.order=r.length-1,c=this.dims=["x","y"];o&&c.push("z"),this.dimlen=c.length;const l=v.align(r,{p1:r[0],p2:r[h]});this._linear=!l.some((t=>k(t.y)>1e-4)),this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,e,i,s){if(void 0===s&&(s=.5),0===s)return new O(e,e,i);if(1===s)return new O(t,e,e);const n=O.getABC(2,t,e,i,s);return new O(t,n.A,i)}static cubicFromPoints(t,e,i,s,n){void 0===s&&(s=.5);const o=O.getABC(3,t,e,i,s);void 0===n&&(n=v.dist(e,o.C));const r=n*(1-s)/s,a=v.dist(t,i),h=(i.x-t.x)/a,c=(i.y-t.y)/a,l=n*h,d=n*c,u=r*h,g=r*c,f=e.x-l,p=e.y-d,_=e.x+u,m=e.y+g,b=o.A,w=b.x+(f-b.x)/(1-s),x=b.y+(p-b.y)/(1-s),y=b.x+(_-b.x)/s,k=b.y+(m-b.y)/s,T={x:t.x+(w-t.x)/s,y:t.y+(x-t.y)/s},S={x:i.x+(y-i.x)/(1-s),y:i.y+(k-i.y)/(1-s)};return new O(t,T,S,i)}static getUtils(){return v}getUtils(){return O.getUtils()}static get PolyBezier(){return y}valueOf(){return this.toString()}toString(){return v.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,e=["M",t[0].x,t[0].y,2===this.order?"Q":"C"];for(let i=1,s=t.length;i<s;i++)e.push(t[i].x),e.push(t[i].y);return e.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map((function(t,e){return""+e+t.x+t.y+(t.z?t.z:0)})).join("")}update(){this._lut=[],this.dpoints=v.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,e=v.angle(t[0],t[this.order],t[1]);this.clockwise=e>0}length(){return v.length(this.derivative.bind(this))}static getABC(t=2,e,i,s,n=.5){const o=v.projectionratio(n,t),r=1-o,a={x:o*e.x+r*s.x,y:o*e.y+r*s.y},h=v.abcratio(n,t);return{A:{x:i.x+(i.x-a.x)/h,y:i.y+(i.y-a.y)/h},B:i,C:a,S:e,E:s}}getABC(t,e){e=e||this.get(t);let i=this.points[0],s=this.points[this.order];return O.getABC(this.order,i,e,s,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t)return this._lut;this._lut=[],t--;for(let e,i,s=0;s<t;s++)i=s/(t-1),e=this.compute(i),e.t=i,this._lut.push(e);return this._lut}on(e,i){i=i||5;const s=this.getLUT(),n=[];for(let t,o=0,r=0;o<s.length;o++)t=s[o],v.dist(t,e)<i&&(n.push(t),r+=o/s.length);return!!n.length&&(t/=n.length)}project(t){const e=this.getLUT(),i=e.length-1,s=v.closest(e,t),n=s.mpos,o=(n-1)/i,r=(n+1)/i,a=.1/i;let h,c,l=s.mdist,d=o,u=d;for(l+=1;d<r+a;d+=a)h=this.compute(d),c=v.dist(t,h),c<l&&(l=c,u=d);return u=u<0?0:u>1?1:u,h=this.compute(u),h.t=u,h.d=l,h}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?v.computeWithRatios(t,this.points,this.ratios,this._3d):v.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,e=[t[0]],i=t.length;for(let s,n,o=1;o<i;o++)s=t[o],n=t[o-1],e[o]={x:(i-o)/i*s.x+o/i*n.x,y:(i-o)/i*s.y+o/i*n.y};return e[i]=t[i-1],new O(e)}derivative(t){return v.compute(t,this.dpoints[0],this._3d)}dderivative(t){return v.compute(t,this.dpoints[1],this._3d)}align(){let t=this.points;return new O(v.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return v.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return v.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const e=this.derivative(t),i=B(e.x*e.x+e.y*e.y);return{x:-e.y/i,y:e.x/i}}__normal3(t){const e=this.derivative(t),i=this.derivative(t+.01),s=B(e.x*e.x+e.y*e.y+e.z*e.z),n=B(i.x*i.x+i.y*i.y+i.z*i.z);e.x/=s,e.y/=s,e.z/=s,i.x/=n,i.y/=n,i.z/=n;const o={x:i.y*e.z-i.z*e.y,y:i.z*e.x-i.x*e.z,z:i.x*e.y-i.y*e.x},r=B(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=r,o.y/=r,o.z/=r;const a=[o.x*o.x,o.x*o.y-o.z,o.x*o.z+o.y,o.x*o.y+o.z,o.y*o.y,o.y*o.z-o.x,o.x*o.z-o.y,o.y*o.z+o.x,o.z*o.z];return{x:a[0]*e.x+a[1]*e.y+a[2]*e.z,y:a[3]*e.x+a[4]*e.y+a[5]*e.z,z:a[6]*e.x+a[7]*e.y+a[8]*e.z}}hull(t){let e=this.points,i=[],s=[],n=0;for(s[n++]=e[0],s[n++]=e[1],s[n++]=e[2],3===this.order&&(s[n++]=e[3]);e.length>1;){i=[];for(let o,r=0,a=e.length-1;r<a;r++)o=v.lerp(t,e[r],e[r+1]),s[n++]=o,i.push(o);e=i}return s}split(t,e){if(0===t&&e)return this.split(e).left;if(1===e)return this.split(t).right;const i=this.hull(t),s={left:2===this.order?new O([i[0],i[3],i[5]]):new O([i[0],i[4],i[7],i[9]]),right:2===this.order?new O([i[5],i[4],i[2]]):new O([i[9],i[8],i[6],i[3]]),span:i};return s.left._t1=v.map(0,0,1,this._t1,this._t2),s.left._t2=v.map(t,0,1,this._t1,this._t2),s.right._t1=v.map(t,0,1,this._t1,this._t2),s.right._t2=v.map(1,0,1,this._t1,this._t2),e?(e=v.map(e,t,1,0,1),s.right.split(e).left):s}extrema(){const t={};let e=[];return this.dims.forEach(function(i){let s=function(t){return t[i]},n=this.dpoints[0].map(s);t[i]=v.droots(n),3===this.order&&(n=this.dpoints[1].map(s),t[i]=t[i].concat(v.droots(n))),t[i]=t[i].filter((function(t){return t>=0&&t<=1})),e=e.concat(t[i].sort(v.numberSort))}.bind(this)),t.values=e.sort(v.numberSort).filter((function(t,i){return e.indexOf(t)===i})),t}bbox(){const t=this.extrema(),e={};return this.dims.forEach(function(i){e[i]=v.getminmax(this,i,t[i])}.bind(this)),e}overlaps(t){const e=this.bbox(),i=t.bbox();return v.bboxoverlap(e,i)}offset(t,e){if(void 0!==e){const i=this.get(t),s=this.normal(t),n={c:i,n:s,x:i.x+s.x*e,y:i.y+s.y*e};return this._3d&&(n.z=i.z+s.z*e),n}if(this._linear){const e=this.normal(0),i=this.points.map((function(i){const s={x:i.x+t*e.x,y:i.y+t*e.y};return i.z&&e.z&&(s.z=i.z+t*e.z),s}));return[new O(i)]}return this.reduce().map((function(e){return e._linear?e.offset(t)[0]:e.scale(t)}))}simple(){if(3===this.order){const t=v.angle(this.points[0],this.points[3],this.points[1]),e=v.angle(this.points[0],this.points[3],this.points[2]);if(t>0&&e<0||t<0&&e>0)return!1}const t=this.normal(0),e=this.normal(1);let i=t.x*e.x+t.y*e.y;return this._3d&&(i+=t.z*e.z),k(P(i))<M/3}reduce(){let t,e,i=0,s=0,n=.01,o=[],r=[],a=this.extrema().values;for(-1===a.indexOf(0)&&(a=[0].concat(a)),-1===a.indexOf(1)&&a.push(1),i=a[0],t=1;t<a.length;t++)s=a[t],e=this.split(i,s),e._t1=i,e._t2=s,o.push(e),i=s;return o.forEach((function(t){for(i=0,s=0;s<=1;)for(s=i+n;s<=1.01;s+=n)if(e=t.split(i,s),!e.simple()){if(s-=n,k(i-s)<n)return[];e=t.split(i,s),e._t1=v.map(i,0,1,t._t1,t._t2),e._t2=v.map(s,0,1,t._t1,t._t2),r.push(e),i=s;break}i<1&&(e=t.split(i,1),e._t1=v.map(i,0,1,t._t1,t._t2),e._t2=t._t2,r.push(e))})),r}scale(t){const e=this.order;let i=!1;if("function"==typeof t&&(i=t),i&&2===e)return this.raise().scale(i);const s=this.clockwise,n=i?i(0):t,o=i?i(1):t,r=[this.offset(0,10),this.offset(1,10)],a=this.points,h=[],c=v.lli4(r[0],r[0].c,r[1],r[1].c);if(!c)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(t){const i=h[t*e]=v.copy(a[t*e]);i.x+=(t?o:n)*r[t].n.x,i.y+=(t?o:n)*r[t].n.y})),i?([0,1].forEach((function(n){if(2!==e||!n){var o=a[n+1],r={x:o.x-c.x,y:o.y-c.y},l=i?i((n+1)/e):t;i&&!s&&(l=-l);var d=B(r.x*r.x+r.y*r.y);r.x/=d,r.y/=d,h[n+1]={x:o.x+l*r.x,y:o.y+l*r.y}}})),new O(h)):([0,1].forEach((t=>{if(2===e&&t)return;const i=h[t*e],s=this.derivative(t),n={x:i.x+s.x,y:i.y+s.y};h[t+1]=v.lli4(i,n,c,a[t+1])})),new O(h))}outline(t,e,i,s){e=void 0===e?t:e;const n=this.reduce(),o=n.length,r=[];let a,h=[],c=0,l=this.length();const d=void 0!==i&&void 0!==s;function u(t,e,i,s,n){return function(o){const r=s/i,a=(s+n)/i,h=e-t;return v.map(o,0,1,t+r*h,t+a*h)}}n.forEach((function(n){const o=n.length();d?(r.push(n.scale(u(t,i,l,c,o))),h.push(n.scale(u(-e,-s,l,c,o)))):(r.push(n.scale(t)),h.push(n.scale(-e))),c+=o})),h=h.map((function(t){return a=t.points,a[3]?t.points=[a[3],a[2],a[1],a[0]]:t.points=[a[2],a[1],a[0]],t})).reverse();const g=r[0].points[0],f=r[o-1].points[r[o-1].points.length-1],p=h[o-1].points[h[o-1].points.length-1],_=h[0].points[0],m=v.makeline(p,g),b=v.makeline(f,_),w=[m].concat(r).concat([b]).concat(h);return w.length,new y(w)}outlineshapes(t,e,i){e=e||t;const s=this.outline(t,e).curves,n=[];for(let t=1,e=s.length;t<e/2;t++){const o=v.makeshape(s[t],s[e-t],i);o.startcap.virtual=t>1,o.endcap.virtual=t<e/2-1,n.push(o)}return n}intersects(t,e){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof O&&(t=t.reduce()),this.curveintersects(this.reduce(),t,e)):this.selfintersects(e)}lineIntersects(t){const e=T(t.p1.x,t.p2.x),i=T(t.p1.y,t.p2.y),s=S(t.p1.x,t.p2.x),n=S(t.p1.y,t.p2.y);return v.roots(this.points,t).filter((t=>{var o=this.get(t);return v.between(o.x,e,s)&&v.between(o.y,i,n)}))}selfintersects(t){const e=this.reduce(),i=e.length-2,s=[];for(let n,o,r,a=0;a<i;a++)o=e.slice(a,a+1),r=e.slice(a+2),n=this.curveintersects(o,r,t),s.push(...n);return s}curveintersects(t,e,i){const s=[];t.forEach((function(t){e.forEach((function(e){t.overlaps(e)&&s.push({left:t,right:e})}))}));let n=[];return s.forEach((function(t){const e=v.pairiteration(t.left,t.right,i);e.length>0&&(n=n.concat(e))})),n}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,e,i,s){const n=(s-i)/4,o=this.get(i+n),r=this.get(s-n),a=v.dist(t,e),h=v.dist(t,o),c=v.dist(t,r);return k(h-a)+k(c-a)}_iterate(t,e){let i,s=0,n=1;do{i=0,n=1;let o,r,a,h,c,l=this.get(s),d=!1,u=!1,g=n,f=1;do{if(u=d,h=a,g=(s+n)/2,o=this.get(g),r=this.get(n),a=v.getccenter(l,o,r),a.interval={start:s,end:n},d=this._error(a,l,s,n)<=t,c=u&&!d,c||(f=n),d){if(n>=1){if(a.interval.end=f=1,h=a,n>1){let t={x:a.x+a.r*E(a.e),y:a.y+a.r*C(a.e)};a.e+=v.angle({x:a.x,y:a.y},t,this.get(1))}break}n+=(n-s)/2}else n=g}while(!c&&i++<100);if(i>=100)break;h=h||a,e.push(h),s=f}while(n<1);return e}}const R={RIGHT:0,BOTTOM:1,LEFT:2,TOP:3,SELF:100},I={DEFAULT:"DEFAULT",LINKING:"LINKING"};function L(t){if(0===t.length)return{width:1,height:1,x:0,y:0};let e=1/0,i=1/0,s=-1/0,n=-1/0;for(let o in t){const r=t[o];r[0]<e&&(e=r[0]),r[0]>s&&(s=r[0]),r[1]<i&&(i=r[1]),r[1]>n&&(n=r[1])}return{width:Math.max(s-e,10),height:Math.max(n-i,10),x:e,y:i}}function D(t){return t*t}function j(t,e){return D(t[0]-e[0])+D(t[1]-e[1])}function W(t,e,i){const s=j(e,i);if(0===s)return j(t,e);let n=((t[0]-e[0])*(i[0]-e[0])+(t[1]-e[1])*(i[1]-e[1]))/s;return n=Math.max(0,Math.min(1,n)),j(t,[e[0]+n*(i[0]-e[0]),e[1]+n*(i[1]-e[1])])}function H(t,e){const i={fromDir:null,fromP:null,toDir:null,toP:null,distMin:1/0};return Object.keys(t).forEach((s=>{if(+s===R.SELF)return;let n=t[s];Object.keys(e).forEach((t=>{if(+t===R.SELF)return;let o=e[t];const r=j(n,o);r<i.distMin&&Object.assign(i,{distMin:r,fromDir:+s,fromP:n,toDir:+t,toP:o})}))})),i}function A(t,e,i,s){return e===R.TOP?[t[0],t[1]-s]:e===R.BOTTOM?[t[0],t[1]+s]:e===R.LEFT?[t[0]-i,t[1]]:e===R.RIGHT?[t[0]+i,t[1]]:void 0}function z(t,e,i=R.TOP,s=R.TOP,n=0,o=0){const r=Math.max(Math.abs((t[0]-e[0])/2),n),a=Math.max(Math.abs((t[1]-e[1])/2),o),h=A(t,i,r,a),c=A(e,s,r,a),l=[R.TOP,R.LEFT].includes(s)?-5:5,d=[R.TOP,R.BOTTOM].includes(s);return[...h,...c,d?e[0]:e[0]+l,d?e[1]+l:e[1]]}function X(t,e,i,s,n,o,r,a,h){var c=Math.pow(1-t,2)*(s-e)+2*t*(1-t)*(o-s)+t*t*(a-o),l=Math.pow(1-t,2)*(n-i)+2*t*(1-t)*(r-n)+t*t*(h-r);return-Math.atan2(c,l)+.5*Math.PI}function Y(t,e,i,s=R.TOP,n=R.TOP,o=10,r=10,a){const h=Math.abs(s-n),c=s===R.TOP||s===R.BOTTOM;switch(t.length=0,h){case 0:if(s===R.TOP){const s=Math.min(e[1],i[1])-r;t.push([e[0],s]),t.push([i[0],s])}if(s===R.BOTTOM){const s=Math.max(e[1],i[1])+r;t.push([e[0],s]),t.push([i[0],s])}if(s===R.LEFT){const s=Math.min(e[0],i[0])-o;t.push([s,e[1]]),t.push([s,i[1]])}if(s===R.RIGHT){const s=Math.max(e[0],i[0])+o;t.push([s,e[1]]),t.push([s,i[1]])}break;case 1:case 3:if(a)c?(t.push([e[0],e[1]+r]),t.push([i[0]+o,e[1]+r]),t.push([i[0]+o,i[1]])):(t.push([e[0]+o,e[1]]),t.push([e[0]+o,i[1]+r]),t.push([i[0],i[1]+r]));else{const s=c?[e[0],i[1]]:[i[0],e[1]];t.push(s)}break;case 2:const n=[(e[0]-i[0])/2+i[0],(e[1]-i[1])/2+i[1]];c?(t.push([e[0],n[1]]),t.push([i[0],n[1]])):(t.push([n[0],e[1]]),t.push([n[0],i[1]]))}t.unshift(e),t.push(i)}function F(t,e){return[t[0]-e[0],t[1]-e[1]]}function N(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function q(t,e){return[t[0]*e,t[1]*e]}function V(t,e){return t[0]!=t[2]&&t[1]!=t[3]&&e[0]!=e[2]&&e[1]!=e[3]&&!(t[2]<=e[0]||t[3]<=e[1]||t[0]>=e[2]||t[1]>=e[3])}function G(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function $(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]}const U=Symbol("ishit"),Z=Symbol("isInViewBox");class K extends EventTarget{constructor(t={}){super(),Object.assign(this,t),this.visible=!0,this._belongs=void 0,this[U]=!1,this.borderWidth=t.borderWidth||0,this.borderColor=t.borderColor||"transparent",this.backgroundColor=t.backgroundColor||"transparent",this.shadowColor=t.shadowColor,this.shadowBlur=t.shadowBlur||5,this.shadowOffsetX=t.shadowOffsetX||0,this.shadowOffsetY=t.shadowOffsetY||0,this.opacity=t.opacity||1,this._boundingrect=[0,0,0,0]}get _isTargeting(){return this===(this._jflow._target.instance||this._jflow._target.link)}get _isMoving(){return this===this._jflow._getMovingTarget()&&this._jflow._target.status.movingState}get _isHit(){return this[U]}get _jflow(){return"jflow"===this._belongs.uniqueName?this._belongs:this._belongs._jflow}set _isHit(t){this[U]!==t&&this.dispatchEvent(new CustomEvent(t?"mouseenter":"mouseleave",{detail:{instance:this,jflow:this._jflow}})),this[U]=t}get isInViewBox(){return this[Z]}set _isInViewBox(t){t!==this[Z]&&(t?this.onEnterViewbox():this.onLeaveViewbox()),this[Z]=t}onEnterViewbox(){}onLeaveViewbox(){}setConfig(t){Object.keys(t).forEach((e=>{void 0!==t[e]&&null!==t[e]&&(this[e]=t[e])}))}render(t){throw"require render implement"}isHit(t){throw"require isHit implement"}getBoundingRect(){throw"require getBoundingRect implement"}calculateIntersection(){throw"require calculateIntersection implement"}getIntersectionsInFourDimension(){throw"require getIntersectionsInFourDimension implement"}getCenter(){return this.anchor}getBoundingDimension(){const t=instance.getBoundingRect();let e=1/0,i=-1/0,s=1/0,n=-1/0;return t.forEach((t=>{i=Math.max(i,t[1]),e=Math.min(e,t[1]),n=Math.max(n,t[0]),s=Math.min(s,t[0])})),{height:i-e,width:n-s}}bubbleEvent(t){t.detail.currentTarget=this,this.dispatchEvent(t),t.detail.bubbles&&(this._belongs.bubbleEvent?this._belongs.bubbleEvent(t):this._belongs.dispatchEvent(t))}calculateToRealWorld(t){return this._belongs&&this._belongs.calculateToRealWorld?this._belongs.calculateToRealWorld(t):t}calculateToRealWorldWithScalar(t){return this._jflow.scale*t}recalculateUp(){this.belongs&&this.belongs.recalculateUp()}destroy(){}}class J extends K{constructor(t={}){super(t),this._rawConfigs=t,this.anchor=t.anchor||[0,0],this.absolutePosition=t.absolutePosition}setConfig(t){Object.keys(t).forEach((e=>{void 0!==t[e]&&null!==t[e]&&(this[e]=t[e],this._rawConfigs[e]=t[e])}))}setAnchorX(t){this.anchor[0]=t}setAnchorY(t){this.anchor[1]=t}setAnchor(t,e){this.anchor[0]=t,this.anchor[1]=e}beforeRender(){return V(this._belongs._getViewBox(),this.getBoundingRect())}clone(){const t=new(0,this.constructor)(this._rawConfigs);return t.visible=this.visible,t}}class Q extends J{constructor(t){super(t)}render(t){}isHit(t){return!1}calculateIntersection(t){return this.anchor}getBoundingRect(){const[t,e]=this.anchor;return[t,e,t,e]}getBoundingDimension(){return{width:0,height:0}}getIntersectionsInFourDimension(){const[t,e]=this.anchor;return{[R.RIGHT]:[t+1,e],[R.LEFT]:[t-1,e],[R.BOTTOM]:[t,e+1],[R.TOP]:[t,e-1]}}}class tt{constructor(){this._map=new WeakMap}get(t){return this._map.get(t)}set(t){const e={layoutNode:void 0,jflowNode:void 0,jflowlinks:[],jflowFromLinks:[],jflowToLinks:[]};return this._map.set(t,e),e}has(t){return this._map.has(t)}delete(t){this._map.delete(t)}clear(){this._map.clear()}}const et={initNodeWeakMap(){this.source_Layout_Render_NodeMap=new tt},getRenderNodeBySource(t){const e=this.source_Layout_Render_NodeMap.get(t);if(e)return e.jflowNode},getLayoutNodeBySource(t){const e=this.source_Layout_Render_NodeMap.get(t);if(e)return e.layoutNode},getSourceRenderMeta(t){return this.source_Layout_Render_NodeMap.get(t)},_getMap(t){const e=this.source_Layout_Render_NodeMap;let i;return i=e.has(t)?e.get(t):e.set(t),i},setLayoutNodeBySource(t,e){this._getMap(t).layoutNode=e},setRenderNodeBySource(t,e){this._getMap(t).jflowNode=e},addLinkNodeBySource(t,e,i){let s=this._getMap(t);s.jflowFromLinks.push(i),s=this._getMap(e),s.jflowToLinks.push(i)},removeLinkNodeBySource(t,e,i){let s=this._getMap(t),n=s.jflowFromLinks.findIndex((t=>t===i));-1!==n&&s.jflowFromLinks.splice(n,1),s=this._getMap(e),n=s.jflowToLinks.findIndex((t=>t===i)),-1!==n&&s.jflowToLinks.splice(n,1)}};class it extends Array{constructor(){super(),this._currentHit=null}render(t,e){let i;this.forEach((s=>{if(s._isMoving)i=s;else if(s.visible&&(!e||e(s))){if(s.beforeRender&&!s.beforeRender(t))return;t.save(),s.render(t),t.restore()}})),i&&(t.save(),i.render(t),t.restore())}resetHitStatus(){this._currentHit=null,this.forEach((t=>{t._stack&&t._stack.resetHitStatus(),t._isHit=!1}))}checkHit(t,e,i){let s=this.length-1;for(;s>=0;){const n=this[s];if(n.visible&&!n.ignoreHit){if(e&&e(n)){s--;continue}if(i&&!i(n)){s--;continue}const o=n.isHit(t,e);if(o)return this._currentHit!==n&&(this._currentHit&&(this._currentHit._isHit=!1),n._isHit=!0,this._currentHit=n),"boolean"!=typeof o?o:n;n._isHit=!1}s--}return this._currentHit=null,null}getBoundingRectPoints(){const t=[];return this.forEach((e=>{if(e.visible&&!e.absolutePosition){const i=e.getBoundingRect();t.push([i[0],i[1]]),t.push([i[2],i[3]])}})),t}getAnchorRectPoints(){const t=[];return this.forEach((e=>{e.visible&&!e.absolutePosition&&t.push(e.anchor)})),t}}const st={instances:[],links:[],_stack:null,_linkStack:null,initStack({data:t}){this._stack=new it,this._linkStack=new it,t&&(this.instances=t.instances,this.links=t.links,this.instances.forEach((t=>{this._stack.push(t),t._belongs=this})),this.links.forEach((t=>{this._linkStack.push(t),t._belongs=this})))},addToStack(t){t._belongs=this,this._stack.push(t)},replaceFromStack(t,e){const i=this._stack.findIndex((e=>e===t));this._stack.splice(i,1,e),t._belongs=null,e._belongs=this},addToLinkStack(t){t._belongs=this,this._linkStack.push(t)},removeFromStack(t){const e=this._stack.findIndex((e=>e===t));-1!==e&&this._stack.splice(e,1)},removeFromLinkStack(t){const e=this._linkStack.findIndex((e=>e===t));-1!==e&&this._linkStack.splice(e,1)},emptyLink(){this._linkStack=new it},resetChildrenPosition(){this._stack.forEach((t=>{t.anchor=[0,0]}))},addInstanceToLink(t,e){this.addToStack(e);const{from:i,to:s}=t,n=this._linkStack.findIndex((e=>e===t)),o=t.__proto__.constructor,r=new o({from:i,to:e});r._belongs=this;const a=new o({from:e,to:s});a._belongs=this,this._linkStack.splice(n,1,r,a)},interateNodeStack(t){this._stack.forEach((e=>{t(e)}))}},nt={_layout:null,initLayout(t){this._layout=t.layout},recalculateUp(){let t=!0;if(this.getBoundingDimension){const{width:e,height:i}=this.getBoundingDimension();this.resetChildrenPosition&&this.resetChildrenPosition(),this._getBoundingGroupRect&&this._getBoundingGroupRect(),this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect();const{width:s,height:n}=this.getBoundingDimension();t=e!==s||i!==n}else this.reflow();this._belongs&&t&&this._belongs.recalculateUp()},recalculate(){this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect()},staticCheck(t){return!!this._layout&&this._layout.staticCheck(t,this)},reflow(){this._layout&&this._layout.reflow(this)}},ot={_message:null,sendMessage(t){this._message=t},consumeMessage(){const t=this._message;return this._message=null,t},readMessage(){return this._message}};var rt={initAnime(){this.anime_queue=[],this.__animeClock__=void 0},requestJFlowAnime(t){const e=this.enqueueAnime(t);return this._runAnime(),e},enqueueAnime(t){const e={start:void 0,callback:t,cancel:()=>{this._cancelAnime(e),this._render()}};return this.anime_queue.push(e),e},_cancelAnime(t){const e=this.anime_queue.findIndex((e=>e===t));~e&&this.anime_queue.splice(e,1)},runAnime(){this._runAnime()},_runAnime(){this.anime_queue.length&&requestAnimationFrame((()=>{this.scheduleRender(),this._runAnime()}))},runAnimeFrame(){this.anime_queue.forEach((t=>{const e=Date.now();t.start||(t.start=e);const i=e-t.start;t.callback(i)}))}},at={captureMap(t,{padding:i=0,placement:s="normal"}){this._getBoundingGroupRect();const{width:n,height:o,x:r,y:a}=this.bounding_box;if(!this.miniMap){this.miniMap=e(t);const{width:i,height:s,raw_width:n,raw_height:o}=this.miniMap;this.addEventListener("zoompan",(()=>{this._renderMap&&this._renderMap()}));let r=!1;this.miniMap.canvas.addEventListener("pointerdown",(t=>{let{offsetX:e,offsetY:i,deltaX:s,deltaY:n}=t;r=!0,this._onMoveMap&&this._onMoveMap(e,i)})),this.miniMap.canvas.addEventListener("pointermove",(t=>{let{offsetX:e,offsetY:n,deltaX:o,deltaY:a}=t;r&&this._onMoveMap&&this._onMoveMap(e,n),(n<5||e<5||e>i-5||n>s-5)&&(r=!1)})),this.miniMap.canvas.addEventListener("pointerup",(()=>{r=!1}));const a=document.createElement("canvas");a.width=n,a.height=o,this.cacheMinimapCtx=a.getContext("2d")}const{width:h,height:c,raw_width:l,raw_height:d,left:u,top:g,scale:f,ctx:p}=this.miniMap,_=2*i,m=i,b=(h-_)/n,w=(c-_)/o,x=Math.min(b,w);let v=0,y=0;"center"===s?(y=(c-o*x)/2-a*x,v=(h-n*x)/2-r*x):b<w?(y=(c-o*x)/2-a*x,v=m):(v=(h-n*x)/2-r*x,y=m);const k=this.cacheMinimapCtx;k.setTransform(),k.clearRect(0,0,l,d),k.scale(f,f),k.transform(x,0,0,x,v,y);const T=[0,0,0,0];this.NodeRenderTop?(this._linkStack.render(k,(t=>(t.isInViewBox(T),!0))),this._stack.render(k)):(this._stack.render(k),this._linkStack.render(k,(t=>(t.isInViewBox(T),!0))));const S=k.getImageData(0,0,l,d);this._renderMap=()=>{p.save(),p.setTransform(),p.clearRect(0,0,l,d),p.scale(f,f),p.putImageData(S,0,0),p.transform(x,0,0,x,v,y);const[t,e,i,s]=this._getViewBox();p.beginPath(),p.rect(t,e,i-t,s-e),p.setTransform(),p.rect(0,0,l,d),p.clip("evenodd"),p.fillStyle="rgba(0,0,0,0.4)",p.fillRect(0,0,l,d),p.restore()},this._renderMap(),this._onMoveMap=(t,e)=>{const[i,s,n,o]=this._getViewBox(),r=[((n-i)/2+i)*x+v,((o-s)/2+s)*x+y];this._recalculatePosition((r[0]-t)/x*this.scale,(r[1]-e)/x*this.scale),this._render(),this._renderMap()}}};class ht{constructor(t,e={}){this.anchor=[0,0],this.width=e.barWidth||4,this.height=e.barWidth||4,this.barMarginX=0,this.barMarginY=0,this.dir=t,this.plainColor=e.plainColor||"rgba(0, 0, 0, 0.15)",this.focusColor=e.focusColor||"rgba(0, 0, 0, 0.25)",this.isFocus=!1}render(t){const[e,i]=this.anchor;if(t.save(),t.beginPath(),"x"===this.dir){const s=this.height/2,n=i+s,o=i+this.height,r=e+this.width-2*this.barMarginX-s,a=e+this.barMarginX+s;t.moveTo(a,o),t.arc(a,n,s,Math.PI/2,Math.PI/2*3),t.lineTo(r,i),t.arc(r,n,s,-Math.PI/2,Math.PI/2),t.closePath()}else{const s=this.width/2,n=i+this.barMarginY+s,o=i+this.height-2*this.barMarginY-s,r=e+s,a=e+this.width;t.moveTo(e,n),t.arc(r,n,s,-Math.PI,0),t.lineTo(a,o),t.arc(r,o,s,0,Math.PI),t.closePath()}t.fillStyle=this.isFocus?this.focusColor:this.plainColor,t.fill(),t.restore()}isHit(t){const e=this.anchor,i=this.width,s=this.height;return t[0]>e[0]-5&&t[0]<e[0]+i+5&&t[1]>e[1]-5&&t[1]<e[1]+s+5}}var ct={initScrollBar(t={}){const{barColor:e,barFocusColor:i,barMarginX:s,barMarginY:n,barWidth:o}=t;this._scrollbarEnable=!0,this._scrollbarX=new ht("x",{plainColor:e,focusColor:i,barWidth:o}),this._scrollbarX.barMarginX=s||5,this._scrollbarY=new ht("y",{plainColor:e,focusColor:i,barWidth:o}),this._scrollbarY.barMarginY=n||5,this._scrollBarStatus={dragging:!1,target:null,xscale:void 0,yscale:void 0,barInitX:0,barInitY:0},this.addEventListener("zoompan",(()=>{this.scrollBarOnPanAndZoom()})),this.scrollBarOnPanAndZoom(),this.canvas.addEventListener("pointerdown",(t=>{const{offsetX:e,offsetY:i,clientX:s,clientY:n}=t;this.onScrollbarPressStart(e,i,s,n)}))},checkScrollDragging(){return this._scrollBarStatus&&this._scrollBarStatus.dragging},onScrollbarPressStart(t,e,i,s){this._scrollbarX.isHit([t,e])&&Object.assign(this._scrollBarStatus,{dragging:!0,target:this._scrollbarX,barStartX:this._scrollbarX.anchor[0],barInitX:i});this._scrollbarY.isHit([t,e])&&Object.assign(this._scrollBarStatus,{dragging:!0,target:this._scrollbarY,barStartY:this._scrollbarY.anchor[1],barInitY:s});const n=(t=>{const{offsetX:e,offsetY:i,clientX:s,clientY:n}=t;this.onDraggingScrollbar(e,i,s,n)}).bind(this);document.addEventListener("pointermove",n);const o=(t=>{Object.assign(this._scrollBarStatus,{dragging:!1,target:null,x:void 0,y:void 0}),document.removeEventListener("pointermove",n),document.removeEventListener("pointerup",o),this.canvas.removeEventListener("pointerup",o)}).bind(this);this.canvas.addEventListener("pointerup",o,{once:!0}),document.addEventListener("pointerup",o,{once:!0})},onDraggingScrollbar(t,e,i,s){if(this._scrollbarEnable&&this._scrollBarStatus.dragging){const{target:t,barInitX:e,barStartX:n,barInitY:o,barStartY:r,xscale:a,yscale:h,scollbarHeight:c,scollbarWidth:l,realR:d,realL:u,realT:g,realB:f}=this._scrollBarStatus,{actual_width:p,actual_height:_}=this.canvasMeta,{x:m,y:b}=this.bounding_box;if("x"===t.dir){const s=n+(i-e),o=(m-((d-u)*((t.anchor[0]=Math.max(Math.min(s,p-l),0))/p)+u))*this.scale;Object.assign(this.position,{offsetX:o-m*this.scale,x:o})}if("y"===t.dir){const e=r+(s-o),i=(b-((f-g)*((t.anchor[1]=Math.max(Math.min(e,_-c),0))/_)+g))*this.scale;Object.assign(this.position,{offsetY:i-b*this.scale,y:i})}return this.scheduleRender(),!0}return!1},checkScrollBarHover(t,e){if(this._scrollbarEnable){if(this._scrollbarX.isHit([t,e]))return this._scrollbarX.isFocus||(this._scrollbarX.isFocus=!0,this.scheduleRender()),this.canvas.style.cursor="default",!0;if(this._scrollbarY.isHit([t,e]))return this._scrollbarY.isFocus||(this._scrollbarY.isFocus=!0,this.scheduleRender()),this.canvas.style.cursor="default",!0}return!1},resetScrollBarHover(){this._scrollbarEnable&&(this._scrollbarY.isFocus||this._scrollbarX.isFocus)&&(this._scrollbarY.isFocus=!1,this._scrollbarX.isFocus=!1,this.scheduleRender())},_getScrollViewBoundingbox(){const{width:t,height:e,x:i,y:s}=this.bounding_box;return{width:t+240,height:e+240,x:i-120,y:s-120}},scrollBarOnPanAndZoom(){if(!this._scrollbarEnable||this._scrollBarStatus.dragging)return;const{width:t,height:e,x:i,y:s}=this._getScrollViewBoundingbox();let[n,o,r,a]=this._getViewBox();const h=Math.max(r,i+t),c=Math.min(n,i),l=Math.min(o,s),d=Math.max(a,s+e),u=r-n,g=a-o,{actual_width:f,actual_height:p}=this.canvasMeta,_=u/(h-c);if(_<1){const t=f*_,e=(n-c)*_*this.scale;this._scrollbarX.anchor=[e,p-10],this._scrollbarX.width=t,this._scrollBarStatus.scollbarWidth=t}const m=g/(d-l);if(m<1){const t=p*m,e=(o-l)*m*this.scale;this._scrollbarY.anchor=[f-10,e],this._scrollbarY.height=t,this._scrollBarStatus.scollbarHeight=t}Object.assign(this._scrollBarStatus,{yscale:m,xscale:_,realR:h,realL:c,realT:l,realB:d})},resetScollBarStatus(){this._scrollbarEnable&&Object.assign(this._scrollBarStatus,{dragging:!1,target:null,x:void 0,y:void 0})},renderScrollBar(t){if(this._scrollbarEnable){t.setTransform(),t.scale(this.dpr,this.dpr);const{xscale:e,yscale:i}=this._scrollBarStatus;e<1&&this._scrollbarX.render(t),i<1&&this._scrollbarY.render(t)}}},lt={initSchedule(){this.__clock__=void 0},scheduleRender(t){requestAnimationFrame((e=>{this.__clock__!==e&&this.__render(),t&&t(e),this.__clock__=e}))}};class dt extends CustomEvent{constructor(t,e={}){super(t,{detail:{...e,originEvent:e.event,target:e.target,jflow:e.jflow,bubbles:e.bubbles||!1}})}}class ut{constructor(t={}){this.plugin=function(){let t={pointerDown:!1,dirty:!1};return{canvas:{wheel:function(t,e){t.preventDefault();let{offsetX:i,offsetY:s,deltaX:n,deltaY:o}=t;t.ctrlKey?(o=-o,e.zoomHandler(i,s,n,o,t)):e.panHandler(-n,-o,t)},pointerdown:function(e,i){const{offsetX:s,offsetY:n,deltaY:o,button:r}=e;0===r&&(t.pointerDown=!0,i.pressStartHandler(s,n,e))},pointermove:function(e,i){const{offsetX:s,offsetY:n}=e;t.pointerDown&&(t.dirty=!0),i.pressMoveHandler(s,n,e)},pointerup:function(e,i){e.preventDefault();const{offsetX:s,offsetY:n,button:o}=e;0===o&&t.pointerDown&&t.dirty&&(t.pointerDown=!1,t.dirty=!1,i.pressUpHanlder(!1,e))},contextmenu:function(t,e){t.preventDefault(),t.stopPropagation();const{offsetX:i,offsetY:s}=t;e.contextMenuHanlder(i,s,t)},dblclick:function(t,e){t.preventDefault(),t.stopPropagation();const{offsetX:i,offsetY:s}=t;e.dblclickHandler(i,s,t)},click:function(e,i){e.preventDefault(),e.stopPropagation();const{offsetX:s,offsetY:n}=e;t.dirty||(t.pointerDown=!1,t.dirty=!1,i.clickHanlder(s,n,e))}},document:{pointerup:function(t,e){e.pressUpHanlder(!0,t)}}}}(),this.use(t),this.canvasHandlers=[],this.documentHandlers=[]}use(t={}){const{canvas:e,document:i}=t;if(e)for(let t in e)e.hasOwnProperty(t)&&(this.plugin.canvas[t]=e[t]);if(i)for(let t in i)i.hasOwnProperty(t)&&(this.plugin.document[t]=i[t])}apply(t){const{canvas:e,document:i}=this.plugin,s=t.canvas;for(let n in e){const o=e[n];function r(e){o(e,t)}s.addEventListener(n,r),this.canvasHandlers.push({eventName:n,handlerWrapperd:r})}for(let a in i){let h,c={};function l(e){h(e,t)}"function"==typeof i[a]?h=i[a]:(h=i[a].handler,Object.assign(c,i[a].options)),document.addEventListener(a,l,c),this.documentHandlers.push({eventName:a,handlerWrapperd:l,options:c})}}unload(t){const e=t.canvas;this.canvasHandlers.forEach((({eventName:t,handlerWrapperd:i})=>{e.removeEventListener(t,i)})),this.documentHandlers.forEach((({eventName:t,handlerWrapperd:e,options:i})=>{console.log("unload",t),document.removeEventListener(t,e,i)}))}}const gt={...st,...nt,_setPadding(t){this.padding={top:t.paddingTop||t.padding||0,right:t.paddingRight||t.padding||0,bottom:t.paddingBottom||t.padding||0,left:t.paddingLeft||t.padding||0}},_setMargin(t){this.margin={top:t.marginTop||t.margin||0,right:t.marginRight||t.margin||0,bottom:t.marginBottom||t.margin||0,left:t.marginLeft||t.margin||0}},_getCenter(){const t=this.anchor,e=this.padding,i=this.margin,s=(i.left-i.right)/2,n=(i.top-i.bottom)/2,o=(e.left-e.right)/2+s,r=(e.top-e.bottom)/2+n;return this._shape.anchor=[t[0]+s,t[1]+n],[t[0]+o,t[1]+r]},setAnchorX(t){this.anchor[0]=t,this._getCenter()},setAnchorY(t){this.anchor[1]=t,this._getCenter()},setAnchor(t,e){this.anchor[0]=t,this.anchor[1]=e,this._getCenter()},_calculatePointBack(t){const[e,i]=t,[s,n]=this._getCenter();return[e-s,i-n]},_calculatePointBackWithPoint(t,e,i,s,n){const o=this.anchor,r=this.padding,a=this.margin;i[s]=t-(o[0]+(r.left-r.right)/2+(a.left-a.right)/2),i[n]=e-(o[1]+(r.top-r.bottom)/2+(a.top-a.bottom)/2)},calculateToCoordination(t){const[e,i]=t,[s,n]=this._getCenter(),o=[e+s,i+n];return this._belongs&&this._belongs.calculateToCoordination?this._belongs.calculateToCoordination(o):o},calculateToRealWorld(t){const[e,i]=t,[s,n]=this._getCenter(),o=[e+s,i+n];if(this._belongs&&this._belongs.calculateToRealWorld)return this._belongs.calculateToRealWorld(o)},clone(){const t=new(0,this.constructor)(Object.assign({},this._rawConfigs,{layout:this._layout&&this._layout.clone()}));return this.interateNodeStack((e=>{t.addToStack(e.clone())})),t.recalculate(),t.visible=this.visible,t},getBoundingDimension(){return{width:this.width,height:this.height}},getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a},getIntersectionsInFourDimension(){let t=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(t=this._belongs.calculateToCoordination(t));const[e,i]=t,s=this.width/2,n=this.height/2;return{[R.RIGHT]:[e+s,i],[R.LEFT]:[e-s,i],[R.BOTTOM]:[e,i+n],[R.TOP]:[e,i-n],[R.SELF]:[e+.618*s,i+.618*n]}},calculateIntersection(t){const[e,i]=t,[s,n]=this.anchor,o=this.width/2,r=this.height/2,a=s-e,h=n-i,c=r/o,l=Math.abs(h/a),d=e>s,u=i>n;let g,f;return l<c?(g=s+(d?o:-o),f=o*(u?l:-l)+n):(f=n+(u?r:-r),g=r/(d?l:-l)+s),[g,f]},onEnterViewbox(){this.interateNodeStack((t=>{t.onEnterViewbox()}))},onLeaveViewbox(){this.interateNodeStack((t=>{t.onLeaveViewbox()}))},destroy(){this._shape.destroy(),this.interateNodeStack((t=>{t.destroy()}))}};function ft(t,e){return[t,e]}function pt(t,e={}){const i="function"==typeof e.shapeShift?e.shapeShift:ft;class s extends J{constructor(e){super(e),this.initStack(e),this.initLayout(e),this._shape=new t(e),this._shape.anchor=[0,0],this._shape._belongs=this,this._setPadding(e),this._setMargin(e),this.definedWidth=e.width,this.minWidth=e.minWidth,this.definedHeight=e.height,this.lock=e.lock??!0,this.display=e.display||"default",this.transparent=e.transparent??!1,this._getBoundingGroupRect(),this.reflow(),this._getBoundingGroupRect(),this._cacheViewBox=[]}}return Object.assign(s.prototype,gt),Object.assign(s.prototype,{reflow(){gt.reflow.call(this);const t=this.margin,[e,s]=i(this.width-t.left-t.right,this.height-t.top-t.bottom,this._shape);this._shape.width=e,this._shape.height=s},setConfig(t){this._shape.setConfig(t),this._setPadding(t),this._setMargin(t),"opacity"in t&&(this.opacity=t.opacity),t.layout&&this._layout!==t.layout&&(this._layout=t.layout)},_getBoundingGroupRect(){const t=L(this._stack.getBoundingRectPoints()),e=this.padding,s=this.minWidth,n=this.definedWidth,o=t.width+e.left+e.right,r=t.height+e.top+e.bottom,a=s?Math.max(s,o):n||o,h=this.definedHeight||r;this._paddingWidth=a,this._paddingHeight=h;const[c,l]=i(a,h,this._shape);this._shape.width=c,this._shape.height=l;const d=this.margin;this.width=c+d.left+d.right,this.height=l+d.top+d.bottom},_getViewBox(){const t=this._belongs.getCacheViewBox(),e=this._cacheViewBox;return this._calculatePointBackWithPoint(t[0],t[1],e,0,1),this._calculatePointBackWithPoint(t[2],t[3],e,2,3),this._cacheViewBox},getCacheViewBox(){return this._cacheViewBox},render(t){t.save(),this._isMoving?t.globalAlpha=.6:1!==this.opacity&&(t.globalAlpha=this.opacity);const[e,i]=this._getCenter();this._shape.render(t),t.translate(e,i),this._stack.render(t),t.translate(-e,-i),t.restore()},isHit(t,e){const i=this._calculatePointBack(t);this._currentp=i;const s=this._stack.checkHit(i,e);return s||!this.transparent&&this._shape.isHit(t)}}),s}class _t extends J{constructor(t){super(t),this.type="Point",this.radius=t.radius||10,this._doCache()}setConfig(t){Object.keys(t).forEach((e=>{void 0!==t[e]&&null!==t[e]&&(this[e]=t[e],this._rawConfigs[e]=t[e])})),this._doCache()}_doCache(){this.width=2*this.radius,this.height=2*this.radius}render(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath(),t.arc(this.anchor[0],this.anchor[1],this.radius,0,2*Math.PI),t.fillStyle=this.backgroundColor,t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}isHit(t){const e=this.anchor;return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)<this.radius*this.radius}getBoundingRect(){const t=this.anchor,e=this.radius,i=t[0]-e,s=t[1]-e,n=t[0]+e,o=t[1]+e,r=this._boundingrect;return r[0]=i,r[1]=s,r[2]=n,r[3]=o,r}calculateIntersection(t){const[e,i]=t,[s,n]=this.anchor,o=s-e,r=n-i,a=Math.sqrt(o*o+r*r),h=this.radius/a;return[s-h*o,n-h*r]}getIntersectionsInFourDimension(){const[t,e]=this.anchor,i=this.radius;return{[R.RIGHT]:[t+i,e],[R.LEFT]:[t-i,e],[R.BOTTOM]:[t,e+i],[R.TOP]:[t,e-i]}}calculateIntersectionInFourDimension(t,e){const[i,s]=t,[n,o]=this.anchor,r=this.radius,a=n-i,h=o-s,c={[R.RIGHT]:[n+r,o],[R.LEFT]:[n-r,o],[R.BOTTOM]:[n,o+r],[R.TOP]:[n,o-r]};let l=Math.abs(h)>Math.abs(a)?h<0?R.BOTTOM:R.TOP:a<0?R.RIGHT:R.LEFT;return{p:c[l],dir:l}}getBoundingDimension(){return{width:this.width,height:this.height}}}class mt extends J{constructor(t={}){super(t),this.type="Rectangle",this.width=t.width||10,this.height=t.height||10,this.borderRadius=t.borderRadius||0,this._setBorder(t)}_setBorder(t){this.border={top:{color:t.border?.top?.borderColor||t.borderColor||"transparent",width:t.border?.top?.borderWidth||t.borderWidth||0,enable:t.border?.top?.borderWidth},right:{color:t.border?.right?.borderColor||t.borderColor||"transparent",width:t.border?.right?.borderWidth||t.borderWidth||0,enable:t.border?.right?.borderWidth},bottom:{color:t.border?.bottom?.borderColor||t.borderColor||"transparent",width:t.border?.bottom?.borderWidth||t.borderWidth||0,enable:t.border?.bottom?.borderWidth},left:{color:t.border?.left?.borderColor||t.borderColor||"transparent",width:t.border?.left?.borderWidth||t.borderWidth||0,enable:t.border?.left?.borderWidth}},this.borderColor=t.borderColor||"transparent",this.borderWidth=t.borderWidth||0}setConfig(t){Object.keys(t).forEach((e=>{void 0!==t[e]&&null!==t[e]&&(this[e]=t[e],this._rawConfigs[e]=t[e])})),this._setBorder(t)}render(t){t.save(),this._isMoving&&(t.globalAlpha=.6);const{borderRadius:e,anchor:i,width:s,height:n}=this,o=this.anchor[0]-this.width/2,r=this.anchor[1]-this.height/2,a=this.anchor[0]+this.width/2,h=this.anchor[1]+this.height/2;if(this.borderRadius?(t.beginPath(),t.moveTo(o+e,r),t.lineTo(o+s-e,r),t.quadraticCurveTo(o+s,r,o+s,r+e),t.lineTo(o+s,r+n-e),t.quadraticCurveTo(o+s,r+n,o+s-e,r+n),t.lineTo(o+e,r+n),t.quadraticCurveTo(o,r+n,o,r+n-e),t.lineTo(o,r+e),t.quadraticCurveTo(o,r,o+e,r),t.closePath()):(t.beginPath(),t.rect(this.anchor[0]-this.width/2,this.anchor[1]-this.height/2,this.width,this.height)),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor),this.shadowColor&&"transparent"!==this.shadowColor){t.shadowColor=this.shadowColor;const i=this._jflow.scale;t.shadowBlur=this.shadowBlur*i,t.shadowOffsetX=this.shadowOffsetX*i,t.shadowOffsetY=this.shadowOffsetY*i;let a=new Path2D;this.borderRadius?(a.moveTo(o+e,r),a.lineTo(o+s-e,r),a.quadraticCurveTo(o+s,r,o+s,r+e),a.lineTo(o+s,r+n-e),a.quadraticCurveTo(o+s,r+n,o+s-e,r+n),a.lineTo(o+e,r+n),a.quadraticCurveTo(o,r+n,o,r+n-e),a.lineTo(o,r+e),a.quadraticCurveTo(o,r,o+e,r),a.closePath()):a.rect(this.anchor[0]-this.width/2,this.anchor[1]-this.height/2,this.width,this.height),a.rect(o-10,r-10,this.width+20,this.height+20),t.save(),t.clip(a,"evenodd"),t.stroke(),t.restore()}if(t.fillStyle=this.backgroundColor,t.fill(),this.borderRadius&&this.borderWidth&&(t.shadowColor="transparent",t.stroke()),this.borderRadius){if(this.border.top.enable){const i=r-this.border.top.width/2;t.beginPath();let n=new Path2D;n.moveTo(o,i+e),n.quadraticCurveTo(o,i,o+e,i),n.lineTo(o+s-e,i),n.quadraticCurveTo(o+s,i,o+s,i+e),n.closePath(),t.clip(n),t.save(),t.shadowColor="transparent",t.fillStyle=this.border.top.color,t.rect(o,i,this.width,this.border.top.width),t.fill(),t.restore()}}else this.border.top.width&&(t.beginPath(),t.moveTo(o,r),t.lineTo(a,r),t.strokeStyle=this.border.top.color,t.lineWidth=this.border.top.width,t.stroke()),this.border.right.width&&(t.beginPath(),t.moveTo(a,r),t.lineTo(a,h),t.strokeStyle=this.border.right.color,t.lineWidth=this.border.right.width,t.stroke()),this.border.bottom.width&&(t.beginPath(),t.moveTo(a,h),t.lineTo(o,h),t.strokeStyle=this.border.bottom.color,t.lineWidth=this.border.bottom.width,t.stroke()),this.border.left.width&&(t.beginPath(),t.moveTo(o,h),t.lineTo(o,r),t.strokeStyle=this.border.left.color,t.lineWidth=this.border.left.width,t.stroke());t.restore()}isHit(t){const e=this.anchor,i=this.width/2,s=this.height/2;return t[0]>e[0]-i&&t[0]<e[0]+i&&t[1]>e[1]-s&&t[1]<e[1]+s}getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a}getBoundingDimension(){return{height:this.height,width:this.width}}calculateIntersection(t){const[e,i]=t,[s,n]=this.anchor,o=this.width/2,r=this.height/2,a=s-e,h=n-i,c=r/o,l=Math.abs(h/a),d=e>s,u=i>n;let g,f;return l<c?(g=s+(d?o:-o),f=o*(u?l:-l)+n):(f=n+(u?r:-r),g=r/(d?l:-l)+s),[g,f]}getIntersectionsInFourDimension(){let t=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(t=this._belongs.calculateToCoordination(t));const[e,i]=t,s=this.width/2,n=this.height/2;return{[R.RIGHT]:[e+s,i],[R.LEFT]:[e-s,i],[R.BOTTOM]:[e,i+n],[R.TOP]:[e,i-n]}}calculateIntersectionInFourDimension(t,e){const[i,s]=t;let n=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(n=this._belongs.calculateToCoordination(n));const[o,r]=n,a=this.width/2,h=this.height/2,c={[R.RIGHT]:[o+a,r],[R.LEFT]:[o-a,r],[R.BOTTOM]:[o,r+h],[R.TOP]:[o,r-h]},l=o-i,d=r-s,u=h/a,g=i>o;let f=Math.abs(d/l)>u?s>r?R.BOTTOM:R.TOP:g?R.RIGHT:R.LEFT;return{p:c[f],dir:f}}}class bt extends J{constructor(t={}){super(t),this.type="Capsule",this.width=t.width||20,this.height=t.height||10}render(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();const[e,i]=this.anchor,s=this.width/2,n=this.height/2,o=e-s+n,r=e+s-n,a=i-n,h=i+n;t.moveTo(o,a),t.lineTo(r,a),t.arc(r,i,n,-Math.PI/2,Math.PI/2),t.lineTo(o,h),t.arc(o,i,n,Math.PI/2,Math.PI/2*3),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}isHit(t){const e=this.anchor,i=this.width/2,s=this.height/2,n=Math.abs(i-s),o=e[0]-i+s,r=e[0]+i-s,a=s*s;return t[0]>e[0]-n&&t[0]<e[0]+n&&t[1]>e[1]-s&&t[1]<e[1]+s||Math.pow(t[0]-o,2)+Math.pow(t[1]-e[1],2)<a||Math.pow(t[0]-r,2)+Math.pow(t[1]-e[1],2)<a}getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a}getBoundingDimension(){return{height:this.height,width:this.width}}getIntersectionsInFourDimension(){let t=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(t=this._belongs.calculateToCoordination(t));const[e,i]=t,s=this.width/2,n=this.height/2;return{[R.RIGHT]:[e+s,i],[R.LEFT]:[e-s,i],[R.BOTTOM]:[e,i+n],[R.TOP]:[e,i-n]}}}class wt extends bt{render(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();const[e,i]=this.anchor,s=this.width/2,n=this.height/2,o=i-n+s,r=i+n-s,a=e-s,h=e+s;t.moveTo(a,o),t.arc(e,o,s,-Math.PI,0),t.lineTo(h,r),t.arc(e,r,s,0,Math.PI),t.closePath(),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}isHit(t,e){const[i,s]=this.anchor,n=this.width/2,o=this.height/2,r=Math.abs(o-n),a=s-o+n,h=s+o-n,c=n*n;return t[0]>i-n&&t[0]<i+n&&t[1]>s-r&&t[1]<s+r||Math.pow(t[0]-i,2)+Math.pow(t[1]-a,2)<c||Math.pow(t[0]-i,2)+Math.pow(t[1]-h,2)<c}}class xt extends J{constructor(t={}){super(t),this.type="Rhombus",this.height=t.diagonalsV||10,this.width=t.diagonalsH||20}render(t){t.save(),this._isMoving&&(t.globalAlpha=.6);const e=this.width/2,i=this.height/2,s=this.anchor;if(t.translate(s[0],s[1]),t.beginPath(),t.moveTo(0,-i),t.lineTo(e,0),t.lineTo(0,i),t.lineTo(-e,0),t.closePath(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor),this.shadowColor){t.shadowColor=this.shadowColor;const s=this._jflow.scale;t.shadowBlur=this.shadowBlur*s,t.shadowOffsetX=this.shadowOffsetX*s,t.shadowOffsetY=this.shadowOffsetY*s;let n=new Path2D;n.moveTo(0,-i),n.lineTo(e,0),n.lineTo(0,i),n.lineTo(-e,0),n.closePath(),n.rect(-e-10,-i-10,this.width+20,this.height+20),t.save(),t.clip(n,"evenodd"),t.stroke(),t.restore()}t.fillStyle=this.backgroundColor,t.fill(),this.borderWidth&&(t.shadowColor="transparent",t.stroke()),t.translate(-s[0],-s[1]),t.restore()}isHit(t){const e=this.height/2,i=this.width/2,s=this.anchor;return Math.abs(t[0]-s[0])/i+Math.abs(t[1]-s[1])/e<=1}getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a}getBoundingDimension(){return{height:this.height,width:this.width}}getIntersectionsInFourDimension(){let t=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(t=this._belongs.calculateToCoordination(t));const[e,i]=t,s=this.width/2,n=this.height/2;return{[R.RIGHT]:[e+s,i],[R.LEFT]:[e-s,i],[R.BOTTOM]:[e,i+n],[R.TOP]:[e,i-n],[R.SELF]:[e+.618*s,i+.618*n]}}}class vt extends J{constructor(t={}){super(t),this.type="Diamond",this.width=t.width||20,this.height=t.height||10,this.side=t.side||6,this._doCache()}setConfig(t){Object.keys(t).forEach((e=>{void 0!==t[e]&&null!==t[e]&&(this[e]=t[e],this._rawConfigs[e]=t[e])})),this._doCache()}_doCache(){this.sinSIDE=Math.sin(Math.PI/3)*this.side,this.cosSIDE=Math.cos(Math.PI/3)*this.side}render(t){const[e,i]=this.anchor,s=this.width/2,n=this.height/2,o=n/1.732,r=e-s+o,a=e+s-o,h=e+s,c=e-s,l=i-n,d=i+n;this._cachePoints=[[a,l],[h,i],[a,d],[r,d],[c,i],[r,l]],t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();const{side:u,sinSIDE:g,cosSIDE:f}=this;t.moveTo(e,l),t.lineTo(a-u,l),t.quadraticCurveTo(a,l,a+f,l+g),t.lineTo(h-f,i-g),t.quadraticCurveTo(h,i,h-f,i+g),t.lineTo(a+f,d-g),t.quadraticCurveTo(a,d,a-u,d),t.lineTo(r+u,d),t.quadraticCurveTo(r,d,r-f,d-g),t.lineTo(c+f,i+g),t.quadraticCurveTo(c,i,c+f,i-g),t.lineTo(r-f,l+g),t.quadraticCurveTo(r,l,r+u,l),t.closePath(),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore()}isHit(t){if(!this._cachePoints)return!1;const e=this._cachePoints;let i=!1;for(let s=0,n=e.length-1;s<e.length;s++)e[s][1]>t[1]!=e[n][1]>t[1]&&t[0]<(e[n][0]-e[s][0])*(t[1]-e[s][1])/(e[n][1]-e[s][1])+e[s][0]&&(i=!i),n=s;return i}getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a}getBoundingDimension(){return{height:this.height,width:this.width}}getIntersectionsInFourDimension(){let t=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(t=this._belongs.calculateToCoordination(t));const[e,i]=t,s=this.width/2,n=this.height/2;return{[R.RIGHT]:[e+s,i],[R.LEFT]:[e-s,i],[R.BOTTOM]:[e,i+n],[R.TOP]:[e,i-n]}}}const yt=Symbol("ishit");class kt extends ht{constructor(t,e={}){super(t,e),this.visible=!1}render(t){this.visible&&super.render(t)}setHit(t){this[yt]!==t&&(this.isFocus=t,this.onHit()),this[yt]=t}}class Tt extends J{constructor(t){super(t),this.type="ScrollGroup",this.initStack(t),this.initLayout(t),this.initScrollBar(t),this._shape=new mt(t),this._shape.anchor=[0,0],this._shape._belongs=this,this.maxWidth=t.maxWidth||1/0,this.definedWidth=t.definedWidth,this.maxHeight=t.maxHeight||1/0,this.definedHeight=t.definedHeight,this.lock=t.lock??!0,this._offset=[0,0],this._getBoundingGroupRect(),this.reflow(),this._getBoundingGroupRect(),this._resetOffset(),this._cacheViewBox=[]}initScrollBar(t){const{barColor:e,barFocusColor:i,barMarginX:s,barMarginY:n,barWidth:o}=t;this._scrollbarX=new kt("x",{plainColor:e,focusColor:i,barWidth:o}),this._scrollbarY=new kt("y",{plainColor:e,focusColor:i,barWidth:o}),this._scrollbarX.barMarginX=s||1,this._scrollbarY.barMarginY=n||1;const r=()=>{this._jflow.scheduleRender()};this._scrollbarX.onHit=r,this._scrollbarY.onHit=r,this._scrollBarStatus={dragging:!1,target:null,barInitX:0,barInitY:0,barStartX:0,barStartY:0,hitScrollX:!1,hitScrollY:!1},this.addEventListener("instancePressStart",(t=>{if(this._scrollBarStatus.hitScrollX){t.detail.preventDefault(),t.detail.bubbles=!1;const e=t.detail.event.clientX;Object.assign(this._scrollBarStatus,{dragging:!0,target:this._scrollbarX,barStartX:this._scrollbarX.anchor[0],barInitX:e}),this.onScrollbarPressStart()}if(this._scrollBarStatus.hitScrollY){t.detail.preventDefault(),t.detail.bubbles=!1;const e=t.detail.event.clientY;Object.assign(this._scrollBarStatus,{dragging:!0,target:this._scrollbarY,barStartY:this._scrollbarY.anchor[1],barInitY:e}),this.onScrollbarPressStart()}}))}onScrollbarPressStart(){const t=this._jflow.canvas,e=(t=>{const{clientX:e,clientY:i}=t;this.onDraggingScrollbar(e,i)}).bind(this);document.addEventListener("pointermove",e);const i=(s=>{Object.assign(this._scrollBarStatus,{dragging:!1,target:null,barInitX:0,barInitY:0,barStartX:0,barStartY:0,hitScrollX:!1,hitScrollY:!1}),document.removeEventListener("pointermove",e),document.removeEventListener("pointerup",i),t.removeEventListener("pointerup",i)}).bind(this);t.addEventListener("pointerup",i,{once:!0}),document.addEventListener("pointerup",i,{once:!0})}onDraggingScrollbar(t,e){if(this._scrollbarX.visible&&this._scrollBarStatus.dragging){const i=this._jflow,s=i.scale,{target:n,barInitX:o,barStartX:r,barInitY:a,barStartY:h}=this._scrollBarStatus;if("x"===n.dir){const e=this._scrollbarX.width,a=this._outerWidth,h=r+(t-o)/s,c=(n.anchor[0]=Math.max(Math.min(h,a-e),0))/(a-e),l=(this._innerWidth-a)/2;this._offset[0]=l-(this._innerWidth-a)*c,i.scheduleRender()}if("y"===n.dir){const t=this._scrollbarY.height,o=this._outerHeight,r=h+(e-a)/s,c=(n.anchor[1]=Math.max(Math.min(r,o-t),0))/(o-t),l=(this._innerHeight-o)/2;this._offset[1]=l-(this._innerHeight-o)*c,i.scheduleRender()}}}setConfig(t){this._shape.setConfig(t)}_getBoundingGroupRect(){const t=L(this._stack.getBoundingRectPoints()),e=t.width,i=t.height,s=this.definedWidth||Math.min(e,this.maxWidth),n=this.definedHeight||Math.min(i,this.maxHeight);this._innerWidth=e,this._outerWidth=s,this._innerHeight=i,this._outerHeight=n,this._shape.width=s,this._shape.height=n,this.width=s,this.height=n}_calculatePointBack(t){const[e,i]=t,[s,n]=this._offset,[o,r]=this.anchor;return[e-o-s,i-r-n]}_calculatePointBackWithPoint(t,e,i,s,n){const o=this.anchor,r=this._offset;i[s]=t-o[0]-r[0],i[n]=e-o[1]-r[1]}calculateToCoordination(t){const[e,i]=t,[s,n]=this.anchor,[o,r]=this._offset,a=[e+s-o,i+n-r];return this._belongs&&this._belongs.calculateToCoordination?this._belongs.calculateToCoordination(a):a}calculateToRealWorld(t){const[e,i]=t,[s,n]=this.anchor,[o,r]=this._offset,a=[e+s-o,i+n-r];if(this._belongs&&this._belongs.calculateToRealWorld)return this._belongs.calculateToRealWorld(a)}_getViewBox(){const t=this._cacheViewBox;return this._calculatePointBackWithPoint(0,0,t,0,1),this._calculatePointBackWithPoint(this.width,this.height,t,2,3),t}getCacheViewBox(){return this._cacheViewBox}_resetOffset(){this._offset=[Math.max((this._innerWidth-this._outerWidth)/2,0),Math.max((this._innerHeight-this._outerHeight)/2,0)],this._innerWidth>this._outerWidth?(this._scrollbarX.visible=!0,this._scrollbarX.width=this._outerWidth*this._outerWidth/this._innerWidth,this._scrollbarX.anchor=[0,this._outerHeight-4]):this._scrollbarX.visible=!1,this._innerHeight>this._outerHeight?(this._scrollbarY.visible=!0,this._scrollbarY.height=this._outerHeight*this._outerHeight/this._innerHeight,this._scrollbarY.anchor=[this._outerWidth-4,0]):this._scrollbarY.visible=!1}render(t){this._isMoving?t.globalAlpha=.6:1!==this.opacity&&(t.globalAlpha=this.opacity);const[e,i]=this.anchor,s=this.width,n=this.height,o=s/2,r=n/2,[a,h]=this._offset;t.translate(e,i),this._shape.render(t),t.translate(-o,-r),this._scrollbarX.visible&&this._scrollbarX.render(t),this._scrollbarY.visible&&this._scrollbarY.render(t),t.translate(o,r),t.save(),t.beginPath(),t.rect(-o,-r,s,n),t.clip(),t.translate(a,h),this._stack.render(t),this._linkStack.render(t),t.translate(-e-a,-i-h),t.restore()}isHit(t,e){const[i,s]=t,[n,o]=this.anchor,r=[i-n+this.width/2,s-o+this.height/2];if(this._scrollBarStatus.hitScrollX=!1,this._scrollBarStatus.hitScrollY=!1,this._scrollbarX.visible){if(this._scrollbarX.isHit(r))return this._scrollBarStatus.hitScrollX=!0,this._scrollbarX.setHit(!0),!0}if(this._scrollbarX.setHit(!1),this._scrollbarY.visible){if(this._scrollbarY.isHit(r))return this._scrollBarStatus.hitScrollY=!0,this._scrollbarY.setHit(!0),!0}this._scrollbarY.setHit(!1);if(this._shape.isHit([i-n,s-o])){const[t,r]=this._offset,a=[i-n-t,s-o-r];this._currentp=a;const h=this._stack.checkHit(a,e);if(h)return h}else this._stack.resetHitStatus();return!1}getBoundingDimension(){return{width:this.width,height:this.height}}getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a}getIntersectionsInFourDimension(){let t=this.anchor;this._belongs&&this._belongs.calculateToCoordination&&(t=this._belongs.calculateToCoordination(t));const[e,i]=t,s=this.width/2,n=this.height/2;return{[R.RIGHT]:[e+s,i],[R.LEFT]:[e-s,i],[R.BOTTOM]:[e,i+n],[R.TOP]:[e,i-n],[R.SELF]:[e+.618*s,i+.618*n]}}onEnterViewbox(){this.interateNodeStack((t=>{t.onEnterViewbox()}))}onLeaveViewbox(){this.interateNodeStack((t=>{t.onLeaveViewbox()}))}destroy(){this._shape.destroy(),this.interateNodeStack((t=>{t.destroy()}))}clone(){const t=new(0,this.constructor)(Object.assign({},this._rawConfigs,{layout:this._layout&&this._layout.clone()}));return this.interateNodeStack((e=>{t.addToStack(e.clone())})),t.recalculate(),t.visible=this.visible,t}}Object.assign(Tt.prototype,st),Object.assign(Tt.prototype,nt),Object.assign(Tt.prototype,{recalculateUp(){let t=!0;if(this.getBoundingDimension){const e=this._innerWidth,i=this._innerHeight;this.resetChildrenPosition&&this.resetChildrenPosition(),this._getBoundingGroupRect&&this._getBoundingGroupRect(),this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect();const s=this._innerWidth,n=this._innerHeight;t=e!==s||i!==n}else this.reflow();this._belongs&&t&&(this._resetOffset(),this._belongs.recalculateUp())},recalculate(){const{width:t,height:e}=this.getBoundingDimension();this.reflow(),this._getBoundingGroupRect&&this._getBoundingGroupRect();const{width:i,height:s}=this.getBoundingDimension();t===i&&e===s||this._resetOffset()}});var St={canvas:{wheel(t,e){t.preventDefault();let{offsetX:i,offsetY:s,deltaX:n,deltaY:o}=t;t.ctrlKey&&(o=-o),e.zoomHandler(i,s,n,o,t)}}};class Et extends K{constructor(t={}){super(),this.from=t.from,this.to=t.to,this.fromDir=t.fromDir,this.toDir=t.toDir,this._cachePoints=null,this.backgroundColor=t.backgroundColor||"#000",this.isSelf=!!t.isSelf}isInViewBox(t){return!0}bringToTop(){const t=this._jflow._linkStack,e=t.findIndex((t=>t===this));t.splice(e,1),t.push(this),this._jflow._render()}}class Ct extends J{constructor(t){super(t),this.width=t.width,this.height=t.height,this.imageBuffer=document.createElement("canvas"),this.imageBuffer.width=this.width+2,this.imageBuffer.height=this.height+2,t.cache(this.imageBuffer.getContext("2d"))}render(t){const[e,i]=this.anchor;t.save(),t.translate(e,i),t.beginPath(),t.drawImage(this.imageBuffer,-this.width/2,-this.height/2),t.translate(-e,-i),t.restore()}getBoundingDimension(){return{height:this.height,width:this.width}}recalculate(){}getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a}}const Pt="center",Bt="left",Mt="right";class Ot extends mt{constructor(t){super(t),this.type="Text",this.content=t.content||"",this.fontFamily=t.fontFamily||"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",this.fontSize=t.fontSize||"14px",this.fontWeight=t.fontWeight||"",this.textColor=t.textColor||"white",this.placeholderColor=t.placeholderColor||t.textColor||"white",this.textAlign=t.textAlign||Pt,this.textBaseline=t.textBaseline||"middle",this.lineHeight=t.lineHeight,this.indent=t.indent||0,this.backgroundColor=t.backgroundColor,this.editable=t.editable,this.definedWidth=t.definedWidth,this.minWidth=t.minWidth||0,this.maxWidth=t.maxWidth,this.ellipsis=t.ellipsis,this.placeholder=t.placeholder||"",this.emptyWhenInput=t.emptyWhenInput||!1,this.editting=!1,this.disabled=t.disabled,this.cursorColor=t.cursorColor||"#60CFC4",this.textRangeColor=t.textRangeColor||"#4E75EC1A",this._status={editing:!1,cursorshow:!0,cursoranime:null,lastElapsed:0,refreshElapsed:!1,cursorDragging:!1,shiftOn:!1,oldVal:"",inputElement:null},this._cursorOffset=0,this._textRange={enable:!1,rangefrom:null,rangeTo:null,initialRange:null},this.editable&&this._makeFunctional(),this.preCalculateText(),this.shadowCache()}get currentContent(){return this.content||this.placeholder}get isEmpty(){return!this.content}preCalculateText(){o((t=>{t.beginPath(),t.font=`${this.fontSize} ${this.fontFamily}`,t.textAlign=this.textAlign,t.textBaseline=this.textBaseline;const e=parseInt(this.fontSize),i=this.currentContent,{fontBoundingBoxAscent:s,fontBoundingBoxDescent:n,width:o}=t.measureText(i);if(this._textWidth=this.indent+o,this.definedWidth){if(this.ellipsis&&this._textWidth>this.definedWidth){const t=this._calculateOffset(this.definedWidth-12);this.ellipsisContent=i.substring(0,t)+"..."}else this.ellipsisContent=i;this.width=this.definedWidth}else if(this.maxWidth&&this.ellipsis){if(this._textWidth>this.maxWidth){const t=this.maxWidth/this._textWidth,e=Math.floor(i.length*t-3);this.ellipsisContent=i.substring(0,e)+"..."}else this.ellipsisContent=i;this.width=Math.min(this.maxWidth,this._textWidth)}else this.width=Math.max(this.minWidth,this._textWidth);const r=Math.abs(s)+Math.abs(n)||e;this._textHeight=r,this.lineHeight?this.height=this.lineHeight:this.height=r}))}shadowCache(){const t=window.devicePixelRatio,e=this.width*t,i=this.height*t,s=this.indent*t,n=parseInt(this.fontSize)*t;this._shadowCache=new Ct({width:e,height:i,cache:t=>{t.translate(e/2,i/2);const o=`${this.fontWeight} ${n}px ${this.fontFamily}`;t.font=o,t.textAlign=this.textAlign,t.textBaseline=this.textBaseline,t.fillStyle=this.isEmpty?this.placeholderColor:this.textColor;let r=this.currentContent;if(this.ellipsisContent&&(r=this.ellipsisContent),r)if(this.textAlign===Bt){const i=e/2;t.fillText(r,s/2-i,0)}else if(this.textAlign===Mt){const i=e/2;t.fillText(r,i,0)}else t.fillText(r,s/2,0)}})}setConfig(t){Object.keys(t).forEach((e=>{void 0!==t[e]&&null!==t[e]&&(this[e]=t[e],this._rawConfigs[e]=t[e])})),this.preCalculateText(),this.shadowCache()}click(){if(!this._status.editing){let t=!0;if(this.dispatchEvent(new dt("edit",{target:this,preventDefault(){t=!1}})),!t)return;const e=this._belongs._currentp,i=this._jflow;this._cursorOffset=e?this._positionToCursorOffset(e):0;const s=function(t,e){const i=document.createElement("input");i.setAttribute("style","\n        width: 100px;\n        position: absolute;\n        left: 0;\n        top: 0;\n        border:none;\n        opacity: 0;\n        z-index: -1;\n        contain: strict;"),i.setAttribute("tabindex",-1),i.setAttribute("aria-hidden",!0),i.setAttribute("spellcheck",!1),i.setAttribute("autocorrect","off");let s=!1,n={ctrlOn:!1};return i.addEventListener("beforeinput",(e=>{e.preventDefault(),e.data&&(s||t("Input",e.data))})),i.addEventListener("compositionstart",(e=>{t("compositionstart"),s=!0})),i.addEventListener("compositionupdate",(e=>{t("compositionupdate",e.data)})),i.addEventListener("compositionend",(e=>{t("compositionend",e.data),i.value="",s=!1})),i.addEventListener("keyup",(e=>{switch(e.key){case"Shift":t("Shift",!1);break;case"Meta":case"Control":n.ctrlOn=!1}})),i.addEventListener("keydown",(e=>{switch(e.code){case"Enter":t("Enter");break;case"Backspace":t("Backspace");break;case"ArrowLeft":t("ArrowLeft");break;case"ArrowRight":t("ArrowRight");break;case"ArrowDown":t("ArrowDown");break;case"ArrowUp":t("ArrowUp")}switch(e.key){case"Shift":t("Shift",!0);break;case"Meta":case"Control":n.ctrlOn=!0;break;case"a":n.ctrlOn&&t("CtrlA")}})),i.addEventListener("keyup",(t=>{e("KeyUp",t)})),i.addEventListener("keydown",(t=>{e("KeyDown",t)})),i.addEventListener("copy",(e=>{e.preventDefault(),e.stopPropagation(),t("COPY",null,e)})),i.addEventListener("cut",(e=>{e.preventDefault(),e.stopPropagation(),t("CUT",null,e)})),i.addEventListener("paste",(e=>{e.preventDefault(),e.stopPropagation(),t("PASTE",null,e)})),i}(this._controlCallback.bind(this),this._defaultCallback.bind(this));i.DOMwrapper.append(s),s.focus({preventScroll:!0}),i.setFocusInstance(this),Object.assign(this._status,{editing:!0,oldVal:this.content,inputElement:s,cursoranime:i.requestJFlowAnime((t=>{const e=this._status.lastElapsed;this._status.refreshElapsed&&(this._status.lastElapsed=t,this._status.refreshElapsed=!1),t-e>500&&(this._status.cursorshow=!this._status.cursorshow,this._status.lastElapsed=t)}))}),this.emptyWhenInput&&(this.content=""),this.syncShadowInputPosition()}}_makeFunctional(){const t=t=>{this._status.editing=!1,this._status.inputElement&&this._status.inputElement.remove(),this._belongs&&this._jflow.scheduleRender()};this.addEventListener("dblclick",(t=>{t.currentTarget===this&&this._status.editing&&this._selectFullRange()})),this.addEventListener("click",(t=>{if(t.currentTarget===this){if(this._status.editing){const t=this._belongs._currentp,e=this._positionToCursorOffset(t);if(this._status.shiftOn){const t=this._textRange.initialRange;Object.assign(this._textRange,{rangefrom:Math.min(e,t),rangeTo:Math.max(e,t),enable:!0}),this._cursorOffset=this._textRange.rangeTo,this._status.inputElement.focus({preventScroll:!0})}else this._cursorOffset=e,this._status.inputElement.focus({preventScroll:!0}),this._refreshCursor(),this.syncShadowInputPosition()}this.click()}})),this.addEventListener("blur",(e=>{t(),this.dispatchEvent(new dt("change",{target:this,oldVal:this._status.oldVal,val:this.content})),this._textRange.enable=!1,this._status.cursoranime.cancel(),Object.assign(this._status,{editing:!1,cursorshow:!0,cursoranime:null,lastElapsed:0,refreshElapsed:!1,cursorDragging:!1,shiftOn:!1,oldVal:"",inputElement:null})})),this.addEventListener("instancePressStart",(t=>{if(this._status.editing&&!this._status.shiftOn){t.detail.bubbles=!1,t.detail.preventDefault();const e=this._belongs._currentp,i=this._positionToCursorOffset(e);this._textRange.initialRange=i;const s=t.detail.jflow;let n=!1;const o=(t=>{n=!0;const{offsetX:e,offsetY:i}=t,o=s._calculatePointBack([e,i]);s._stack.checkHit(o);const r=this._belongs._currentp,a=this._positionToCursorOffset(r),h=this._textRange.initialRange;this._status.editing=!1,Object.assign(this._textRange,{rangefrom:Math.min(a,h),rangeTo:Math.max(a,h),enable:!0})}).bind(this);document.addEventListener("pointermove",o),document.addEventListener("pointerup",(t=>{if(document.removeEventListener("pointermove",o),!n)return void(this._textRange.initialRange=null);const e=this._textRange.rangeTo;this._cursorOffset=e,this._status.editing=!0,this._status.inputElement.focus({preventScroll:!0}),this._textRange.initialRange=null}),{once:!0})}}))}_positionToCursorOffset(t){const[e]=t,i=this.width/2,[s]=this.anchor,n=e-(s-i);let o=0;return o=n>=this._textWidth?this.content.length:this._calculateOffset(n),o}_calculateOffset(t){const e=this.content,i=e.length-1,s=this._textWidth;if(0===s)return 0;const n=s;let r=Math.floor(t/n*i);return o((s=>{let o,a,h;s.font=`${this.fontSize} ${this.fontFamily}`;let c=e.substring(0,r),l=e.substring(r-1,r),d=e.substring(r,r+1),u=s.measureText(c).width,g=s.measureText(l).width,f=s.measureText(d).width;o=u-g/2,a=u+f/2;do{if(o<=t&&a>=t)break;if(o>t){const i=a-t;h=r,r-=i<100?1:Math.floor(i/a*h),c=e.substring(r,h),u-=s.measureText(c).width}else if(a<t){const a=t-o;h=r,r+=a<100?1:Math.floor(a/(n-o)*(i-h)),c=e.substring(h,r),u+=s.measureText(c).width}l=e.substring(r-1,r),d=e.substring(r,r+1),g=s.measureText(l).width,f=s.measureText(d).width,o=u-g/2,a=u+f/2}while(r>=0&&r<=i)})),r}_refreshCursor(){this._status.editing&&Object.assign(this._status,{cursorshow:!0,refreshElapsed:!0}),this._textRange.enable&&(this._textRange.enable=!1)}render(t){if(this._isMoving&&(t.globalAlpha=.6),!t.disableCache&&!this._status.editing&&this._jflow.scale*parseInt(this.fontSize)<8){const[e,i]=this.anchor;return t.save(),t.translate(e,i),t.beginPath(),t.drawImage(this._shadowCache.imageBuffer,-this.width/2,-this.height/2,this.width,this.height),t.translate(-e,-i),void t.restore()}const e=`${this.fontWeight} ${this.fontSize} ${this.fontFamily}`;t.font!==e&&(t.font=e),t.textAlign!==this.textAlign&&(t.textAlign=this.textAlign),t.textBaseline!==this.textBaseline&&(t.textBaseline=this.textBaseline),t.fillStyle=this.isEmpty?this.placeholderColor:this.textColor;let i=this.currentContent;if(this.ellipsisContent&&(i=this.ellipsisContent),i)if(this.textAlign===Bt){const e=this.width/2;t.fillText(i,this.anchor[0]-e+this.indent/2,this.anchor[1])}else if(this.textAlign===Mt){const e=this.width/2;t.fillText(i,this.anchor[0]+e,this.anchor[1])}else t.fillText(i,this.anchor[0]+this.indent/2,this.anchor[1]);const s=this.width/2,n=this._textHeight,[o,r]=this.anchor,a=o-s,h=r-n/2;if(this._status.cursorshow&&this._status.editing){const e=this._cursorOffset,i=this.content.substring(0,e),s=a+t.measureText(i).width,n=this._textHeight/2;t.beginPath(),t.moveTo(s,r-n),t.lineTo(s,r+n),t.lineWidth=2,t.strokeStyle=this.cursorColor,t.stroke()}if(this._textRange.enable){const{rangefrom:e,rangeTo:i}=this._textRange,s=this.content.substring(0,e),o=this.content.substring(e,i),r=a+t.measureText(s).width,c=t.measureText(o).width;t.beginPath(),t.rect(r,h,c,n),t.fillStyle=this.textRangeColor,t.fill()}}_inputControl(t,e){if(this._textRange.enable&&(this._clearTextRange(),"Backspace"===t))return this.dispatchEvent(new dt("input",{target:this,oldVal:this._status.oldVal,val:this.content})),this.refresh(),void this.syncShadowInputPosition();const i=this._cursorOffset,s=this.content;let n,o=s.substring(0,i);n=this.cacheIdx?s.substring(this.cacheIdx[1]):s.substring(i);let r=!1;switch(t){case"Input":o+=e,this._cursorOffset+=e.length,this.content=o+n;break;case"compositionstart":this.cacheIdx=[o.length,o.length];break;case"compositionupdate":o=o.substring(0,this.cacheIdx[0]),o+=e,this.content=o+n,this._cursorOffset=this.cacheIdx[0]+e.length,this.cacheIdx[1]=this.cacheIdx[0]+e.length;break;case"compositionend":o=o.substring(0,this.cacheIdx[0]),this._cursorOffset=this.cacheIdx[0]+e.length,this.cacheIdx=null,o+=e,this.content=o+n;break;case"Enter":if(this.cacheIdx)return;let t=!0;this.dispatchEvent(new dt("enterkeypressed",{target:this,handler:e=>{t=e},stopInput(){r=!0}})),t&&this._jflow.blur();break;case"Backspace":o=o.substring(0,o.length-1),this._cursorOffset=Math.max(0,this._cursorOffset-1),this.content=o+n}r||this.dispatchEvent(new dt("input",{target:this,oldVal:this._status.oldVal,val:this.content})),this.refresh(),this.syncShadowInputPosition()}refresh(){this.preCalculateText(),this._belongs.recalculateUp(),this._jflow.scheduleRender()}syncShadowInputPosition(){if(this._status.editing){const t=this.width/2,e=this.height/2;let i=this.anchor[0]-t;const s=this._cursorOffset;o((t=>{t.beginPath(),t.font=`${this.fontSize} ${this.fontFamily}`;const e=this.content.substring(0,s);i+=t.measureText(e).width}));const n=this.calculateToRealWorld([i,e]),r=this._jflow.canvasMeta,a=Math.min(r.actual_width-120,n[0]);this._status.inputElement.style.transform=`translate(${a}px, ${n[1]}px)`}}_controlCallback(t,e,i){switch(this._status.editing&&Object.assign(this._status,{cursorshow:!0,refreshElapsed:!0}),t){case"Input":case"compositionstart":case"compositionupdate":case"compositionend":case"Enter":case"Backspace":this._inputControl(t,e);break;case"ArrowLeft":this._textRange.enable&&(this._textRange.enable=!1),this._onArrowLeft();break;case"ArrowRight":this._textRange.enable&&(this._textRange.enable=!1),this._onArrowRight();break;case"Shift":this._onShiftToggle(e);break;case"CtrlA":this._selectFullRange();break;case"COPY":this._copy(i);break;case"CUT":this._cut(i);break;case"PASTE":this._paste(i)}}_onArrowLeft(){this._cursorOffset=Math.max(0,this._cursorOffset-1),this._jflow.scheduleRender(),this.syncShadowInputPosition()}_onArrowRight(){this._cursorOffset=Math.min(this.content.length,this._cursorOffset+1),this._jflow.scheduleRender(),this.syncShadowInputPosition()}_onShiftToggle(t){this._status.shiftOn=t,this._textRange.initialRange=t?this._cursorOffset:null}_selectFullRange(){this._textRange={enable:!0,rangefrom:0,rangeTo:this.content.length},this._cursorOffset=this.content.length}_clearTextRange(){if(this._textRange.enable){const{rangefrom:t,rangeTo:e}=this._textRange,i=this.content,s=i.substring(0,t),n=i.substring(e);this.content=s+n,this._cursorOffset=s.length,this._textRange.enable=!1}}_getSelection(){if(this._textRange.enable){const{rangefrom:t,rangeTo:e}=this._textRange;return this.content.substring(t,e)}return null}_copy(t){const e=this._getSelection();e&&t.clipboardData.setData("text/plain",e)}_cut(t){const e=this._getSelection();e&&(t.clipboardData.setData("text/plain",e),this._clearTextRange(),this.refresh())}_paste(t){let e=(t.clipboardData||window.clipboardData).getData("text"),i=!1;if(this.dispatchEvent(new dt("paste",{target:this,content:e,preventDefault(){i=!0},resolvePasteContent(t){e=t(e)}})),i)return;this._clearTextRange();const s=this._cursorOffset,n=this.content,o=n.substring(0,s),r=n.substring(s);this.content=o+e+r,this._cursorOffset=(o+e).length,this.refresh()}_defaultCallback(t,e){switch(t){case"KeyDown":this.dispatchEvent(new dt("keydown",{target:this,key:e.key,code:e.code,rawEvent:e}));break;case"KeyUp":this.dispatchEvent(new dt("keyup",{target:this,key:e.key,code:e.code,rawEvent:e}))}}destroy(){this._jflow._focus.instance===this&&this._jflow.blur()}}class Rt extends mt{constructor(t){super(t),this.image=t.image,this.image.onload=()=>{this._jflow._render()},this.imageBounding={width:t.imageWidth||t.width,height:t.imageHeight||t.height}}setConfig(t){Object.keys(t).forEach((e=>{void 0!==t[e]&&null!==t[e]&&(this[e]=t[e],this._rawConfigs[e]=t[e])})),t.image&&!t.image.complete&&(this.image.onload=()=>{this._jflow._render()}),this.imageBounding={width:t.imageWidth||t.width||this.imageBounding.width,height:t.imageHeight||t.height||this.imageBounding.height}}render(t){t.save(),this._isMoving&&(t.globalAlpha=.6),mt.prototype.render.call(this,t);const e=this.anchor[0]-this.width/2,i=this.anchor[1]-this.height/2;this.opacity<1&&(t.globalAlpha=this.opacity),this.image.complete&&t.drawImage(this.image,e,i,this.imageBounding.width,this.imageBounding.height),t.restore()}}class It extends mt{constructor(t){super(t),this.domFactory=t.createDocument,this._dom=null}getRealWorldPosition(){const t=this.getBoundingRect();return this.calculateToRealWorld(t.slice(0,2))}render(t){if(!this._dom&&this.domFactory)requestAnimationFrame((()=>{if(!this._dom){const t=document.createElement("div"),e=this.getRealWorldPosition(),i=this._jflow.scale;t.setAttribute("style",`\n                        position: absolute;\n                        width: ${this.width}px;\n                        height: ${this.height}px;\n                        transform-origin: left top;\n                        top: 0;\n                        left: 0;\n                        transform: translate(${e[0]}px, ${e[1]}px) scale(${i});`),this._dom=t,this._jflow.DOMwrapper.appendChild(t),this.domFactory(t)}}));else{const t=this.getRealWorldPosition(),e=this._jflow.scale;this._dom.style.transform=`translate(${t[0]}px, ${t[1]}px) scale(${e})`}super.render(t)}onEnterViewbox(){this._dom&&(this._dom.style.display="block")}onLeaveViewbox(){this._dom&&(this._dom.style.display="none")}destroy(){this._dom&&this._jflow.DOMwrapper.removeChild(this._dom),super.destroy()}}class Lt extends Et{constructor(t){super(t),this.fontFamily=t.fontFamily="-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",this.fontSize=t.fontSize||"12px",this.content=t.content||"",this.lineDash=t.lineDash,this.approximate=t.approximate||6,this._cacheAngle=void 0,this._cachePoints=[],this._cacheBoundingbox={from:[],to:[]}}_calculateAnchorPoints(){const t=this.from.calculateIntersection(this.to.getCenter()),e=this.to.calculateIntersection(this.from.getCenter());this._cachePoints[0]=t,this._cachePoints[1]=e;const i=e[0]-t[0],s=e[1]-t[1],n=Math.atan2(s,i);this._cacheAngle=n}isInViewBox(t){const e=this.from.getBoundingRect(),i=this.to.getBoundingRect(),s=this._cacheBoundingbox;return G(s.from,e)&&!G(s.to,i)||($(s.from,e),$(s.to,i),this._calculateAnchorPoints()),!0}render(t){const[e,i]=this._cachePoints,s=this._cacheAngle,n=i[0]-e[0],o=i[1]-e[1];if(t.fillStyle=t.strokeStyle=this.backgroundColor,t.beginPath(),this.content){t.textAlign="center",t.font=`${this.fontSize} ${this.fontFamily}`,t.textBaseline="middle";const{actualBoundingBoxLeft:s,actualBoundingBoxRight:r,fontBoundingBoxAscent:a,fontBoundingBoxDescent:h}=t.measureText(this.content),c=n/2+e[0],l=o/2+e[1];t.fillText(this.content,c,l);const d=Math.abs(s)+Math.abs(r)+20,u=1.5*(Math.abs(a)+Math.abs(h));t.beginPath();let g=new Path2D;g.rect(c-d/2,l-u/2,d,u);const f=Math.min(i[0],e[0])-10,p=Math.min(i[1],e[1])-10,_=Math.abs(n)+20,m=Math.abs(o)+20;g.rect(f,p,_,m),t.clip(g,"evenodd")}t.moveTo(e[0],e[1]),t.lineTo(i[0],i[1]),this.lineDash&&(t.save(),t.setLineDash(this.lineDash)),t.stroke(),this.lineDash&&t.restore(),t.translate(i[0],i[1]),t.rotate(s),t.moveTo(0,0),t.lineTo(-5,-4),t.lineTo(-5,4),t.lineTo(0,0),t.fill(),t.rotate(-s),t.translate(-i[0],-i[1])}isHit(t){if(!this._cachePoints)return!1;const[e,i]=this._cachePoints;return W(t,e,i)<this.approximate}}const Dt=Math.PI/180;class jt extends Et{constructor(t){super(t),this.approximate=t.approximate||6,this.radius=t.radius||0,this.minSpanX=t.minSpanX||10,this.minSpanY=t.minSpanY||10,this.lineDash=t.lineDash,this.doubleLink=t.doubleLink,this.fontFamily=t.fontFamily="-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",this.fontSize=t.fontSize||"12px",this.content=t.content||"",this.isSelf=!!t.isSelf,this.noArrow=!!t.noArrow,this._cacheAngle=[],this._cachePoints=[],this._cacheBoundingbox={from:[],to:[]}}_calculateAnchorPoints(){const t=this.from.getIntersectionsInFourDimension(),e=this.to.getIntersectionsInFourDimension(),i=this._cacheAngle;if(this.isSelf)Y(this._cachePoints,t[this.fromDir],e[R.SELF],this.fromDir,this.toDir,this.minSpanX,this.minSpanY,!0),i[0]=this.fromDir,i[1]=this.toDir;else if(void 0!==this.fromDir&&void 0!==this.toDir)Y(this._cachePoints,t[this.fromDir],e[this.toDir],this.fromDir,this.toDir,this.minSpanX,this.minSpanY),i[0]=this.fromDir,i[1]=this.toDir;else{const s=H(t,e);Y(this._cachePoints,s.fromP,s.toP,s.fromDir,s.toDir,this.minSpanX,this.minSpanY),i[0]=s.fromDir,i[1]=s.toDir}}isInViewBox(t){return!!this._static||(this._calculateAnchorPoints(),function(t,e){let i=t[0],s=t.length,n=1;const[o,r,a,h]=e;for(;n<s;){const e=t[n];if(i[0]===e[0]){if(i[0]<a&&i[0]>o&&!(i[1]>h&&e[1]>h||i[1]<r&&e[1]<r))return!0}else if(i[1]<h&&i[1]>r&&!(i[0]>a&&e[0]>a||i[0]<o&&e[0]<o))return!0;i=e,n++}return!1}(this._cachePoints,t))}render(t){const e=this.radius,i=this._cachePoints,s=i[0],n=i[i.length-1],o=(this._cacheAngle[1]+2)%4*90*Dt;if(t.fillStyle=t.strokeStyle=this.backgroundColor,this.doubleLink){const e=(this._cacheAngle[0]+2)%4*90*Dt;t.beginPath(),t.translate(s[0],s[1]),t.rotate(e),t.moveTo(5,0),t.lineTo(0,-4),t.lineTo(0,4),t.lineTo(5,0),t.fill(),t.rotate(-e),t.translate(-s[0],-s[1])}if(t.beginPath(),t.moveTo(s[0],s[1]),i.slice(1,i.length-1).forEach(((s,n)=>{if(this.radius){const o=i[n],r=i[n+2],{p1:a,p2:h}=function(t,e,i,s){const n=F(e,t),o=F(e,i),r=N(n),a=N(o);if(!r||!a)return{p1:null,p2:null};const h=q(n,s/r),c=q(o,s/a);return{p1:F(e,h),p2:F(e,c)}}(o,s,r,e);a&&h?(t.lineTo(a[0],a[1]),t.quadraticCurveTo(s[0],s[1],h[0],h[1])):t.lineTo(s[0],s[1])}else t.lineTo(s[0],s[1])})),t.lineTo(n[0],n[1]),this.lineDash&&(t.save(),t.setLineDash(this.lineDash)),t.stroke(),this.lineDash&&t.restore(),this.noArrow||(t.beginPath(),t.translate(n[0],n[1]),t.rotate(o),t.moveTo(0,0),t.lineTo(-5,-4),t.lineTo(-5,4),t.lineTo(0,0),t.fill(),t.rotate(-o),t.translate(-n[0],-n[1])),this.content)switch(t.beginPath(),t.font=`${this.fontSize} ${this.fontFamily}`,this.fromDir){case R.BOTTOM:t.textAlign="left",t.fillText(this.content,s[0]+2,s[1]+10);break;case R.RIGHT:t.textAlign="left",t.fillText(this.content,s[0]+10,s[1]-2)}}isHit(t){if(this._static)return!1;if(!this._cachePoints)return!1;const e=this._cachePoints;let i=e[0];const s=e.slice(1);do{const e=s.shift();if(e){if(W(t,i,e)<this.approximate)return!0}i=e}while(i);return!1}cloneStatic(){const t=new jt({});return Object.assign(t,{radius:this.radius,_cachePoints:this._cachePoints,_cacheAngle:this._cacheAngle,backgroundColor:this.backgroundColor,doubleLink:this.doubleLink,radius:this.radius,lineDash:this.lineDash,noArrow:this.noArrow,content:this.content,fontSize:this.fontSize,fontFamily:this.fontFamily,fromDir:this.fromDir,_static:!0}),t}}const Wt=Math.PI/180;class Ht extends Et{constructor(t){super(t),this.approximate=t.approximate||6,this.minSpanX=t.minSpanX||0,this.minSpanY=t.minSpanY||0,this.lineDash=t.lineDash,this.doubleLink=t.doubleLink,this.fontFamily=t.fontFamily="-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",this.fontSize=t.fontSize||"12px",this.content=t.content||"",this.isSelf=!!t.isSelf}_calculateAnchorPoints(){const t=this.from.getIntersectionsInFourDimension(),e=this.to.getIntersectionsInFourDimension();if(this.isSelf){const i=z(t[this.fromDir],e[R.SELF],this.fromDir,R.BOTTOM,this.minSpanX,this.minSpanY);this._cachePoints=[...t[this.fromDir],...i],this._cacheAngle=[this.fromDir,R.BOTTOM]}else if(void 0!==this.fromDir&&void 0!==this.toDir){const i=z(t[this.fromDir],e[this.toDir],this.fromDir,this.toDir,this.minSpanX,this.minSpanY);this._cachePoints=[...t[this.fromDir],...i],this._cacheAngle=[this.fromDir,this.toDir]}else{const i=H(t,e),s=z(i.fromP,i.toP,i.fromDir,i.toDir);this._cachePoints=[...i.fromP,...s],this._cacheAngle=[i.fromDir,i.toDir]}}render(t){this._calculateAnchorPoints();const e=this._cachePoints,i=X.apply(null,[1,...e]);if(t.fillStyle=t.strokeStyle=this.backgroundColor,this.doubleLink){const i=(this._cacheAngle[0]+2)%4*90*Wt;t.beginPath(),t.translate(e[0],e[1]),t.rotate(i),t.moveTo(5,0),t.lineTo(0,-4),t.lineTo(0,4),t.lineTo(5,0),t.fill(),t.rotate(-i),t.translate(-e[0],-e[1])}if(t.beginPath(),t.moveTo(e[0],e[1]),t.bezierCurveTo(...e.slice(2)),this.lineDash&&(t.save(),t.setLineDash(this.lineDash)),t.stroke(),this.lineDash&&t.restore(),t.beginPath(),t.translate(e[6],e[7]),t.rotate(i),t.moveTo(5,0),t.lineTo(0,-4),t.lineTo(0,4),t.lineTo(5,0),t.fill(),t.rotate(-i),t.translate(-e[6],-e[7]),this.content){t.beginPath();const i=e[0]>e[6];let[s,n,o]=function(t,e){const i=1-t,s=i*i*i*e[0]+3*i*i*t*e[2]+3*i*t*t*e[4]+t*t*t*e[6],n=i*i*i*e[1]+3*i*i*t*e[3]+3*i*t*t*e[5]+t*t*t*e[7],o=i*i*(e[2]-e[0])+2*t*i*(e[4]-e[2])+t*t*(e[6]-e[4]),r=i*i*(e[3]-e[1])+2*t*i*(e[5]-e[3])+t*t*(e[7]-e[5]);return[s,n,Math.atan2(r,o)]}(.5,e);t.translate(s,n),t.rotate(o),i&&t.rotate(Math.PI),t.font=`${this.fontSize} ${this.fontFamily}`,t.textAlign="center",t.fillText(this.content,0,-(parseInt(this.fontSize)||12)/4),i&&t.rotate(Math.PI),t.rotate(-o),t.translate(-s,-n)}}isHit(t){if(!this._cachePoints)return!1;const e=function(t,e){const i=new O(...e).project({x:t[0],y:t[1]});return j(t,[i.x,i.y])}(t,this._cachePoints);return e<this.approximate}}class At{constructor(t={}){this.direction=t.direction||"vertical",this.gap=t.gap??5,this.alignment=t.alignment||"center",this.justify=t.justify||"center",this._rawConfigs=t}reflow(t){const e=t._stack.filter((t=>t.visible&&!t.absolutePosition)),i=t._stack.filter((t=>t.visible&&t.absolutePosition)),s=t.width-t.padding.left-t.padding.right;if("vertical"===this.direction){let n=0,o=0,r=0,a=0;const h=e.concat(i);h.forEach(((t,e)=>{"block"===t.display&&(t.width=0,t.resetChildrenPosition(),t.reflow(),t._getBoundingGroupRect())})),e.forEach(((t,e)=>{const{width:i,height:s}=t.getBoundingDimension(),h=e>0?this.gap:0;"outstretch"!==t.display&&(r=Math.max(i,r)),a+=s+h,n+=s/2+h+o,o=s/2,t.anchor=[0,n]})),h.forEach(((e,i)=>{if("block"===e.display)e.resetChildrenPosition(),e.width=r,e.reflow();else if("outstretch"===e.display){const i=t._belongs.width-t._belongs.padding.left-t._belongs.padding.right;e.resetChildrenPosition(),e.width=Math.max(i,r),e.reflow()}})),r=Math.max(s,r),a/=2,"start"===this.alignment&&e.forEach(((t,e)=>{const{width:i}=t.getBoundingDimension();t.anchor[0]=-(r-i)/2,t.anchor[1]-=a})),"end"===this.alignment&&e.forEach(((t,e)=>{const{width:i}=t.getBoundingDimension();t.anchor[0]=(r-i)/2,t.anchor[1]-=a})),"center"===this.alignment&&e.forEach(((t,e)=>{t.getBoundingDimension(),t.anchor[1]-=a}))}if("horizontal"===this.direction){let t=0,i=0,n=0,o=0;if(e.forEach(((e,s)=>{const{width:r,height:a}=e.getBoundingDimension(),h=s>0?this.gap:0;n=Math.max(a,n),o+=r+h,t+=r/2+h+i,i=r/2,e.anchor=[t,0]})),"start"===this.justify){const t=s/2;e.forEach(((e,i)=>{e.anchor[0]-=t}))}if("end"===this.justify){const t=s/2-o;e.forEach(((e,i)=>{e.anchor[0]+=t}))}if("center"===this.justify){const t=o/2;e.forEach(((e,i)=>{e.anchor[0]-=t}))}if("space-between"===this.justify&&e.length>1){const t=Math.max(s,o),i=(t-o)/(e.length-1),n=t/2;e.forEach(((t,e)=>{t.anchor[0]+=i*e-n}))}"start"===this.alignment&&e.forEach(((t,e)=>{const{height:i}=t.getBoundingDimension();t.anchor[1]=-(n-i)/2})),"end"===this.alignment&&e.forEach(((t,e)=>{const{height:i}=t.getBoundingDimension();t.anchor[1]=(n-i)/2}))}if(i.length){"block"===t.display?t.getBoundingDimension():t._getBoundingGroupRect();const e=t.width/2,s=t.height/2,n=(t.padding.top-t.padding.bottom)/2,o=(t.padding.left-t.padding.right)/2;i.forEach((t=>{t.anchor=this._resolveAbsoluteAnchor(t.absolutePosition,t,e,s,o,n)}))}}_resolveAbsoluteAnchor(t,e,i,s,n,o){const{top:r,right:a,bottom:h,left:c,centerX:l,centerY:d}=t,{width:u,height:g}=e.getBoundingDimension(),f=u/2,p=g/2;let _=0,m=0;return"number"==typeof r&&(_=r+p-s-o),"number"==typeof a&&(m=i-a-f-n),"number"==typeof h&&(_=s-h-p-o),"number"==typeof c&&(m=c+f-i-n),"number"==typeof l&&(m=l),"number"==typeof d&&(_=d),[m,_]}clone(){return new At(this._rawConfigs)}}class zt{constructor(t){this.source=t,this.id=t.id,this.type=t.type,this.level=void 0,this.sequence=void 0,this.isFree=!1,this.parent=void 0,this.idx=void 0,this.parentIterateType=void 0,this.hasEndPoint=!1}reflowPreCalculate(t=0,e=0,i){return this.level=t,this.sequence=e,this.spanX=1,this.spanY=1,i&&i(t,e,this),{spanX:this.spanX,spanY:this.spanY,level:t,sequence:e}}makeLink(t){return this}makeEndpoint(){}traverse(t){t(this)}getNodes(t){const e=[];return this.traverse((i=>{const s=t.getRenderNodeBySource(i.source);s&&e.push(s)})),e}linkSource(t){this.parent.source[this.parentIterateType].splice(this.idx+1,0,t)}remove(){this.parent.source[this.parentIterateType].splice(this.idx,1)}}const Xt={IfStatement:class extends zt{constructor(t){super(t),this.consequent=(t.consequent||[]).map(Yt("consequent").bind(this)),this.alternate=(t.alternate||[]).map(Yt("alternate").bind(this)),this.isLocked=!0,this.hasEndPoint=!0}reflowPreCalculate(t=0,e=0,i){let s=1,n=1;this.level=t,this.sequence=e,i&&i(t,e,this);let o=1,r=0,a=0,h=0;this.consequent.forEach(((s,n)=>{const{spanX:a,spanY:h}=s.reflowPreCalculate(t+1,e,i);o=Math.max(o,a),r+=h,t+=h}));const c=e+o;t=this.level,this.alternate.forEach(((e,s)=>{const{spanX:n,spanY:o}=e.reflowPreCalculate(t+1,c,i);a=Math.max(a,n),h+=o,t+=o})),s=Math.max(1,o+a),n+=Math.max(r,h),t=this.level+n-1;const{spanY:l}=this.Endpoint.reflowPreCalculate(t+1,e,i);return n+=l,this.spanX=s,this.spanY=n,{spanX:s,spanY:n,level:t,sequence:e}}makeLink(t){let e=this;this.consequent.forEach((i=>{t({from:e,to:i,part:"consequent",fromDir:R.BOTTOM,toDir:R.TOP}),i=i.makeLink(t),e=i})),t({from:e,to:this.Endpoint,fromDir:R.BOTTOM,toDir:R.TOP,part:"consequent"});let i=this;return this.alternate.forEach((e=>{t({from:i,to:e,fromDir:i===this?R.RIGHT:R.BOTTOM,toDir:R.TOP,part:"alternate"}),e=e.makeLink(t),i=e})),t({from:i,to:this.Endpoint,fromDir:i===this?R.RIGHT:R.BOTTOM,toDir:R.RIGHT,part:"alternate"}),this.Endpoint}traverse(t){t(this),this.consequent.forEach((e=>{e.traverse(t)})),this.alternate.forEach((e=>{e.traverse(t)})),console.log(this.Endpoint),t(this.Endpoint)}linkSource(t,e){this.source[e.part].unshift(t)}},SwitchStatement:class extends zt{constructor(t){super(t),this.cases=(t.cases||[]).map(Yt("case").bind(this)),this.cases.length&&(this.cases[this.cases.length-1].lastCase=!0),this.isLocked=!0,this.hasEndPoint=!0}reflowPreCalculate(t=0,e=0,i){let s=1,n=1;this.level=t,this.sequence=e,i&&i(t,e,this);let o=1,r=0;if(this.cases.length){const s=this.cases[this.cases.length-1].consequent;t=this.level,s.forEach((s=>{const{spanX:n,spanY:a}=s.reflowPreCalculate(t+1,e,i);o=Math.max(o,n),r+=a,t+=a}))}let a=o,h=0;this.cases.forEach(((s,n)=>{const o=e+a;let r=0,c=0;t=this.level,s.alternate.forEach((e=>{const{spanX:s,spanY:n}=e.reflowPreCalculate(t+1,o,i);r=Math.max(r,s),c+=n,t+=n})),a+=r,h=Math.max(h,c)})),s=Math.max(1,a),n=Math.max(r,h),t=this.level+n;const{spanY:c}=this.Endpoint.reflowPreCalculate(t+1,e,i);return n+=c,n+=1,this.spanX=s,this.spanY=n,{spanX:s,spanY:n,level:t,sequence:e}}makeLink(t){let e=this;if(this.cases.length){this.cases[this.cases.length-1].consequent.forEach(((i,s)=>{t({from:e,to:i,fromDir:R.BOTTOM,toDir:R.TOP,part:"consequent"}),e=i.makeLink(t)}))}return console.log(e),t({from:e,to:this.Endpoint,fromDir:R.BOTTOM,toDir:R.TOP,part:"consequent"}),this.cases.forEach(((e,i)=>{let s=e;e.alternate.forEach((i=>{t({from:s,to:i,fromDir:s===e?R.RIGHT:R.BOTTOM,toDir:R.TOP,part:"alternate"}),s=i.makeLink(t)})),t({from:s,to:this.Endpoint,fromDir:s===e?R.RIGHT:R.BOTTOM,toDir:R.RIGHT,part:"alternate",minSpanX:32*(i+1)})})),this.Endpoint}traverse(t){t(this),this.cases.forEach((e=>{e.traverse(t)})),t(this.Endpoint)}getNodes(t){const e=[];return this.traverse((i=>{if("SwitchCase"===i.type)return;const s=t.getRenderNodeBySource(i.source);s&&e.push(s)})),e}linkSource(t,e){const i=this.source.cases;i[i.length-1].consequent.unshift(t)}},SwitchCase:class extends zt{constructor(t){super(t),this.consequent=(t.consequent||[]).map(Yt("consequent").bind(this)),this.alternate=(t.alternate||[]).map(Yt("alternate").bind(this)),this.lastCase=!1}reflowPreCalculate(t=0,e=0,i){let s=1,n=1;this.level=t,this.sequence=e,i&&i(t,e,this);let o=0,r=0,a=0,h=0;this.lastCase&&this.consequent.forEach(((s,n)=>{const{spanX:a,spanY:h}=s.reflowPreCalculate(t+1,e,i);o=Math.max(o,a),r+=h,t+=h}));const c=e+Math.max(o,1);return t=this.level,this.alternate.forEach(((e,s)=>{const{spanX:n,spanY:o}=e.reflowPreCalculate(t+1,c,i);a=Math.max(a,n),h+=o,t+=o})),s=Math.max(1,o+a),n+=Math.max(r,h),this.spanX=s,this.spanY=n,{spanX:s,spanY:n,level:t,sequence:e}}traverse(t){t(this),this.consequent.forEach((e=>{e.traverse(t)})),this.alternate.forEach((e=>{e.traverse(t)}))}linkSource(t,e){this.source[e.part].unshift(t)}},ForEachStatement:class extends zt{},WhileStatement:class extends zt{constructor(t){super(t),this.body=(t.body||[]).map(Yt("body").bind(this)),this.isLocked=!0}reflowPreCalculate(t=0,e=0,i){let s=1,n=1;this.level=t,this.sequence=e,i&&i(t,e,this);const o=e+1;return this.body.forEach((e=>{const{spanX:r,spanY:a}=e.reflowPreCalculate(t+1,o,i);s=Math.max(r,s),n+=a,t+=a})),this.spanX=s+1,this.spanY=n,{spanX:s,spanY:n,level:t,sequence:e}}makeLink(t){let e=this;return this.body.forEach(((i,s)=>{t({from:e,to:i,part:"body",fromDir:e===this?R.RIGHT:R.BOTTOM,toDir:R.TOP}),i=i.makeLink(t),e=i})),t({from:e,to:this,part:"body",fromDir:e===this?R.RIGHT:R.BOTTOM,anticlock:e===this,toDir:R.BOTTOM,isSelf:!0,minSpanX:20,minSpanY:20}),this}traverse(t){t(this),this.body.forEach((e=>{e.traverse(t)}))}linkSource(t,e){this.source[e.part].unshift(t)}},Root:class extends zt{constructor(t){super(t),this.isroot=!0,this.body=(t.body||[]).map(Yt("body").bind(this));const e=Yt("playground").bind(this);this.playground=(t.playground||[]).map(((t,i)=>{const s=e(t,i);return s.isFree=!0,s}))}reflowBodyPreCalculate(t=0,e=0,i){let s=1,n=1;return this.level=t,this.sequence=e,i&&i(t,e,this),this.body.forEach((o=>{const{spanX:r,spanY:a}=o.reflowPreCalculate(t+1,e,i);s=Math.max(r,s),n+=a,t+=a})),this.spanX=s,this.spanY=n,{spanX:s,spanY:n,level:t,sequence:e}}reflowPlaygroundPreCalculate(t,e){this.playground.forEach((i=>{t(i),i.reflowPreCalculate(0,0,e)}))}makeLink(t){let e;return this.body.forEach((i=>{e?(t({from:e,to:i,part:"body",fromDir:R.BOTTOM,toDir:R.TOP}),i=i.makeLink(t),e=i):e=i})),this.playground.forEach((e=>{e.makeLink(t)})),this}traverse(t){this.body.forEach((e=>{e.traverse(t)})),this.playground.forEach((e=>{e.traverse(t)}))}},other:zt};function Yt(t){return function(e,i){const s=Ft(e);if(s.parent=this,s.idx=i,s.parentIterateType=t,s.hasEndPoint){e.__endpoint__||(e.__endpoint__={type:"endpoint",id:`${s.id}-endpoint`});const n=Ft(e.__endpoint__);n.parent=this,n.idx=i,n.parentIterateType=t,s.Endpoint=n}return s}}function Ft(t){const e=t.type;return new(Xt[e]||Xt.other)(t)}function Nt(t){return t*t}class qt{constructor(t){this.linkLength=t.linkLength||18,this.gap=t.gap||30,this.treeItemDraggable=t.treeItemDraggable??!0,this.reOrder(t.ast),this.static=!0}reOrder(t){this.ast=t,this.flowStack=[],this.flowLinkStack=[],this.root=Ft(this.ast),this.root.traverse((t=>{"playground"!==t.parentIterateType&&(t.isDraggable=this.treeItemDraggable),this.flowStack.push({type:t.type,source:t.source,layoutNode:t})}));const e={vertical:{},horizontal:{}},i={};let s;this.root.reflowBodyPreCalculate(0,0,((t,i,s)=>{s.isroot||(e.vertical[t]||(e.vertical[t]={}),e.vertical[t][i]=s,e.horizontal[i]||(e.horizontal[i]={}),e.horizontal[i][t]=s)})),this.root.reflowPlaygroundPreCalculate((t=>{s=t.id,i[t.id]={vertical:{},horizontal:{},node:t}}),((t,e,n)=>{const o=i[s];o.vertical[t]||(o.vertical[t]={}),o.vertical[t][e]=n,o.horizontal[e]||(o.horizontal[e]={}),o.horizontal[e][t]=n})),this.layoutMapping=e,this.playgroundLayoutMapping=i,this.root.makeLink((t=>{this.flowLinkStack.push(t)}))}staticCheck(t,e){if(t._layoutNode&&t._layoutNode.isFree)return!1;if(!e._linkStack.find((e=>e.from===t||e.to===t)))return!1;const i=t.anchor.slice();if(e.reflow(),e._linkStack.length<2)return;const s=t.anchor;var n,o;return(o=s,Nt((n=i)[0]-o[0])+Nt(n[1]-o[1]))>1e3&&(t.dispatchEvent(new dt("outOfFlow",{anchor:i,instance:t,jflow:e,point:i})),!0)}reflowByMapping(t,e,i=0,s=0){const n=this.linkLength,o=this.gap,{vertical:r,horizontal:a}=e;let h=i;Object.keys(a).forEach(((e,i)=>{const s=a[e];let n=0;const r=Object.keys(s);r.forEach((e=>{const i=s[e],o=t.getRenderNodeBySource(i.source),{width:r}=o.getBoundingDimension();n=Math.max(r,n)})),h+=0===i?0:n/2,r.forEach((e=>{const i=s[e];t.getRenderNodeBySource(i.source).anchor[0]=h})),h+=n/2+o}));let c=s;Object.keys(r).forEach(((e,i)=>{const s=r[e];let o=0;const a=Object.keys(s);a.forEach((e=>{const i=s[e],n=t.getRenderNodeBySource(i.source),{height:r,width:a}=n.getBoundingDimension();o=Math.max(r,o)})),c+=0===i?0:o/2,a.forEach((e=>{const i=s[e];t.getRenderNodeBySource(i.source).anchor[1]=c})),c+=o/2+n}))}findLayoutNode(t){const e=this.flowStack.find((e=>e.configs===t));return e?e.layoutMeta:null}reflow(t){this.reflowByMapping(t,this.layoutMapping),Object.values(this.playgroundLayoutMapping).forEach((e=>{const i=t.getRenderNodeBySource(e.node.source);this.reflowByMapping(t,e,i.anchor[0],i.anchor[1])}))}}class Vt{constructor(t,e,i){this.type="ERProperty",this.source=t,this.node=e,this.ref=t.ref,this.type=t.type,this.association=t.association,this.id=i?`${e.id}-${t.name}-navigation`:`${e.id}-${t.name}`,this._selfLink=!1,this.parentPropertyRef=void 0,this.getJflowInstance=void 0,this.doubleRef=void 0}}class Gt{constructor(t){this.type="ERNode",this.source=t,this.id=t.name,this.isDraggable=!0,this.getJflowInstance=void 0,this.propertyList=t.propertyList.map((t=>new Vt(t,this))),this.navigationPropertyList=t.navigationPropertyList.map((t=>new Vt(t,this,!0))),this.idProperty=this.propertyList.find((t=>"id"===t.source.name))}_traverseProperty(t){this.propertyList.forEach((e=>{const i=e.source.idRef;if(e.source.isParentRef,i&&"Array"!==e.source.type&&t[i]){const s=t[i];e.source.isParentRef&&(this.parentRef=s),s===this&&(e._selfLink=!0),e.parentPropertyRef=s.idProperty}})),this.navigationPropertyList.forEach((e=>{const i=e.source.objectRef;if(i&&t[i]){const s=t[i],n=s.navigationPropertyList.find((t=>t.source.objectRef===this.id));s===this&&(e._selfLink=!0),e.doubleRef=n}}))}traverse(t){t(this),this.propertyList.forEach((e=>{e.ref instanceof Gt&&t(e)}))}makeLink(t){this.propertyList.forEach((e=>{if(e.parentPropertyRef instanceof Vt){const i=e.parentPropertyRef;e._selfLink?t({from:e.id,to:i.id,part:"property",fromDir:R.LEFT,toDir:R.LEFT,content:e.association,minSpanX:80,meta:{from:e,to:i}}):t({from:e.id,to:i.id,part:"property",content:e.association,meta:{from:e,to:i}})}})),this.navigationPropertyList.forEach((e=>{if(e.doubleRef instanceof Vt){const i=e.doubleRef;e._selfLink?t({from:e.id,to:i.id,part:"property",fromDir:R.LEFT,toDir:R.TOP,lineDash:[10,5],doubleLink:!0,content:e.association,minSpanX:80,minSpanY:80,meta:{from:e,to:i}}):t({from:e.id,to:i.id,part:"property",lineDash:[10,5],doubleLink:!0,content:e.association,meta:{from:e,to:i,isObjectRef:!0}})}}))}}class $t{constructor(t){this.static=!1,this.flowStack=[],this.flowLinkStack=[],this.erNodes=[],this.reOrder(t.entityRelationship)}reOrder(t){this.er=t,this.flowStack=[],this.flowLinkStack=[];const e=function(t){const e={},i=t.map((t=>{const i=new Gt(t);return e[t.name]=i,i}));return i.forEach((t=>{t._traverseProperty(e)})),i}(this.er),i=[];e.forEach((t=>{t.traverse((t=>{this.flowStack.push({type:t.type,configs:t.source,layoutMeta:t})})),t.makeLink((t=>{const{from:e,to:s,meta:n}=t;if(n.isObjectRef){const o=`${e}-${s}`,r=`${s}-${e}`,a=n.from;if(i.includes(o)||i.includes(r))return;a.source.isParentRef||(i.push(o),i.push(r),this.flowLinkStack.push(t))}else this.flowLinkStack.push(t)}))})),this.erNodes=e}staticCheck(t,e){return!1}reflow(t){this.flowLinkStack,this.erNodes;const e={},i=1e3;function s(t,e=[]){let n=[0,0];return t.parentRef?e.includes(t.parentRef)?[n[0]-500+t.source.diagramWeight*i,n[1]]:(e.push(t.parentRef),n=s(t.parentRef,e),[n[0]-500+t.source.diagramWeight*i,n[1]+600]):n}this.erNodes.forEach((t=>{const i=t.getJflowInstance(),[n,o]=s(t);e[o]||(e[o]=[]),e[o].push(t),i.anchor=[n+500*e[o].length,o]}))}}const Ut="input",Zt="control",Kt="input",Jt="compositionstart",Qt="compositionupdate",te="compositionend",ee="enter",ie="delete",se="backspace",ne="arrowLeft",oe="arrowRight",re="arrowUp",ae="arrowDown",he="undo",ce="redo",le="shift_down",de="shift_up",ue="ctrla",ge="ctrlc",fe="ctrlv",pe="ctrlx",_e="startedit",me="editclick",be="shiftonclick",we="doubleclick";class xe extends EventTarget{_inputElement=null;constructor(t){super(),this._inputElement=function(t){const e=document.createElement("input");e.setAttribute("style","\n        width: 100px;\n        position: absolute;\n        left: 0;\n        top: 0;\n        border:none;\n        opacity: 0;\n        z-index: -1;\n        contain: strict;"),e.setAttribute("tabindex",-1),e.setAttribute("aria-hidden",!0),e.setAttribute("spellcheck",!1),e.setAttribute("autocorrect","off");let i=!1,s={ctrlOn:!1,shiftOn:!1};return e.addEventListener("beforeinput",(e=>{e.preventDefault(),e.data&&(i||t(Kt,e.data))})),e.addEventListener("compositionstart",(e=>{t(Jt),i=!0})),e.addEventListener("compositionupdate",(e=>{t(Qt,e.data)})),e.addEventListener("compositionend",(s=>{t(te,s.data),e.value="",i=!1})),e.addEventListener("keyup",(e=>{if(!i)switch(e.key){case"Shift":t(de),s.shiftOn=!1;break;case"Meta":case"Control":s.ctrlOn=!1}})),e.addEventListener("keydown",(e=>{if(!i){switch(e.code){case"Enter":t(ee);break;case"Backspace":t(se);break;case"Delete":t(ie);break;case"ArrowLeft":t(ne);break;case"ArrowRight":t(oe);break;case"ArrowDown":t(ae);break;case"ArrowUp":t(re)}switch(e.key){case"Shift":t(le),s.shiftOn=!0;break;case"Meta":case"Control":s.ctrlOn=!0;break;case"a":s.ctrlOn&&t(ue);break;case"c":s.ctrlOn&&t(ge);break;case"v":s.ctrlOn&&t(fe);break;case"x":s.ctrlOn&&t(pe);break;case"y":s.ctrlOn&&(e.preventDefault(),t(ce));break;case"z":s.ctrlOn&&s.shiftOn?t(ce):s.ctrlOn&&t(he)}}})),e}(this.controlCallback.bind(this)),t.append(this._inputElement),this._inputElement.focus()}controlCallback(t,e){switch(t){case Kt:case Jt:case Qt:case te:case ee:case se:case ie:this.dispatchEvent(new CustomEvent(Ut,{detail:{kind:t,data:e}}));break;case ne:case oe:case re:case ae:case ue:case le:case de:case he:case ce:this.dispatchEvent(new CustomEvent(Zt,{detail:{kind:t}}))}}focus(){this._inputElement.focus({preventScroll:!0})}syncPosition(t,e){this._inputElement.style.transform=`translate(${t}px, ${e}px)`}destroy(){this._inputElement.remove()}}class ve{_row=0;_column=[0,0];_status={show:!0,anime:null,lastElapsed:0,refreshElapsed:!1};setRow(t){this._row=t}setColumn(t,e){void 0!==e?this._column[t]=e:this._column=t}getRow(){return this._row}getColumn(t){return void 0!==t?this._column[t]:this._column}animate(t){this._status.anime=t.requestJFlowAnime((t=>{const e=this._status.lastElapsed;this._status.refreshElapsed&&(this._status.lastElapsed=t,this._status.refreshElapsed=!1),t-e>500&&(this._status.show=!this._status.show,this._status.lastElapsed=t)}))}cancelAnimate(){this._status.anime.cancel(),Object.assign(this._status,{show:!0,anime:null,lastElapsed:0})}isShow(){return this._status.show}refresh(){Object.assign(this._status,{show:!0,refreshElapsed:!0})}toRange(){return[this._row,...this._column]}fromRange(t){this._row=t[0],this._column=t.slice(1)}}class ye{_lines=[];get(t){return this._lines[t]}getLineAbove(t){let e=0;const i=this._lines;for(;e<i.length&&!(i[e].reduceHeight>t);)e++;return Math.min(e,i.length-1)}truncate(t){const e=ke.create(t);return this._lines=[e],e}push(t){this._lines.push(t)}forEach(t){this._lines.forEach(t)}length(){return this._lines.length}}class ke{width=0;anchorY=0;height=0;reduceHeight=0;_elements=[];static create(t){return new ke(t)}constructor(t={}){Object.assign(this,t)}_elements=[];get(t){return this._elements[t]}length(){return this._elements.length}insert(t,e){this._elements.splice(t,0,e)}push(t){this._elements.push(t)}tail(){return this._elements[this._elements.length-1]}copy(){return this._elements.slice()}getColumnNearest(t,e,i,s){const n=this._elements;if(t>=this.width){const t=n.length-1,e=n[t];let i=0;return"text"===e.type&&(i=e.source.length),[t,i]}{let r=0,a=0,h=0,c=null;for(;r<n.length-1;){a=h;const i=n[r];if("text"!==i.type){const t=c&&"text"===c.type?2*e:e;h+=i.width+t}else h+=i.width;if(h>t){c=i;break}c=i,r++}h<=t&&(a=h);const l=n[r];if("text"===l.type){const e=function(t,e,i,s){const n=e.source,r=n.length-1;if(0===e.width)return 0;const a=e.width;let h=Math.floor(t/a*r);return o((e=>{let o,c,l;e.font=`${i} ${s}`;let d=n.substring(0,h),u=n.substring(h-1,h),g=n.substring(h,h+1),f=e.measureText(d).width,p=e.measureText(u).width,_=e.measureText(g).width;o=f-p/2,c=f+_/2;do{if(o<=t&&c>=t)break;if(o>t){const i=c-t;l=h,h-=i<100?1:Math.floor(i/c*l),d=n.substring(h,l),f-=e.measureText(d).width}else if(c<t){const i=t-o;l=h,h+=i<100?1:Math.floor(i/(a-o)*(r-l)),d=n.substring(l,h),f+=e.measureText(d).width}u=n.substring(h-1,h),g=n.substring(h,h+1),p=e.measureText(u).width,_=e.measureText(g).width,o=f-p/2,c=f+_/2}while(h>=0&&h<=r)})),h}(t-a,l,i,s);return[r,e]}return t-a>c.width/2?[r+1,0]:[r,0]}}forEach(t){this._elements.forEach(t)}}class Te{static create(t){const e=new Te;return e.from(t),e}_textElements=[];_records=[];_caretRecord=null;insertBefore(t,e){const i=this.findIndex(t);this.inersetAt(i,e)}insertAfter(t,e){const i=this.findIndex(t);this.get(i+1)&&e.setNeedWrap(t.needWrap||t.isTail),this.inersetAt(i+1,e)}findIndex(t){return this._textElements.findIndex((e=>e===t))}get(t){return this._textElements[t]}from(t){this._textElements=t}inersetAt(t,e){this.splice(t,0,e)}push(t){this.splice(this.length(),0,t)}remove(t){this.splice(t,1)}splice(){const t=this._textElements.splice(...arguments);this._records.push({op:"splice",args:arguments,removed:t})}copy(){return this._textElements.slice()}isEmpty(){return 1===this._textElements.length&&""===this._textElements[0].source}forEach(t){this._textElements.forEach(t)}tail(){return this._textElements[this._textElements.length-1]}filter(t){return this._textElements.filter(t)}length(){return this._textElements.length}startRecord(){return this._caretRecord={before:null,after:null},this._records=[],this._records}getRecord(){return this._records}recordBeforeCaret(t){this._caretRecord.before=t.toRange()}recordAfterCaret(t){this._caretRecord.after=t.toRange()}getCaretRecord(){return this._caretRecord}collectRecords(){return this._records}}class Se{needWrap=!1;width=0;reduceWidth=0;height=0;anchorX=0;anchorY=0;dirty=!0;isTail=!1;constructor(t,e){this.type=t,this.source=e}setSource(t,e){const i=this.source;this.source=t,this.dirty=!0,e&&e.push({op:"setSource",args:[this,t,i]})}setNeedWrap(t,e){const i=this.needWrap;this.needWrap=t,i!==t&&e&&e.push({op:"setNeedWrap",args:[this,t,i]})}shift(t,e){if("text"===this.type){const i=this.source.length,s=t+e;return s<0?"prev":s>i?"next":"self"}return e>0?"next":e<0?"prev":void 0}tailOffset(){return"text"===this.type?this.needWrap||this.isTail?this.source.length:Math.max(0,this.source.length-1):0}headOffset(){return 0}}class Ee{_enable=!1;_rangeFrom=null;_rangeTo=null;_initialRange=null;setInitialRange(t){this._initialRange=t}getRangeFrom(){return this._rangeFrom}getRangeTo(){return this._rangeTo}isEnable(){return this._enable}enable(){this._enable=!0}disable(){this._enable=!1}handleCaret(t){const[e,i,s]=this._rangeTo;t.setRow(e),t.setColumn([i,s])}setRange(t){const e=this._initialRange;this._compareRange(e,t)?(this._rangeFrom=e,this._rangeTo=t):(this._rangeFrom=t,this._rangeTo=e)}_compareRange(t,e){return!(t[0]>e[0])&&(!(t[0]===e[0]&&t[1]>e[1])&&!(t[0]===e[0]&&t[1]===e[1]&&t[2]>e[2]))}delete(t,e){if(this._enable){const i=t._area,s=t._caret,n=this._rangeFrom,o=this._rangeTo,r=i.get(n[0]).get(n[1]),a=i.get(o[0]).get(o[1]);let[h,c,l]=n;if(e.push({op:"range",args:[n.slice(),o.slice()]}),r===a){const t=r.source;r.setSource(t.substring(0,n[2])+t.substring(o[2]),e),r.dirty=!0}else{const i=t._flattenTxtElem;let s,d,u="",g="";const f=i.findIndex(r),p=i.findIndex(a);let _=!1;if("text"===r.type?u=r.source.substring(0,n[2]):s=i.get(f-1),"text"===a.type?(g=a.source.substring(o[2]),_=a.needWrap):d=i.get(p-1),s)if(i.splice(f,p-f+1),"text"===s.type)s.needWrap?h-=1:c-=1,l=s.source.length,s.setSource(s.source+g,e),s.dirty=!0,s.setNeedWrap(_,e);else{const t=new Se("text",u+g);t.setNeedWrap(_,e),i.splice(f,0,t)}else if(i.splice(f,p-f),d){const t=new Se("text",u);i.splice(f,0,t)}else a.setSource(u+g,e),a.dirty=!0;0===i.length()&&i.push(new Se("text",""))}this.disable(),s.setRow(h),s.setColumn([c,l])}}}function Ce(t){return 1===t.length&&"setSource"===t[0].op}class Pe{static length=50;_undo=[];_redo=[];_editor=null;write(t,e){if(0===t.length)return;if(Ce(t)){const i=t[0],s=this.getLastUndo();if(s&&Ce(s._batch)){const t=s._batch[0];if(t.args[0]===i.args[0])return t.args[1]=i.args[1],void(s._caretMetaTo=e.after)}}const i=new Be(t);i._caretMetaFrom=e.before,i._caretMetaTo=e.after,this._undo.push(i),this._undo.length>Pe.length&&this._undo.splice(0,1),this._redo.length&&(this._redo=[])}getLastUndo(){return this._undo[this._undo.length-1]}undo(){const t=this._undo.pop();return t&&(t.undo(this._editor),this._redo.push(t)),t}redo(){let t=this._redo.pop();for(;t&&t.SKIP_REDO;)t=this._redo.pop();return t&&(t.redo(this._editor),this._undo.push(t)),t}}class Be{_batch=[];_caretMetaFrom=null;_caretMetaTo=null;constructor(t){this._batch=t}updateCaretMetaTo(t){this._caretMetaTo=t}undo(t){this._batch.slice().reverse().forEach((e=>{switch(e.op){case"range":const[i,s]=e.args,n=t._range;n.setInitialRange(i),n.setRange(s),n.enable();break;case"setSource":const[o,r,a]=e.args;o.source=a,o.dirty=!0;break;case"setNeedWrap":const[h,c,l]=e.args;h.needWrap=l,h.dirty=!0;break;case"splice":const d=t._flattenTxtElem,[u,g,...f]=e.args,p=e.removed;let _=0;f&&(_=f.length),d.splice(u,_,...p)}})),t._caret.fromRange(this._caretMetaFrom)}redo(t){this._batch.forEach((e=>{switch(e.op){case"setSource":const[i,s,n]=e.args;i.source=s,i.dirty=!0;break;case"setNeedWrap":const[o,r,a]=e.args;o.needWrap=r,o.dirty=!0;break;case"splice":t._flattenTxtElem.splice(...e.args)}})),t._caret.fromRange(this._caretMetaTo)}}class Me{static create(t){return new this(t)}constructor(t){this._editor=t}exec(){}}class Oe extends Me{static name=ne;exec(){const t=this._editor;t._range.disable();const e=t._flattenTxtElem,i=t._caret,s=i.getRow(),n=i.getColumn(),[o,r]=n,a=t._area.get(s),h=a.get(o),c=e.findIndex(h);switch(h.shift(r,-1)){case"prev":if(o>0){const t=a.get(o-1);i.setColumn([o-1,t.tailOffset()])}else if(c>0){const n=s-1,o=t._area.get(n).length()-1,r=e.get(c-1).tailOffset();i.setRow(n),i.setColumn([o,r])}break;case"self":i.setColumn(1,r-1)}i.refresh(),t.syncShadowInputPosition(),t._jflow._render()}}class Re extends Me{static name=oe;exec(){const t=this._editor;t._range.disable();const e=t._flattenTxtElem,i=t._caret,s=i.getRow(),n=i.getColumn(),[o,r]=n,a=t._area.get(s),h=a.get(o),c=e.findIndex(h);switch(h.shift(r,1,c===e.length()-1)){case"next":if(o<a.length()-1){const t=a.get(o+1);"text"===h.type&&"text"!==t.type?i.setColumn([o+2,t.headOffset()]):i.setColumn([o+1,t.headOffset()])}else if(c<e.length()-1){const t=s+1,n=e.get(c+1).headOffset();i.setRow(t),i.setColumn([0,n])}break;case"self":i.setColumn(1,r+1)}i.refresh(),t.syncShadowInputPosition(),t._jflow._render()}}class Ie extends Me{static name=re;exec(){this._editor._range.disable();const t=this._editor._caret.getRow()-1;t>-1&&this._handler(t)}}class Le extends Me{static name=ae;exec(){this._editor._range.disable();const t=this._editor._caret.getRow()+1;t<this._editor._area.length()&&this._handler(t)}}const De={_handler(t){const e=this._editor,i=e._caret,s=i.getRow(),n=i.getColumn(),[o,r]=n,a=e._area;let h=a.get(s).get(o),c=h.reduceWidth;r>0&&(c+=e.measureTextWidth(h.source.substring(0,r)));const l=a.get(t).getColumnNearest(c,e.elementSpace,e.fontSize,e.fontFamily);i.setRow(t),i.setColumn(l),i.refresh(),e.syncShadowInputPosition(),e._jflow._render()}};function je(t,e,i,s){if(!t)return[i,!1];if("text"===t.type&&"text"===e.type){const i=t.source.length;return t.setSource(t.source+e.source,s),t.setNeedWrap(e.needWrap,s),[i,!0]}return[i,!1]}Object.assign(Ie.prototype,De),Object.assign(Le.prototype,De);class We extends Me{static name=Ut;cacheIdx=null;exec(t,e){const i=this._editor,s=i._range,n=i._caret,o=i._flattenTxtElem,r=i._undoredo,a=o.startRecord();if(o.recordBeforeCaret(n),s.isEnable()&&(s.delete(i,a),t===se||t===ie))return o.collectRecords(),o.recordAfterCaret(n),this._editor.refresh(),void r.write(a,o.getCaretRecord());const h=n.getRow();let[c,l]=n.getColumn();const d=i._area,u=d.get(h);let g=u.get(c),f=u.get(c-1),p="";if("text"===g.type)p=g.source;else if("text"===f?.type)p=f.source,g=f,l=p.length,n.setColumn([c-1,p.length]);else{const t=new Se("text","");o.insertBefore(g,t),g=t}let _,m=p.substring(0,l);switch(_=this.cacheIdx?p.substring(this.cacheIdx[1]):p.substring(l),t){case Kt:if(/\r?\n/.test(e)){let t=e.split(/\r?\n/);t=t.replace(/\t/,"");let i=o.findIndex(g),s=t.shift();g.setSource(m+s,a);let r=h+1;for(i++;t.length>1;){const e=new Se("text",t.shift());e.setNeedWrap(!0,a),r++,o.inersetAt(i,e),i++}s=t.shift();const c=o.get(i);if(c&&"text"===c.type)c.setSource(s+c.source,a);else{const t=new Se("text",s);o.inersetAt(i,t)}n.setRow(r),n.setColumn([0,s.length])}else m+=e,n.setColumn(1,n.getColumn(1)+e.length),g.setSource(m+_,a);break;case Jt:this.cacheIdx=[m.length,m.length];break;case Qt:m=m.substring(0,this.cacheIdx[0]),m+=e,g.setSource(m+_,a);const t=this.cacheIdx[0]+e.length;n.setColumn(1,t),this.cacheIdx[1]=t;break;case te:m=m.substring(0,this.cacheIdx[0]),n.setColumn(1,this.cacheIdx[0]+e.length),this.cacheIdx=null,m+=e,g.setSource(m+_,a);break;case ee:g.setSource(m,a),g.setNeedWrap(!0,a);const i=new Se("text",_);o.insertAfter(g,i),n.setRow(h+1),n.setColumn([0,0]);break;case se:switch(g.shift(l,-1)){case"prev":let t=o.findIndex(g);if(c>0){o.splice(t-1,1),t-=1;const[e,i]=je(o.get(t-1),g,0,a);i&&o.remove(t),n.setColumn([c-(e>0?2:1),e])}else if(t>0){const e=h-1,i=d.get(e).length()-1,[s,r]=je(o.get(t-1),g,0,a);r&&o.remove(t),n.setRow(e),n.setColumn([i,s])}break;case"self":m=m.substring(0,m.length-1),n.setColumn(1,n.getColumn(1)-1),g.setSource(m+_,a)}break;case ie:switch(g.shift(l,1)){case"next":let t=o.findIndex(g);if(c<u.length()-1){o.splice(t+1,1);const e=o.get(t+1),[i,s]=je(g,e,g.source.length,a);s&&o.remove(t+1),n.setColumn([c,i])}else if(t<o.length()-1){const e=o.get(t+1),[i,s]=je(g,e,g.source.length,a);s&&o.remove(t+1),n.setColumn([c,i])}break;case"self":_=_.substring(1),g.setSource(m+_,a)}}o.collectRecords(),o.recordAfterCaret(n),r.write(a,o.getCaretRecord()),this._editor.refresh()}}class He extends Me{static name=_e;exec(){const t=this._editor;if(!this._startEdit())return;const e=t._jflow;t.moveCaretByHitPoint(),t.createShadowInput(),t._caret.animate(e),t.syncShadowInputPosition()}_startEdit(){let t=!0;const e=this._editor;return e.dispatchEvent(new dt("edit",{target:e,preventDefault(){t=!1}})),t}}class Ae extends Me{static name=me;exec(){const t=this._editor;t.moveCaretByHitPoint(),t._caret.refresh(),t.syncShadowInputPosition(),t._range.disable()}}class ze extends Me{static name=we;exec(){const t=this._editor;t.moveCaretByHitPoint();const e=t._caret,i=t._range,s=t._area,n=e.getRow(),o=s.get(n),r=o.length()-1;i.setInitialRange([n,0,0]),i.setRange([n,r,o.tail().tailOffset()]),i.handleCaret(e),i.enable(),t.syncShadowInputPosition()}}class Xe extends Me{static name=de;exec(){this._editor._range.setInitialRange(null),this._editor.toggleShift(!1)}}class Ye extends Me{static name=le;exec(){const t=this._editor._range,e=this._editor._caret;t.setInitialRange(e.toRange()),this._editor.toggleShift(!0)}}class Fe extends Me{static name=be;exec(){const t=this._editor;t.moveCaretByHitPoint();const e=this._editor._caret,i=this._editor._range;i.setRange(e.toRange()),i.enable(),i.handleCaret(e),e.refresh(),t.syncShadowInputPosition()}}class Ne extends Me{static name=ue;exec(){const t=this._editor,e=t._caret,i=t._range,s=t._area,n=s.length()-1,o=s.get(n),r=o.length()-1;i.setInitialRange([0,0,0]),i.setRange([n,r,o.tail().tailOffset()]),i.handleCaret(e),i.enable(),t.syncShadowInputPosition()}}class qe extends Me{static name=he;exec(){this._editor._range.disable(),this._editor._undoredo.undo(),this._editor.refresh()}}class Ve extends Me{static name=ce;exec(){this._editor._range.disable(),this._editor._undoredo.redo(),this._editor.refresh()}}class Ge extends J{get currentLineHeight(){return this.lineHeight||parseInt(this.fontSize)}constructor(t){super(t),this.initStack(t),this.initLayout(t),this._undoredo=new Pe,this._undoredo._editor=this,this._caret=new ve,this._range=new Ee,this._shadowInput=void 0,this.textColor=t.textColor||"transparent",this.fontFamily=t.fontFamily||"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Tahoma,Arial,Noto Sans,PingFang SC,Microsoft YaHei,Hiragino Sans GB,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji",this.fontSize=t.fontSize||"28px",this.fontWeight=t.fontWeight||"",this.elementSpace=t.elementSpace||5,this.lineSpace=t.lineSpace||5,this.placeholder=t.placeholder||"",this.placeholderColor=t.placeholderColor||"#eee",this.cursorColor=t.cursorColor||"#60CFC4",this.textRangeColor=t.textRangeColor||"#4E75EC1A",this.minWidth=t.minWidth||0,this.resolver=()=>{const e=t.resolver();return 0!==e.length&&"text"===e[e.length-1].type||e.push(new Se("text","")),e},this._area=new ye,this._flattenTxtElem=Te.create(this.resolver()),this._status={editing:!1,dragover:!1},this.commands=new Map,this.registCommand(He),this.registCommand(Ae),this.registCommand(Xe),this.registCommand(Ye),this.registCommand(Fe),this.registCommand(We),this.registCommand(Oe),this.registCommand(Re),this.registCommand(Ie),this.registCommand(Le),this.registCommand(Ne),this.registCommand(ze),this.registCommand(qe),this.registCommand(Ve),this._makeFunctional(),this._cacheViewBox=[]}registCommand(t){this.commands.has(t.name)||this.commands.set(t.name,t.create(this))}_makeFunctional(){this.addEventListener("dblclick",(t=>{t.currentTarget===this&&(t.detail.bubbles=!1,this._status.editing&&this.execCommand(we))})),this.addEventListener("click",(t=>{if(t.currentTarget!==this)return;let e;t.detail.bubbles=!1,e=this._status.editing?this._status.shiftOn?be:me:_e,this.execCommand(e)})),this.addEventListener("blur",(t=>{this._status.editing=!1,this._shadowInput&&this._shadowInput.destroy(),this._belongs&&this._jflow._render(),this.dispatchEvent(new dt("change",{target:this,textElements:this._flattenTxtElem.copy()})),this._range.disable(),this._caret.cancelAnimate()})),this.addEventListener("instancePressStart",(t=>{if(this._status.editing&&!this._status.shiftOn){t.detail.bubbles=!1,t.detail.preventDefault();const e=this._currentp,i=this._positionToCursorOffset(e),s=this._range;s.setInitialRange([i.row,...i.column]);const n=t.detail.jflow;let o=!1;const r=(t=>{this._status.editing=!1,o=!0;const{offsetX:e,offsetY:i}=t,r=n._calculatePointBack([e,i]);n._stack.checkHit(r);const a=this._currentp,h=this._positionToCursorOffset(a);s.setRange([h.row,...h.column]),s.enable()}).bind(this);document.addEventListener("pointermove",r),document.addEventListener("pointerup",(t=>{document.removeEventListener("pointermove",r),s.setInitialRange(null),o&&(s.handleCaret(this._caret),this._status.editing=!0,this._shadowInput.focus())}),{once:!0})}})),this.addEventListener("dragenter",(()=>{this.moveCaretByHitPoint(),this._status.dragover=!0})),this.addEventListener("dragover",(()=>{this.moveCaretByHitPoint()})),this.addEventListener("dragleave",(()=>{this._status.dragover=!1}));const t=(t=>{if(!this._status.dragover)return;t.detail.bubbles=!1,this._status.dragover=!1;const e=this._caret,i=e.getRow(),s=e.getColumn(),n=this._area.get(i);let[o,r]=s;const a=n.get(o),h=n.get(o-1);let c=this._flattenTxtElem,l=c.findIndex(a);"text"!==a.type&&"text"===h?.type&&(r=h.source.length,l=c.findIndex(h));const d=c.length();this.dispatchEvent(new dt("insert",{...t.detail,type:t.type,textElements:c.copy(),idx:l,offset:r})),c=this._flattenTxtElem,this._status.editing&&(c.length()>d&&e.setColumn([o+c.length()-d,0]),this._shadowInput.focus()),this._status.editing&&this._caret.refresh(),this.syncShadowInputPosition(),this._range.disable()}).bind(this);this.addEventListener("pressEnd",t),this.addEventListener("drop",t)}toggleShift(t){this._status.shiftOn=t}execCommand(t){this.commands.get(t).exec()}createShadowInput(){const t=this._jflow;this._shadowInput=new xe(t.DOMwrapper),this._shadowInput.addEventListener(Zt,(t=>{const e=t.detail.kind;this.execCommand(e)})),this._shadowInput.addEventListener(Ut,(t=>{const e=t.detail.kind,i=t.detail.data;this.commands.get(Ut).exec(e,i)})),this._status.editing=!0,t.setFocusInstance(this)}moveCaretByHitPoint(){const t=this._currentp,e=this._caret,{row:i,column:s}=this._positionToCursorOffset(t);e.setRow(i),e.setColumn(s)}refresh(){this.recalculateUp(),this.syncShadowInputPosition(),this._jflow._render()}refreshTextElements(){this._flattenTxtElem=Te.create(this.resolver())}_positionToCursorOffset(t){const[e,i]=t,s=this._area,n=e+this.width/2,o=i+this.height/2,r=s.getLineAbove(o);return{row:r,column:s.get(r).getColumnNearest(n,this.elementSpace,this.fontSize,this.fontFamily)}}_caretToPosition(){const t=this._caret.getRow(),e=this._caret.getColumn(),i=this._area.get(t),[s,n]=e,r=i.get(s),a=this._flattenTxtElem.findIndex(r),h=this._flattenTxtElem.get(a-1);let c,l=this.currentLineHeight/2;if("text"===r.type){const t=r.source.substring(0,n);o((e=>{e.beginPath(),e.font=`${this.fontSize} ${this.fontFamily}`,c=r.anchorX-r.width/2+e.measureText(t).width}))}else c=r.anchorX-r.width/2,l=Math.max(l,r.height/2);return 0===n&&h&&"text"!==h.type&&(l=Math.max(l,h.height/2)),[c,l,i.anchorY,h,r]}syncShadowInputPosition(){if(this._status.editing){const[t,e,i]=this._caretToPosition(),s=this.calculateToRealWorld([t,i+e]),n=this._jflow.canvasMeta,o=Math.min(n.actual_width-120,s[0]);this._shadowInput.syncPosition(o,s[1]),this._shadowInput.focus()}}render(t){t.save(),this._isMoving?t.globalAlpha=.6:1!==this.opacity&&(t.globalAlpha=this.opacity);const[e,i]=this.anchor,s=this._jflow,n=this._area;t.translate(e,i);const o=this._flattenTxtElem;if(o.isEmpty())return t.beginPath(),t.font=`${this.fontWeight} ${this.fontSize} ${this.fontFamily}`,t.textAlign="center",t.textBaseline="middle",t.fillStyle=this.placeholderColor,t.fillText(this.placeholder,0,0),this._randerCursor(t),t.translate(-e,-i),void t.restore();t.beginPath(),t.font=`${this.fontWeight} ${this.fontSize} ${this.fontFamily}`,t.textAlign="center",t.textBaseline="middle",t.fillStyle=this.textColor,n.forEach((e=>{e.forEach((e=>{"text"===e.type&&t.fillText(e.source,e.anchorX,e.anchorY)}))})),o.forEach((e=>{if("text"!==e.type){const i=s.getRenderNodeBySource(e.source);i.visible&&(t.save(),i.render(t),t.restore())}})),this._randerCursor(t),this._renderRange(t),t.translate(-e,-i),t.restore()}_randerCursor(t){if(this._caret.isShow()&&(this._status.editing||this._status.dragover)){const[e,i,s]=this._caretToPosition();t.beginPath(),t.moveTo(e,s-i),t.lineTo(e,s+i),t.lineWidth=2,t.strokeStyle=this.cursorColor,t.stroke()}}_renderRange(t){const e=this._range;if(e.isEnable()){const i=this._area,s=this.textRangeColor,n=this.height,o=this.width,r=this.lineSpace,[a,h,c]=e.getRangeFrom(),[l,d,u]=e.getRangeTo();if(a===l){if(h===d&&c==u)return;const e=i.get(a);let o=a===i.length()-1?0:r;const l=e.reduceHeight-o-e.height-n/2,g=e.height,f=this._measureElementOffsetX(e.get(h),c,t),p=this._measureElementOffsetX(e.get(d),u,t);t.beginPath(),t.rect(f,l,p-f,g),t.fillStyle=s,t.fill()}else{let e=a,g=!0;for(;e<=l;){const a=i.get(e);let f=e===i.length()-1?0:r;const p=a.reduceHeight-f-a.height-n/2,_=a.height;if(g){const e=a.get(h),i=this._measureElementOffsetX(e,c,t),n=a.tail(),o=n.anchorX+n.width/2;t.beginPath(),t.rect(i,p,o-i,_),t.fillStyle=s,t.fill()}else if(e===l){const e=a.get(d),i=this._measureElementOffsetX(e,u,t);t.beginPath(),t.rect(-o/2,p,e.reduceWidth+(i-e.anchorX+e.width/2),_),t.fillStyle=s,t.fill()}else t.beginPath(),t.rect(-o/2,p,a.width,_),t.fillStyle=s,t.fill();g=!1,e++}}}}_measureElementOffsetX(t,e,i){return"text"!==t.type||0===e?t.anchorX-t.width/2:t.anchorX-t.width/2+i.measureText(t.source.substring(0,e)).width}measureTextWidth(t){let e;return o((i=>{i.font=`${this.fontSize} ${this.fontFamily}`,e=i.measureText(t).width})),e}getBoundingDimension(){return{width:this.width,height:this.height}}getBoundingRect(){const t=this.anchor,e=this.width/2,i=this.height/2,s=t[0]-e,n=t[1]-i,o=t[0]+e,r=t[1]+i,a=this._boundingrect;return a[0]=s,a[1]=n,a[2]=o,a[3]=r,a}_getViewBox(){const t=this._belongs.getCacheViewBox(),e=this._cacheViewBox;return this._calculatePointBackWithPoint(t[0],t[1],e,0,1),this._calculatePointBackWithPoint(t[2],t[3],e,2,3),this._cacheViewBox}getCacheViewBox(){return this._cacheViewBox}calculateToCoordination(t){const[e,i]=t,[s,n]=this.anchor,o=[e+s,i+n];return this._belongs&&this._belongs.calculateToCoordination?this._belongs.calculateToCoordination(o):o}calculateToRealWorld(t){const[e,i]=t,[s,n]=this.anchor,o=[e+s,i+n];if(this._belongs&&this._belongs.calculateToRealWorld)return this._belongs.calculateToRealWorld(o)}_calculatePointBack(t){const[e,i]=t,[s,n]=this.anchor;return[e-s,i-n]}_calculatePointBackWithPoint(t,e,i,s,n){i[s]=t-this.anchor[0],i[n]=e-this.anchor[1]}isHit(t,e){const i=this._calculatePointBack(t),s=this._jflow;this._currentp=i;let n=[];this._flattenTxtElem.forEach((t=>{if("text"!==t.type){const e=s.getRenderNodeBySource(t.source);e.visible&&n.push(e)}}));const o=this._stack.checkHit(i,e,(t=>n.includes(t)));if(o)return o;const r=this.anchor,a=this.width/2,h=this.height/2;return t[0]>r[0]-a&&t[0]<r[0]+a&&t[1]>r[1]-h&&t[1]<r[1]+h}clone(){return new Ct({width:this.width,height:this.height,cache:t=>{const[e,i]=this.anchor;t.translate(-e+this.width/2,-i+this.height/2),this.render(t)}})}destroy(){this._jflow._focus.instance===this&&this._jflow.blur()}}Object.assign(Ge.prototype,st),Object.assign(Ge.prototype,nt),Object.assign(Ge.prototype,{_getBoundingGroupRect(){},resetChildrenPosition(){},reflow(){let t=this.currentLineHeight;const e=this._flattenTxtElem,i=this._area;if(e.isEmpty()){let s=0;const n=e.get(0);o((t=>{t.font=`${this.fontSize} ${this.fontFamily}`,s=t.measureText(this.placeholder).width}));return i.truncate({height:t,reduceHeight:t}).insert(0,n),Object.assign(n,{anchorX:-s/2,height:t,isTail:!0}),this.width=s,void(this.height=t)}const s=this._jflow;o((t=>{t.font=`${this.fontSize} ${this.fontFamily}`,e.forEach((e=>{"text"===e.type&&e.dirty&&(e.width=t.measureText(e.source).width,e.dirty=!1)}))}));const n=new ye;n.truncate({height:t});let r=n.get(0),a=0,h=0,c=null;const l=this.lineSpace,d=this.elementSpace;e.forEach((e=>{if(r.push(e),e.reduceWidth=r.width,"text"===e.type)e.height=t,r.width+=e.width,e.needWrap&&(a+=r.height+l,r.reduceHeight=a,h=Math.max(r.width,h),r=ke.create({height:t}),n.push(r));else{const t=s.getRenderNodeBySource(e.source);e.height=t.height,r.height=Math.max(r.height,t.height);const i=c&&"text"!==c.type?d:2*d;r.width+=t.width+i}c=e})),e.tail().isTail=!0,a+=r.height,r.reduceHeight=a,h=Math.max(this.minWidth,Math.max(r.width,h));const u=h/2;let g=-(a/2),f=0;n.forEach((t=>{const{height:e,reduceHeight:i}=t,n=g+f+e/2;t.anchorY=n;let o=-u,r=null;t.forEach((t=>{if("text"===t.type)t.anchorY=n,t.anchorX=o+t.width/2,o+=t.width;else{const e=s.getRenderNodeBySource(t.source),i=!r||"text"===r.type,a=i?2*d:d;t.width=e.width,t.anchorY=n,t.anchorX=o+t.width/2+(i?a/2:0),e.anchor=[t.anchorX,t.anchorY],o+=t.width+a}r=t})),f=i})),this._area=n,this.width=h,this.height=a}}),function(){const t=".jfloweditablespan[contenteditable=true]:empty:before{\n        content: attr(placeholder);\n        opacity: 0.5;\n        pointer-events: none;\n        display: block; \n      }",e=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");e.appendChild(i),i.type="text/css",i.styleSheet?i.styleSheet.cssText=t:i.appendChild(document.createTextNode(t))}();const $e=pt(mt),Ue=pt(bt),Ze=pt(xt),Ke=pt(vt,{shapeShift:(t,e)=>[t+.28865*e,e]}),Je=pt(class extends vt{constructor(t){super(t)}render(t){t.save(),this._isMoving&&(t.globalAlpha=.6),t.beginPath();const[e,i]=this.anchor,s=this.width/2,n=this.height/2,o=s/1.732,r=i-n,a=i+n,h=i-n+o,c=i+n-o,l=e-s,d=e+s;t.moveTo(e,r),t.lineTo(d,h),t.lineTo(d,c),t.lineTo(e,a),t.lineTo(l,c),t.lineTo(l,h),t.closePath(),t.fillStyle=this.backgroundColor,this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY),t.fill(),this.borderWidth&&(t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.stroke()),t.restore(),this._cachePoints=[[e,r],[d,h],[d,c],[e,a],[l,c],[l,h]]}},{shapeShift:(t,e)=>[t,e+.5773*t]}),Qe=pt(wt),ti=pt(_t,{shapeShift(t,e,i){const s=Math.ceil(Math.sqrt(t*t+e*e)/2);i.radius=s;const n=2*s;return[n,n]}});class ei extends EventTarget{constructor(t){super(),this.uniqueName="jflow",this.eventAdapter=new ut(t.eventAdapter),this.initNodeWeakMap(),this.initAnime(),this.initStack(t),this.initLayout(t),this.ctx=null,this.canvas=null,this.dpr=1,this.padding=20,this.position=null,this.scale=null,this.initialZoom=t.initialZoom,this.initialPosition=t.setInitialPosition,this.maxZoom=t.maxZoom||3,this.minZoom=t.minZoom||.5,this.NodeRenderTop=!!t.NodeRenderTop,this.worldMargin=t.worldMargin,this.draggingbehavior=Object.assign({panInBorder:{enable:!0,padding:20,deltamovement:8,allowMovingTargetInPan:!0}},t.draggingbehavior||{}),this.scrollBarBehavior=Object.assign({enable:!0},t.scrollBarBehavior||{}),this.offeset=null,this._lastState={x:null,y:null,dragging:!1,processing:!1},this._lastDragState={target:null,targetLink:null,processing:!1},this._target={instance:null,link:null,moving:null,isInstanceDirty:!1,isLinkDirty:!1,cache:{stack:null,belongs:null,point:null},meta:{x:void 0,y:void 0,initialX:void 0,initialY:void 0},status:{dragovering:!1,dragging:!1,processing:!1,movingState:!1}},this._focus={instance:null},this._dragOverTarget=null,this.allowDrop=t.allowDrop,this._tempNode=null,this._tempLink=null,this.mode=I.DEFAULT,this._allowMovingTarget=!0,this.canvasMeta={},this._cacheViewBox=[]}setMovingTargets(t){Object.assign(this._target,{moving:t})}setTempDraggingInstance(t){t._belongs=this,this._tempNode=t,Object.assign(this._target,{moving:[this._tempNode],dragging:!0})}removeTempDraggingInstance(){if(this._tempNode){const t=this._tempNode.anchor;return this._tempNode=null,t}}preventDefaultDragging(){this._allowMovingTarget=!1}allowDefaultDragging(){this._allowMovingTarget=!0}$mount(t){const{canvas:i,ctx:s,scale:n,width:o,height:a,raw_width:h,raw_height:c,left:l,top:d}=e(t);this.reflow(),this.ctx=s,this.DOMwrapper=t,this.canvas=i,this.canvas.setAttribute("data-jflow",!0),this.canvas.$jflow=this,this.canvasMeta={width:h,height:c,actual_width:o,actual_height:a},this.dpr=n,this._getBoundingGroupRect();const u=this.padding,{width:g,height:f,x:p,y:_}=this.bounding_box,m={x:u,y:u,width:o-2*u,height:a-2*u},b={x:0,y:0,offsetX:0,offsetY:0},w=m.width/g,x=m.height/f,v=w<=x?"x":"y";let y;y=this.initialZoom?this.initialZoom:Math.min(w,x),this.scale=y,y>this.maxZoom&&(this.maxZoom=y),y<this.minZoom&&(this.minZoom=y);const k=p*y,T=_*y,S=m.width,E=m.height;if(this.initialPosition){const{x:t,y:e}=this.initialPosition(k,T,S,E,m.x,m.y,o,a,p,_,g,f);b.x=t,b.y=e}else b.x="x"===v?m.x:(S-g*y)/2+u,b.y="y"===v?m.y:(E-f*y)/2+u;b.offsetX=b.x-k,b.offsetY=b.y-T,this.position=b,this._readyToRender=!0,this.scrollBarBehavior.enable&&this.initScrollBar(this.scrollBarBehavior),this.__render(),this._createEventHandler(),r((t=>{this.dpr=t,this.resizeCanvas(),this.scheduleRender()}),(t=>{this.destroyDprListener=t}))}setLinkingMode(t,e,i){const s=this.getRenderNodeBySource(t);this._tempNode=new Q,this._tempLink=e(i?{from:this._tempNode,to:s}:{from:s,to:this._tempNode}),this.sendMessage({instance:t}),this.mode=I.LINKING}isInLinkingMode(){return this.mode===I.LINKING}setLinkingLink(t){this.mode===I.LINKING&&this._tempLink.setConfig(t)}resetLinkingLink(){this.mode===I.LINKING&&this._tempLink.setConfig({to:this._tempNode})}clearTemp(){this._tempNode&&(this._tempNode.destroy(),this._tempNode=null),this._tempLink&&(this._tempLink.destroy(),this._tempLink=null),this._render()}preventClearTemp(){this._preventClearTemp=!0}resizeCanvas(){if(this.canvas&&this.DOMwrapper){const{width:t,height:e,raw_width:i,raw_height:s}=function(t,e){const{width:i,height:s,left:n,top:o}=e.getBoundingClientRect();t.style.width=i+"px",t.style.height=s+"px";const r=window.devicePixelRatio;return t.width=Math.floor(i*r),t.height=Math.floor(s*r),{width:i,height:s,raw_width:t.width,raw_height:t.height}}(this.canvas,this.DOMwrapper);this.canvasMeta={width:i,height:s,actual_width:t,actual_height:e}}}setFocusInstance(t){this._focus.instance=t}focusOn(t){const e=this._calculatePointBack([this.canvasMeta.actual_width/2,this.canvasMeta.actual_height/2]);let i=t.anchor;t._belongs.calculateToCoordination&&(i=t._belongs.calculateToCoordination(i));const s=(e[0]-i[0])*this.scale,n=(e[1]-i[1])*this.scale;this._recalculatePosition(s,n),this._render()}_getBoundingGroupRect(){const t=this._stack.getBoundingRectPoints();if(this.bounding_box){this.bounding_box=L(t);const{x:e,y:i}=this.bounding_box,s=this.scale;this.position.x=this.position.offsetX+e*s,this.position.y=this.position.offsetY+i*s}else this.bounding_box=L(t)}_createEventHandler(){const t=this.canvas;let e;this.eventAdapter.apply(this);const i=()=>{this.eventAdapter.unload(this),this.destroyDprListener()};if(e=i,this.allowDrop){const s=this._onDragover.bind(this),n=this._onDrop.bind(this),o=this._onDragLeave.bind(this);t.addEventListener("dragstart",(t=>{t.preventDefault()})),t.addEventListener("dragover",s),t.addEventListener("drop",n),t.addEventListener("dragleave",o),e=()=>{i(),t.removeEventListener("dragover",s),t.removeEventListener("drop",n),t.removeEventListener("dragleave",o)}}this.destroy=e}_targetLockOn(t,e){let i=this._calculatePointBack(t);const s=i;this._currentp=i;let n=this._stack;const o=this._getViewBox(),r=n.checkHit(i,(t=>this._target.status.dragging&&t===this._getMovingTarget()),(t=>V(o,t.getBoundingRect())));let a,h=this._linkStack;if(r&&r._belongs!==this||(a=h.checkHit(i,(t=>{if(!this._target.status.dragging)return!1;const e=this._getMovingTarget();return t.from===e||t.to===e}))),a||(a=h.checkHit(i,(t=>!t.ON_TOP))),Object.assign(this._target,{instance:r,link:a,isInstanceDirty:r===this._target.instance,isLinkDirty:a===this._target.link}),Object.assign(this._target.cache,{stack:n,belongs:this,point:i,topLayerPoint:s}),Object.assign(this._target.meta,{x:t[0],y:t[1]}),"pressStart"===e&&!this._target.status.dragging&&!this._target.status.dragovering){let t=r;for(;t&&t._belongs.lock&&t!==this;)t=t._belongs;this.setMovingTargets(t&&[t]),t&&r.bubbleEvent(new dt("afterResolveMovingTarget",{event:e,target:t,jflow:this,bubbles:!0}))}return["pressStart","click","dblclick","contextclick"].includes(e)&&this._focus.instance&&this._focus.instance!==r&&(this._focus.instance.dispatchEvent(new dt("blur",{relatedTarget:r})),this._focus.instance=null),this._target}blur(){this._focus.instance&&(this._focus.instance.dispatchEvent(new dt("blur",{relatedTarget:null})),this._focus.instance=null)}_getMovingTarget(){return this._target.moving&&this._target.moving[0]}_processDragOver(t,e){if(this._dragOverTarget!==t){const i=this.readMessage()?.instance;this._dragCurrentData=i;const{point:s}=this._target.cache;if(this._dragOverTarget){const t=this._dragOverTarget;t.dispatchEvent(new dt("dragleave",{event:e,instance:t,target:i,jflow:this,point:s}))}t&&t.dispatchEvent(new dt("dragenter",{event:e,instance:t,target:i,jflow:this,point:s})),this._dragOverTarget=t}else this._dragOverTarget&&this._dragOverTarget.dispatchEvent(new dt("dragover",{event:e,instance:t,jflow:this,target:this._dragCurrentData}));this._processPanInBorder()}_processPanInBorder(){if(this.draggingbehavior?.panInBorder?.enable&&(this.draggingbehavior.panInBorder.timer||(this.draggingbehavior.panInBorder.timer=Date.now()),Date.now()-this.draggingbehavior.panInBorder.timer>500)){const[t,e,i,s]=this._cacheViewBox,[n,o]=this._currentp,{padding:r,deltamovement:a}=this.draggingbehavior.panInBorder;let h=0,c=0;n<t+r&&(h=a),n>i-r&&(h=-a),o<e+r&&(c=a),o>s-r&&(c=-a),this.__processOverAnime&&this.__processOverAnime.cancel(),h||c?this.__processOverAnime=this.requestJFlowAnime((()=>{this.panHandler(h,c)})):this.draggingbehavior.panInBorder.timer=null}}_onDragover(t){if(t.preventDefault(),t.stopPropagation(),this._lastDragState.processing)return;this._lastDragState.processing=!0;const{offsetX:e,offsetY:i}=t;Object.assign(this._target.status,{dragovering:!0}),this._targetLockOn([e,i]);const s=this._target.instance||this._target.link;this._processDragOver(s,t),this._target.isLinkDirty||this._target.isInstanceDirty?Promise.resolve().then((()=>{this._render(),this._target.isLinkDirty=!1,this._target.isInstanceDirty=!1,this._lastDragState.processing=!1})):this._lastDragState.processing=!1}_cancelPanInBorder(){this.__processOverAnime&&this.__processOverAnime.cancel(),this.draggingbehavior?.panInBorder&&(this.draggingbehavior.panInBorder.timer=null)}_onDragLeave(){this._cancelPanInBorder()}_onDrop(t){this._cancelPanInBorder();const e=this.consumeMessage()?.instance;if(this._dragOverTarget){const e=this._dragOverTarget;e.dispatchEvent(new dt("dragoverend",{event:t,instance:e})),this._dragOverTarget=null}const{link:i,instance:s}=this._target,{point:n,belongs:o}=this._target.cache;i?i.dispatchEvent(new dt("drop",{event:t,instance:e,link:i,jflow:this,belongs:o,point:n})):s?s.bubbleEvent(new dt("drop",{event:t,instance:e,jflow:this,target:s,point:n,bubbles:!0})):this.dispatchEvent(new dt("drop",{event:t,instance:e,jflow:this,target:s,point:n})),requestAnimationFrame((()=>{this.cancelDrop()}))}cancelDrop(){this._target.instance=null,this._target.link=null,Object.assign(this._target.status,{dragovering:!1})}zoomHandler(t,e,i,s,n){if(this._zooming)return;this._zooming=!0;const{width:o,height:r,x:a,y:h}=this.bounding_box,{actual_width:c,actual_height:l}=this.canvasMeta;let d=this.minZoom;if(this.worldMargin){const t=this.worldMargin,e=o+2*t,i=r+2*t;d=Math.max(d,Math.max(c/e,l/i))}let u=this.scale;u*=s>0?1.05:1/1.05,u=Math.min(this.maxZoom,Math.max(d,u));var g=u-this.scale,f=o*this.scale,p=r*this.scale,_=o*g,m=r*g,b=-(t-this.position.x)/f,w=-(e-this.position.y)/p;this.scale=u,this._recalculatePosition(b*_,w*m),this.dispatchEvent(new dt("zoompan",{deltaX:0,deltaY:0})),this.scheduleRender((()=>{this._zooming=!1}))}panHandler(t,e,i){if(this._panning)return;this._panning=!0;const{dragging:s}=this._target.status;if(s){const i=this._target.moving;i&&this.draggingbehavior.panInBorder.allowMovingTargetInPan&&i.forEach((i=>{i.anchor[0]+=-t/this.scale,i.anchor[1]+=-e/this.scale}))}this._recalculatePosition(t,e),this.dispatchEvent(new dt("zoompan",{deltaX:t,deltaY:e})),this.scheduleRender((()=>{this._panning=!1}))}pressStartHandler(t,e,i){if(this.checkScrollDragging())return;Object.assign(this._target.meta,{initialX:t,initialY:e});const{link:s,instance:n}=this._targetLockOn([t,e],"pressStart");if(this.mode===I.LINKING)return;if(Object.assign(this._target.status,{dragging:!0,processing:!1}),this._target.moving){const t=this._getMovingTarget();t.dispatchEvent(new dt("pressStart",{event:i,instance:t,jflow:this}))}const o=this._resolveLockOnTarget(s,n);o&&o.bubbleEvent(new dt("instancePressStart",{event:i,target:o,jflow:this,bubbles:!0,preventDefault:()=>{this._preventPressSequeence=!0,this._clearTarget(),document.addEventListener("pointerup",(t=>{t.preventDefault(),t.stopPropagation(),this._preventPressSequeence=!1}),{once:!0})}})),this._preventPressSequeence||this.dispatchEvent(new dt("jflowPressStart",{event:i,jflow:this}))}pressMoveHandler(t,e,i){if(this._preventPressSequeence)return;if(this.checkScrollDragging())return;const{dragging:s,processing:n}=this._target.status,{x:o,y:r}=this._target.meta;if(!s){if(this.checkScrollBarHover(t,e))return;this.resetScrollBarHover()}if(!s&&!n){const{link:s,instance:n}=this._targetLockOn([t,e]),o=this._resolveLockOnTarget(s,n);if(o?o.bubbleEvent(new dt("instancemousemove",{event:i,instance:o,jflow:this,bubbles:!0})):this.dispatchEvent(new dt("instancemousemove",{event:i,instance:null,jflow:this})),this.mode===I.LINKING)return this._tempNode.anchor=this._currentp,this.scheduleRender((()=>{this._target.isLinkDirty=!1,this._target.isInstanceDirty=!1,this._target.status.processing=!1})),void this._processPanInBorder()}if(this.dispatchEvent(new dt("canvasmousemove",{event:i,jflow:this})),!s)return;if(n)return;const a=this._target.moving;this._target.status.movingState=!0,this._target.status.processing=!0;const h=t-o,c=e-r;a?this._allowMovingTarget&&a.forEach((t=>{t.anchor[0]+=h/this.scale,t.anchor[1]+=c/this.scale})):(this._recalculatePosition(h,c),this.dispatchEvent(new dt("zoompan",{deltaX:h,deltaY:c})));const{instance:l,link:d}=this._targetLockOn([t,e]);this._processDragOver(l||d,i),this.scheduleRender((()=>{this._target.isLinkDirty=!1,this._target.isInstanceDirty=!1,this._target.status.processing=!1}))}pressUpHanlder(t,e){if(!this._preventPressSequeence){if(this.__processOverAnime&&this.__processOverAnime.cancel(),this._cancelPanInBorder(),this._target.meta,this.mode===I.LINKING){const t=this._target.instance,i=this.consumeMessage();let s=!1;const n=()=>{s=!0};if(t)t.bubbleEvent(new dt("link",{event:e,target:t,jflow:this,payload:i,bubbles:!0,link:this._tempLink,preventDefault:n}));else{const{offsetX:t,offsetY:s}=e;this.dispatchEvent(new dt("link",{event:e,jflow:this,payload:i,anchor:this._calculatePointBack([t,s]),link:this._tempLink,preventDefault:n}))}if(s)return;return this._clearTarget(),this._preventClearTemp||(this._tempNode&&(this._tempNode.destroy(),this._tempNode=null),this._tempLink&&(this._tempLink.destroy(),this._tempLink=null)),this._preventClearTemp=!1,this.mode=I.DEFAULT,void this._render()}if(this._target.moving){let t=!1;if(this._layout.static&&(t=this.staticCheck(this._getMovingTarget())),!t&&this._target.link){const{point:t,belongs:i}=this._target.cache,s=this._target.link,n=this._getMovingTarget();s.dispatchEvent(new dt("drop",{event:e,instance:n,link:s,jflow:this,belongs:i})),this._target.link=null,this._target.instance=null}this._target.moving&&(this._target.instance?this._target.instance.bubbleEvent(new dt("pressEnd",{event:e,instance:this._getMovingTarget(),jflow:this,target:this._target.instance,bubbles:!0})):this.dispatchEvent(new dt("pressEnd",{event:e,instance:this._getMovingTarget(),jflow:this}))),this._target.moving=null,this.removeTempDraggingInstance(),this._render()}this._clearTarget()}}clickHanlder(t,e,i){const{link:s,instance:n,meta:o}=this._targetLockOn([t,e],"click");if(Math.abs(o.initialX-o.x)<1&&Math.abs(o.initialY-o.y)<1){if(i.target!==this.canvas)return this._clearTarget(),void Object.assign(this._target.meta,{initialX:void 0,initialY:void 0});const{topLayerPoint:t}=this._target.cache,e=this._resolveLockOnTarget(s,n);if(e){const s=e;s.bubbleEvent(new dt("click",{event:i,jflow:this,target:s,topLayerPoint:t,bubbles:!0}))}else this.dispatchEvent(new dt("click",{event:i,jflow:this,topLayerPoint:t}));this._clearTarget(),Object.assign(this._target.meta,{initialX:void 0,initialY:void 0})}}contextMenuHanlder(t,e,i){const{link:s,instance:n}=this._targetLockOn([t,e],"contextclick"),{topLayerPoint:o}=this._target.cache,r=this._resolveLockOnTarget(s,n);if(r){const t=r;t.bubbleEvent(new dt("contextclick",{event:i,jflow:this,target:t,topLayerPoint:o,bubbles:!0}))}else this.dispatchEvent(new dt("contextclick",{event:i,jflow:this,topLayerPoint:o}))}dblclickHandler(t,e,i){const{link:s,instance:n}=this._targetLockOn([t,e],"dblclick"),{topLayerPoint:o}=this._target.cache,r=this._resolveLockOnTarget(s,n);if(r){const t=r;t.bubbleEvent(new dt("dblclick",{event:i,jflow:this,target:t,topLayerPoint:o,bubbles:!0}))}else this.dispatchEvent(new dt("dblclick",{event:i,jflow:this,topLayerPoint:o}))}_resolveLockOnTarget(t,e){return t?.ON_TOP?t:e||t}_clearTarget(){Object.assign(this._target.meta,{x:void 0,y:void 0}),Object.assign(this._target.status,{dragging:!1,processing:!1,movingState:!1}),Object.assign(this._target,{instance:null,link:null,moving:null})}_recalculatePosition(t,e,i){const{x:s,y:n,width:o,height:r}=this.bounding_box,{actual_width:a,actual_height:h}=this.canvasMeta;if(void 0===i&&(i=this.scale),this.worldMargin){const c=this.worldMargin,l=(s+o+c)*i-a,d=(s-c)*i,u=s*i,g=this.position.x+t-u;this.position.offsetX=Math.min(Math.max(-l,g),-d),this.position.x=this.position.offsetX+u;const f=(n+r+c)*i-h,p=(n-c)*i,_=n*i,m=this.position.y+e-_;this.position.offsetY=Math.min(Math.max(-f,m),-p),this.position.y=this.position.offsetY+_}else this.position.x+=t,this.position.y+=e,this.position.offsetX=this.position.x-s*i,this.position.offsetY=this.position.y-n*i}calculateToRealWorld(t){const e=this.scale,i=this.position;return[t[0]*e+i.offsetX,t[1]*e+i.offsetY]}_calculatePointBack(t){const e=this.scale,i=this.position;return[(t[0]-i.offsetX)/e,(t[1]-i.offsetY)/e]}_calculatePointBackWithPoint(t,e,i,s,n){const o=this.scale,r=this.position;i[s]=(t-r.offsetX)/o,i[n]=(e-r.offsetY)/o}_calculateDistance(t){return this.scale*t}_resetTransform(){const{width:t,height:e}=this.canvasMeta,i=this.position,s=this.scale,n=this.ctx;n.setTransform(),n.clearRect(0,0,t,e),n.scale(this.dpr,this.dpr),n.transform(s,0,0,s,i.offsetX,i.offsetY)}resetTransform(t){const e=this.position,i=this.scale;t.setTransform(),t.scale(this.dpr,this.dpr),t.transform(i,0,0,i,e.offsetX,e.offsetY)}_getViewBox(){const t=this._cacheViewBox;return this._calculatePointBackWithPoint(0,0,t,0,1),this._calculatePointBackWithPoint(this.canvasMeta.actual_width,this.canvasMeta.actual_height,t,2,3),t}setNodeToTopLayer(t){const e=this._stack.findIndex((e=>e===t));if(-1!==e){const[t]=this._stack.splice(e,1);this._stack.push(t)}}getCacheViewBox(){return this._cacheViewBox}_render(){this.scheduleRender()}__render(){if(!this._readyToRender)return;this.runAnimeFrame(),this._resetTransform();const t=this.ctx;this.dispatchEvent(new dt("beforeJflowRender",{ctx:t}));const e=this._getViewBox();this.NodeRenderTop?(this._linkStack.render(t,(t=>!t.ON_TOP&&t.isInViewBox(e))),this._stack.render(t,(t=>{const i=V(e,t.getBoundingRect());return t._isInViewBox=i,i})),this._linkStack.render(t,(t=>t.ON_TOP&&t.isInViewBox(e)))):(this._stack.render(t,(t=>{const i=V(e,t.getBoundingRect());return t._isInViewBox=i,i})),this._linkStack.render(t,(t=>t.isInViewBox(e)))),this._tempNode&&(t.save(),this._tempNode.render(t),t.restore()),this._tempLink&&(t.save(),this._tempLink.isInViewBox(e),this._tempLink.render(t),t.restore()),this.dispatchEvent(new dt("afterJflowRender",{ctx:t})),this.renderScrollBar(t)}}Object.assign(ei.prototype,ot),Object.assign(ei.prototype,st),Object.assign(ei.prototype,nt),Object.assign(ei.prototype,et),Object.assign(ei.prototype,rt),Object.assign(ei.prototype,at),Object.assign(ei.prototype,lt),Object.assign(ei.prototype,ct);const ii=require("../package.json");window.$jflow_version=ii.version;export{Et as BaseLink,Ht as BezierLink,bt as Capsule,Ue as CapsuleGroup,wt as CapsuleVertical,Qe as CapsuleVerticalGroup,vt as Diamond,Ke as DiamondGroup,Je as DiamondVerticalGroup,$t as ERLayout,$e as Group,pt as GroupFactory,Rt as Icon,K as Instance,I as JFLOW_MODE,dt as JFlowEvent,At as LinearLayout,Lt as Link,qt as Lowcodelayout,J as Node,_t as Point,ti as PointGroup,jt as PolyLink,mt as Rectangle,xt as Rhombus,Ze as RhombusGroup,Tt as ScrollGroup,It as ShadowDom,Ot as Text,Se as TextElement,Ge as TextGroup,St as commonEventAdapter,ei as default};
//# sourceMappingURL=jflow.es.min.js.map

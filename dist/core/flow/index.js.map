{"version":3,"sources":["core/flow/index.js"],"names":["JFlow","configs","uniqueName","initStack","initLayout","ctx","canvas","dpr","padding","position","scale","maxZoom","minZoom","offeset","_lastState","x","y","dragging","processing","_lastDragState","target","targetLink","_target","instance","link","moving","isInstanceDirty","isLinkDirty","cache","stack","belongs","point","meta","undefined","initialX","initialY","status","dragovering","_focus","_dragOverTarget","allowDrop","_tempInstance","_belongs","Object","assign","anchor","dom","c_width","width","c_height","height","raw_width","raw_height","left","top","reflow","DOMwrapper","canvasMeta","actual_width","actual_height","_createEventHandler","_getBoundingGroupRect","bounding_box","p_width","p_height","contentBox","offsetX","offsetY","w_ratio","h_ratio","align","scaleRatio","Math","min","_render","points","_stack","getBoundingRectPoints","nowx","nowy","zoomHandler","_onZoom","bind","pressStartHandler","_onPressStart","pressMoveHandler","_onPressMove","pressUpHandler","_onPressUp","pressUpDocument","_onPressUpDocument","contextmenuHandler","_onContextMenu","addEventListener","e","preventDefault","document","destroyListener","destroyPlainEventListener","removeEventListener","dragoverHandler","_onDragover","dropHandler","_onDrop","destroy","offsetPoint","event","_calculatePointBack","topLayerPoint","_currentp","checkHit","_getMovingTarget","linkStack","_linkStack","movingtarget","from","to","lock","_layoutNode","isLocked","getNodes","isDraggable","readMessage","_dragCurrentData","oldIns","dispatchEvent","JFlowEvent","stopPropagation","_targetLockOn","_processDragOver","Promise","resolve","then","clientX","clientY","payload","consumeMessage","jflow","requestAnimationFrame","_zooming","deltaY","newScale","amount","deltaScale","currentWidth","currentHeight","deltaWidth","deltaHeight","tX","tY","pX","pY","button","t","bubbleEvent","bubbles","style","cursor","deltaX","forEach","_recalculatePosition","isDocument","_clearTarget","checkresult","_layout","staticCheck","console","log","removeTempDraggingInstance","p","l","setTransform","clearRect","transform","_resetTransform","render","save","restore","EventTarget","prototype","MessageMixin","StackMixin","LayoutMixin"],"mappings":"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","sourcesContent":["import { createCanvas } from '../utils/canvas';\nimport { bounding_box } from '../utils/functions';\nimport StackMixin from '../instance/stackMixin';\nimport InstanceStack from '../instance/stack';\nimport LayoutMixin from '../instance/layoutMixin';\nimport MessageMixin from '../instance/messageMixin';\nimport { setUniqueId, getUniqueId } from '../utils/functions';\nimport JFlowEvent from '../events';\n/**\n * @typedef JFlow~JFlowConfigs\n * @type {object}\n * @property {Boolean} allowDrop      - 是否允许 dragdrop\n * @property {Number} maxZoom         - 最大缩放\n * @property {Number} minZoom         - 最小缩放\n */\n\n/**\n * @typedef {JFlowConfigs | LayoutMixin~LayoutConfigs} JFlow~JFlowLayoutConfigs\n */\n/** \n * JFlow 对象\n * JFlow 是 canvas 上面封装的一个顶层对象，具有处理事件和绘制的功能\n * @constructor JFlow\n * @mixes LayoutMixin\n * @mixes StackMixin\n * @mixes MessageMixin\n */\nclass JFlow extends EventTarget{\n    /**\n     * 创建一个JFlow对象\n     * @param {JFlowLayoutConfigs} configs - 配置项\n     */\n    constructor(configs) {\n        super();\n        this.uniqueName = 'jflow';\n        this.initStack(configs);\n        this.initLayout(configs);\n        /**\n         * @property {Context2d} ctx        - Context2d 对象\n         * @property {Element} canvas       - canvas 元素\n         * @property {number} dpr           - 设备DPR\n         * @property {number} padding       - 内边距\n         */\n        // TODO 引入 plugin 拓展\n        // this.plugins = [];\n        this.ctx = null;\n        this.canvas = null;\n        this.dpr = 1;\n        this.padding = 20;\n        /**\n         * for zoom and pinch\n         * @property {Context2d} position       - 平移位置\n         * @property {Element} scale            - 当前缩放比\n         * @property {number} maxZoom           - 最大缩放比\n         * @property {number} minZoom           - 最小缩放比\n         */\n        this.position = null;\n\t\tthis.scale = null;\n        this.maxZoom = configs.maxZoom || 3;\n        this.minZoom = configs.minZoom || .5;\n\t\t// this.initScale = 1;\n\t\t// this.initPosition = null\n\t\tthis.offeset = null;\n        this._lastState = {\n            x: null,\n            y: null,\n            dragging: false,\n            processing: false\n        };\n        this._lastDragState = {\n            target: null,\n            targetLink: null,\n            processing: false,\n        }\n\n        this._target = {\n            instance: null,\n            link: null,\n            moving: null,\n            isInstanceDirty: false, \n            isLinkDirty: false, \n            // isMovingDirty: false, \n            cache: {\n                stack: null,\n                belongs: null,\n                point: null,\n            },\n            meta: {\n                x: undefined,\n                y: undefined,\n                initialX: undefined,\n                initialY: undefined, \n            },\n            status: {\n                dragovering: false,\n                dragging: false,\n                processing: false,\n            }\n        }\n\n        this._focus = {\n            instance: null,\n        }\n\n        this._dragOverTarget = null;\n        // this.lock = configs.lock;\n\n        // this._belongs = \n        this.allowDrop = configs.allowDrop;\n        this._tempInstance = null;\n    }\n\n    // use(plugin) {\n    //     this.plugins.push(plugin)\n    // }\n\n    /**\n     * 设置当前拖动的 JFlow 对象\n     * @param {Instance} instance - JFlow 对象\n     */\n    setTempDraggingInstance(instance) {\n        instance._belongs = this;\n        this._tempInstance = instance;\n        Object.assign(this._target, {\n            moving: [this._tempInstance],\n            dragging: true,\n        })\n        // this.addToStack(instance);\n    }\n\n    /**\n     * 取消当前拖动的 JFlow 对象\n     * @return {number[]} point - JFlow 坐标\n     */\n    removeTempDraggingInstance() {\n        if(this._tempInstance) {\n            // this.removeFromStack(this._tempInstance);\n            const anchor = this._tempInstance.anchor;\n            this._tempInstance = null;\n            return anchor;\n        }\n    }\n    /**\n     * 在 Document 元素上初始化实例\n     * @param {Element} dom \n     */\n    $mount(dom) {\n        const { \n            canvas, \n            ctx, \n            scale: dpr, \n            width: c_width, \n            height: c_height, \n            raw_width,\n            raw_height,\n            left, top \n        } = createCanvas(dom);\n        this.reflow();\n        this.ctx = ctx;\n        this.DOMwrapper = dom;\n        this.canvas = canvas;\n        this.canvasMeta = {\n            width: raw_width,\n            height: raw_height,\n            actual_width: c_width,\n            actual_height: c_height\n        }\n        this.dpr = dpr;\n        this._createEventHandler();\n        this._getBoundingGroupRect();\n\n        const padding = this.padding;\n        const { width: p_width, height: p_height, x, y } = this.bounding_box;\n        const contentBox = {\n            x: padding,\n            y: padding,\n            width: c_width - padding * 2,\n            height: c_height - padding * 2,\n        }\n        const position = { x: 0, y: 0, offsetX: 0, offsetY: 0 };\n        const w_ratio = contentBox.width / p_width;\n        const h_ratio = contentBox.height / p_height;\n        const align = w_ratio <= h_ratio ? 'x' : 'y';\n        const scaleRatio = Math.min(w_ratio, h_ratio);\n        this.scale = scaleRatio;\n        if(scaleRatio > this.maxZoom) {\n            this.maxZoom = scaleRatio;\n        }\n        if(scaleRatio < this.minZoom) {\n            this.minZoom = scaleRatio;\n        }\n        // this.initScale = scaleRatio;\n        position.x = align === 'x' ? contentBox.x : (contentBox.width - p_width * scaleRatio) / 2 + padding\n        position.y = align === 'y' ? contentBox.y : (contentBox.height - p_height * scaleRatio) / 2 + padding\n        position.offsetX = position.x - x * scaleRatio;\n        position.offsetY = position.y - y * scaleRatio;\n        this.position = position;\n        this._render();\n    }\n    // _resetPosition() {\n    //     const padding = this.padding;\n    //     const {\n    //         c_width,\n    //         c_height,\n    //     } =  this.canvasMeta;\n    //     const { width: p_width, height: p_height, x, y } = this.bounding_box;\n    //     console.log(this.bounding_box)\n    //     const contentBox = {\n    //         x: padding,\n    //         y: padding,\n    //         width: c_width - padding * 2,\n    //         height: c_height - padding * 2,\n    //     }\n    //     const position = { x: 0, y: 0, offsetX: 0, offsetY: 0 };\n    //     const w_ratio = contentBox.width / p_width;\n    //     const h_ratio = contentBox.height / p_height;\n    //     const align = w_ratio <= h_ratio ? 'x' : 'y';\n    //     const scaleRatio = Math.min(w_ratio, h_ratio);\n    //     this.scale = scaleRatio;\n    //     if(scaleRatio > this.maxZoom) {\n    //         this.maxZoom = scaleRatio;\n    //     }\n    //     if(scaleRatio < this.minZoom) {\n    //         this.minZoom = scaleRatio;\n    //     }\n    //     // this.initScale = scaleRatio;\n    //     position.x = align === 'x' ? contentBox.x : (contentBox.width - p_width * scaleRatio) / 2 + padding\n    //     position.y = align === 'y' ? contentBox.y : (contentBox.height - p_height * scaleRatio) / 2 + padding\n    //     position.offsetX = position.x - x * scaleRatio;\n    //     position.offsetY = position.y - y * scaleRatio;\n    //     this.position = position;\n    // }\n    \n    _getBoundingGroupRect() {\n        const points = this._stack.getBoundingRectPoints();\n        if(this.bounding_box) {\n            this.bounding_box = bounding_box(points);\n            const {\n                x: nowx,\n                y: nowy,\n            } = this.bounding_box;\n            const scale = this.scale;\n            this.position.x = this.position.offsetX + nowx * scale;\n            this.position.y = this.position.offsetY + nowy * scale;\n        } else {\n            this.bounding_box = bounding_box(points);\n        }\n    }\n\n    // $setFocus(instance) {\n    //     if(this._lastFocus.processing) return;\n    //     this._lastFocus.processing = true;\n    //     if(this._lastFocus.instance){\n    //         this._lastFocus.instance.status.focus = false;\n    //     }\n        \n    //     this._lastFocus.instance = instance;\n    //     if(instance) {\n    //         instance.status.focus = true;\n    //         instance.bubbleEvent(new JFlowEvent('focus'))\n    //     }\n\n    //     requestAnimationFrame(() => {\n    //         this._render();\n    //         this._lastFocus.processing = false;\n    //     })\n\n    // }\n\n    _createEventHandler() { \n        const canvas = this.canvas;\n        const zoomHandler = this._onZoom.bind(this);\n        const pressStartHandler = this._onPressStart.bind(this);\n        const pressMoveHandler = this._onPressMove.bind(this);\n        const pressUpHandler = this._onPressUp.bind(this);\n        const pressUpDocument = this._onPressUpDocument.bind(this);\n        const contextmenuHandler = this._onContextMenu.bind(this);\n        canvas.addEventListener('wheel', zoomHandler );\n        canvas.addEventListener('contextmenu', e => {\n            e.preventDefault();\n        });\n        canvas.addEventListener('pointerdown', pressStartHandler );\n        canvas.addEventListener('pointermove', pressMoveHandler );\n        canvas.addEventListener('pointerup', pressUpHandler );\n        canvas.addEventListener('contextmenu', contextmenuHandler)\n        document.addEventListener('pointerup', pressUpDocument);\n        let destroyListener;\n        const destroyPlainEventListener = () => {\n            canvas.removeEventListener('wheel', zoomHandler );\n            canvas.removeEventListener('pointerdown', pressStartHandler );\n            canvas.removeEventListener('pointermove', pressMoveHandler );\n            canvas.removeEventListener('pointerup', pressUpHandler );\n            document.removeEventListener('pointerup', pressUpDocument);\n        }\n        destroyListener = destroyPlainEventListener;\n\n        if(this.allowDrop) {\n            const dragoverHandler = this._onDragover.bind(this);\n            const dropHandler = this._onDrop.bind(this);\n            canvas.addEventListener('dragover', dragoverHandler);\n            canvas.addEventListener('drop', dropHandler);\n            destroyListener = () => {\n                destroyPlainEventListener();\n                canvas.removeEventListener('dragover', dragoverHandler);\n                canvas.removeEventListener('drop', dropHandler);\n            }\n        } \n        this.destroy = destroyListener;\n    }\n\n    _targetLockOn(offsetPoint, event) {\n        let point = this._calculatePointBack(offsetPoint);\n        const topLayerPoint = point;\n        this._currentp = point;\n        let stack = this._stack;\n        const target = stack.checkHit(point, (instance) => {\n            return this._target.status.dragging && (instance === this._getMovingTarget())\n        });\n        let linkStack = this._linkStack;\n        let belongs = this;\n        if(target) {\n            linkStack = target._belongs._linkStack;\n            point = target._belongs._currentp;\n            stack = target._belongs._stack;\n            belongs = target._belongs\n        }\n        const targetLink = linkStack.checkHit(point, (link) => {\n            if(!this._target.status.dragging) {\n                return false;\n            }\n            const movingtarget = this._getMovingTarget();\n            return link.from === movingtarget || link.to === movingtarget;\n        });\n\n        Object.assign(this._target, {\n            instance: target,\n            link: targetLink, \n            isInstanceDirty: target === this._target.instance,\n            isLinkDirty: targetLink === this._target.link,\n        });\n        Object.assign(this._target.cache, {\n            stack,\n            belongs,\n            point,\n            topLayerPoint,\n        })\n        Object.assign(this._target.meta, {\n            x: offsetPoint[0],\n            y: offsetPoint[1],\n        });\n\n        if(event === 'pressStart' && !this._target.status.dragging && !this._target.status.dragovering) {\n            let movingtarget = target;\n            while (movingtarget && movingtarget._belongs.lock && movingtarget !== this) {\n                movingtarget = movingtarget._belongs;\n            }\n            // if(movingtarget === this) {\n            //     movingtarget = undefined;\n            // }\n            if(movingtarget) {\n                if(movingtarget._layoutNode) {\n                    if(movingtarget._layoutNode.isLocked) {\n                        movingtarget = movingtarget._layoutNode.getNodes()\n                    } else if(!movingtarget._layoutNode.isDraggable) {\n                        movingtarget = undefined;\n                    } else {\n                        movingtarget = [movingtarget];\n                    }\n                } else {\n                    movingtarget = [movingtarget];\n                }\n            } \n            Object.assign(this._target, {\n                moving: movingtarget,\n                // isMovingDirty: movingtarget[0] === this._target.moving[0],\n            })\n        }\n        return this._target;\n    }\n\n    _getMovingTarget() {\n        return this._target.moving && this._target.moving[0];\n    }\n\n    _processDragOver(instance, event) {\n        if(this._dragOverTarget !== instance) {\n            const target = this.readMessage()?.instance;\n            this._dragCurrentData = target;\n            if(this._dragOverTarget) {\n                const oldIns = this._dragOverTarget;\n                /**\n                * dragleave 退出事件\n                * @event Instance#dragleave\n                * @type {object}\n                * @property {Event} event           - 原始事件 \n                * @property {Object} instance       - dragleave的对象 \n                * @property {target} target         - drag 携带的对象（特指从外面拖进canvas的对象） \n                */\n                oldIns.dispatchEvent(new JFlowEvent('dragleave', {\n                    event,\n                    instance: oldIns,\n                    target\n                }));\n            }\n            if(instance) {\n                /**\n                * dragenter 进入事件\n                * @event Instance#dragenter\n                * @type {object}\n                * @property {Event} event           - 原始事件 \n                * @property {Object} instance       - dragenter的对象 \n                * @property {target} target         - drag 携带的对象（特指从外面拖进canvas的对象） \n                */\n                instance.dispatchEvent(new JFlowEvent('dragenter', {\n                    event,\n                    instance,\n                    target,\n                }));\n            }\n            this._dragOverTarget = instance;\n        } else if(this._dragOverTarget){\n            /**\n            * dragover 进入事件\n            * @event Instance#dragover\n            * @type {object}\n            * @property {Event} event           - 原始事件 \n            * @property {Object} instance       - dragover的对象 \n            * @property {target} target         - drag 携带的对象（特指从外面拖进canvas的对象） \n            */\n            this._dragOverTarget.dispatchEvent(new JFlowEvent('dragover', {\n                event,\n                instance,\n                target: this._dragCurrentData,\n            }));\n        }\n    }\n\n    _onDragover(event) {\n        // console.log(event);\n        event.preventDefault();\n        event.stopPropagation();\n        if(this._lastDragState.processing) return;\n        this._lastDragState.processing = true;\n        const { offsetX, offsetY } = event\n        Object.assign(this._target.status, {\n            dragovering: true,\n        })\n        this._targetLockOn([offsetX, offsetY])\n        const instance = this._target.instance || this._target.link;\n        // console.log(event)\n        // if (instance) {\n        //     event.dataTransfer.dropEffect = 'copy';\n        // }\n        this._processDragOver(instance, event);\n        // if(this._dragOverTarget !== instance) {\n        //     if(instance) {\n        //         instance.dispatchEvent(new JFlowEvent('dragover', {\n        //             event,\n        //             instance,\n        //         }));\n        //     }\n        //     if(this._dragOverTarget) {\n        //         const oldIns = this._dragOverTarget;\n        //         oldIns.dispatchEvent(new JFlowEvent('dragoverend', {\n        //             event,\n        //             instance: oldIns,\n        //         }));\n        //     }\n        //     this._dragOverTarget = instance;\n        // }\n        \n        if(this._target.isLinkDirty || this._target.isInstanceDirty) {\n            Promise.resolve().then(() => {\n                this._render();    \n                this._target.isLinkDirty = false; \n                this._target.isInstanceDirty = false;\n                this._lastDragState.processing = false;\n            })\n        } else {\n            this._lastDragState.processing = false;\n        } \n    }\n\n    _onDrop(event) {\n        const { offsetX, offsetY, clientX, clientY } = event\n        const payload = this.consumeMessage();\n        const instance = payload.instance;\n        if(this._dragOverTarget) {\n            const oldIns = this._dragOverTarget;\n            oldIns.dispatchEvent(new JFlowEvent('dragoverend', {\n                event,\n                instance: oldIns,\n            }));\n            this._dragOverTarget = null;\n        }\n        const {\n            link,\n            instance: target,\n        } = this._target;\n        const {\n            point, belongs\n        } = this._target.cache;\n        if(link) {   \n            /**\n             * 丢在线上事件\n             *\n             * @event BaseLink#drop\n             * @type {object}\n             * @property {Event} event           - 原始事件 \n             * @property {Object} instance       - 拖动的对象 \n             * @property {BaseLink} link         - 目标连线 \n             * @property {JFlow} jflow           - 当前JFlow对象 \n             * @property {Group|JFlow} belongs   - 连线所在的绘图栈的对象\n             * @property {number[]} point        - 已经计算到绘图栈对应坐标系下的坐标\n             */\n            instance.anchor = point;\n            link.dispatchEvent(new JFlowEvent('drop', {\n                event,\n                instance,\n                link,\n                jflow: this,\n                belongs,\n                point\n            }))\n        } else if(target) {\n            /**\n             * 丢在节点上事件\n             *\n             * @event Node#drop\n             * @type {object}\n             * @property {Event} event           - 原始事件 \n             * @property {Object} instance       - 拖动的对象 \n             * @property {JFlow} jflow           - 当前JFlow对象 \n             * @property {Node} target           - 目标节点\n             * @property {number[]} point        - 已经计算到绘图栈对应坐标系下的坐标\n             */\n            target.dispatchEvent(new JFlowEvent('drop', {\n                event,\n                instance,\n                jflow: this,\n                target,\n                point\n            }));\n        } else {\n            /**\n            * 丢在主图上事件\n            *\n            * @event JFlow#drop\n            * @type {object}\n            * @property {Event} event           - 原始事件 \n            * @property {Object} instance       - 拖动的对象 \n            * @property {JFlow} jflow           - 当前JFlow对象 \n            * @property {number[]} point        - 已经计算到绘图栈对应坐标系下的坐标\n            */\n            this.dispatchEvent(new JFlowEvent('drop', {\n                event,\n                instance,\n                jflow: this,\n                target,\n                point,\n            }))\n        }\n        \n        requestAnimationFrame(() => {\n            // this.recalculate();\n            this._target.instance = null;\n            this._target.link = null;\n            Object.assign(this._target.status, {\n               dragovering: false,\n            })\n            // this._render();\n        })\n    }\n\n    _onZoom(event) {\n        event.preventDefault();\n        if(this._zooming) return;\n        this._zooming = true;\n        const { offsetX, offsetY, deltaY } = event\n        const { width: p_width, height: p_height, x, y } = this.bounding_box;\n        let newScale = this.scale;\n        const amount = deltaY > 0 ? 1.1 : 1 / 1.1;\n        newScale *= amount;\n\n        if (this.maxZoom && newScale > this.maxZoom){\n            // could just return but then won't stop exactly at maxZoom\n            newScale = this.maxZoom;\n        }\n\n        if(this.minZoom && newScale < this.minZoom) {\n            newScale = this.minZoom;\n        }\n\n        var deltaScale    = newScale - this.scale;\n        var currentWidth  = p_width * this.scale;\n        var currentHeight = p_height * this.scale;\n        var deltaWidth    = p_width * deltaScale;\n        var deltaHeight   = p_height * deltaScale;\n\n        var tX = offsetX - this.position.x;\n        var tY = offsetY - this.position.y;\n        var pX = -tX / currentWidth;\n        var pY = -tY / currentHeight;\n\n        this.scale = newScale;\n        this.position.x += pX * deltaWidth;\n\t\tthis.position.y += pY * deltaHeight;\n        this.position.offsetX = this.position.x - x * newScale;\n        this.position.offsetY = this.position.y - y * newScale;\n        /**\n         * 缩放平移事件\n         *\n         * @event JFlow#zoompan\n        */\n        this.dispatchEvent(new JFlowEvent('zoompan'));\n        requestAnimationFrame(() => {\n            this._render();\n            this._zooming = false;\n        })\n    }\n\n    _onPressStart(event) { \n        const { offsetX, offsetY, deltaY, button } = event\n        if(button !== 0) return;\n        this._targetLockOn([offsetX, offsetY], 'pressStart');\n        Object.assign(this._target.meta, {\n            initialX: offsetX,\n            initialY: offsetY,\n        })\n        Object.assign(this._target.status, {\n            dragging: true,\n            processing: false,\n        });\n        if(this._target.moving) {\n            const moving = this._getMovingTarget();\n            /**\n             * 开始拖动组的事件（特指lock的顶层组）\n             *\n             * @event Node#pressStart\n             * @type {object}\n             * @property {Event} event           - 原始事件 \n             * @property {Node} instance       - 拖动的对象 \n             * @property {JFlow} jflow           - 当前JFlow对象 \n             */\n            moving.dispatchEvent(new JFlowEvent('pressStart', {\n                event,\n                instance: moving,\n                jflow: this,\n            }))\n        }\n\n        if(this._target.instance) {\n            /**\n             * 开始拖动对象事件（就是目标对象的拖动事件，事件支持冒泡）\n             *\n             * @event Node#instancePressStart\n             * @type {object}\n             * @property {Event} event           - 原始事件 \n             * @property {Node} instance     - 拖动的对象 \n             * @property {JFlow} jflow           - 当前JFlow对象 \n             * @property {Boolean} bubbles       - 冒泡\n             */\n            const t = this._target.instance;\n            t.bubbleEvent(new JFlowEvent('instancePressStart', {\n                event,\n                target: t,\n                jflow: this,\n                bubbles: true,\n            }))\n        }\n\n    }\n\n    _onPressMove(event) {\n        // console.log('_onPressMove')\n        const {\n            dragging, processing\n        } = this._target.status;\n        const { x, y } = this._target.meta;\n\n        const { offsetX, offsetY, clientX, clientY } = event\n        /**\n         * canvas pressmove 原生事件\n         *\n         * @event JFlow#canvasmousemove\n         * @type {object}\n         * @property {Event} event           - 原始事件\n         * @property {JFlow} jflow           - 当前JFlow对象 \n         */\n        this.dispatchEvent(new JFlowEvent('canvasmousemove', {\n            event,\n            jflow: this,\n        }))\n\n        if(!dragging && !processing) {\n            const {\n                link,\n                instance\n            } = this._targetLockOn([offsetX, offsetY]);\n            // console.log(offsetX, offsetY)\n            // if(instance || link) {\n            //     this.canvas.style.cursor = 'move';\n            // } else {\n            //     this.canvas.style.cursor = 'default';\n            // }\n        }\n        this.canvas.style.cursor = 'default';\n        if(!dragging) return;\n        this.canvas.style.cursor = 'move';\n        if(processing) return;\n        \n        const movingtarget = this._target.moving;// this._tempInstance ? [this._tempInstance] : this._target.moving;\n\n        this._target.status.processing = true;\n        const deltaX = offsetX - x;\n        const deltaY = offsetY - y;\n\n        if(movingtarget) {\n            movingtarget.forEach(t => {\n                t.anchor[0] += deltaX / this.scale;\n                t.anchor[1] += deltaY / this.scale;\n            })\n        } else {\n            this._recalculatePosition(deltaX, deltaY);    \n            this.dispatchEvent(new JFlowEvent('zoompan'));\n        }\n        const { instance, link } = this._targetLockOn([offsetX, offsetY]);\n        // console.log(instance);\n        this._processDragOver(instance || link, event);\n            \n        // this._target.meta.x = offsetX;\n        // this._target.meta.y = offsetY;\n        \n        requestAnimationFrame(() => {\n            this._render();\n            this._target.isLinkDirty = false; \n            this._target.isInstanceDirty = false;\n            this._target.status.processing = false;\n        })\n        \n    }\n\n    _onPressUp(event, isDocument) {\n        event.preventDefault();\n        event.stopPropagation();\n        const { button } = event\n        if(button !== 0) return;\n        const meta = this._target.meta;\n        // if(meta.initialX === undefined && isDocument) {\n        //     this.dispatchEvent(new JFlowEvent('click', {\n        //         event,\n        //         jflow: this,\n        //     }));\n        //     return;\n        // }\n        \n        // if(this._tempInstance) {\n        //     this.dispatchEvent(new JFlowEvent('canvasmouseup', {\n        //         event,\n        //         jflow: this,\n        //     }));\n        //     this._clearTarget();\n        //     return;\n        // } else {\n        //     // 没有设置也需要触发事件\n        //     this.dispatchEvent(new JFlowEvent('canvasmouseup', {\n        //         event,\n        //         jflow: this,\n        //     }));\n        // }\n        \n        \n        if(meta.initialX === meta.x\n            && meta.initialY === meta.y) {\n                if(event.target !== this.canvas){\n                    this._clearTarget();\n                    return;\n                }\n                if(this._target.instance && !isDocument) {\n                    const t = this._target.instance;\n                    /**\n                    * 点击事件（冒泡）\n                    *\n                    * @event Node#click\n                    * @type {object}\n                    * @property {Event} event          - 原始事件 \n                    * @property {Instance} target      - 点击的对象 \n                    * @property {JFlow} jflow          - 当前JFlow对象 \n                    * @property {Boolean} bubbles      - 冒泡\n                    */\n                    t.bubbleEvent(new JFlowEvent('click', {\n                        event,\n                        target: t,\n                        jflow: this,\n                        bubbles: true,\n                    }))\n                    this._clearTarget();\n                    this._render();\n                    return;\n                } else {\n                    /**\n                    * 点击事件\n                    *\n                    * @event JFlow#click\n                    * @type {object}\n                    * @property {Event} event          - 原始事件 \n                    * @property {JFlow} jflow          - 当前JFlow对象 \n                    */\n                    this.dispatchEvent(new JFlowEvent('click', {\n                        event,\n                        jflow: this,\n                    }));\n                    this._clearTarget();\n                    this._render();\n                    return\n                }\n            \n        } else if(this._target.moving) {\n            let checkresult = false;\n            if(this._layout.static) {\n                checkresult = this.staticCheck(this._getMovingTarget());\n            }\n\n            if(!checkresult && this._target.link) {\n                const {\n                    point, belongs\n                } = this._target.cache;\n                const link = this._target.link;\n                const instance = this._getMovingTarget();\n                // instance.anchor = point;\n                // belongs.addInstanceToLink(this._target.link, instance);\n                // belongs.dispatchEvent(new JFlowEvent('drop', {\n                //     event,\n                //     instance,\n                //     link: ,\n                //     jflow: this,\n                //     target,\n                // }))\n                /**\n                 * 拖动到线上事件\n                 *\n                 * @event BaseLink#drop\n                 * @type {object}\n                 * @property {Event} event           - 原始事件 \n                 * @property {Object} instance     - 拖动的对象 \n                 * @property {BaseLink} link         - 目标连线 \n                 * @property {JFlow} jflow           - 当前JFlow对象 \n                 * @property {Group|JFlow} belongs   - 连线所在的绘图栈的对象\n                 */\n                link.dispatchEvent(new JFlowEvent('drop', {\n                    event,\n                    instance,\n                    link,\n                    jflow: this,\n                    belongs,\n                    // reflowCallback: () => {\n                    //     debugger\n                    //     belongs.recalculate();\n                    //     belongs.reflow();\n                    //     this._render();\n                    // }\n                }));\n                this._target.link = null;\n                this._target.instance = null;\n                // link.dispatchEvent(new JFlowEvent('dragover', {\n                //     event,\n                //     instance,\n                //     link,\n                //     jflow: this,\n                //     belongs,\n                // }))\n                // this.recalculate();\n            }\n            if(this._target.moving) {\n                if(this._target.instance) {\n                    /**\n                     * 拖动后放置到 Instance 上的事件\n                     *\n                     * @event Instance#pressEnd\n                     * @type {object}\n                     * @property {Event} event           - 原始事件 \n                     * @property {Instance} instance     - 拖动的对象 \n                     * @property {JFlow} jflow           - 当前JFlow对象 \n                     * @property {Instance} target       - 拖动到的对象\n                     * @property {boolean} bubbles       - 冒泡\n                     */\n                     console.log('pressEnd', this._target.instance)\n                    this._target.instance.bubbleEvent(new JFlowEvent('pressEnd', {\n                        event,\n                        instance: this._getMovingTarget(),\n                        jflow: this,\n                        target: this._target.instance,\n                        bubbles: true\n                    }));\n                } else {\n                    /**\n                     * 拖动后放置到主图上的事件\n                     *\n                     * @event JFlow#pressEnd\n                     * @type {object}\n                     * @property {Event} event           - 原始事件 \n                     * @property {Instance} instance       - 拖动的对象 \n                     * @property {JFlow} jflow           - 当前JFlow对象 \n                     */\n                    this.dispatchEvent(new JFlowEvent('pressEnd', {\n                        event,\n                        instance: this._getMovingTarget(),\n                        jflow: this,\n                    }))\n                }\n            }\n            this._target.moving = null;\n            this.removeTempDraggingInstance()\n            // this._target.isMovingDirty = false;\n            this._render();\n        }\n        this._clearTarget();\n    }\n\n    _clearTarget(){\n        Object.assign(this._target.meta, {\n            x: undefined,\n            y: undefined,\n            initialX: undefined,\n            initialY: undefined, \n        })\n        Object.assign(this._target.status, {\n            dragging: false,\n            processing: false,\n        });\n        Object.assign(this._target, {\n            instance: null,\n            link: null,\n            moving: null,\n        });\n    }\n\n    _onPressUpDocument(event) {\n        this._onPressUp(event, true);\n    }\n\n    _onClick(event) {\n        const { offsetX, offsetY } = event;\n        const point = this._calculatePointBack([offsetX, offsetY]);\n        const target = this._stack.checkHit(point);\n    }\n\n    _onContextMenu(event) {\n        event.preventDefault();\n        event.stopPropagation();\n        const { offsetX, offsetY } = event;\n        const {\n            link,\n            instance\n        } = this._targetLockOn([offsetX, offsetY]);\n        const { topLayerPoint } = this._target.cache\n        if(instance || link) {\n            const target = (instance || link);\n            /**\n             * 右键事件（冒泡）\n             *\n             * @event instance#contextclick\n             * @type {object}\n             * @property {Event} event           - 原始事件 \n             * @property {Instance} target       - 右键对象 \n             * @property {JFlow} jflow           - 当前JFlow对象\n             * @property {number[]} topLayerPoint  - jflow坐标系上的位置\n             * @property {Boolean} bubbles       - 冒泡\n             */\n            target.bubbleEvent(new JFlowEvent('contextclick', {\n                event,\n                jflow: this,\n                target,\n                topLayerPoint,\n                bubbles: true\n            }));\n        } else {\n            /**\n             * 右键事件\n             *\n             * @event JFlow#contextclick\n             * @type {object}\n             * @property {Event} event           - 原始事件 \n             * @property {JFlow} jflow           - 当前JFlow对象\n             * @property {number[]} topLayerPoint  - jflow坐标系上的位置\n             */\n            this.dispatchEvent(new JFlowEvent('contextclick', {\n                event,\n                jflow: this,\n                topLayerPoint,\n            }));\n        }\n    }\n\n    _recalculatePosition(deltaX, deltaY, scale) {\n        const { x, y } = this.bounding_box;\n        if(scale === undefined) {\n            scale = this.scale;\n        }\n        this.position.x += deltaX;\n\t\tthis.position.y += deltaY;\n        this.position.offsetX = this.position.x - x * scale;\n        this.position.offsetY = this.position.y - y * scale;\n    }\n\n    calculateToRealWorld(p) {\n        const scale = this.scale;\n        const position = this.position;\n        return [p[0] * scale + position.offsetX, p[1] * scale + position.offsetY]\n    }\n\n    _calculatePointBack(p) {\n        const scale = this.scale;\n        const position = this.position;\n        return [(p[0] - position.offsetX)/scale, (p[1] - position.offsetY) / scale];\n    }\n\n    _calculateDistance(l) {\n        const scale = this.scale;\n        return scale * l;\n    }\n\n    _resetTransform() {\n        const { width: c_width, height: c_height } = this.canvasMeta;\n        const position = this.position;\n        const scale = this.scale;\n        const ctx = this.ctx;\n        ctx.setTransform();\n        ctx.clearRect(0, 0, c_width, c_height);\n        ctx.scale(this.dpr, this.dpr);\n        ctx.transform(scale, 0, 0, scale, position.offsetX, position.offsetY);\n    }\n     /**\n     * 绘制画布\n     */\n    _render() {\n        this._resetTransform();\n        // this._stack.forEach(instance => {\n        //     instance._intersections = [];\n        // });\n        // let linkStack = this._linkStack;\n        // if(this._layout.alignLinkOrder) {\n        //     const p = new InstanceStack();\n        //     this._layout.alignLinkOrder(linkStack, p);\n        //     linkStack = p;\n        // }\n        const ctx = this.ctx;\n        \n        this._stack.render(ctx);\n        this._linkStack.render(ctx);\n        if(this._tempInstance) {\n            ctx.save();\n            this._tempInstance.render(ctx)\n            ctx.restore();\n        }\n        \n    }\n}\nObject.assign(JFlow.prototype, MessageMixin);\nObject.assign(JFlow.prototype, StackMixin);\nObject.assign(JFlow.prototype, LayoutMixin);\n\nexport default JFlow;\nexport { default as JFlowEvent } from '../events';\nexport { default as Instance } from '../instance/instance';\nexport { default as Node } from '../instance/node';\nexport { default as BaseLink } from '../instance/base-link';\nexport { default as Point } from '../instance/shapes/point';\nexport { default as Rectangle } from '../instance/shapes/rectangle';\nexport { default as Group } from '../instance/shapes/rectangle-group';\nexport { default as Capsule } from '../instance/shapes/capsule';\nexport { default as CapsuleGroup } from '../instance/shapes/capsule-group';\nexport { default as CapsuleVerticalGroup } from '../instance/shapes/capsule-vertical-group';\nexport { default as Diamond } from '../instance/shapes/diamond';\nexport { default as DiamondGroup } from '../instance/shapes/diamond-group';\nexport { default as DiamondVerticalGroup } from '../instance/shapes/diamond-vertical-group';\nexport { default as Rhombus } from '../instance/shapes/rhombus';\nexport { default as RhombusGroup } from '../instance/shapes/rhombus-group';\nexport { default as Text } from '../instance/text';\nexport { default as Icon } from '../instance/image';\nexport { default as Link } from '../instance/link';\nexport { default as PolyLink } from '../instance/poly-link';\nexport { default as BezierLink } from '../instance/bezier-link';\nexport { default as LinearLayout} from '../layout/linear-layout';\n// export { default as TreeLayout } from '../ler-layouta;yout/tree-layout';\nexport { default as Lowcodelayout } from '../layout/low-code-layout';\nexport { default as ERLayout } from '../layout/er-layout/er-layout';\n"],"file":"index.js"}